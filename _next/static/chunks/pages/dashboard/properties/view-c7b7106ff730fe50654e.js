(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8521],{96692:function(e,t,n){"use strict";n.d(t,{E:function(){return R}});var r=n(92809),o=n(67294),i=n(11163),a=n(93633),s=n(64930),c=n(80880),u=n(11570),l=n(18862),d=n(58448),p=n(14347),m=n(77417),f=n(80284),y=n(22796),b=n(83789),h=n(24237),v=n(78215),j=n(34610),x=n(18944),g=n(2356),O=n(85893),w=function(e){var t=e.onFilter,n=(0,o.useState)([]),r=n[0],i=n[1];return(0,O.jsx)(v.Z,{children:(0,O.jsxs)(I,{md:3,children:[(0,O.jsx)(j.Z,{onToggle:function(e){return function(e,n){var o;o=n?[].concat((0,b.Z)(r),[e]):r.filter((function(t){return t!==e})),t({bookable:o.includes("bookable")?"yes":null}),i(o)}("bookable",e)},size:"sm"}),(0,O.jsx)(y.Z,{marginLeft:"sm"}),(0,O.jsx)(x.Z,{size:"sm",children:"Show only bookable items"})]})})},I=(0,h.ZP)(g.Z).withConfig({displayName:"customFilters__StyledColumn",componentId:"sc-1wqxvby-0"})(["align-items:center;display:flex;"]),Z=n(60683),S=n(25610),P=n(53444),k=n(81185),C=n(76589),D=n(49705),A=n(42160),E=n(29444),_=n(91126),T=n(1323);function N(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function q(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?N(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):N(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var R=function(e){var t=e.filters,n=e.formData,r=e.customFilters,b=(e.showActionButton,e.rowDetailsInNewPage),h=e.sublocation,v=(0,T.x)().hasRole,j=v("admin")?s.tG:s.Al,x=(0,o.useContext)(c.Z),g=(0,o.useState)(null),I=g[0],N=g[1],R=(0,D.x)({filters:t}),$=R.initialData,J=R.ref,F=(0,a.a)(j,{skip:!t.categoryId&&h,variables:(0,A.Z)($)}),M=F.data,L=(M=void 0===M?{assets:[],meta:{aggregate:{totalCount:0}}}:M).assets,V=M.meta,z=F.loading,H=F.refetch,B=x.close,U=function(e){e.stopPropagation(),h&&!t.categoryId?x.show({content:(0,O.jsx)(u.Z,{content:"You should create a sublocation of assetCategories ",context:"warning"}),title:"Add sublocation",submit:!1}):x.show({content:(0,O.jsx)(Z.R,{data:n,disableSelects:!!n,onSuccess:B,sublocation:h,categoryIdSublocation:null===t||void 0===t?void 0:t.categoryId,initialData:$}),title:h?"Add sublocation":"Add asset"})},W=function(e){var t=e.handleBookingCanvas,n=e.handleEditCanvas,r=e.handleEditLocation,o=e.hasRole,i=e.locationId;return[{hidden:!0},{hidden:!0},{hidden:!0},{text:"Name"},{text:"Category"},{hidden:i,formatter:(0,E.Z)("/dashboard/properties/view","locationId","location"),text:"Location"},{hidden:i,formatter:(0,E.Z)("/dashboard/customers/view","customerId","customer"),text:"Customer"},{sortable:!0,sortName:"createdAt",text:"Created"},{formatter:_.Z,hidden:!o("admin"),formatterData:function(e){return[{context:"secondary",icon:["fas","edit"],onClick:n,tooltip:"Edit Asset"},{context:"secondary",disabled:"yes"!==e.data.bookable,icon:["fas","plus"],onClick:t,tooltip:"Make a booking"},{context:"primary",icon:["fas","map-marker-alt"],onClick:r,tooltip:"Edit Location",hidden:!0}]},text:"Actions"}]}({handleBookingCanvas:function(e,n){e.stopPropagation(),x.show({content:(0,O.jsx)(S.D,{assetId:n.data.id,locationId:t.locationId,onSuccess:B}),title:"Make a Booking"})},handleEditCanvas:function(e,n){e.stopPropagation();var r=q(q({},n.data),{},{assetCategory:n.data.category});x.show({content:(0,O.jsx)(Z.R,{categoryIdSublocation:null===t||void 0===t?void 0:t.categoryId,data:r,id:r.id,onSuccess:B,sublocation:h,initialData:$}),title:h?"Edit sublocation":"Edit asset"})},handleEditLocation:function(e,t){e.stopPropagation(),x.show({content:(0,O.jsx)(P._,{data:t.data,id:t.data.id,locationId:t.locationId,onSuccess:B,name:t.name}),title:"Edit location"})},hasRole:v,locationId:t.locationId}),Y=function(){return(0,O.jsx)(d.Z,{children:(0,O.jsx)(p.Z,{context:"secondary",onClick:U,size:"sm",children:h?"Create sublocations ":"Create Asset"})})};return(0,O.jsx)(O.Fragment,{children:I&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(d.Z,{align:"flex-end",children:(0,O.jsx)(p.Z,{context:"secondary",content:"Back To Table",onClick:function(){N(null)},size:"sm"})}),(0,O.jsx)(m.Z,{size:"sm"}),(0,O.jsx)(C.K,{assetId:I})]})||(0,O.jsxs)(f.Z,{dataSet:{"data-cy":"assets"},open:!0,title:h?"Sublocations":"Assets",toolbar:v("admin")&&(0,O.jsx)(Y,{}),children:[r&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(w,{onFilter:function(e){H((0,A.Z)(q(q({},$),e)))}}),(0,O.jsx)(y.Z,{})]}),(0,O.jsx)(k.t,{columns:W,loading:z,meta:V,ref:J,refetch:H,rowClick:function(e){b?i.default.push("".concat("/dashboard/assets/","view?id=").concat(e.data.id)):N(e.data.id)},rows:L.map((function(e){var t,n,r;return{data:e,locationId:null===(t=e.location)||void 0===t?void 0:t.id,customerId:null===(n=e.customer)||void 0===n?void 0:n.id,name:e.name,cat:null===(r=e.category)||void 0===r?void 0:r.name,location:e.location.name,customer:e.customer.name,createdAt:(0,l.Z)(e.createdAt),actions:""}}))})]})})};R.defaultProps={rowDetailsInNewPage:!0,showActionButton:!0,sublocation:!1}},67082:function(e,t,n){"use strict";n.d(t,{T:function(){return j}});var r=n(92809),o=n(67294),i=n(42283),a=n(24237),s=n(80880),c=n(20305),u=n(78215),l=n(2356),d=n(46482),p=n(22796),m=n(34717),f=n(25610),y=n(83479),b=n(85893);function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var j=function(e){var t=e.assets,n=e.locationId,r=e.onSuccess,a=e.sublocations,h=(0,o.useContext)(s.Z),j=(0,o.useState)(null),g=j[0],O=j[1],w=(0,o.useState)(null),I=w[0],Z=w[1],S=(0,i.cI)(),P={control:S.control,errors:S.errors,register:S.register},k=function(e){var t,n,r=a.find((function(t){return t.id===e})),o=null===r||void 0===r||null===(t=r.media[0])||void 0===t||null===(n=t.medium)||void 0===n?void 0:n.filename,i="".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(o);Z(o?i:null)};return(0,o.useEffect)((function(){var e;if(null!==(e=a[0])&&void 0!==e&&e.id){var t,n=null===(t=a[0])||void 0===t?void 0:t.id;O(n),k(n)}}),[]),(0,b.jsx)(b.Fragment,{children:(0,b.jsxs)(u.Z,{children:[(0,b.jsx)(l.Z,{md:3,children:(0,b.jsx)(d.Z,v(v({},P),{},{name:"status",options:function(){for(var e=[],t=0;t<a.length;t++){var n,r,o;e.push({text:a[t].name,value:a[t].id,filename:null===(n=a[t])||void 0===n||null===(r=n.media[0])||void 0===r||null===(o=r.medium)||void 0===o?void 0:o.filename})}return e}(),onChange:function(e){return function(e){var t=Number(e.target.value);O(t),k(t)}(e)}}))}),(0,b.jsx)(p.Z,{}),(0,b.jsx)(l.Z,{md:12,children:(0,b.jsx)(x,{children:(0,b.jsx)(m.Z,{item:{filename:I},initialZoomLevel:1,maxZoomLevel:14,markers:function(){for(var e=[],n=0;n<t.length;n++){var r,o,i,a,s,u,l,d,p,m,f,h;if((null===(r=t[n].parentId)||void 0===r?void 0:r.value)===g&&null!==(o=t[n].meta)&&void 0!==o&&o.coordinates)e.push({icon:null!==(i=null===(a=t[n].meta)||void 0===a||null===(s=a.markerStyles)||void 0===s||null===(u=s.shape)||void 0===u?void 0:u.icon)&&void 0!==i?i:"circle",popupComponent:(0,b.jsxs)(b.Fragment,{children:[t[n].name,(0,b.jsx)("br",{}),(null===(l=t[n].childAssets)||void 0===l?void 0:l.length)&&(null===(d=t[n].childAssets[0].logs)||void 0===d?void 0:d.length)&&(0,c.Z)(t[n].childAssets[0].logs[0].eventTime)||"",(0,b.jsx)("br",{}),"green"===(0,y.t)({asset:t[n]})?"Unoccupied":"Occupied"]}),x:null===(p=t[n].meta)||void 0===p||null===(m=p.coordinates)||void 0===m?void 0:m.x,y:null===(f=t[n].meta)||void 0===f||null===(h=f.coordinates)||void 0===h?void 0:h.y,colour:(0,y.t)({asset:t[n]}),data:t[n],id:t[n].id,name:t[n].name})}return e}(),onMarkerClick:function(e){h.show({content:(0,b.jsx)(f.D,{assetId:e.data.id,locationId:n,onSuccess:r}),title:"Add asset booking"})}})})})]})})},x=a.ZP.div.withConfig({displayName:"canvas__StyledContainer",componentId:"sc-1t5eak-0"})(["padding:1rem;position:relative;"]);j.defaultProps={}},83479:function(e,t,n){"use strict";n.d(t,{t:function(){return i},l:function(){return a}});var r=n(29444),o=n(91126),i=function(e){var t,n,r,o,i=e.asset;if(i){var a="green",s=!1;null!==(t=i.childAssets)&&void 0!==t&&t.length&&null!==(n=i.childAssets[0].logs)&&void 0!==n&&n.length&&(s=i.childAssets[0].logs[0].value);var c=(null===(r=i.bookings)||void 0===r?void 0:r.length)&&(null===(o=i.bookings)||void 0===o?void 0:o.length)>0;return("true"===s||c)&&(a="red"),a}},a=function(e){var t=e.handleBookingCanvas,n=e.handleEditLocation,i=e.handleEditCanvas,a=e.locationId;return[{hidden:!0},{hidden:!0},{hidden:!0},{text:"Name"},{text:"Category"},{hidden:a,formatter:(0,r.Z)("/dashboard/properties/view","locationId","location"),text:"Location"},{hidden:a,formatter:(0,r.Z)("/dashboard/customers/view","customerId","customer"),text:"Customer"},{sortable:!0,sortName:"createdAt",text:"Created"},{formatter:o.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:i,tooltip:"Edit Asset"},{context:"secondary",icon:["fas","plus"],onClick:t,tooltip:"Make a booking"},{context:"primary",icon:["fas","map-marker-alt"],onClick:n,tooltip:"Edit Location",hidden:!0}],text:"Actions"}]}},87160:function(e,t,n){"use strict";n.d(t,{F:function(){return R}});var r,o=n(92809),i=n(83789),a=n(10219),s=n(30266),c=n(64687),u=n.n(c),l=n(67294),d=n(11163),p=n(26075),m=n(52209),f=(0,n(54397).Ps)(r||(r=(0,m.Z)(['\n  query GetEvents($where: Job_bool_exp) {\n    events: Job(where: $where) {\n      id\n      number\n      description\n      end: timingStart\n      scheduledAt\n      siteVisitStart\n      start: timingStart\n      status\n      title\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      supplierQuotes: SupplierQuotes(\n        where: {\n          siteVisitAt: { _is_null: false }\n          status: { _neq: "cancelled" }\n          type: { _eq: "quote" }\n        }\n      ) {\n        siteVisitAt\n        quoteNumber\n      }\n    }\n  }\n']))),y=n(80880),b=n(80284),h=n(78215),v=n(2356),j=n(92700),x=n(90358),g=n(1323),O=n(78586),w=n(12517),I=n(55148),Z=n(39129),S=n(34610),P=n(22796),k=n(18944),C=n(84550),D=n(24237),A=n(85893),E=function(e){var t=e.setTypes,n=e.setSiteVisit,r=e.types,o=function(e,n){t(n?[].concat((0,i.Z)(r),[e]):r.filter((function(t){return t!==e})))};return(0,A.jsxs)(h.Z,{children:[(0,A.jsxs)(_,{md:3,children:[(0,A.jsx)(S.Z,{onToggle:function(e){return o("reactive",e)},size:"sm",toggled:r.includes("reactive")}),(0,A.jsx)(P.Z,{marginLeft:"sm"}),(0,A.jsx)(k.Z,{size:"sm",children:"Reactive"})]}),(0,A.jsxs)(_,{md:3,children:[(0,A.jsx)(S.Z,{onToggle:function(e){return o("ppm",e)},size:"sm",toggled:r.includes("ppm")}),(0,A.jsx)(P.Z,{marginLeft:"sm"}),(0,A.jsx)(k.Z,{size:"sm",children:"PPM"})]}),(0,A.jsxs)(_,{md:3,children:[(0,A.jsx)(S.Z,{onToggle:function(e){return o("quote",e)},size:"sm",toggled:r.includes("quote")}),(0,A.jsx)(P.Z,{marginLeft:"sm"}),(0,A.jsx)(k.Z,{size:"sm",children:"Quote"})]}),(0,A.jsxs)(_,{md:3,children:[(0,A.jsx)(S.Z,{onToggle:function(e){return o("cppm",e)},size:"sm",toggled:r.includes("cppm")}),(0,A.jsx)(P.Z,{marginLeft:"sm"}),(0,A.jsx)(k.Z,{size:"sm",children:"Compliance"})]}),(0,A.jsxs)(P.Z,{marginLeft:"sm",children:[(0,A.jsx)(C.Z,{data:[{label:"Only show site visits",id:"siteVisit",value:"yes"}],name:"siteVisit",onClick:function(e){n(e.target.checked)}}),(0,A.jsx)(P.Z,{})]})]})},_=(0,D.ZP)(v.Z).withConfig({displayName:"filters__StyledColumn",componentId:"sc-3gjja8-0"})(["align-items:center;display:flex;"]),T=["supplierQuotes"];function N(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function q(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?N(Object(n),!0).forEach((function(t){(0,o.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):N(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var R=function(e){var t,n,r=e.defaultFilters,o=e.defaultView,c=e.locationId,m=e.showCompliance,S=e.showFilters,P=e.showSiteVisits,k=e.supplierId,C=(0,d.useRouter)().query,D=(0,l.useContext)(y.Z),_=(0,O.q)(),N=null===(t=_.admin.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,R=null===(n=_.admin.jobSetting)||void 0===n?void 0:n.jobNumberSuffix,$=(0,g.x)().user,J=(0,p.x)(),F=!1,M=!1;switch($.accountType){case"supplier":M=!0;break;case"customer":F=!0}var L=(0,l.useState)(C.type?["".concat(C.type)]:r),V=L[0],z=L[1],H=(0,l.useState)(P),B=H[0],U=H[1],W="scheduled"===C.type?"PPM":"Bookings";(0,l.useEffect)((function(){return C.type?["".concat(C.type)]:z(M?["ppm"]:r)}),[r]);var Y=function(){var e=(0,s.Z)(u().mark((function e(t,n){var r,o,s,l,d;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={type:{_in:V},_or:[{_and:[{timingStart:{_gte:t.start}},{timingStart:{_lte:t.end}}]},{_and:[{scheduledAt:{_gte:t.start}},{scheduledAt:{_lte:t.end}}]},{_and:[{siteVisitStart:{_gte:t.start}},{siteVisitStart:{_lte:t.end}}]}]},M&&(r.supplierId={_eq:$.accountId}),k&&(r.supplierId={_eq:k}),F&&(r.customerId={_eq:$.accountId}),c&&(r.locationId={_eq:c}),(m||c)&&(r.Compliances={complianceId:{_is_null:!1}}),B&&(r.siteVisitStart={_is_null:!1}),e.next=9,J.query({query:f,variables:{where:r}});case 9:o=e.sent,s=o.data,l=(s=void 0===s?{events:[]}:s).events,d=[],l.map((function(e){var t,n=e.supplierQuotes,r=(0,a.Z)(e,T),o=(null===r||void 0===r||null===(t=r.shortJobDesc[0])||void 0===t?void 0:t.taxonomy.name)||r.title;return d=[].concat((0,i.Z)(d),[q(q({},e),{},{title:o})]),n.length>0&&n.map((function(e){return d=[].concat((0,i.Z)(d),[q(q({},r),{},{start:e.siteVisitAt,end:e.siteVisitAt,title:"".concat(o," ").concat(e.quoteNumber),siteVisit:!0})])})),d})),n(d.map((function(e){var t=q({},e);return t.start=t.scheduledAt||t.start,t.end=t.scheduledAt||t.end||t.start,t.color=t.siteVisit?"rgb(182, 79, 200)":(0,x.t)(t.status),t})));case 16:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();return(0,A.jsxs)(b.Z,{fitParentHeight:!0,open:!0,title:W,children:[S&&(0,A.jsx)(E,{setTypes:z,setSiteVisit:U,types:V}),(0,A.jsx)(j.A,{eventClick:function(e){D.show({content:(0,A.jsx)(w.g,{jobId:parseInt(e.event.id),toggleShow:D.close,numberPrefix:N,numberSuffix:R}),title:"Job details",submit:!1,width:"50%"})},events:Y,initialView:"day"===C.show?"timeGridDay":o}),(0,A.jsx)(h.Z,{children:(0,A.jsx)(v.Z,{md:12,children:(0,A.jsx)(Z.D,{status:I.yW})})})]})};R.defaultProps={dateClick:!1,defaultFilters:["reactive","ppm","quote","cppm"],showFilters:!0,showSiteVisits:!1}},39129:function(e,t,n){"use strict";n.d(t,{D:function(){return i}});var r=n(24237),o=n(85893),i=function(e){var t=e.status;return(0,o.jsx)(a,{children:(0,o.jsx)("ul",{children:t.map((function(e,t){return(0,o.jsxs)("li",{children:[(0,o.jsx)("span",{style:{backgroundColor:e.colour}}),e.text]},"legend".concat(t))}))})})},a=r.ZP.div.withConfig({displayName:"legend__StyledContainer",componentId:"sc-1gaw8i-0"})(["ul{list-style:none;float:left;padding-top:15px;}ul li{display:flex;flex-direction:row;align-items:center;float:left;width:120px;font-size:90%;list-style:none;}li span{display:block;float:left;height:12px;width:12px;margin-right:5px;}"])},3213:function(e,t,n){"use strict";n.d(t,{M:function(){return J}});var r=n(80318),o=n(67294),i=n(11163),a=n(93633),s=n(75709),c=n(36732),u=n(11640),l=n(80880),d=n(91126),p=n(14347),m=n(80284),f=n(52002),y=n(48213),b=n(50899),h=n(92809),v=n(42283),j=n(79665),x=n(7739),g=n.n(x),O=n(97202),w=n(65375),I=n(93515),Z=n(71247),S=n(34868),P=n(19501),k=(0,P.Ry)().shape({complianceId:(0,P.Ry)().required(),expiryAt:(0,P.hT)().required(),insuranceAmount:(0,P.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable(),regNum:(0,P.Z_)().required()}),C=n(76800),D=n(23461),A=n(1323),E=n(85893);function _(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_(Object(n),!0).forEach((function(t){(0,h.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var N=function(e){e.complianceType;var t=e.defaultValues,n=e.onSubmit,r=(0,A.x)().user,i=(0,v.cI)({defaultValues:T(T({},t),(null===t||void 0===t?void 0:t.meta)||{}),resolver:(0,j.S)(k)}),s=i.control,u=i.errors,l=i.handleSubmit,d=i.register,p=(0,i.watch)("complianceId",{hasInsuranceAmount:null===t||void 0===t?void 0:t.hasInsuranceAmount,regNumExample:null===t||void 0===t?void 0:t.regNumExample,questions:null===t||void 0===t?void 0:t.questions}),m=p&&p.questions,f=(0,a.a)(c.kU,{variables:{adminId:r.adminId}}),y=f.loading,b=f.data,h=(b=void 0===b?{compliance:[]}:b).compliances,x={control:s,errors:u,register:d};return!y&&(0,E.jsxs)(O.Z,{id:"offCanvasForm",handleSubmit:l(n),children:[(0,E.jsx)(w.Z,{label:"Compliance",children:(0,E.jsx)(I.Z,T(T({},x),{},{name:"complianceId",options:function(){var e=g()(h,(function(e){return e.category.name})),t=[];return Object.keys(e).forEach((function(n){t.push({label:n,options:e[n]})})),t}()}))}),(0,E.jsx)(w.Z,{label:"Registration Number",children:(0,E.jsx)(Z.Z,T(T({},x),{},{name:"regNum",placeholder:p.regNumExample&&"eg ".concat(p.regNumExample)}))}),(0,E.jsx)(w.Z,{label:"Expiry"}),(0,E.jsx)(C.M,T(T({},x),{},{name:"expiryAt",placeholderText:"Click to select date"})),p.hasInsuranceAmount&&(0,E.jsx)(w.Z,{label:"Insurance Amount",children:(0,E.jsx)(S.Z,T(T({},x),{},{name:"insuranceAmount"}))}),null===m||void 0===m?void 0:m.map((function(e){var t,n,r,i;return(0,o.createElement)(D.f,T(T({},x),{},{input:null===(t=e.meta)||void 0===t?void 0:t.input,inputType:null===(n=e.meta)||void 0===n?void 0:n.inputType,key:e.id,label:null===(r=e.meta)||void 0===r?void 0:r.label,name:e.name,options:null===(i=e.meta)||void 0===i?void 0:i.options}))})),(null===t||void 0===t?void 0:t.id)&&(0,E.jsx)(Z.Z,T(T({},x),{},{name:"id",type:"hidden"}))]})},q=n(7304),R=new Date,$=(0,u.Z)(R,1),J=function(e){var t,n=e.entity,u=e.entityId,h=(0,i.useRouter)().query,v=(0,o.useContext)(l.Z),j=(0,a.a)(c.Au,{variables:{entity:n,entityId:u}}),x=j.loading,g=j.data,O=(g=void 0===g?{job:null}:g).compliances,w=j.refetch,I=(0,s.D)(c.FD,{onCompleted:function(e){v.close(),w()}}),Z=(0,r.Z)(I,1)[0],S=(0,s.D)(c.YW,{onCompleted:function(e){v.close(),w()}}),P=(0,r.Z)(S,1)[0],k=(0,s.D)(c.tC,{onCompleted:function(e){w()}}),C=(0,r.Z)(k,1)[0],D=function(e){var t=function(e){var t=e.entity,n=e.entityId,r=e.form,o={complianceId:r.complianceId.value,entityId:n,entity:t,expiryAt:r.expiryAt,insuranceAmount:r.insuranceAmount,regNum:r.regNum};return delete r.complianceId,delete r.expiryAt,delete r.insuranceAmount,delete r.regNum,o.meta=r,o}({entity:n,entityId:u,form:e});e.id?P({variables:{id:e.id,changes:t}}):Z({variables:{objects:t}})},A=function(e){var t=e.e,r=e.row;t.stopPropagation();var o="Account"===n?null:"regulatory";v.show({content:(0,E.jsx)(N,{complianceType:o,defaultValues:r,onSubmit:D}),title:"Compliance"})},_=[{hidden:!0},{hidden:!0},{text:"Name"},{text:"Registration number"},{formatter:y.FT,text:"Expiry date"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:d.Z,formatterData:(t={editClick:function(e,t){return A({e:e,row:t})},mediaClick:function(e,t){return function(e){var t=e.row;v.show({content:(0,E.jsx)(b.G,{entity:"Compliance_Entity",entityId:null===t||void 0===t?void 0:t.id}),submit:!1,title:"Media"})}({row:t})},deleteClick:function(e,t){return function(e){var t=e.row;C({variables:{id:t.id}})}({row:t})}},[{context:"secondary",icon:["fas","edit"],onClick:t.editClick,tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],onClick:t.mediaClick,tooltip:"Media"},{context:"danger",icon:["fas","trash"],onClick:t.deleteClick,tooltip:"Delete"}]),text:"Actions"}],T=(0,E.jsx)(p.Z,{content:"Add Compliance",context:"secondary",onClick:function(e){return A({e:e})},size:"sm"});return!x&&(0,E.jsxs)(m.Z,{open:!0,title:"Compliances",toolbar:T,children:["Location"===n&&(0,E.jsx)(q.p,{locationId:u}),(0,E.jsx)(f.Z,{columns:_,rows:function(){var e=O;return h.overdue&&(e=O.filter((function(e){return new Date(e.expiryAt)<R}))),h.upcoming&&(e=O.filter((function(e){return new Date(e.expiryAt)>R&&new Date(e.expiryAt)<$}))),e.map((function(e){return{id:e.id,complianceId:{label:e.compliance.name,value:e.compliance.id,hasInsuranceAmount:e.compliance.hasInsuranceAmount,insuranceAmount:e.insuranceAmount,questions:e.compliance.questions,regNumExample:e.compliance.regNumExample},name:e.compliance.name,regNum:e.regNum,expiry:e.expiryAt,expiryAt:e.expiryAt?new Date(e.expiryAt):"",insuranceAmount:e.insuranceAmount,hasInsuranceAmount:e.compliance.hasInsuranceAmount,regNumExample:e.compliance.regNumExample,meta:e.meta,actions:""}}))}()})]})}},38342:function(e,t,n){"use strict";n.d(t,{z:function(){return oe}});var r,o,i,a,s=n(92809),c=n(30266),u=n(80318),l=n(64687),d=n.n(l),p=n(67294),m=n(93633),f=n(75709),y=n(52209),b=n(54397),h=(0,b.Ps)(r||(r=(0,y.Z)(["\n  mutation InsertExpense($objects: [Expense_insert_input!]!) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),v=(0,b.Ps)(o||(o=(0,y.Z)(["\n  mutation UpdateExpense($id: Int!, $changes: Expense_set_input) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),j=(0,b.Ps)(i||(i=(0,y.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']))),x=(0,b.Ps)(a||(a=(0,y.Z)(["\n  mutation DeleteExpense($id: Int!) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),g=n(30493),O=n(42593),w=n(80880),I=n(80285),Z=n(91126),S=n(58448),P=n(14347),k=n(18862),C=n(11417),D=n(78215),A=n(2356),E=n(93443),_=n(52002),T=n(80284),N=n(34112),q=n(50899),R=n(42283),$=n(79665),J=n(97202),F=n(69128),M=n(34868),L=n(65375),V=n(71247),z=n(12757),H=n(83528),B=n(76800),U=n(95146),W=n(19501),Y=(0,W.Ry)().shape({amount:(0,W.Rx)().required(),unit:(0,W.Rx)().required(),categoryId:(0,W.Ry)().required(),description:(0,W.Z_)().required(),markup:(0,W.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable(),paid:(0,W.Z_)().oneOf(["admin","supplier"]).required(),vatMarkup:(0,W.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable()}),G=n(85893);function Q(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Q(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var X=function(e){e.categories,e.currency;var t=e.defaultValues,n=e.entityId,r=e.submit,o=e.serviceRateExpenses,i=e.showRecurring;null!==t&&void 0!==t&&t.vat&&"20"!==(null===t||void 0===t?void 0:t.vat)&&(t.vatMarkup=t.vat,t.vat="custom");var a=(0,R.cI)({defaultValues:K({vat:"20"},t),resolver:(0,$.S)(Y)}),s=a.control,c=a.errors,u=a.handleSubmit,l=a.register,d=(0,a.watch)("vat"),p=[{id:"admin",label:g.H2.name,value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],m={control:s,errors:c,register:l};return(0,G.jsxs)(J.Z,{id:"offCanvasForm",handleSubmit:u(r),children:[(0,G.jsx)(F.Z,K(K({},m),{},{name:"paid",data:p,legend:"Paid by"})),(0,G.jsx)(M.Z,K(K({},m),{},{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,G.jsx)(L.Z,{label:"Units",children:(0,G.jsx)(V.Z,K(K({},m),{},{name:"unit"}))}),(0,G.jsx)(F.Z,K(K({},m),{},{name:"vat",data:[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],legend:"VAT"})),"custom"===d&&(0,G.jsx)(z.Z,K(K({},m),{},{label:"Custom VAT",name:"vatMarkup"})),(0,G.jsx)(z.Z,K(K({},m),{},{label:"Markup ".concat(o?"(Service Rate Expenses and Material : ".concat(o,"%)"):""),name:"markup"})),n&&(0,G.jsx)(L.Z,{label:"Occurred At",children:(0,G.jsx)(B.M,K(K({},m),{},{name:"occurredAt",placeholderText:"Click to select date"}))}),(0,G.jsx)(U.P,K(K({},m),{},{errors:K({},c),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,G.jsx)(L.Z,{label:"Description",children:(0,G.jsx)(H.Z,K(K({},m),{},{name:"description",rows:2}))}),i&&(0,G.jsx)(F.Z,K(K({},m),{},{name:"recurring",data:[{id:"recurring",label:"Recurring",value:"recurring"},{id:"nextInvoice",label:"Only for next invoice",value:"nextInvoice"}]})),t.id&&(0,G.jsx)(V.Z,K(K({},m),{},{name:"id",type:"hidden"}))]})};X.defaultProps={currency:"GBP",serviceRateExpenses:0,showRecurring:!1};var ee=n(88261),te=n(38596);function ne(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function re(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ne(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ne(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var oe=function(e){var t,n,r,o=e.currency,i=e.enableUpdate,a=e.entity,s=e.entityId,l=e.job,y=e.refetchParent,b=e.tab,R=e.withDetails,$=e.showRecurring,J=(0,p.useContext)(O.Z).hasRole,F=(0,p.useContext)(w.Z),M=(0,N.E)(l,"invoiceSent"),L=J("customer")&&!M,V=!l||(J(["admin"])&&!(0,N.E)(l,["validated","unvalidated"])||J(["admin","supplier"])&&!(0,N.E)(l,"reportSent")||i),z=(0,te.B)("serviceRateExpenses",null===l||void 0===l?void 0:l.financeLogs,null===l||void 0===l||null===(t=l.customer)||void 0===t||null===(n=t.meta)||void 0===n||null===(r=n.finance)||void 0===r?void 0:r.serviceRateExpenses)||0,H=b||(!J("admin")&&J("supplier")?"supplier":"admin"),B=(0,m.a)(j,{variables:{entity:a,entityId:s,jobId:null===l||void 0===l?void 0:l.id},skip:L}),U=B.data,W=(U=void 0===U?{expenses:[]}:U).expenses,Y=B.loading,Q=B.refetch,K=(0,ee.E)(W,0,H),ne=K.preparedExpenses,oe=K.totalExpenses,ie=K.totalExpensesExVAT,ae=(0,f.D)(x,{onCompleted:function(e){y?y():Q()}}),se=(0,u.Z)(ae,1)[0],ce=(0,f.D)(h,{onCompleted:function(e){F.close(),y?y():Q()}}),ue=(0,u.Z)(ce,1)[0],le=(0,f.D)(v,{onCompleted:function(e){F.close(),y?y():Q()}}),de=(0,u.Z)(le,1)[0],pe=function(){var e=(0,c.Z)(d().mark((function e(t){var n,r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("custom"===t.vat&&(t.vat=t.vatMarkup),n=t.unit*t.amount,r=n*(t.markup/100)+n,t.total=r*(t.vat/100)+r,delete t.vatMarkup,t.categoryId=t.categoryId.value,!t.id){e.next=11;break}return e.next=9,de({variables:{id:t.id,changes:t}});case 9:e.next=16;break;case 11:return t.jobId=null===l||void 0===l?void 0:l.id,t.entity=a,t.entityId=s,e.next=16,ue({variables:{objects:t}});case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),me=function(e){var t=e.item?re({},null===e||void 0===e?void 0:e.item):{markup:z};null!==t&&void 0!==t&&t.vat&&(t.vat=String(t.vat)),F.show({content:(0,G.jsx)(X,{currency:o,defaultValues:t,entityId:s,submit:pe,serviceRateExpenses:z,showRecurring:$}),title:"Expenses"})},fe=[{context:"secondary",icon:["fas","edit"],onClick:function(e,t){return me(t)},tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],numberOverlay:"mediaCount",onClick:function(e,t){return function(e){F.show({content:(0,G.jsx)(q.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})}(t)},tooltip:"Media"},{context:"danger",icon:["fas","trash"],onClick:function(e,t){return function(e,t){e.preventDefault(),e.stopPropagation(),se({variables:{id:t.item.id}})}(e,t)},tooltip:"Delete"}],ye=[{text:"Description"},{formatter:function(e){var t=e.row;return(0,I.Z)(t.total,o)},text:"Total"},{text:"Occurred At",hidden:!s},{text:"Paid By"},{formatter:Z.Z,formatterData:fe,hidden:!V,text:"Actions"},{hidden:!0},{hidden:!0}],be=function(){return(0,G.jsx)(S.Z,{children:(0,G.jsx)(P.Z,{context:"secondary",content:"Add",onClick:me,size:"sm"})})},he=function(){return(0,G.jsxs)(G.Fragment,{children:[!R&&(0,G.jsx)(C.Z,{content:"Expenses",tag:"h3"}),(0,G.jsxs)(D.Z,{children:[(0,G.jsx)(A.Z,{md:6,children:(0,G.jsx)(E.Z,{content:"Total",text:(0,I.Z)(ie,o)})}),(0,G.jsx)(A.Z,{md:6,children:(0,G.jsx)(E.Z,{content:"VAT Total",text:(0,I.Z)(oe,o)})})]}),(0,G.jsx)(_.Z,{columns:ye,loading:Y,rows:W.map((function(e){var t,n;return{description:e.description,total:ne.find((function(t){return t.id===e.id})).total,occurredAt:(0,k.Z)(e.occurredAt),paid:"supplier"===e.paid?"Supplier":g.H2.name,actions:"",item:re(re(re({},e),{occurredAt:new Date(e.occurredAt)}),{categoryId:{label:null===(t=e.category)||void 0===t?void 0:t.name,value:e.categoryId}}),mediaCount:null===(n=e.media)||void 0===n?void 0:n.length}}))}),V&&!R&&(0,G.jsx)(S.Z,{align:"flex-end",children:(0,G.jsx)(P.Z,{context:"secondary",content:"Add",onClick:me,size:"sm"})})]})};return R?(0,G.jsx)(T.Z,{toolbar:V&&(0,G.jsx)(be,{}),open:!0,title:"Expenses",children:he()}):he()};oe.defaultProps={currency:"GBP",enableUpdate:!1,withDetails:!0,showRecurring:!1}},88261:function(e,t,n){"use strict";n.d(t,{E:function(){return r}});var r=function(e,t,n){var r=0,o=0;return{preparedExpenses:null===e||void 0===e?void 0:e.map((function(e){var i=e.amount;"supplier"===n&&"supplier"!==e.paid&&(i=0),"supplier"!==n&&(i+=e.markup/100*i,i/=1-t/100);var a=i*(e.unit||1),s=a+a*(e.vat/100);return o+=a,r+=s,{id:e.id,name:e.description,unitCost:i,price:a,total:s,unit:e.unit||1,vatAmount:a*(e.vat/100),vatRate:e.vat/100,markup:e.markup}})),totalExpenses:r,totalExpensesExVAT:o}}},56572:function(e,t,n){"use strict";n.d(t,{f:function(){return l}});var r=n(92809),o=n(30266),i=n(64687),a=n.n(i),s=n(53256);n(29575);function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var l=function(){var e=(0,o.Z)(a().mark((function e(t){var n,r,o,i,c,l,d,p,m,f;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.adminId,i=t.client,e.next=3,i.query({query:s.mP,variables:{id:o}});case 3:return c=e.sent,l=c.data,d=(l=void 0===l?{account:{}}:l).account,p=(null===(n=d.meta)||void 0===n||null===(r=n.finance)||void 0===r?void 0:r.invoicePointer)&&u({},d.meta.finance)||{invoiceStart:1,invoicePointer:1},m=Number(p.invoicePointer||p.invoiceStart),p.invoicePointer=m+1,f={meta:u(u({},d.meta),{finance:p})},e.abrupt("return",{invoiceNumber:m,accountMeta:f});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},53256:function(e,t,n){"use strict";n.d(t,{mP:function(){return c},aO:function(){return u}});var r,o,i,a=n(52209),s=n(54397),c=((0,s.Ps)(r||(r=(0,a.Z)(["\n  mutation UpdateJob(\n    $accountId: Int!\n    $account: Account_set_input\n    $id: Int!\n    $changes: Job_set_input\n    $entries: [AccountEntry_insert_input!]!\n    $timing: [JobTiming_insert_input!]!\n    $updatePointer: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $account)\n      @include(if: $updatePointer) {\n      id\n    }\n    insert_AccountEntry(objects: $entries) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,s.Ps)(o||(o=(0,a.Z)(["\n  query GetInvoicePointer($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n      meta\n    }\n  }\n"])))),u=(0,s.Ps)(i||(i=(0,a.Z)(["\n  mutation createInvoiceJob($invoiceJobInput: InvoiceJobInput!) {\n    createInvoiceJob(invoiceJobInput: $invoiceJobInput) {\n      data\n    }\n  }\n"])))},56188:function(e,t,n){"use strict";n.d(t,{K:function(){return _}});var r=n(92809),o=n(30266),i=n(80318),a=n(64687),s=n.n(a),c=n(67294),u=n(18218),l=n(38460),d=n(7802),p=n(80880),m=n(42593),f=n(58448),y=n(26398),b=n(14347),h=n(80284),v=n(5360),j=n(18944),x=n(55657),g=n(80285),O=n(42283),w=n(97202),I=n(69128),Z=n(95146),S=n(85893);function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var C=function(e){var t=e.defaultValues,n=e.setScheduleFilters,r=e.toggleShow,o=(0,O.cI)({defaultValues:t}),i=o.control,a=o.errors,s=o.handleSubmit,c=o.register,u=(0,o.watch)("assetCategory",null===t||void 0===t?void 0:t.assetCategory),l={control:i,errors:a,register:c};return(0,S.jsxs)(w.Z,{id:"offCanvasForm",handleSubmit:s((function(e){n((function(){return k({},e)})),r()})),children:[(0,S.jsx)(I.Z,k(k({},l),{},{name:"compliance",data:[{id:"yes",label:"Yes",value:!0},{id:"no",label:"No",value:!1}],legend:"Compliance"})),(0,S.jsx)(Z.P,k(k({},l),{},{label:"Asset category",locationId:location.id,name:"assetCategory",type:"assetCategory"})),u&&(0,S.jsx)(Z.P,k(k({},l),{},{label:"Assets",locationId:location.id,name:"assetSelected",type:"asset",isMulti:!0,assetCategoryId:(null===u||void 0===u?void 0:u.value)||null})),(0,S.jsx)(Z.P,k(k({},l),{},{errors:k({},a),isMulti:!0,label:"Service",name:"service",type:"service"}))]})},D=n(38099);function A(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?A(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):A(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var _=function(e){var t=e.clickable,n=e.handleHistory,r=e.locationId,a=(e.showDetails,e.refetchSchedule),O=e.setRefetchSchedule,w=(e.setR,e.customerDetails),I=e.supplierDetails,Z=(0,u.useMainContext)(),P=Z.setJobScheduleForToolbar,k=Z.scheduleFilters,A=Z.setScheduleFilters,_=(0,c.useContext)(p.Z),T=(0,c.useContext)(m.Z).hasRole,N=(0,l.t)(d.YW),q=(0,i.Z)(N,2),R=q[0],$=q[1],J=$.data,F=(J=void 0===J?{jobSchedule:[]}:J).jobSchedule,M=void 0===F?[]:F,L=$.refetch;(0,c.useEffect)((0,o.Z)(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,R({variables:{locationId:r,where:(0,D.WJ)(E({},k))}});case 2:case"end":return e.stop()}}),e)}))),[k]),(0,c.useEffect)((function(){a&&(A(!1),O(!1),L())}),[a]);var V=function(e){e.stopPropagation(),_.show({content:(0,S.jsx)(C,{defaultValues:k,toggleShow:_.close,setScheduleFilters:A}),title:"Filter"})},z=function(){var e={context:"secondary",size:"sm",startIconProps:{size:"lg"}};return(0,S.jsxs)(f.Z,{children:[(0,S.jsx)(y.Z,{border:!1,passHref:!0,to:"/reports/ppm/schedule?locationId=".concat(r),children:(0,S.jsx)(b.Z,E(E({},e),{},{startIcon:"file-pdf"}))}),(0,S.jsx)(b.Z,E(E({},e),{},{onClick:V,startIcon:"filter"}))]})};return(0,S.jsx)(h.Z,{fitParentHeight:!0,open:!0,title:"Schedule",toolbar:(0,S.jsx)(z,{}),children:(0,S.jsx)(v.Z,{dataSource:M.length>0?(P(M),M):[],events:"jobs",eventTimeSplitting:"timingStart",flag:"rag",handleClick:t?function(e,t,r){var o=e.e,i=e.row;o.stopPropagation();var a=k.mode;"string"!==typeof(null===i||void 0===i?void 0:i.id)&&n(i,a,r)}:null,handleFetchData:function(){var e=(0,o.Z)(s().mark((function e(t,n){var r,o;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.startDate,o=t.endDate,e.next=3,A((function(e){return E(E({},e),{},{dateFilter:{startDate:r,endDate:o},mode:n})}));case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),hiddenColumn:["id","costCustomer","costSupplier","serviceName","jobs"],initialMode:"year",onTitleFormatter:function(e){var t=e.row;return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsxs)(j.Z,{size:"sm",children:[t.compliance&&(0,S.jsx)(x.Z,{context:"info",icon:"clipboard-check"}),t.serviceName]}),t.costCustomer&&T("customer")&&(0,S.jsx)(j.Z,{size:"xs",children:(0,g.Z)(t.costCustomer)}),t.costSupplier&&T("supplier")&&(0,S.jsx)(j.Z,{size:"xs",children:(0,g.Z)(t.costSupplier)}),t.costCustomer&&T("admin")&&t.costCustomer&&w&&(0,S.jsxs)(j.Z,{size:"xs",children:["Customer: ",(0,g.Z)(t.costCustomer)]}),t.costSupplier&&T("admin")&&I&&t.costSupplier&&(0,S.jsxs)(j.Z,{size:"xs",children:["Supplier: ",(0,g.Z)(t.costSupplier)]})]})},title:"serviceName"})})};_.defaultProps={clickable:!0,showDetails:!0}},13157:function(e,t,n){"use strict";n.d(t,{b:function(){return i}});var r,o=n(52209),i=(0,n(54397).Ps)(r||(r=(0,o.Z)(["\n  query GetTenantBookings(\n    $limit: Int\n    $locationId: Int\n    $offset: Int\n    $orderBy: TenantBooking_order_by!\n    $q: Int\n    $userId: Int\n  ) {\n    tenantBookings: TenantBooking(\n      limit: $limit\n      offset: $offset\n      where: { id: { _eq: $q }, locationId: { _eq: $locationId }, userId: { _eq: $userId } }\n      order_by: [$orderBy]\n    ) {\n      id\n      bookingStart\n      bookingEnd\n      notes\n      status\n      createdAt\n      location: Location {\n        id\n        name\n        customer: Account_Locations {\n          id\n          account: Account {\n            id\n            name\n            admin: Admins {\n              id: adminId\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n            contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n              id\n              user: User {\n                id\n                fullName\n              }\n            }\n          }\n        }\n      }\n      user: User {\n        id\n        fullName\n        email\n        phone\n      }\n    }\n    meta: TenantBooking_aggregate(\n      where: { id: { _eq: $q }, locationId: { _eq: $locationId }, userId: { _eq: $userId } }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"])))},66678:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return No}});var r,o,i,a=n(66918),s=n(80318),c=n(67294),u=n(93633),l=n(75709),d=n(19952),p=n(71742),m=n(11163),f=n(92743),y=n(78215),b=n(2356),h=n(96692),v=n(3213),j=n(35450),x=n(37415),g=n(87160),O=n(2640),w=n(24237),I=n(80880),Z=n(80284),S=n(93443),P=n(26398),k=n(18862),C=n(14347),D=n(80285),A=n(76931),E=n(92809),_=n(18218),T=n(7802),N=n(42593),q=n(58448),R=n(18944),$=n(91126),J=n(11570),F=n(7720),M=n(81185),L=n(38342),V=n(92700),z=n(90358),H=n(12517),B=n(85893),U=function(e){var t=e.jobs,n=e.jobSchedule,r=(0,c.useContext)(I.Z),o=function(e){return e.map((function(e){var t;return{id:e.id,color:(0,z.t)(e.status),start:e.timingStart,end:e.timingEnd||e.timingStart,title:(null===(t=e.shortJobDesc[0])||void 0===t?void 0:t.taxonomy.name)||e.title,description:e.description,status:e.status}}))}(function(e,t){var n=t.map((function(e){return e.id}));return e.filter((function(e){return n.includes(e.jobScheduleId)}))}(t,n));return(0,B.jsx)(V.A,{eventClick:function(e){r.show({content:(0,B.jsx)(H.g,{jobId:parseInt(e.event.id),toggleShow:r.close}),submit:!1,width:"50%",title:"Job details"})},events:o,hasLoading:!0})},W=n(30266),Y=n(64687),G=n.n(Y),Q=n(52209),K=n(54397),X=(0,K.Ps)(r||(r=(0,Q.Z)(["\n  mutation AddJobSchedule($objects: [JobSchedule_insert_input!]!) {\n    insert_JobSchedule(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),ee=(0,K.Ps)(o||(o=(0,Q.Z)(['\n  mutation UpdateJobSchedule(\n    $adminId: Int!\n    $changes: JobSchedule_set_input\n    $deletedAssetIds: [Int!]\n    $assets: [Asset_Entity_insert_input!]!\n    $currentJobId: Int!\n    $frequencyChanged: Boolean!\n    $hasCreateJobs: Boolean!\n    $id: Int!\n    $job: Job_set_input\n    $jobs: [CreateJobInput]!\n    $today: timestamptz\n    $updateAllJobs: Boolean!\n    $updateCurrentJob: Boolean!\n  ) {\n    update_JobSchedule_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_Asset_Entity(objects: $assets) {\n      returning {\n        assetId\n        entity\n        id\n        entityId\n        status\n      }\n    }\n    delete_Asset_Entity(where: { id: { _in: $deletedAssetIds } }) {\n      returning {\n        assetId\n        entityId\n        entity\n        id\n      }\n    }\n    update_Job(_set: $job, where: { jobScheduleId: { _eq: $id }, timingStart: { _gte: $today } })\n      @include(if: $updateAllJobs) {\n      affected_rows\n    }\n    update_Job_by_pk(pk_columns: { id: $currentJobId }, _set: $job)\n      @include(if: $updateCurrentJob) {\n      id\n    }\n    cancel: update_Job(\n      _set: { status: "canceled" }\n      where: { jobScheduleId: { _eq: $id }, _not: { JobTimings: { status: { _eq: "completed" } } } }\n    ) @include(if: $frequencyChanged) {\n      affected_rows\n    }\n    createJob(adminId: $adminId, objects: $jobs) @include(if: $hasCreateJobs) {\n      data\n    }\n  }\n']))),te=((0,K.Ps)(i||(i=(0,Q.Z)(["\n  mutation UpdateJobSchedule(\n    $id: Int!\n    $changes: JobScheduleContract_set_input\n    $statusLog: [StatusLog_insert_input!]!\n  ) {\n    update_JobScheduleContract_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_StatusLog(objects: $statusLog) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n"]))),n(42283)),ne=n(79665),re=n(47385),oe=n(44658),ie=n(97202),ae=n(65375),se=n(83528),ce=n(84550),ue=n(34868),le=n(70448),de=n(42426),pe=n(36968),me=n.n(pe),fe=n(71247),ye=[{text:"Yearly",value:"Yearly"},{text:"Monthly",value:"Monthly"},{text:"Weekly",value:"Weekly"},{text:"Daily",value:"Daily"},{text:"Hourly",value:"Hourly"}],be=[{id:"on",label:"on",value:"on"}],he=[{id:"onThe",label:"on the",value:"on the"}],ve=[{text:"First",value:"First"},{text:"Second",value:"Second"},{text:"Third",value:"Third"},{text:"Fourth",value:"Fourth"},{text:"Last",value:"Last"}],je=[{text:"Monday",value:"Monday"},{text:"Tuesday",value:"Tuesday"},{text:"Wednesday",value:"Wednesday"},{text:"Thursday",value:"Thursday"},{text:"Friday",value:"Friday"},{text:"Saturday",value:"Saturday"},{text:"Day",value:"Day"},{text:"Weekday",value:"Weekday"},{text:"Weekend day",value:"Weekend day"}],xe=[{id:"on",label:"on day",value:"on"}],ge=[{id:"onThe",label:"on the",value:"on the"}],Oe=[{label:"Mon",value:"mon"},{label:"Tue",value:"tue"},{label:"Wed",value:"wed"},{label:"Thu",value:"thu"},{label:"Fri",value:"fri"},{label:"Sat",value:"sat"},{label:"Sun",value:"sun"}],we=[{text:"After",value:"After"},{text:"On date",value:"On date"}],Ie=n(7151),Ze=n(30381),Se=n.n(Ze),Pe=function(e){var t=e.onDate.date;return Se().isMoment(Se()(t))||(t=(new Date).setMilliseconds(0)),{dtstart:Se()(t).toDate()}},ke="YYYY-MM-DD",Ce=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],De=function(e){return{bymonth:Ce.indexOf(e.month)+1,bymonthday:e.day}},Ae=function(e){var t={};switch(e.which){case"First":t.bysetpos=1;break;case"Second":t.bysetpos=2;break;case"Third":t.bysetpos=3;break;case"Fourth":t.bysetpos=4;break;case"Last":t.bysetpos=-1}switch(e.day){case"Monday":t.byweekday=[0];break;case"Tuesday":t.byweekday=[1];break;case"Wednesday":t.byweekday=[2];break;case"Thursday":t.byweekday=[3];break;case"Friday":t.byweekday=[4];break;case"Saturday":t.byweekday=[5];break;case"Sunday":t.byweekday=[6];break;case"Day":t.byweekday=[0,1,2,3,4,5,6];break;case"Weekday":t.byweekday=[0,1,2,3,4];break;case"Weekend day":t.byweekday=[5,6]}return t.bymonth=Ce.indexOf(e.month)+1,t};function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var _e=function(e){var t=e.mode,n=e.on,r=e.onThe;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({freq:Ie.Ci.YEARLY},"on"===t?De(n):Ae(r))},Te=function(e){return{bymonthday:e.day}},Ne=function(e){var t={};switch(e.which){case"First":t.bysetpos=1;break;case"Second":t.bysetpos=2;break;case"Third":t.bysetpos=3;break;case"Fourth":t.bysetpos=4;break;case"Last":t.bysetpos=-1}switch(e.day){case"Monday":t.byweekday=[0];break;case"Tuesday":t.byweekday=[1];break;case"Wednesday":t.byweekday=[2];break;case"Thursday":t.byweekday=[3];break;case"Friday":t.byweekday=[4];break;case"Saturday":t.byweekday=[5];break;case"Sunday":t.byweekday=[6];break;case"Day":t.byweekday=[0,1,2,3,4,5,6];break;case"Weekday":t.byweekday=[0,1,2,3,4];break;case"Weekend day":t.byweekday=[5,6]}return t};function qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var Re=function(e){var t=e.mode,n=e.interval,r=e.on,o=e.onThe;return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qe(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({freq:Ie.Ci.MONTHLY,interval:n},"on"===t?Te(r):Ne(o))},$e=n(83789),Je=n(52628),Fe=n.n(Je),Me=function(e){var t=e.interval,n=e.days;return{freq:Ie.Ci.WEEKLY,interval:t,byweekday:Fe()(n).reduce((function(e,t,n){return t?[].concat((0,$e.Z)(e),[n]):e}),[])}},Le=function(e){var t=e.interval;return{freq:Ie.Ci.DAILY,interval:t}},Ve=function(e){var t=e.interval;return{freq:Ie.Ci.HOURLY,interval:t}},ze=function(e){var t=e.frequency,n=e.yearly,r=e.monthly,o=e.weekly,i=e.daily,a=e.hourly;switch(t){case"Yearly":return _e(n);case"Monthly":return Re(r);case"Weekly":return Me(o);case"Daily":return Le(i);case"Hourly":return Ve(a);default:return{}}},He=function(e){var t=e.mode,n=e.after,r=e.onDate.date,o={};return"After"===t&&(o.count=n),"On date"===t&&(o.until=Se()(r).toDate()),o},Be=function(e){var t=e.hideStart,n=e.weekStartsOnSunday,r={};return t&&(r.dtstart=null),n&&(r.wkst=Ie.Ci.SU),r};function Ue(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function We(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ue(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ue(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ye=function(e){var t=e.start,n=e.repeat,r=e.end,o=e.options,i=We(We(We(We({},Pe(t)),ze(n)),He(r)),Be(o)),a=new Ie.Ci(i);return{rruleString:a.toString(),rruleText:a.toText()}},Ge=function(e,t){return t.dtstart?t.dtstart:e.start.onDate.date},Qe=function(e,t){switch(t.freq){case 0:return"Yearly";case 1:return"Monthly";case 2:return"Weekly";case 3:return"Daily";case 4:return"Hourly";default:return e.repeat.frequency}},Ke=function(e,t){return 0===t.freq&&t.bymonth?t.bymonthday?"on":"on the":e.repeat.yearly.mode},Xe=function(e,t){return 0===t.freq&&t.bymonthday?"number"===typeof t.bymonth?Ce[t.bymonth-1]:Ce[t.bymonth[0]-1]:e.repeat.yearly.on.month},et=function(e,t){return 0===t.freq&&t.bymonthday?"number"===typeof t.bymonthday?t.bymonthday:t.bymonthday[0]:e.repeat.yearly.on.day},tt=function(e,t){return 0===t.freq&&t.byweekday?"number"===typeof t.bymonth?Ce[t.bymonth-1]:Ce[t.bymonth[0]-1]:e.repeat.yearly.onThe.month},nt=function(e,t){if(0!==t.freq||!t.byweekday)return e.repeat.yearly.onThe.day;switch(t.byweekday.map((function(e){return e.weekday})).join(",")){case"0":return"Monday";case"1":return"Tuesday";case"2":return"Wednesday";case"3":return"Thursday";case"4":return"Friday";case"5":return"Saturday";case"6":return"Sunday";case"0,1,2,3,4,5,6":return"Day";case"0,1,2,3,4":return"Weekday";case"5,6":return"Weekend day";default:return e.repeat.yearly.onThe.day}},rt=function(e,t){if(0!==t.freq||!t.byweekday)return e.repeat.yearly.onThe.which;switch("number"===typeof t.bysetpos?t.bysetpos:t.bysetpos[0]){case 1:return"First";case 2:return"Second";case 3:return"Third";case 4:return"Fourth";case-1:return"Last";default:return e.repeat.yearly.onThe.which}},ot=function(e,t){return 1!==t.freq?e.repeat.monthly.mode:t.bymonthday?"on":"on the"},it=function(e,t){return 1!==t.freq?e.repeat.monthly.interval:t.interval},at=function(e,t){return 1===t.freq&&t.bymonthday?"number"===typeof t.bymonthday?t.bymonthday:t.bymonthday[0]:e.repeat.monthly.on.day},st=function(e,t){if(1!==t.freq||!t.byweekday)return e.repeat.monthly.onThe.day;switch(t.byweekday.map((function(e){return e.weekday})).join(",")){case"0":return"Monday";case"1":return"Tuesday";case"2":return"Wednesday";case"3":return"Thursday";case"4":return"Friday";case"5":return"Saturday";case"6":return"Sunday";case"0,1,2,3,4,5,6":return"Day";case"0,1,2,3,4":return"Weekday";case"5,6":return"Weekend day";default:return e.repeat.monthly.onThe.day}},ct=function(e,t){if(1!==t.freq||!t.bysetpos)return e.repeat.monthly.onThe.which;switch("number"===typeof t.bysetpos?t.bysetpos:t.bysetpos[0]){case 1:return"First";case 2:return"Second";case 3:return"Third";case 4:return"Fourth";case-1:return"Last";default:return e.repeat.monthly.onThe.which}},ut=function(e,t){return 2!==t.freq?e.repeat.weekly.interval:t.interval},lt=function(e,t){var n=[];return 2!==t.freq?e.repeat.weekly.days:(t.byweekday&&(n=t.byweekday.map((function(e){return e.weekday}))),{mon:n.includes(0),tue:n.includes(1),wed:n.includes(2),thu:n.includes(3),fri:n.includes(4),sat:n.includes(5),sun:n.includes(6)})},dt=function(e,t){return t.wkst?6===t.wkst:e.options.weekStartsOnSunday},pt=function(e,t){return 3!==t.freq?e.repeat.daily.interval:t.interval},mt=function(e,t){return 4!==t.freq?e.repeat.daily.interval:t.interval},ft=function(e,t){return t.count||0===t.count?"After":t.until?"On date":"After"},yt=function(e,t){return t.count||0===t.count?t.count:e.end.after},bt=function(e,t){return t.until?t.until:e.end.onDate.date};function ht(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function vt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ht(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ht(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var jt=function(e,t){if(!t)return e;var n;try{var r=(0,Ie.SA)(t).origOptions;n=vt(vt({},e),{},{start:vt(vt({},e.start),{},{onDate:{date:Se()(Ge(e,r)).format(ke),options:vt(vt({},e.start.onDate.options),{},{weekStartsOnSunday:dt(e,r)})}}),repeat:vt(vt({},e.repeat),{},{frequency:Qe(e,r),yearly:vt(vt({},e.repeat.yearly),{},{mode:Ke(e,r),on:{month:Xe(e,r),day:et(e,r)},onThe:{month:tt(e,r),day:nt(e,r),which:rt(e,r)}}),monthly:vt(vt({},e.repeat.monthly),{},{mode:ot(e,r),interval:it(e,r),on:{day:at(e,r)},onThe:{day:st(e,r),which:ct(e,r)}}),weekly:{interval:ut(e,r),days:lt(e,r),options:{weekStartsOnSunday:dt(e,r)}},daily:{interval:pt(e,r)},hourly:{interval:mt(e,r)}}),end:vt(vt({},e.end),{},{mode:ft(e,r),after:yt(e,r),onDate:{date:Se()(bt(e,r)).format(ke),options:vt(vt({},e.end.onDate.options),{},{weekStartsOnSunday:dt(e,r)})}}),options:vt(vt({},e.options),{},{weekStartsOnSunday:dt(e,r)}),error:null})}catch(o){return vt(vt({},e),{},{error:{value:t,message:o}})}return n},xt=n(41609),gt=n.n(xt),Ot=n(73955),wt=n.n(Ot),It=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r=function(){return e.repeat?e.repeat[0]:"Yearly"},o=function(){return e.yearly||"on"},i=function(){return e.monthly||"on"},a=function(){return e.end?e.end[0]:"After"},s=function(){return"undefined"===typeof e.hideStart||e.hideStart},c=gt()(n)?wt()("rrule-"):n,u={start:{onDate:{date:Se()().format(ke),options:{weekStartsOnSunday:e.weekStartsOnSunday,calendarComponent:t}}},repeat:{frequency:r(),yearly:{mode:o(),on:{month:"Jan",day:1},onThe:{month:"Jan",day:"Monday",which:"First"},options:{modes:e.yearly}},monthly:{mode:i(),interval:1,on:{day:1},onThe:{day:"Monday",which:"First"},options:{modes:e.monthly}},weekly:{interval:1,days:{mon:!1,tue:!1,wed:!1,thu:!1,fri:!1,sat:!1,sun:!1},options:{weekStartsOnSunday:e.weekStartsOnSunday}},daily:{interval:1},hourly:{interval:1},options:{frequency:e.repeat}},end:{mode:a(),after:1,onDate:{date:Se()().format(ke),options:{weekStartsOnSunday:e.weekStartsOnSunday,calendarComponent:t}},options:{modes:e.end}},options:{hideStart:s(),hideEnd:e.hideEnd,hideError:e.hideError,weekStartsOnSunday:e.weekStartsOnSunday},error:null};return{id:c,data:u,rrule:Ye(u)}},Zt=function(e,t){var n=[];for(var r in e)!0===e[r]&&n.push(r);return t.filter((function(e){return n.includes(e.value)}))},St=n(76800),Pt=n(313),kt=n(96843),Ct=n(46482),Dt=n(7654),At=n.n(Dt),Et=function(e){return function(t){var n=+t.target.value;if(!(At()(n)||n>=1e3)){var r={target:{value:n,name:t.target.name}};e(r)}}};function _t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Tt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_t(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Nt=function(e){var t=e.data,n=e.defaultOptions,r=e.handleChange,o=e.mainDefaultOptions,i=e.setValue,a=e.setValueParent,s=e.watch,u=s("end.onDate.date"),l=s("start.onDate.date");(0,c.useEffect)((function(){((0,kt.Z)(u,l)||(0,Pt.Z)(u,l))&&"On date"===t.end.mode?a("formErrors",""):a("formErrors","No Error")}),[u,l,t.end.mode]);return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(ae.Z,{label:"End on",children:[(0,B.jsx)(Ct.Z,Tt(Tt({},n),{},{name:"end.mode",options:we,onChange:r})),(0,B.jsx)(fe.Z,Tt(Tt({},o),{},{name:"formErrors",type:"hidden"}))]}),function(){switch(t.end.mode){case"After":return(0,B.jsx)(ae.Z,{label:"Occurrences",children:(0,B.jsx)(fe.Z,Tt(Tt({},n),{},{name:"end.after",onChange:Et(r)}))});case"On date":var e=(0,kt.Z)(u,l)||(0,Pt.Z)(u,l);return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(St.M,Tt(Tt({},n),{},{locale:de.Z,name:"end.onDate.date",placeholder:"End On",shouldCloseOnSelect:!0,onChange:function(e){i("end.onDate.date",new Date(e)),a("end.onDate.date",new Date(e))}})),e&&(0,B.jsx)(R.Z,{context:"danger",content:"End On should be less than start date",size:"sm"})]})}}()]})};function qt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Rt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qt(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var $t=function(e){var t=e.defaultOptions,n=e.handleChange;return(0,B.jsx)(B.Fragment,{children:(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:2,children:"every"}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(fe.Z,Rt(Rt({},t),{},{name:"repeat.daily.interval",onChange:Et(n)}))}),(0,B.jsx)(b.Z,{md:3,children:"day(s)"})]})})};function Jt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ft(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Jt(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Jt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Mt=function(e){var t=e.defaultOptions,n=e.handleChange;return(0,B.jsx)(B.Fragment,{children:(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:2,children:"every"}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(fe.Z,Ft(Ft({},t),{},{name:"repeat.hourly.interval",onChange:Et(n)}))}),(0,B.jsx)(b.Z,{md:3,children:"hour(s)"})]})})},Lt=n(69128),Vt=[{text:"1",value:"1"},{text:"2",value:"2"},{text:"3",value:"3"},{text:"4",value:"4"},{text:"5",value:"5"},{text:"6",value:"6"},{text:"7",value:"7"},{text:"8",value:"8"},{text:"9",value:"9"},{text:"10",value:"10"},{text:"11",value:"11"},{text:"12",value:"12"},{text:"13",value:"13"},{text:"14",value:"14"},{text:"15",value:"15"},{text:"16",value:"16"},{text:"17",value:"17"},{text:"18",value:"18"},{text:"19",value:"19"},{text:"20",value:"20"},{text:"21",value:"21"},{text:"22",value:"22"},{text:"23",value:"23"},{text:"24",value:"24"},{text:"25",value:"25"},{text:"26",value:"26"},{text:"27",value:"27"},{text:"28",value:"28"},{text:"29",value:"29"},{text:"30",value:"30"},{text:"31",value:"31"}];function zt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ht(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?zt(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Bt=function(e){var t=e.defaultOptions,n=e.handleChange;e.weeklyDays;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:"every"}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(fe.Z,Ht(Ht({},t),{},{name:"repeat.monthly.interval",onChange:Et(n)}))}),(0,B.jsx)(b.Z,{md:3,children:"month(s)"})]}),(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Lt.Z,Ht(Ht({},t),{},{data:xe,name:"repeat.monthly.mode",onChange:n,stacked:!1}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Ht(Ht({},t),{},{name:"repeat.monthly.on.day",onChange:Et(n),options:Vt}))})]}),(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Lt.Z,Ht(Ht({},t),{},{data:ge,name:"repeat.monthly.mode",onChange:n,stacked:!1}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Ht(Ht({},t),{},{name:"repeat.monthly.onThe.which",onChange:n,options:ve}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Ht(Ht({},t),{},{name:"repeat.monthly.onThe.day",onChange:n,options:je}))})]})]})},Ut=n(93515);function Wt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Wt(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Wt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Gt=function(e){var t=e.currentWeeklyDays,n=e.defaultOptions,r=e.handleChange,o=e.setValue;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:"every"}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(fe.Z,Yt(Yt({},n),{},{name:"repeat.weekly.interval",onChange:Et(r)}))}),(0,B.jsx)(b.Z,{md:3,children:"week(s)"})]}),(0,B.jsx)(Ut.Z,Yt(Yt({},n),{},{isMulti:!0,name:"repeat.weekly.days",onChange:function(e){Object.keys(t).forEach((function(e){return t[e]=!1})),e.forEach((function(e){t[e.value]=!0}));var n={target:{value:t,name:"repeat.weekly.days"}};o("repeat.weekly.days",Zt(t,Oe)),r(n)},options:Oe}))]})},Qt=[{text:"Month",value:""},{text:"Jan",value:"Jan"},{text:"Feb",value:"Feb"},{text:"Mar",value:"Mar"},{text:"Apr",value:"Apr"},{text:"May",value:"May"},{text:"Jun",value:"Jun"},{text:"Jul",value:"Jul"},{text:"Aug",value:"Aug"},{text:"Sep",value:"Sep"},{text:"Oct",value:"Oct"},{text:"Nov",value:"Nov"},{text:"Dec",value:"Dec"}];function Kt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Kt(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Kt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var en=function(e){var t=e.defaultOptions,n=e.handleChange;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Lt.Z,Xt(Xt({},t),{},{onChange:n,name:"repeat.yearly.mode",data:be,stacked:!1}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Xt(Xt({},t),{},{name:"repeat.yearly.on.month",onChange:n,options:Qt}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Xt(Xt({},t),{},{name:"repeat.yearly.on.day",onChange:Et(n),options:Vt}))})]}),(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Lt.Z,Xt(Xt({},t),{},{onChange:n,name:"repeat.yearly.mode",data:he,stacked:!1}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Xt(Xt({},t),{},{name:"repeat.yearly.onThe.which",onChange:n,options:ve}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Xt(Xt({},t),{},{name:"repeat.yearly.onThe.day",onChange:n,options:je}))}),(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(Ct.Z,Xt(Xt({},t),{},{name:"repeat.yearly.onThe.month",onChange:n,options:Qt}))})]})]})};function tn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function nn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tn(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var rn=function(e){var t=e.data,n=e.defaultOptions,r=e.handleChange,o=e.setValue;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(ae.Z,{label:"Repeat",children:(0,B.jsx)(Ct.Z,nn(nn({},n),{},{name:"repeat.frequency",options:ye,onChange:r}))}),function(){switch(t.repeat.frequency){case"Yearly":return(0,B.jsx)(en,{defaultOptions:n,handleChange:r});case"Monthly":return(0,B.jsx)(Bt,{defaultOptions:n,handleChange:r});case"Weekly":return(0,B.jsx)(Gt,{currentWeeklyDays:t.repeat.weekly.days,defaultOptions:n,handleChange:r,setValue:o});case"Daily":return(0,B.jsx)($t,{defaultOptions:n,handleChange:r});case"Hourly":return(0,B.jsx)(Mt,{defaultOptions:n,handleChange:r})}}()]})};function on(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function an(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?on(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):on(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var sn=function(e){var t=e.defaultOptions,n=e.setValueParent,r=(0,e.watchParent)("frequency"),o=It({hideStart:!1},null,null),i=(0,c.useState)(r?jt(o.data,r):o.data),a=i[0],s=i[1],u=(0,te.cI)({defaultValues:{"start.onDate.date":new Date(a.start.onDate.date),"repeat.frequency":a.repeat.frequency,"repeat.yearly.mode":a.repeat.yearly.mode,"repeat.yearly.on.month":a.repeat.yearly.on.month,"repeat.yearly.on.day":a.repeat.yearly.on.day,"repeat.yearly.onThe.which":a.repeat.yearly.onThe.which,"repeat.yearly.onThe.day":a.repeat.yearly.onThe.day,"repeat.yearly.onThe.month":a.repeat.yearly.onThe.month,"repeat.monthly.interval":a.repeat.monthly.interval,"repeat.monthly.mode":a.repeat.monthly.mode,"repeat.monthly.on.day":a.repeat.monthly.on.day,"repeat.monthly.onThe.which":a.repeat.monthly.onThe.which,"repeat.monthly.onThe.day":a.repeat.monthly.onThe.day,"repeat.weekly.interval":a.repeat.weekly.interval,"repeat.weekly.days":Zt(a.repeat.weekly.days,Oe),"repeat.daily.interval":a.repeat.daily.interval,"repeat.hourly.interval":a.repeat.hourly.interval,"end.mode":a.end.mode,"end.after":a.end.after,"end.onDate.date":new Date(a.end.onDate.date)},resolver:(0,ne.S)()}),l=u.control,d=u.errors,p=u.register,m=u.setValue,f=u.watch,y={control:l,errors:d,register:p,setValue:m,watch:f},b=f("start.onDate.date",new Date(a.start.onDate.date)),h=f("end.onDate.date",new Date(a.end.onDate.date)),v=(0,re.Z)(b),j=(0,re.Z)(h);(0,c.useEffect)((function(){if(b&&b!==v){var e={target:{value:new Date(b),name:"start.onDate.date"}};x(e)}else if(h&&h!==j){var t={target:{value:new Date(h),name:"end.onDate.date"}};x(t)}}),[b,h]);var x=function(e){var t=e.target,r=an({},a);me()(r,t.name,t.value),s(an({},r));var o=Ye(r),i=o.rruleString,c=o.rruleText;n("frequency",i),n("frequencyDescription",c)};return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(fe.Z,an(an({},t),{},{name:"frequency",type:"hidden"})),(0,B.jsxs)(ie.Z,{id:"Form",children:[(0,B.jsx)(ae.Z,{label:"Start on",children:(0,B.jsx)(St.M,an(an({},y),{},{locale:de.Z,name:"start.onDate.date",placeholder:"Start On",shouldCloseOnSelect:!0,onChange:function(e){m("start.onDate.date",new Date(e)),n("start.onDate.date",new Date(e))}}))}),(0,B.jsx)(rn,{data:a,defaultOptions:y,handleChange:x,setValue:m}),(0,B.jsx)(Nt,{data:a,defaultOptions:y,handleChange:x,mainDefaultOptions:t,setValue:m,setValueParent:n,watch:f})]})]})},cn=n(95146),un=n(45697),ln=n(66805),dn=n(19501),pn=(0,dn.Ry)().shape({shortDescription:(0,dn.Ry)().required(),description:(0,dn.Z_)().required(),costCategory:(0,dn.Ry)().required(),service:(0,dn.Ry)().required(),supplier:(0,dn.Ry)().required(),assetCategory:(0,dn.Ry)(),assetSelected:(0,dn.IX)(),frequency:(0,dn.Z_)().required(),costCustomer:(0,dn.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable(),costSupplier:(0,dn.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable(),formErrors:(0,dn.Z_)().required()}),mn=(0,dn.Ry)().shape({frequencyConfirm:(0,dn.Z_)().oneOf(["yes"]),supplierConfirm:(0,dn.Z_)()}),fn=function(){var e=(0,W.Z)(G().mark((function e(t){var n,r,o,i,a,s,c,u,l,d,p,m;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.adminId,o=t.defaultValues,i=t.form,a=t.location,s=Ie.Ci.fromString(i.frequency),c=s.all().sort((function(e,t){return e-t})).slice(o.completeCount),u=i.meta.costCustomer,l=i.meta.costSupplier,d=(null===a||void 0===a||null===(n=a.user)||void 0===n?void 0:n.id)||null,p=i.meta.supplierId,m=[],c.forEach((function(e){var t,n={adminId:r,amount:u,assetId:i.meta.assetId,costCategoryId:i.meta.costCategoryId,customerId:a.customer[0].account.id,customerUserId:d,description:i.meta.description,jobScheduleId:o.id,locationId:a.id,managerId:a.customer[0].account.managerId,pricing:"fixed",serviceId:i.meta.serviceId,source:"other",status:"offered",paymentMethod:"invoice",supplierLabourAmount:l,timing:"at",timingStart:e,title:i.meta.shortDescriptionName,type:"ppm",JobTimings:{data:[{status:"raised"},{status:"offered"}]},SupplierOffers:{data:[{status:"offered",accountId:p}]},Taxonomy:{data:[{entity:"Job",taxonomyId:null===(t=i.meta)||void 0===t?void 0:t.shortDescriptionId}]}};i.meta.complianceSelectId&&(n.Compliances={data:{complianceId:i.meta.complianceSelectId,entity:"Job",status:"active"}}),m.push(n)})),e.abrupt("return",m);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),yn=n(1323);function bn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function hn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?bn(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var vn=function(e){var t,n=e.defaultValues,r=e.data,o=e.deletedAssetIds,i=e.addedAssets,a=e.onConfirm,s=e.toggleShow,c=e.location,u=(0,yn.x)(),l=u.hasRole,d=u.user;t=l("admin")?d.accountId:d.adminId;var p=r.frequency!==n.frequency,m=r.meta.supplierId!==n.supplier.value,f=(0,te.cI)({resolver:(0,ne.S)(mn)}),y=f.control,b=f.errors,h=f.handleSubmit,v=f.register,j=function(){var e=(0,W.Z)(G().mark((function e(u){var l,d;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l=[],d=[],!p){e.next=6;break}return e.next=5,fn({adminId:t,defaultValues:n,form:r,location:c});case 5:l=e.sent;case 6:m&&(d={supplierId:r.meta.supplierId}),a({data:r,frequencyChanged:p,job:d,jobs:l,deletedAssetIds:o,addedAssets:i,updateAllJobs:"futureJobs"===u.supplierConfirm,updateCurrentJob:"nextJob"===u.supplierConfirm}),s();case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),x={control:y,errors:b,register:v};return(0,B.jsxs)(ie.Z,{handleSubmit:h(j),children:[p&&(0,B.jsx)(ce.Z,hn(hn({},x),{},{data:[{label:"Do you confirm to change frequency?",key:"frequencyConfirm",value:"yes"}],name:"frequencyConfirm"})),m&&(0,B.jsx)(Lt.Z,hn(hn({},x),{},{legend:"Do you want to change supplier for next job only or all future jobs?",name:"supplierConfirm",data:[{id:"nextJob",label:"Next job only",value:"nextJob"},{id:"futureJobs",label:"All future jobs",value:"futureJobs"}]})),(0,B.jsx)(ln.H,{content:"Update",type:"submit"})]})};vn.propType={form:un.object,onConfirm:un.func,toggleShow:un.func};var jn=n(72197),xn=function(e){var t,n=e.currentJob,r=e.defaultValues,o=e.data;return!(null===r||void 0===r||!r.id||null===n||void 0===n||!n.id)&&(o.meta.supplierId!==(null===r||void 0===r||null===(t=r.supplier)||void 0===t?void 0:t.value)||o.frequency!==(null===r||void 0===r?void 0:r.frequency))},gn=["assetCategory","costCategory","complianceSelect","service","shortDescription","supplier"],On=function(e){var t=e.form,n=e.location;return t.locationId=n.id,gn.forEach((function(e){t[e]&&t[e].value&&(t[e+"Id"]=t[e].value,t[e+"Name"]=t[e].label),delete t[e]})),t.meta={assetCategoryId:t.assetCategoryId,assetCategoryName:t.assetCategoryName,costCategoryId:t.costCategoryId,costCategoryName:t.costCategoryName,complianceSelectId:t.complianceSelectId,complianceSelectName:t.complianceSelectName,costCustomer:t.costCustomer,costSupplier:t.costSupplier,description:t.description,serviceId:t.serviceId,serviceName:t.serviceName,shortDescriptionId:t.shortDescriptionId,shortDescriptionName:t.shortDescriptionName,supplierId:t.supplierId,supplierName:t.supplierName},delete t.assetCategoryId,delete t.assetCategoryName,delete t.compliance,delete t.complianceSelectId,delete t.complianceSelectName,delete t.costCategoryId,delete t.costCategoryName,delete t.serviceId,delete t.serviceName,delete t.description,delete t.shortDescriptionId,delete t.shortDescriptionName,delete t.supplierId,delete t.supplierName,delete t.costCustomer,delete t.costSupplier,t},wn=n(45935);function In(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Zn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?In(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):In(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Sn,Pn,kn,Cn,Dn,An=function(e){var t,n,r,o=e.currentJob,i=e.defaultValues,a=e.location,u=e.onSuccess,d=e.user,p=(0,c.useContext)(I.Z),m=(0,te.cI)({defaultValues:Zn({},i),resolver:(0,ne.S)(pn)}),f=m.control,h=m.errors,v=m.handleSubmit,j=m.register,x=m.setValue,g=m.watch,O=g("shortDescription"),w=g("compliance",null===i||void 0===i?void 0:i.compliance),Z=g("service"),S=g("assetCategory",null===i||void 0===i?void 0:i.assetCategory),P=(0,re.Z)(O),k=(0,re.Z)(S),C=(0,re.Z)(Z);(0,c.useEffect)((function(){var e,t,n,r,o,a;O===P||!O||!P&&i||[{name:"description",value:null===(e=O.meta)||void 0===e||null===(t=e.template)||void 0===t?void 0:t.description},{name:"costCategory",value:null===(n=O.meta)||void 0===n||null===(r=n.template)||void 0===r?void 0:r.costCategorySelected},{name:"service",value:null===(o=O.meta)||void 0===o||null===(a=o.template)||void 0===a?void 0:a.serviceSelected}].map((function(e){var t=e.name,n=e.value;return x(t,n)}));S!==k&&k&&x("assetSelected",[]),Z!==C&&C&&x("supplier",null)}),[S,Z,O]);var D=(0,l.D)(X,{onCompleted:function(e){}}),A=(0,s.Z)(D,1)[0],E=(0,l.D)(ee,{onCompleted:function(e){}}),_=(0,s.Z)(E,1)[0],T=(0,le.WE)(a,"registered"),N=(0,oe.Z)({postCode:null===T||void 0===T||null===(t=T.address)||void 0===t?void 0:t.postCode,country:null===T||void 0===T||null===(n=T.address)||void 0===n||null===(r=n.country)||void 0===r?void 0:r.code}),q=null!==N&&void 0!==N&&N.area?N.area.toUpperCase():null,R=function(e){var t=e.data,n=e.deletedAssetIds,r=e.addedAssets,o=e.update;p.show({content:(0,B.jsx)(vn,{defaultValues:i,data:t,deletedAssetIds:n,addedAssets:r,onConfirm:o,toggleShow:p.close,location:a}),title:"Confirm",submit:!1})},$=function(){var e=(0,W.Z)(G().mark((function e(t){var n,r,s,c;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(delete t.formErrors,n={},n=On({form:t,location:a}),null!==i&&void 0!==i&&i.id){e.next=10;break}return n=(0,wn.OU)(t),e.next=7,A({variables:{objects:[n]}});case 7:u&&u(),e.next=17;break;case 10:if(r=(0,wn.v8)({data:n,defaultAssets:i.assetSelected,entity:"JobSchedule",entityId:i.id}),s=r.deletedAssetIds,c=r.addedAssets,!xn({currentJob:o,defaultValues:i,data:n})){e.next=15;break}R({data:n,deletedAssetIds:s,addedAssets:c,update:J}),e.next=17;break;case 15:return e.next=17,J({data:n,frequencyChanged:!1,job:{},jobs:[],deletedAssetIds:s,addedAssets:c,updateAllJobs:!1,updateCurrentJob:!1});case 17:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),J=function(){var e=(0,W.Z)(G().mark((function e(t){var n,r,a,s,c,l,p,m,f;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.data,r=t.frequencyChanged,a=t.job,s=t.jobs,c=t.deletedAssetIds,l=t.addedAssets,p=t.updateAllJobs,m=t.updateCurrentJob,f=r&&s.length>0,e.next=4,_({variables:{adminId:d.adminId,currentJobId:(null===o||void 0===o?void 0:o.id)||null,changes:n,deletedAssetIds:c,assets:l,frequencyChanged:r,hasCreateJobs:f,id:i.id,job:a,jobs:s,today:new Date,updateAllJobs:p,updateCurrentJob:m}});case 4:u&&u();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),F={control:f,isClearable:!1,errors:h,register:j};return(0,B.jsxs)(ie.Z,{id:"offCanvasForm",handleSubmit:v($),children:[(0,B.jsx)(jn.l,Zn(Zn({},F),{},{label:"Short job description",name:"shortDescription",type:"jobTags"})),(0,B.jsx)(ae.Z,{label:"Work description",children:(0,B.jsx)(se.Z,Zn(Zn({},F),{},{name:"description",rows:3}))}),(0,B.jsx)(jn.l,Zn(Zn({},F),{},{label:"Cost category",name:"costCategory",type:"costCategory"})),(0,B.jsx)(cn.P,Zn(Zn({},F),{},{label:"Service",name:"service",type:"service"})),Z&&(0,B.jsx)(cn.P,Zn(Zn({},F),{},{label:"Supplier",name:"supplier",type:"supplier",area:q,serviceId:(null===Z||void 0===Z?void 0:Z.value)||null})),(0,B.jsx)(cn.P,Zn(Zn({},F),{},{label:"Asset category",locationId:a.id,name:"assetCategory",type:"assetCategory"})),S&&(0,B.jsx)(cn.P,Zn(Zn({},F),{},{label:"Assets",locationId:a.id,name:"assetSelected",type:"asset",isMulti:!0,assetCategoryId:(null===S||void 0===S?void 0:S.value)||null})),(0,B.jsx)(ce.Z,Zn(Zn({},F),{},{data:[{id:"compliance",label:"Compliance",value:!!w}],name:"compliance"})),w&&(0,B.jsx)(cn.P,Zn(Zn({},F),{},{label:"",locationId:a.id,name:"complianceSelect",type:"compliance"})),(0,B.jsx)(sn,{defaultOptions:F,name:"frequencyForm",setValueParent:x,watchParent:g}),(0,B.jsx)(ae.Z,{label:"Frequency description",children:(0,B.jsx)(se.Z,Zn(Zn({},F),{},{name:"frequencyDescription",rows:3}))}),(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ue.Z,Zn(Zn({},F),{},{label:"Customer cost per visit",name:"costCustomer",vat:"Ex VAT"}))}),(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ue.Z,Zn(Zn({},F),{},{label:"Supplier cost per visit",name:"costSupplier",vat:"Ex VAT"}))})]})]})},En=n(9273),_n=n(50899),Tn=n(26075);var Nn=(0,K.Ps)(Sn||(Sn=(0,Q.Z)(['\n  query GetScheduledJobInvoices(\n    $entity: String\n    $entityId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: AccountEntry_order_by!\n  ) {\n    ScheduledJobInvoice: AccountEntry(\n      limit: $limit\n      offset: $offset\n      where: { Invoice: { entity: { _eq: $entity }, entityId: { _eq: $entityId } } }\n      order_by: [$orderBy]\n    ) {\n      account: Account {\n        type\n      }\n      createdAt\n      credit\n      debit\n      entity\n      id\n      jobId\n      meta\n      status\n      updatedAt\n      job: Job {\n        type\n        number\n        meta\n      }\n    }\n    meta: AccountEntry_aggregate(\n      where: {\n        _or: [\n          { Job: { locationId: { _eq: $entityId }, type: { _eq: "ppm" } } }\n          { _and: [{ entityId: { _eq: $entityId } }, { entity: { _eq: $entity } }] }\n        ]\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),qn=(0,K.Ps)(Pn||(Pn=(0,Q.Z)(['\n  query GetJobsForinvoice($endDate: timestamptz, $locationId: Int, $startDate: timestamptz) {\n    jobs: Job(\n      where: {\n        status: { _in: ["reportSent", "invoiceSent"] }\n        locationId: { _eq: $locationId }\n        jobScheduleId: { _is_null: false }\n        _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }]\n      }\n    ) {\n      id\n      number\n      adminId\n      title\n      description\n      quoted\n      reference\n      access\n      costCategory\n      pricing\n      timing\n      timingStart\n      timingEnd\n      createdAt\n      status\n      jobScheduleId\n      supplierNotes\n      timingNormalHours\n      paymentMethod\n      customerSpendThreshold\n      time\n      amount\n      supplierLabourAmount\n      supplierMaterialsAmount\n      type\n      meta\n      source\n      discount\n      customerDeposit\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        unit\n        vat\n      }\n      timings: JobTimings {\n        id\n        status\n        createdAt\n      }\n      supplier: Supplier {\n        id\n        name\n        vatId\n      }\n      customer: Customer {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        financial: Financial {\n          id\n          amountOutstanding\n          approvalThreshold\n          arrangementFee\n          createdAt\n          creditLimit\n          creditRating\n          defaultPaymentMethod\n          invoicing\n          serviceRate\n          spendThreshold\n          stripeId\n          totalRevenue\n          unpaidInvoices\n        }\n        slas: SLAs(where: { entity: { _eq: "Account" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          meta\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n        }\n      }\n      location: Location {\n        id\n        access\n        createdAt\n        name\n        contactUserId\n        expenses: Expenses(where: { entity: { _eq: "Location" } }) {\n          id\n          amount\n          description\n          markup\n          total\n          unit\n          vat\n          paid\n          occurredAt\n          recurring\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          meta\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n        }\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      supplier: Supplier {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          meta\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n        }\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n        }\n      }\n      accountEntries: AccountEntries {\n        id\n        type\n      }\n    }\n  }\n']))),Rn=(0,K.Ps)(kn||(kn=(0,Q.Z)(["\n  mutation AddPPMInvoice(\n    $accountId: Int!\n    $timings: [JobTiming_insert_input!]!\n    $account: Account_set_input\n    $invoice: [Invoice_insert_input!]!\n  ) {\n    insert_Invoice(objects: $invoice) {\n      returning {\n        id\n      }\n    }\n    insert_JobTiming(objects: $timings) {\n      returning {\n        id\n      }\n    }\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $account) {\n      id\n    }\n  }\n"]))),$n=(0,K.Ps)(Cn||(Cn=(0,Q.Z)(["\n  mutation AddPPMInvoice($invoice: [Invoice_insert_input!]!) {\n    insert_Invoice(objects: $invoice) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),Jn=(0,K.Ps)(Dn||(Dn=(0,Q.Z)(["\n  mutation updateJob($id: Int!, $meta: jsonb!, $status: String) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: { status: $status, meta: $meta }) {\n      id\n    }\n  }\n"]))),Fn=n(4135),Mn=n(43703),Ln=n(73165),Vn=n(22796),zn=n(52002),Hn=n(88261),Bn=n(73303),Un=n.n(Bn),Wn=n(380),Yn=n(26496),Gn=n(56572),Qn=n(29575);function Kn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Kn(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Kn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var er=function(){var e=(0,W.Z)(G().mark((function e(t,n){var r,o,i,a,s,c,u,l,d,p;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.customerId,o=n.date,i=n.jobs,a=n.jobScheduled,s=n.location,n.type,c=n.user,u=n.mainJobRefetch,e.next=3,(0,Gn.f)({client:t,adminId:c.adminId});case 3:l=e.sent,d=l.invoiceNumber,p=l.accountMeta,new Promise((function(e,n){rr(t,{customerId:r,date:o,entity:"Location",entityId:s.id,location:s,jobs:i,jobScheduled:a,user:c,mainJobRefetch:u,invoiceNumber:d,accountMeta:p,callback:e})})).then((function(e){return i.map((function(t){var n,r=null===e||void 0===e?void 0:e.find((function(e){return e.id===t.id}));return Xn(Xn({},t),{},{status:"invoiceSent",meta:null!==(n=null===r||void 0===r?void 0:r.meta)&&void 0!==n?n:t.meta})}))})).then((function(e){tr(t,{jobs:e,jobScheduled:a,locationId:s.id,user:c,entity:"Location",entityId:s.id,location:s,invoiceNumber:d})}));case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),tr=function(){var e=(0,W.Z)(G().mark((function e(t,n){var r,o,i,a,s,c,u,l;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.jobs,o=n.jobScheduled,n.locationId,i=n.entity,a=n.entityId,n.location,s=n.user,c=n.invoiceNumber,u=0,l=r.filter((function(e){var t;return!e.accountEntries.length||!(null!==(t=e.accountEntries)&&void 0!==t&&t.find((function(e){return"invoice"===e.type})))})),e.next=5,l.map(function(){var e=(0,W.Z)(G().mark((function e(n,r){var l,d,p,m,f,y,b,h,v,j,x,g,O,w,I,Z;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=n.supplier.id,p=(0,Yn.l)(n.supplierLabourAmount,2),m=(0,Yn.l)(n.supplierMaterialsAmount,2),u=p+m,e.next=6,(0,Qn.F)(t,n.id,"supplier");case 6:return f=e.sent,y=f.financeSupplier,b=0,h=(0,Hn.E)(n.expenses,0,"supplier"),v=h.totalExpenses,u+=b+=v,0,x=o.find((function(e){return e.id===n.jobScheduleId})),g=Ie.Ci.fromString(x.frequency),O=g.all(),j=(0,Hn.E)(x.jobScheduledExpenses,0,"supplier"),u+=(0,Yn.l)((null===(l=j)||void 0===l?void 0:l.totalExpenses)/O.length,2),(w=Xn({},n.meta)||{}).supplierInvoice=y,e.next=22,t.mutate({mutation:Jn,variables:{meta:w,id:n.id,status:n.status}});case 22:return I={entity:i,adminId:s.adminId,entityId:a,invoiceType:"supplierPPM",invoiceNumber:"".concat(c," -").concat(r+1),amounts:{vatTotal:u},configs:{referenceInvoice:"PPM invoice supplier",jobInfo:{jobId:n.id,supplierId:n.supplier.id}},meta:{invoiceNumber:"".concat(c," -").concat(r+1),jobIds:"".concat(n.id)}},Z={entity:i,entityId:a,invoiceType:"supplierPPM",rebateAmount:null,vatTotal:u,adminId:s.adminId,expensesTotal:null,currencyId:(0,Wn.K)(d),invoiceNumber:"".concat(c," -").concat(r+1),meta:{job:{accountId:n.supplier.id,id:n.id},invoiceNumber:"".concat(c," -").concat(r+1)}},e.next=26,t.mutate({mutation:$n,variables:{invoice:[Xn(Xn({},I),{},{InvoiceAmount:{data:[Xn({},Z)]}})]}});case 26:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),nr=function(){var e=(0,W.Z)(G().mark((function e(t){var n,r,o,i,a,s,c,u,l,d,p;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.client,r=t.filteredJobs,t.invoiceAmount,o=t.jobs,i=t.jobScheduled,a=t.monthlyAmount,s=t.monthlyAmounthVat,c=t.monthlyAmountWithoutVat,u=t.timings,l=t.user,d=t.callback,p=[],e.next=4,o.forEach(function(){var e=(0,W.Z)(G().mark((function e(t){var o;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(o=t.timings)||void 0===o?void 0:o.find((function(e){return"ppmInvoiceCreated"===e.status}))){e.next=5;break}r.push(t),e.next=6;break;case 5:return e.abrupt("return");case 6:return(0,Yn.l)(Un()(r,"amount"),2),e.next=9,r.forEach(function(){var e=(0,W.Z)(G().mark((function e(t,o){var m,f,y,b,h,v,j,x,g,O,w,I;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,Qn.F)(n,t.id,"customer");case 2:f=e.sent,y=f.financeCustomer,b=(0,Hn.E)(t.expenses,0,"customer"),h=b.totalExpenses,h,0,j=i.find((function(e){return e.id===t.jobScheduleId})),v=(0,Hn.E)(j.jobScheduledExpenses,0,"customer"),x=Ie.Ci.fromString(j.frequency),g=x.all(),(0,Yn.l)((null===(m=v)||void 0===m?void 0:m.totalExpenses)/g.length,2),O=t.location.expenses.filter((function(e){return e.occurredAt.toString().substring(0,7)===t.timingStart.toString().substring(0,7)||"recurring"===e.recurring})),w=(0,Hn.E)(O,0,"customer"),w.totalExpenses,a&&a>0&&s+c,u.push({status:"ppmInvoiceCreated",jobId:t.id,userId:l.id}),(I=Xn({},t.meta)||{}).customerVATInvoice=y,p.push({id:t.id,meta:I}),r.length===o+1&&d(p);case 21:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),rr=function(){var e=(0,W.Z)(G().mark((function e(t,n){var r,o,i,a,s,c,u,l,d,p,m,f,y,b,h,v,j;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.customerId,i=n.entity,a=n.entityId,s=n.location,c=n.jobs,u=n.jobScheduled,l=n.user,d=n.mainJobRefetch,p=n.callback,m=n.invoiceNumber,f=n.accountMeta,.2,0,y=[],b=[],h=null===(r=s.meta)||void 0===r?void 0:r.monthlyAmount,v=0,j=0,h&&h>0&&(v=.2*Number(h),j=Number(h)),e.next=11,new Promise((function(e,n){nr({client:t,filteredJobs:y,invoiceAmount:0,jobs:c,jobScheduled:u,monthlyAmount:h,monthlyAmounthVat:v,monthlyAmountWithoutVat:j,timings:b,user:l,callback:e})})).then((function(e){var n=y.map((function(e){return e.id})).join(","),r={entity:i,adminId:l.adminId,entityId:a,invoiceType:"invoicePPMCustomer",invoiceNumber:"".concat(m),amounts:{vatTotal:0},configs:{referenceInvoice:"PPM invoice",jobInfo:{customerId:o,jobIds:n,invoiceNumber:"".concat(m),monthlyAmount:j||0,monthlyAmounthVat:v||0}},meta:{invoiceNumber:"".concat(m),jobIds:n,monthlyAmount:j||0,monthlyAmounthVat:v||0}},s={entity:i,entityId:a,invoiceType:"customerPPM",rebateAmount:null,vatTotal:0,adminId:l.adminId,expensesTotal:null,currencyId:(0,Wn.K)(o),invoiceNumber:"".concat(m),meta:{job:{customerId:o,accountId:o,id:n},invoiceNumber:"".concat(m),jobIds:n,monthlyAmount:j||0,monthlyAmounthVat:v||0}};return e.forEach(function(){var e=(0,W.Z)(G().mark((function e(n){return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.mutate({mutation:Jn,variables:{meta:n.meta,id:n.id}});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.length>0&&t.mutate({mutation:Rn,variables:{account:f,accountId:l.adminId,invoice:[Xn(Xn({},r),{},{InvoiceAmount:{data:[Xn({},s)]}})],timings:b}}),d(),p(e)}));case 11:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),or=n(65570);function ir(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ar(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ir(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ir(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var sr=function(e){var t=e.customerId,n=e.jobScheduled,r=e.locationId,o=e.location,i=e.user,a=e.toggleShow,s=e.numberPrefix,l=e.numberSuffix,d=e.mainJobRefetch,p=(0,te.cI)({defaultValues:{month:new Date}}),m=p.control,f=p.errors,h=p.handleSubmit,v=p.register,j=(0,c.useContext)(I.Z),x=(0,Tn.x)(),g=(0,c.useState)(new Date),O=g[0],w=g[1],Z=(0,u.a)(qn,{variables:{endDate:(0,Fn.Z)(O),locationId:r,startDate:(0,Mn.Z)(O)}}).data,S=(Z=void 0===Z?{jobs:[]}:Z).jobs,P=function(){var e=(0,W.Z)(G().mark((function e(r){return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,er(x,{customerId:t,date:(0,Fn.Z)(O),location:o,jobs:S,jobScheduled:n,type:r,user:i,mainJobRefetch:d});case 2:j.close();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),A=[{hidden:!0},{text:"ID",formatter:function(e){return function(e){return(0,B.jsx)(or.D,{id:e.id,number:e.number,numberPrefix:s,numberSuffix:l,openCanvas:!0,type:"ppm",toggleShow:a})}(e.row)}},{text:"Start date"},{text:"Customer Amount"},{text:"Supplier Amount"},{text:"Customer Expenses"},{text:"Supplier Expenses"},{text:"Status"}],E={control:m,errors:f,register:v};return(0,B.jsxs)(ie.Z,{handleSubmit:h((function(e){var t=e.month;w(t)})),children:[(0,B.jsx)(J.Z,{context:"info",content:"Only jobs with sent reports are available to invoice"}),(0,B.jsx)(Vn.Z,{}),(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:3,children:(0,B.jsx)(St.M,ar(ar({},E),{},{dateFormat:"MM/yyyy",name:"month",placeholderText:"Click to select month",showMonthYearPicker:!0}))}),(0,B.jsx)(b.Z,{children:(0,B.jsx)(C.Z,{content:"Show jobs",context:"secondary",size:"sm",type:"submit"})})]}),(0,B.jsx)(zn.Z,{columns:A,rows:S.map((function(e){return{id:e.id,number:e.number,date:(0,k.Z)(e.timingStart),customerAmount:(0,D.Z)(e.amount),supplierAmount:(0,D.Z)(e.supplierLabourAmount+e.supplierMaterialsAmount),expensesCustomer:(0,D.Z)((0,Hn.E)(e.expenses,0,"customer").totalExpenses),expensesSupplier:(0,D.Z)((0,Hn.E)(e.expenses,0,"supplier").totalExpenses),status:(0,Ln.Z)(e.status)}}))}),S&&S.length>0&&(0,B.jsx)(q.Z,{align:"flex-end",children:(0,B.jsx)(C.Z,{context:"secondary",content:"Generate Invoice",onClick:P,size:"sm"})})]})},cr=n(38460),ur=n(84774),lr=n(49705),dr=n(78606),pr=n(55863);function mr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var fr=function(e){var t,n=e.locationId,r=e.numberPrefix,o=e.numberSuffix,i=e.toggleShow,a=(0,yn.x)().user,c=(0,Tn.x)(),l=a.adminId,d=(0,lr.x)({filters:{}}),p=d.initialData,m=d.ref,f=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?mr(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({entity:"Location",entityId:n},p),y=(0,u.a)(Nn,{variables:f}),b=y.data,h=(b=void 0===b?{ScheduledJobInvoice:[],meta:{aggregate:{totalCount:0}}}:b).ScheduledJobInvoice,v=b.meta,j=y.loading,x=y.refetch,g=(0,cr.t)(ur.E6,{onCompleted:function(e){(0,dr._)({adminId:l,type:"customerVat",job:Z[0],client:c})}}),O=(0,s.Z)(g,2),w=O[0],I=O[1].data,Z=(I=void 0===I?{job:null}:I).job,S=function(){var e=(0,W.Z)(G().mark((function e(t,n){var r,o,i,a,s;return G().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.preventDefault(),t.stopPropagation(),n.jobId){e.next=13;break}return r=n.meta.jobIds.split(","),o=n.meta.invoiceNumber,i=n.id,a={jobIds:r,invoiceNumber:o,adminId:l,accountEntryId:i},"ppm/create",s=window.open("/download","_blank"),e.next=11,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/invoice/").concat("ppm/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(a)}).then((function(e){return e.json()})).then((function(e){s.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,pr.Tb)({message:e,section:"fetch"})}));case 11:e.next=14;break;case 13:w({variables:{adminId:l,number:n.number}});case 14:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),P=[{hidden:!0},{hidden:!0},{text:"Type"},{text:"Number",formatter:function(e){var t=e.row;return(0,B.jsx)(or.D,{id:t.jobId,number:t.number,invoiceNumber:t.invoiceNumber,numberPrefix:r,numberSuffix:o,openCanvas:!!t.number,type:"Location"===t.entity?"ppm":"",toggleShow:i})}},{text:"Date"},{text:"Amount"},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:$.Z,formatterData:(t={editClick:function(e,t){return S(e,t)}},[{context:"secondary",icon:["fas","download"],onClick:t.editClick,tooltip:"Download"}]),text:"Actions"}];return(0,B.jsx)(M.t,{columns:P,loading:j,meta:v,ref:m,refetch:x,rows:h.map((function(e){var t,n,r;return{id:e.id,number:null===(t=e.job)||void 0===t?void 0:t.number,type:(0,Ln.Z)(e.account.type),invoiceNumber:null===(n=e.meta)||void 0===n||null===(r=n.invoiceNumbers)||void 0===r?void 0:r[0],date:(0,k.Z)(e.createdAt),debit:"customer"===e.account.type?(0,D.Z)(e.debit):(0,D.Z)(e.credit),jobId:e.jobId,entity:e.entity,meta:e.meta,actions:""}}))})},yr=function(e){var t=e.customerId,n=e.jobScheduled,r=e.locationId,o=e.location,i=e.user,a=e.numberPrefix,s=e.numberSuffix,c=e.toggleShow,u=e.mainJobRefetch;return(0,B.jsx)(B.Fragment,{children:(0,B.jsxs)(f.Z,{handleChange:!1,children:[(0,B.jsx)("div",{active:!0,label:"All Invoices",children:(0,B.jsx)(fr,{locationId:r,numberPrefix:a,numberSuffix:s,toggleShow:c})}),(0,B.jsx)("div",{label:"New Invoice",children:(0,B.jsx)(sr,{customerId:t,locationId:r,location:o,jobScheduled:n,user:i,toggleShow:c,numberPrefix:a,numberSuffix:s,mainJobRefetch:u})})]})})},br=n(56188),hr=n(38099),vr=n(78586),jr=n(34112),xr=function(e){var t=e.jobSchedule,n=e.onSuccess,r=(0,l.D)(T.Ms,{onCompleted:n}),o=(0,s.Z)(r,1)[0];return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(R.Z,{children:"Are you sure you want to delete JobSchedule?"}),(0,B.jsx)(ln.H,{content:"Delete",context:"danger",handleClick:function(){o({variables:{id:t.id}})}})]})},gr=n(22887),Or=n(71508),wr=n(50542);function Ir(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Zr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ir(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ir(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Sr={item:"id",order:"asc"},Pr=function(e){var t,n,r=e.location,o=e.refetch,i=e.setNextJob,a=e.setNextTaskExp,s=e.user,l=(0,c.useContext)(N.Z).hasRole,d=(0,_.useMainContext)(),p=d.customerDetails,m=d.setCustomerDetails,f=d.supplierDetails,y=d.setSupplierDetails,b=(0,c.useState)(!1),h=b[0],v=b[1],j=(0,c.useState)(!1),x=j[0],g=j[1],O=(0,c.useState)(!0),w=O[0],S=O[1],k=(0,vr.q)(),A=(null===(t=k.admin.jobSetting)||void 0===t?void 0:t.jobNumberPrefix)||"",E=(null===(n=k.admin.jobSetting)||void 0===n?void 0:n.jobNumberSuffix)||"",V=(0,lr.x)({filters:{},initialSort:Sr}),z=V.initialData,H=V.ref,W=(0,c.useContext)(I.Z),Y=(0,u.a)(T.RV,{variables:Zr({locationId:r.id},z)}),G=Y.loading,Q=Y.data,K=(Q=void 0===Q?{JobSchedule:[],meta:{aggregate:{totalCount:0}}}:Q).JobSchedule,X=Q.meta,ee=Y.error,te=Y.refetch;ee&&console.error("Error! ".concat(ee)),(0,c.useEffect)((function(){var e=(0,hr.BH)({scheduledJobs:K});a(e.nextExpire),i(e.nextJob)}),[K]);var ne=(0,u.a)(T.B6,{variables:{locationId:r.id}}),re=ne.data,oe=(re=void 0===re?{jobs:[]}:re).jobs,ie=ne.errorCalendar,ae=ne.refetch;ie&&console.error("Error! ".concat(ie));var se=oe.length>0,ce=function(){W.close(),te(),ae(),v(!0)},ue=function(e,t,n){g(!1),W.show({content:(0,B.jsx)(En.r,{jobs:oe.filter((function(r){return t?r.jobScheduleId===(null===e||void 0===e?void 0:e.id)&&(0,hr.CH)(r,n):r.jobScheduleId===(null===e||void 0===e?void 0:e.id)})),location:r,offCanvas:W,refetch:o,row:e}),submit:!1,title:"Work orders"})},le=function(e,t){e.stopPropagation(),g(!1),"inactive"!==r.status?W.show({content:(0,B.jsx)(An,{currentJob:oe.find((function(e){return new Date(e.timingStart)>new Date||!(0,jr.E)(e,"completed")})),defaultValues:t,location:r,onSuccess:ce,user:s}),title:"Add item",width:"40%"}):g(!0)},de=function(){var e={context:"secondary",size:"sm",startIconProps:{size:"lg"}};return(0,B.jsxs)(q.Z,{children:[(0,B.jsx)(C.Z,Zr(Zr({},e),{},{context:"info",onClick:function(e){return function(e){e.stopPropagation(),S(!w)}(e)},startIcon:w?"table":"calendar-alt"})),(0,B.jsx)(C.Z,Zr(Zr({},e),{},{onClick:function(e){return function(e){e.stopPropagation(),g(!1),W.show({content:(0,B.jsx)(yr,{mainJobRefetch:ce,customerId:r.customer[0].account.id,locationId:r.id,location:r,jobScheduled:he(),user:s,numberPrefix:A,numberSuffix:E,toggleShow:W.close}),title:"Invoices",width:"50%"})}(e)},startIcon:"file-invoice"})),!l("customer")&&(0,B.jsx)(C.Z,Zr(Zr({},e),{},{onClick:function(e){return function(e){e.stopPropagation(),g(!1),W.show({content:(0,B.jsx)(L.z,{entity:"Location",entityId:r.id,open:!0,withDetails:!1,showRecurring:!0},"job-schedule-expenses-".concat(r.id)),submit:!1,title:"Service fees"})}(e)},startIcon:"receipt"})),(0,B.jsx)(P.Z,{border:!1,to:"/reports/ppm/schedule?locationId=".concat(r.id),onClick:function(e){return e.stopPropagation()},children:(0,B.jsx)(C.Z,Zr(Zr({},e),{},{startIcon:"file-pdf"}))}),!l("customer")&&(0,B.jsx)(C.Z,Zr(Zr({},e),{},{context:"primary",onClick:le,startIcon:"plus"}))]})},pe=0,me=0,fe=[],ye=function(e){"supplierDetails"===e.target.name?y(!f):"customerDetails"===e.target.name&&m(!p)},be=[{hidden:!0},{formatter:function(e){var t=e.row;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(R.Z,{size:"sm",children:t.title}),(0,B.jsx)(R.Z,{size:"xs",children:t.description})]})},text:"Job"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var t=e.row;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(R.Z,{size:"sm",children:t.service.label}),(0,B.jsxs)(R.Z,{size:"xs",children:["Assigned to: ",t.supplier.label]})]})},text:"Service"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var t=e.row;return(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(R.Z,{size:"sm",children:"".concat(t.jobs," Jobs ").concat(t.completeCount," completed")}),(0,B.jsx)(R.Z,{size:"xs",children:t.frequencyDescription})]})},text:"Frequency"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var t,n,o=e.row;return(0,B.jsxs)(B.Fragment,{children:[p&&l("admin")&&(0,B.jsxs)(R.Z,{size:"sm",children:["Customer ",null!==(t=r.meta)&&void 0!==t&&t.monthlyAmount?"":(0,D.Z)(o.costCustomerSoFar)]}),f&&l("admin")&&(0,B.jsxs)(R.Z,{size:"sm",children:["Supplier ",(0,D.Z)(o.costSupplierSoFar)]}),l("customer")&&(0,B.jsx)(R.Z,{size:"sm",children:null!==(n=r.meta)&&void 0!==n&&n.monthlyAmount?"":(0,D.Z)(o.costCustomerSoFar)}),l("supplier")&&(0,B.jsx)(R.Z,{size:"sm",children:(0,D.Z)(o.costSupplierSoFar)})]})},text:"Price",hidden:!(p||f||!l("admin"))},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:l("customer"),formatter:$.Z,formatterData:function(e){return[{context:"secondary",icon:["fas","file-upload"],numberOverlay:"mediaCount",onClick:function(e,t){return function(e,t){e.stopPropagation(),g(!1),W.show({content:(0,B.jsx)(_n.G,{entity:"JobSchedule",entityId:null===t||void 0===t?void 0:t.id}),submit:!1,title:"Media"})}(e,t)},tooltip:"Media"},{context:"secondary",icon:["fas","receipt"],onClick:function(e,t){return function(e,t){e.stopPropagation(),g(!1),W.show({content:(0,B.jsx)(L.z,{entity:"JobSchedule",entityId:null===t||void 0===t?void 0:t.id,open:!0,withDetails:!1},"expenses-".concat(null===t||void 0===t?void 0:t.id)),submit:!1,title:"Expenses"})}(e,t)},tooltip:"Expenses"},{context:"info",icon:["fas","edit"],onClick:function(e,t){return le(e,t)},tooltip:"Edit"},{context:"danger",icon:["fas","trash"],onClick:function(e,t){return function(e,t){if(e.stopPropagation(),t.jobs>0)return!1;W.show({content:(0,B.jsx)(xr,{jobSchedule:t,onSuccess:ce}),submit:!1,title:"Delete JobSchedule"})}(e,t)},tooltip:"Delete",disabled:(null===e||void 0===e?void 0:e.jobs)>0}]},text:"Actions"},{hidden:!0}],he=function(){return K.map((function(e){var t,n,r;pe+=(0,hr.tf)({frequency:e.frequency,cost:e.meta.costCustomer}),me+=(0,hr.tf)({frequency:e.frequency,cost:e.meta.costSupplier});var o=null!==(t=e.meta)&&void 0!==t&&t.assetCategoryId?{value:e.meta.assetCategoryId,label:e.meta.assetCategoryName}:{};return e.assets&&e.assets.length>0&&(fe=e.assets.map((function(e){var t=e.Asset.serialNumber?" (".concat(e.Asset.serialNumber,")"):"";return{value:e.Asset.id,label:e.Asset.name+t,assetId:e.id,jobScheduleId:e.entityId}}))),{id:e.id,title:e.meta.shortDescriptionName,description:e.meta.description,costCategory:{value:e.meta.costCategoryId,label:e.meta.costCategoryName},service:{value:e.meta.serviceId,label:e.meta.serviceName},serviceName:e.meta.serviceName,supplier:{value:e.meta.supplierId,label:e.meta.supplierName},supplierName:e.meta.supplierName,assetCategory:o,assetSelected:fe,frequency:e.frequency,frequencyDescription:e.frequencyDescription,jobs:null===(n=e.jobs)||void 0===n?void 0:n.length,completeCount:(0,hr.k3)({jobScheduleId:e.id,jobs:oe}),paymentMethod:e.paymentMethod,shortDescription:{value:e.meta.shortDescriptionId,label:e.meta.shortDescriptionName},compliance:!!e.meta.complianceSelectId,complianceSelect:{value:e.meta.complianceSelectId,label:e.meta.complianceSelectName},costCustomer:e.meta.costCustomer,costSupplier:e.meta.costSupplier,costCustomerSoFar:(0,hr.tf)({frequency:e.frequency,cost:e.meta.costCustomer}),costSupplierSoFar:(0,hr.tf)({frequency:e.frequency,cost:e.meta.costSupplier}),jobScheduledExpenses:e.expenses,actions:"",mediaCount:null===e||void 0===e||null===(r=e.media)||void 0===r?void 0:r.length}}))};return(0,B.jsxs)(B.Fragment,{children:[l("admin")&&(0,B.jsxs)(Or.Z,{sx:{display:"flex",justifyContent:"flex-end"},children:[(0,B.jsx)(wr.Z,{control:(0,B.jsx)(gr.Z,{name:"customerDetails",checked:p,onChange:ye}),label:"Show customer amounts"}),(0,B.jsx)(wr.Z,{control:(0,B.jsx)(gr.Z,{name:"supplierDetails",checked:f,onChange:ye}),label:"Show supplier amounts"})]}),(0,B.jsx)(Z.Z,{fitParentHeight:!0,open:!0,title:"Items",toolbar:(0,B.jsx)(de,{}),children:w?function(){var e;return(0,B.jsxs)(B.Fragment,{children:[x&&(0,B.jsx)(J.Z,{context:"info",content:"This location is inactive"}),(0,B.jsx)(M.t,{columns:be,initialSort:Sr,loading:G,meta:X,ref:H,refetch:o,rowClick:ue,rows:he()}),(0,B.jsxs)("div",{style:{textAlign:"right",marginTop:"8px"},children:[(p||l("customer"))&&(0,B.jsx)(F.Z,{content:(0,B.jsxs)(B.Fragment,{children:[l("customer")?"Total":"Customer Total",":"," ",(0,B.jsx)("b",{children:null!==(e=r.meta)&&void 0!==e&&e.monthlyAmount?"Monthly: ".concat((0,D.Z)(r.meta.monthlyAmount)):(0,D.Z)(pe)})]}),context:"dark",shape:"round",size:"sm"}),(f||l("supplier"))&&(0,B.jsx)(F.Z,{content:(0,B.jsxs)(B.Fragment,{children:[l("supplier")?"Total":"Supplier Total",":"," ",(0,B.jsx)("b",{children:(0,D.Z)(me)})]}),context:"dark",shape:"round",size:"sm"})]})]})}():(0,B.jsx)(U,{jobs:oe,jobSchedule:K})}),se&&(0,B.jsx)(br.K,{refetchSchedule:h,setRefetchSchedule:v,locationId:r.id,handleHistory:ue,customerDetails:p,supplierDetails:f})]})};function kr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Cr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kr(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Dr=function(e){var t=e.defaultValues,n=e.location,r=e.offCanvas,o=e.refetch,i=(0,te.cI)({defaultValues:t}),a=i.errors,c=i.handleSubmit,u=i.register,d=(0,l.D)(p.zg,{onCompleted:function(e){o(),r.close()}}),m=(0,s.Z)(d,1)[0];return(0,B.jsxs)(ie.Z,{id:"offCanvasForm",handleSubmit:c((function(e){var t=e.monthlyAmount,r=n.meta,o=void 0===r?{}:r,i=n.id,a={meta:Cr(Cr({},o),{},{monthlyAmount:t})};m({variables:{id:i,changes:a}})})),children:[(0,B.jsx)(ae.Z,{label:"Monthly amount",children:(0,B.jsx)(ue.Z,{errors:a,name:"monthlyAmount",register:u,vat:"Ex VAT"})}),(0,B.jsx)(R.Z,{size:"xs",content:"Updating the monthly billing figure will overide any per item customer billing"})]})},Ar=function(e){var t=e.location,n=e.refetch,r=e.user,o=(0,c.useContext)(I.Z),i=(0,c.useState)(null),a=i[0],s=i[1],u=(0,c.useState)(null),l=u[0],d=u[1],p=t.meta,m=void 0===p?{}:p;return(0,B.jsxs)(y.Z,{children:[(0,B.jsxs)(b.Z,{md:3,children:[(0,B.jsxs)(y.Z,{children:[a&&a.name&&(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(Er,{body:a.name,className:"tile1",colourConfig:{10:"success"},description:a.date&&(0,k.Z)(a.date),rounded:!0,size:"xxs",title:"Next task"})}),l&&l.title&&(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(Er,{body:"".concat(l.title),colourConfig:{10:"success"},description:l.timingStart&&"".concat((0,k.Z)(l.timingStart)),rounded:!0,size:"xxs",title:"Next job"})})]}),function(e){var t=e.access,n=e.customer,r=e.id,o=e.name,i=e.user;return(0,B.jsxs)(Z.Z,{fitParentHeight:!0,title:"Contact",children:[(0,B.jsx)(S.Z,{text:(0,B.jsx)(P.Z,{to:"/dashboard/users/view?id=".concat(n[0].account.managerId),children:n[0].account.manager.fullName}),content:"Assigned to"}),(0,B.jsx)(S.Z,{text:(0,B.jsx)(P.Z,{to:"/dashboard/customers/view?id=".concat(n[0].account.id),children:n[0].account.name}),content:"Customer"}),(0,B.jsx)(S.Z,{text:(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(P.Z,{to:"/dashboard/users/view?id=".concat(i&&i.id),children:i?i.fullName:""}),(0,B.jsx)("br",{}),(0,B.jsx)(P.Z,{to:"tel:".concat(i&&i.phone),children:i?i.phone:""})]}),content:"Contact"}),(0,B.jsx)(S.Z,{text:(0,B.jsx)(P.Z,{to:"/dashboard/properties/view?id=".concat(r,"&tab=details"),children:o}),content:"Location"}),(0,B.jsx)(S.Z,{text:t,content:"Access information"})]})}(t),(0,B.jsx)(Z.Z,{toolbar:(0,B.jsx)(C.Z,{context:"info",onClick:function(e){e.stopPropagation(),o.show({content:(0,B.jsx)(Dr,{defaultValues:{monthlyAmount:null===m||void 0===m?void 0:m.monthlyAmount},location:t,offCanvas:o,refetch:n}),submit:!0,title:"Billing"})},size:"sm",startIcon:"edit"}),open:!0,title:"Billing",children:(0,B.jsx)(S.Z,{content:"Monthly amount",text:null!==m&&void 0!==m&&m.monthlyAmount?(0,D.Z)(m.monthlyAmount):(0,D.Z)(0)})}),(0,B.jsx)(_n.G,{category:"PPM",details:!0,entity:"Location",entityId:t.id,summary:"Documentation"})]}),(0,B.jsx)(b.Z,{md:9,children:(0,B.jsx)(Pr,{location:t,refetch:n,setNextTaskExp:s,setNextJob:d,user:r})})]})},Er=(0,w.ZP)(A.Z).withConfig({displayName:"view__StyledTile",componentId:"sc-1fv133-0"})(["min-height:130px;div{font-size:16px;}"]),_r=n(70316),Tr=n(66639),Nr=n(64111),qr=n(28323),Rr=n(48213),$r=function(e){var t=e.compliances,n=e.id,r=function(e){e.stopPropagation(),m.default.push("/dashboard/properties/view?id=".concat(n,"&tab=compliance"))},o=t.length;if(o<=0)return(0,B.jsx)(Z.Z,{open:!0,title:"Compliance Score",children:(0,B.jsx)(Jr,{onClick:r,children:(0,B.jsx)(R.Z,{content:"No compliance records, please add."})})});var i=(0,Rr.JB)(t),a=(0,Rr.CV)(t),s=(0,Rr.kW)(a);return(0,B.jsxs)(Z.Z,{open:!0,title:"Compliance Score",children:[o<=0&&(0,B.jsx)(R.Z,{content:"No compliance records, please add."}),(0,B.jsx)(Jr,{onClick:r,children:(0,B.jsx)(R.Z,{content:a&&"Score ".concat(a," %"),context:s})}),(0,B.jsx)(R.Z,{content:"".concat(o," compliance item").concat(1!==o?"s":"")}),i>0&&(0,B.jsx)(R.Z,{context:"danger",content:"".concat(i," expired")})]})},Jr=w.ZP.a.withConfig({displayName:"rating__StyledLink",componentId:"sc-1bayrs3-0"})(["cursor:pointer;text-decoration:none;"]),Fr=n(46991),Mr=n(77567),Lr=n(26),Vr=n(87883),zr=n(7755),Hr=function(e,t,n){var r=function(e,t,n){var r,o,i,a,s,c,u="/dashboard/properties/",l=(0,le.WE)(e,"registered"),d=(0,le.WE)(e,"invoice"),p=function(e){e&&n()};return[{id:1,label:"Create location",date:e.createdAt,content:[{id:1,active:e.createdAt&&e.name,data:"Name: ".concat(e.name)},{id:2,active:e.createdAt,data:"Access: ".concat(e.access)}]},{id:2,label:"Complete profile",info:"",date:(null===l||void 0===l?void 0:l.createdAt)||null,actions:[{id:1,active:!0,content:"Main address",context:"secondary",handleClick:function(){var n;t.show({content:(0,B.jsx)(zr.H,{addressId:(null===l||void 0===l||null===(n=l.address)||void 0===n?void 0:n.id)||null,entity:"Location",entityId:e.id,id:(null===l||void 0===l?void 0:l.id)||null,onSubmit:p,type:"registered"}),submit:!1,title:"Manage addresses"})},type:"button"},{id:2,active:!0,content:"Invoice address",context:"secondary",handleClick:function(){var n;t.show({content:(0,B.jsx)(zr.H,{addressId:(null===d||void 0===d||null===(n=d.address)||void 0===n?void 0:n.id)||null,entity:"Location",entityId:e.id,id:(null===d||void 0===d?void 0:d.id)||null,onSubmit:p,type:"invoice"}),submit:!1,title:"Manage addresses"})},type:"button"}]},{id:3,label:"Add assets",info:"",date:null!==(r=e.assets)&&void 0!==r&&r.length?e.assets[0].createdAt:null,content:[{id:1,active:(null===(o=e.assets)||void 0===o?void 0:o.length)>0,data:"".concat(null===(i=e.assets)||void 0===i?void 0:i.length," assets added")}],actions:[{id:1,active:!0,content:"Submit sublocations",context:"secondary",handleClick:function(){m.default.push("".concat(u,"view?id=").concat(e.id,"&tab=assets"))},type:"button"},{id:2,active:!0,content:"Submit products",context:"secondary",handleClick:function(){m.default.push("".concat(u,"view?id=").concat(e.id,"&tab=assets"))},type:"button"},{id:3,active:!0,content:"Submit sensors",context:"secondary",handleClick:function(){m.default.push("".concat(u,"view?id=").concat(e.id,"&tab=assets"))},type:"button"}]},{id:6,label:"Start issuing work orders",info:"submit work orders",date:null!==(a=e.bookings)&&void 0!==a&&a.length?e.bookings[0].createdAt:null,content:[{id:1,active:(null===(s=e.assets)||void 0===s?void 0:s.length)>0,data:"".concat(null===(c=e.assets)||void 0===c?void 0:c.length," jobs created")}]}]}(e,t,n);return r.forEach((function(e){e.date&&(e.date=Se()(e.date).format("D MMM YYYY HH:mm"))})),r},Br=function(e){var t=e.location,n=e.refetch,r=(0,c.useContext)(I.Z);return(0,B.jsx)(Z.Z,{open:!0,title:"Profile",children:(0,B.jsx)(Vr.Z,{items:Hr(t,r,n),summary:[]},"stepper-".concat(t.id))})},Ur=function(e){var t,n,r,o,i=e.location,a=e.refetch,s=(e.updateLocation,(0,c.useContext)(I.Z)),u=(0,c.useContext)(N.Z).hasRole,l=i.createdAt,d=i.compliances,p=i.customer,m=i.id,f=i.supplier,h=i.user,v=(0,le.WE)(i,"registered"),j=(0,le.WE)(i,"invoice");return(0,B.jsxs)(y.Z,{children:[(0,B.jsxs)(b.Z,{md:4,children:[(0,B.jsx)(Mr.g,{avatar:(0,qr.Q)(null===(t=i.customer[0].account)||void 0===t?void 0:t.media),entity:{id:i.id,description:i.customer[0].account.name,name:i.name||"Not Specified"},entityName:"Location",icons:(o=function(e){e.stopPropagation(),s.show({content:(0,B.jsx)(Lr.V,{data:i,refetch:a}),title:"Edit property"})},[{icon:"edit",onClick:o}])}),(0,B.jsx)(Fr.J,{data:{accountName:p.length&&p[0].account.name||f.length&&f[0].account.name,country:null===v||void 0===v||null===(n=v.address)||void 0===n||null===(r=n.country)||void 0===r?void 0:r.name,createdAt:l,fullName:null===h||void 0===h?void 0:h.fullName,position:null===h||void 0===h?void 0:h.position,phone:null===h||void 0===h?void 0:h.phone}}),v&&(0,B.jsx)(Tr.f,{address:v.address,entity:"Location",entityId:i.id,id:v.id,refetch:a,showMap:!0,title:"Address",type:"registered"}),j&&(0,B.jsx)(Tr.f,{address:j.address,entity:"Location",entityId:i.id,id:j.id,refetch:a,title:"Invoice Address",type:"invoice"}),u("admin")&&(0,B.jsx)(Nr.E,{entity:"Location",entityId:i.id,open:!0,title:"Notes"})]}),(0,B.jsx)(b.Z,{md:4,children:(0,B.jsx)(Br,{refetch:a,location:i})}),(0,B.jsxs)(b.Z,{md:4,children:[(0,B.jsx)(_n.G,{details:!0,entity:"Location",entityId:m}),(0,B.jsx)($r,{compliances:d,id:m})]})]})},Wr=n(47763),Yr=function(e){var t,n,r,o,i,a=e.location;return(0,B.jsx)(Wr.b,{accountId:null===(t=a.customer[0])||void 0===t||null===(n=t.account)||void 0===n?void 0:n.id,locationId:a.id,meta:null!==(r=null===a||void 0===a||null===(o=a.customer[0])||void 0===o||null===(i=o.account)||void 0===i?void 0:i.meta)&&void 0!==r?r:{}})},Gr=n(63306),Qr=n(41482),Kr=n(30083),Xr=n(64930),eo=n(30493),to=n(17437),no=n(97721),ro=n(4513),oo=n(55657),io=n(60683),ao=n(25610),so=n(53444),co=n(83479);function uo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function lo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?uo(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var po=function(e){var t=e.assets,n=e.categoryIdSublocation,r=e.locationId,o=e.loading,i=e.meta,a=e.refetch,s=e.onSuccess,u=(0,c.useRef)(),l=(0,c.useContext)(I.Z),d=(0,co.l)({handleBookingCanvas:function(e,t){e.stopPropagation(),l.show({content:(0,B.jsx)(ao.D,{assetId:t.data.id,locationId:r,onSuccess:s}),title:"Make a Booking"})},handleEditLocation:function(e,t){e.stopPropagation(),l.show({content:(0,B.jsx)(so._,{data:t.data,id:t.data.id,locationId:t.locationId,onSuccess:s,name:t.name}),title:"Edit location"})},handleEditCanvas:function(e,t){e.stopPropagation();var r=lo(lo({},t.data),{},{assetCategory:t.data.category});l.show({content:(0,B.jsx)(io.R,{categoryIdSublocation:n,data:r,id:r.id,onSuccess:s,sublocation:!0}),title:"Edit sublocation"})},locationId:r});return(0,B.jsx)(B.Fragment,{children:(0,B.jsx)(M.t,{columns:d,loading:o,meta:i,ref:u,refetch:a,rowClick:function(e){m.default.push("".concat("/dashboard/assets/","view?id=").concat(e.data.id))},rows:t.map((function(e){var t,n,r;return{data:e,locationId:null===(t=e.location)||void 0===t?void 0:t.id,customerId:null===(n=e.customer)||void 0===n?void 0:n.id,name:e.name,cat:null===(r=e.category)||void 0===r?void 0:r.name,location:e.location.name,customer:e.customer.name,createdAt:(0,k.Z)(e.createdAt),actions:""}}))})})};po.defaultProps={hideDetails:!0,rowDetailsInNewPage:!0,showActionButton:!0};var mo=n(67082),fo=n(39129),yo=n(42160);function bo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ho(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?bo(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var vo,jo,xo,go=new Date,Oo=function(e){var t,n,r,o=e.categoryIdSublocation,i=e.locationId,a=e.formData,s=(0,c.useRef)(),l=(0,c.useContext)(I.Z),d=(0,c.useState)("canvas"),p=d[0],m=d[1],f=ho(ho({date:go,excludeCategoryId:0},{locationId:i}),{},{limit:eo.C1.paginationSize,offset:((null===(t=s.current)||void 0===t?void 0:t.currentPage)-1||0)*eo.C1.paginationSize,orderBy:(0,E.Z)({},null===(n=s.current)||void 0===n?void 0:n.sort.item,null===(r=s.current)||void 0===r?void 0:r.sort.order)}),y=(0,u.a)(Xr.tG,{variables:(0,yo.Z)(f)}),b=y.data,h=(b=void 0===b?{assets:[],meta:{aggregate:{totalCount:0}}}:b).assets,v=b.meta,j=y.loading,x=y.refetch;if(j)return(0,B.jsx)(no.Z,{indicator:(0,B.jsx)(ro.Z,{})});var g=[{text:"Occupied",colour:to.Q.COLOUR.warning},{text:"Free",colour:to.Q.COLOUR.secondary}],O=h.filter((function(e){return e.category.id===o})),w=h.filter((function(e){return e.category.id!==o})),S=l.close,P=function(e){e.stopPropagation(),o?l.show({content:(0,B.jsx)(io.R,{data:a,disableSelects:!!a,onSuccess:S,sublocation:!0,categoryIdSublocation:o}),title:"Add sublocation"}):l.show({content:(0,B.jsx)(J.Z,{content:"You should create a sublocation of assetCategories ",context:"warning"}),title:"Add sublocation",submit:!1})},k=function(e,t){e.stopPropagation(),m(t)};return(0,B.jsxs)(Z.Z,{fitParentHeight:!0,iconComponent:null,open:!0,title:"Sublocations",toolbar:(0,B.jsxs)(q.Z,{children:[(0,B.jsx)(C.Z,{context:"secondary",onClick:P,content:"Create sublocations"}),(0,B.jsx)(C.Z,{context:"white",onClick:function(e){k(e,"table")},title:"Table View",children:(0,B.jsx)(oo.Z,{context:"secondary",icon:"bars",size:"lg"})}),(0,B.jsx)(C.Z,{context:"white",onClick:function(e){k(e,"canvas")},title:"Canvas View",children:(0,B.jsx)(oo.Z,{context:"secondary",icon:"calendar-alt",size:"lg"})})]}),children:["canvas"===p&&(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(mo.T,{assets:w,locationId:i,onSuccess:S,sublocations:O}),(0,B.jsx)(fo.D,{status:g})]}),"table"===p&&(0,B.jsx)(po,{assets:O,categoryIdSublocation:!0,locationId:i,loading:j,meta:v,refetch:x,onSuccess:S})]})},wo=n(13157),Io=(0,K.Ps)(vo||(vo=(0,Q.Z)(["\n  mutation AddTenantBooking($objects: [TenantBooking_insert_input!]!) {\n    insert_TenantBooking(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),Zo=(0,K.Ps)(jo||(jo=(0,Q.Z)(["\n  mutation UpdateTenantBooking($id: Int!, $changes: TenantBooking_set_input) {\n    update_TenantBooking_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),So=((0,K.Ps)(xo||(xo=(0,Q.Z)(["\n  mutation DeleteTenantBooking($id: Int!) {\n    delete_TenantBooking_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),(0,dn.Ry)().shape({bookingStart:(0,dn.hT)(),bookingEnd:(0,dn.hT)().nullable(),notes:(0,dn.Z_)()})),Po=n(75838);function ko(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Co(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ko(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ko(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Do=function(e){var t,n,r,o=e.defaultValues,i=e.submit,a=(0,c.useState)(!1),s=a[0],u=a[1],l=(0,te.cI)({defaultValues:o&&o,resolver:(0,ne.S)(So)}),d=l.control,p=l.errors,m=l.handleSubmit,f={control:d,errors:p,register:l.register},h=(0,l.watch)("tenantSelected");return(0,B.jsxs)(ie.Z,{id:"offCanvasForm",handleSubmit:m(i),children:[(0,B.jsx)(Z.Z,{open:!0,title:"Tenant information",children:s?(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ae.Z,{label:"First name",children:(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"nameFirst"}))})}),(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ae.Z,{label:"Last name",children:(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"nameLast"}))})}),(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ae.Z,{label:"Email",children:(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"email",type:"email"}))})}),(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(ae.Z,{label:"Mobile",children:(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"phone"}))})})]}),(0,B.jsx)(C.Z,{content:"Cancel",context:"secondary",onClick:function(){return u(!1)},size:"sm"})]}):null!==o&&void 0!==o&&o.id?(0,B.jsxs)("div",{children:[null===o||void 0===o||null===(t=o.user)||void 0===t?void 0:t.fullName," ",(0,B.jsx)("br",{}),null===o||void 0===o||null===(n=o.user)||void 0===n?void 0:n.email," ",(0,B.jsx)("br",{}),null===o||void 0===o||null===(r=o.user)||void 0===r?void 0:r.phone," ",(0,B.jsx)("br",{})]}):(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(cn.P,Co(Co({},f),{},{errors:Co({},p),label:"Tenant",name:"tenantSelected",type:"tenant"})),h&&(0,B.jsxs)("div",{children:[h.label," ",(0,B.jsx)("br",{}),h.email," ",(0,B.jsx)("br",{}),h.phone," ",(0,B.jsx)("br",{}),(0,B.jsx)("br",{})]}),"or"," ",(0,B.jsx)(C.Z,{content:"Add new tenant",context:"secondary",onClick:function(){return u(!0)},size:"sm"})]})}),(0,B.jsxs)(Z.Z,{open:!0,title:"Booking information",children:[(0,B.jsxs)(y.Z,{children:[(0,B.jsxs)(b.Z,{md:6,children:[(0,B.jsx)(ae.Z,{label:"Booked from"}),(0,B.jsx)(St.M,Co(Co({},f),{},{name:"bookingStart",placeholderText:"Click to select date"}))]}),(0,B.jsxs)(b.Z,{md:6,children:[(0,B.jsx)(ae.Z,{label:"Booked to"}),(0,B.jsx)(St.M,Co(Co({},f),{},{name:"bookingEnd",placeholderText:"Click to select date"}))]})]}),(0,B.jsx)(ae.Z,{label:"Notes",children:(0,B.jsx)(se.Z,Co(Co({},f),{},{name:"notes",rows:3}))}),(0,B.jsx)(ae.Z,{label:"Status",children:(0,B.jsx)(Ct.Z,Co(Co({},f),{},{name:"status",options:Po.bg}))})]}),(null===o||void 0===o?void 0:o.id)&&(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"id",type:"hidden"})),(null===o||void 0===o?void 0:o.locationId)&&(0,B.jsx)(fe.Z,Co(Co({},f),{},{name:"locationId",type:"hidden"}))]})};function Ao(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Eo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ao(Object(n),!0).forEach((function(t){(0,E.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ao(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var _o=function(e){var t,n,r,o=e.filters,i=(0,c.useRef)(),a=(0,c.useContext)(I.Z),d=o.locationId,p=(0,u.a)(wo.b,{variables:Eo(Eo({},o),{},{limit:eo.C1.paginationSize,offset:((null===(t=i.current)||void 0===t?void 0:t.currentPage)-1||0)*eo.C1.paginationSize,orderBy:(0,E.Z)({},null===(n=i.current)||void 0===n?void 0:n.sort.item,null===(r=i.current)||void 0===r?void 0:r.sort.order)})}),m=p.data,f=(m=void 0===m?{tenantBookings:[],meta:{aggregate:{totalCount:0}}}:m).tenantBookings,y=m.meta,b=p.loading,h=p.refetch,v=(0,l.D)(Io,{onCompleted:function(e){a.close(),h()}}),j=(0,s.Z)(v,1)[0],x=(0,l.D)(Zo,{onCompleted:function(e){a.close(),h()}}),g=(0,s.Z)(x,1)[0],O=function(e){var t=function(e){var t={};return e.id?(t.id=parseInt(e.id),t.changes={bookingStart:e.bookingStart,bookingEnd:e.bookingEnd,notes:e.notes,status:e.status}):(t.bookingStart=e.bookingStart,t.bookingEnd=e.bookingEnd,t.notes=e.notes,t.status=e.status,t.locationId=parseInt(e.locationId),e.tenantSelected?t.userId=parseInt(e.tenantSelected.value):(t.meta={newTenantUserCreated:!0},t.User={data:{nameFirst:e.nameFirst,nameLast:e.nameLast,email:e.email,phone:e.phone,status:"active",meta:{sendDefaultWelcomeEmail:!1}}})),t}(e);e.id?g({variables:Eo({},t)}):j({variables:{objects:t}})},w=function(e,t){e.stopPropagation();var n=function(e,t){var n={id:(null===e||void 0===e?void 0:e.id)||null,bookingStart:null!==e&&void 0!==e&&e.bookingStart?new Date(e.bookingStart):null,bookingEnd:null!==e&&void 0!==e&&e.bookingEnd?new Date(e.bookingEnd):null,notes:(null===e||void 0===e?void 0:e.notes)||"",locationId:t,status:(null===e||void 0===e?void 0:e.status)||"active"};return null!==e&&void 0!==e&&e.id&&null!==e&&void 0!==e&&e.user?n.user=e.user:(n.email="",n.nameFirst="",n.nameLast="",n.phone=""),n}(f.find((function(e){return e.id===(null===t||void 0===t?void 0:t.id)})),d);a.show({title:t?"Edit tenant":"Add tenant",content:(0,B.jsx)(Do,{defaultValues:n,submit:O})})},S=[{text:"ID"},{text:"Tenant"},{text:"Email Address"},{text:"Booked from"},{text:"Booked to"},{text:"Status"},{text:"Date Added",sortable:!0,sortName:"createdAt"},{formatter:$.Z,formatterData:[{context:"secondary",icon:["fas","edit"],onClick:w,tooltip:"Edit"}],text:"Actions"},{hidden:!0}];return(0,B.jsx)(Z.Z,{fitParentHeight:!0,open:!0,title:"Tenant bookings",toolbar:d&&(0,B.jsx)(C.Z,{content:"Add tenant",context:"secondary",onClick:w,size:"sm"}),children:(0,B.jsx)(M.t,{columns:S,loading:b,meta:y,ref:i,refetch:h,rows:f.map((function(e){var t=null===e||void 0===e?void 0:e.user;return{id:e.id,name:null===t||void 0===t?void 0:t.fullName,email:null===t||void 0===t?void 0:t.email,bookingStart:e.bookingStart,bookingEnd:e.bookingEnd?e.bookingEnd:"-",status:"active"===e.status?"Active":"Inactive",createdAt:(0,k.Z)(e.createdAt),actions:"",locationId:e.locationId}}))})})},To=function(){var e,t,n,r,o,i,a,w,I,Z,S,P,k,C=(0,yn.x)(),D=C.hasRole,A=C.user,E=(0,m.useRouter)().query,_=(0,c.useMemo)((function(){return E.tab||"details"}),[E.tab]),T=(0,u.a)(d.K,{}).data,N=null===(e=(T=void 0===T?{taxonomy:[]}:T).taxonomy[0])||void 0===e?void 0:e.id,q=(0,u.a)(d.t,{skip:!E.id,variables:{id:E.id}}),R=q.loading,$=q.data,J=($=void 0===$?{location:{}}:$).location,F=q.refetch,M=(0,l.D)(p.zg,{onCompleted:function(){F()}}),L=(0,s.Z)(M,1)[0];return E.id?R||J?!R&&(0,B.jsxs)(f.Z,{children:[(0,B.jsx)("div",{active:"details"===_||!_,label:"Details",children:(0,B.jsx)(Ur,{location:J,refetch:F,updateLocation:L})}),(0,B.jsx)("div",{active:"finances"===_,label:"Finances",children:(0,B.jsx)(Yr,{location:J})}),(0,B.jsx)("div",{active:"sublocations"===_,label:"Sublocations",children:(0,B.jsx)(Oo,{customFilters:!0,categoryIdSublocation:Number(N),locationId:Number(J.id),formData:{customer:{id:null===(t=J.customer[0])||void 0===t||null===(n=t.account)||void 0===n?void 0:n.id,name:null===(r=J.customer[0])||void 0===r||null===(o=r.account)||void 0===o?void 0:o.name},location:{id:J.id,name:J.name}}})}),(0,B.jsx)("div",{active:"assets"===_,label:"Assets",children:(0,B.jsx)(h.E,{customFilters:!0,filters:{excludeCategoryId:N,locationId:J.id},formData:{location:{id:J.id,name:J.name},customer:{id:null===(i=J.customer[0])||void 0===i||null===(a=i.account)||void 0===a?void 0:a.id,name:null===(w=J.customer[0])||void 0===w||null===(I=w.account)||void 0===I?void 0:I.name}}})}),(0,B.jsx)("div",{active:"slas"===_,label:"SLAs",children:(0,B.jsx)(Kr.C,{entity:"Location",entityId:J.id,parentEntityId:null===(Z=J.customer[0])||void 0===Z||null===(S=Z.account)||void 0===S?void 0:S.id})}),(0,B.jsx)("div",{active:"services"===_,label:"Services",children:(0,B.jsx)(_r.J,{customerId:null===(P=J.customer[0])||void 0===P||null===(k=P.account)||void 0===k?void 0:k.id,edit:D("admin"),entity:"Location",entityId:J.id,FiltersComp:Qr.l,initialFilters:{entity:"Location",entityId:J.id,countryId:null,currencyId:null},TableComp:Gr.o,type:"location"})}),(0,B.jsx)("div",{active:"bookings"===_,label:"Bookings",children:(0,B.jsx)(O.F,{filters:{locationId:J.id},workorderVisibility:!0,jobType:["reactive","ppm"]})}),(0,B.jsx)("div",{active:"quotes"===_,label:"Quotes",children:(0,B.jsx)(_r.J,{FiltersComp:j.r,initialFilters:{customerId:null,supplierId:null,status:null,id:null,locationId:J.id},TableComp:x.v})}),(0,B.jsx)("div",{active:"compliance"===_,label:"Compliance",children:(0,B.jsxs)(y.Z,{children:[(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(v.M,{data:J.compliances,entity:"Location",entityId:J.id,refetch:F,showOverallRating:!0})}),(0,B.jsx)(b.Z,{md:6,children:(0,B.jsx)(g.F,{compliance:!0,locationId:J.id,showFilters:!1})})]})}),(0,B.jsx)("div",{active:"tenants"===_,label:"Tenants",children:(0,B.jsx)(_o,{filters:{locationId:J.id}})}),(0,B.jsx)("div",{active:"planned-maintenance"===_,label:"Planned Maintenance",children:(0,B.jsx)(Ar,{location:J,refetch:F,user:A})})]},_):(m.default.push("/404"),!1):null},No=function(){return(0,B.jsx)(a.Z,{children:(0,B.jsx)(To,{})})}},9482:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/properties/view",function(){return n(66678)}])}},function(e){e.O(0,[9774,367,6898,3662,9809,284,4195,5312,7287,2002,3086,7134,3486,9082,3515,4712,1265,6996,9666,4177,7431,5597,8158,7615,4829,999,786,7622,3694,899,3016,1110,9547,8606,6589,9431,1670,2888,179],(function(){return t=9482,e(e.s=t);var t}));var t=e.O();_N_E=t}]);