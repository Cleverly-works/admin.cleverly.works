(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6107],{66805:function(t,e,n){"use strict";n.d(e,{H:function(){return d}});var o=n(92809),i=n(77417),r=n(58448),c=n(14347),a=n(85893);function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function l(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){(0,o.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var d=function(t){var e=t.children,n=t.content,o=t.context,s=t.data,d=t.disabled,u=t.handleClick,f=t.size,p=t.type;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.Z,{size:"sm"}),(0,a.jsxs)(r.Z,{align:"flex-end",children:[e,(0,a.jsx)(c.Z,l({content:n,context:o,disabled:d,onClick:u,size:f,type:p},s))]})]})};d.defaultProps={content:"Add",context:"secondary",disabled:!1,size:"sm",type:"button"}},51681:function(t,e,n){"use strict";n.d(e,{qZ:function(){return o},Me:function(){return i},aW:function(){return r}});var o=[{entity:"Asset",event:"assetVacated",title:"Asset Vacated"},{entity:"Job",event:"issueReported",title:"Issue reported"},{entity:"Job",event:"jobRaised",title:"Job raised"},{entity:"Job",event:"supplierBookingAccepted",title:"Supplier accepted job offer"},{entity:"Job",event:"jobCompleted",title:"Supplier completed job"},{entity:"Job",event:"jobReportSent",title:"Supplier sent job report"},{entity:"Job",event:"jobCustomerPaid",title:"Customer paid invoice"},{entity:"Job",event:"jobDisputeAdded",title:"Job dispute submitted"},{entity:"Job",event:"quoteCreated",title:"Quote Created"},{entity:"Job",event:"quoteAccepted",title:"Quote accepted by customer"},{entity:"Job",event:"quoteRejected",title:"Quote rejected by customer"},{entity:"Sensor",event:"sensorOutOfBounds",title:"Sensor out of bounds"},{entity:"Supplier",event:"supplierCreated",title:"New supplier registered"},{entity:"Supplier",event:"supplierProfileCompleted",title:"Supplier completed profile"}],i=[{entity:"Account",for:["Asset","Job","Sensor"],name:"customer",title:"Customer is",type:"select"},{entity:"Account",for:["Job"],name:"supplier",title:"Supplier is",type:"select"},{entity:"Location",for:["Asset","Job","Sensor"],name:"property",title:"Property is",type:"select"},{entity:"Service",for:["Job"],name:"service",title:"Service line is",type:"select"},{entity:"Asset",for:["Asset","Job","Sensor"],name:"asset",title:"Asset is",type:"select"},{entity:"Sensor",for:["Sensor"],name:"sensor",title:"Sensor is",type:"select"},{entity:"Sensor",for:["Sensor"],name:"sensorAbove",title:"Sensor reading is above",type:"text"},{entity:"Sensor",for:["Sensor"],name:"sensorBelow",title:"Sensor reading is below",type:"text"},{entity:"SLA",for:["Job"],name:"sla",title:"Priority is",type:"select"},{entity:"User",for:["Job","Supplier"],name:"manager",title:"Assigned to manager",type:"select"},{entity:"Job",for:["Job"],name:"title",title:"Job title contains",type:"text"},{entity:"Job",for:["Job"],name:"description",title:"Job description contains",type:"text"},{entity:"PostcodeArea",for:["Asset","Supplier","Sensor"],name:"coverage",title:"Coverage area is",type:"select"},{entity:"Address",for:["Supplier","Sensor"],name:"city",title:"City is",type:"text"}],r=[{action:"createJob",entity:"Job",for:["Asset","Sensor"],title:"Create a new job",type:"none"},{action:"assignManager",entity:"User",for:["Asset","Job","Supplier","Sensor"],name:"manager",title:"Assign Manager",type:"select"},{action:"assignSupplier",entity:"Account",for:["Asset","Job","Sensor"],name:"supplier",title:"Assign Supplier",type:"select"},{action:"assignPriority",entity:"SLA",for:["Asset","Job","Sensor"],name:"sla",title:"Assign Priority",type:"select"},{action:"createTask",entity:"Task",for:["Asset","Job","Supplier","Sensor"],name:"task",title:"Create a new task",type:"text"},{action:"sendReminder",entity:"Communication",for:["Job","Supplier"],name:"message",title:"Send a reminder",type:"text"}]},30016:function(t,e,n){"use strict";n.d(e,{Z3:function(){return l},CS:function(){return d},mJ:function(){return f}});var o,i,r,c,a=n(52209),s=n(54397),l=(0,s.Ps)(o||(o=(0,a.Z)(["\n  fragment WorkflowFields on Workflow {\n    id\n    title\n    event\n    status\n    createdAt\n  }\n"]))),d=(0,s.Ps)(i||(i=(0,a.Z)(["\n  fragment WorkflowActionFields on WorkflowAction {\n    id\n    action\n    actionEntity\n    actionEntityId\n    actionValue\n    createdAt\n  }\n"]))),u=(0,s.Ps)(r||(r=(0,a.Z)(["\n  fragment WorkflowConditionFields on WorkflowCondition {\n    id\n    condition\n    conditionEntity\n    conditionEntityId\n    conditionValue\n    createdAt\n  }\n"]))),f=(0,s.Ps)(c||(c=(0,a.Z)(["\n  query GetWorkflow($id: Int!) {\n    workflow: Workflow_by_pk(id: $id) {\n      ...WorkflowFields\n      actions: WorkflowActions {\n        ...WorkflowActionFields\n      }\n      conditions: WorkflowConditions {\n        ...WorkflowConditionFields\n      }\n    }\n  }\n  ","\n  ","\n  ","\n"])),l,d,u)},75838:function(t,e,n){"use strict";n.d(e,{bg:function(){return o},WG:function(){return i}});var o=[{text:"Status",value:""},{text:"Active",value:"active"},{text:"Inactive",value:"inactive"}],i=[{text:"Status",value:""},{text:"Open",value:"open"},{text:"Resolved",value:"resolved"},{text:"Closed",value:"closed"}]},46437:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return ct}});var o,i,r,c,a,s=n(66918),l=n(80318),d=n(67294),u=n(11163),f=n(38460),p=n(30016),v=n(92809),y=n(30266),b=n(64687),m=n.n(b),w=n(75709),j=n(52209),h=n(54397),k=(0,h.Ps)(o||(o=(0,j.Z)(["\n  mutation AddWorkflow($objects: [Workflow_insert_input!]!) {\n    insert_Workflow(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),O=(0,h.Ps)(i||(i=(0,j.Z)(["\n  mutation UpdateWorkflow(\n    $id: Int!\n    $changes: Workflow_set_input!\n    $actions: [WorkflowAction_insert_input!]!\n    $conditions: [WorkflowCondition_insert_input!]!\n  ) {\n    update_Workflow_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_WorkflowAction(\n      objects: $actions\n      on_conflict: {\n        constraint: pk_WorkflowAction\n        update_columns: [action, actionEntity, actionEntityId, actionValue]\n      }\n    ) {\n      returning {\n        id\n      }\n    }\n    insert_WorkflowCondition(\n      objects: $conditions\n      on_conflict: {\n        constraint: pk_WorkflowCondition\n        update_columns: [condition, conditionEntity, conditionEntityId, conditionValue]\n      }\n    ) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),g=((0,h.Ps)(r||(r=(0,j.Z)(["\n  mutation DeleteWorkflow($id: Int!) {\n    delete_Workflow_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),(0,h.Ps)(c||(c=(0,j.Z)(["\n  mutation DeleteWorkflowActions($ids: [Int!]!) {\n    delete_WorkflowAction(where: { id: { _in: $ids } }) {\n      affected_rows\n    }\n  }\n"])))),S=(0,h.Ps)(a||(a=(0,j.Z)(["\n  mutation DeleteWorkflowConditions($ids: [Int!]!) {\n    delete_WorkflowCondition(where: { id: { _in: $ids } }) {\n      affected_rows\n    }\n  }\n"]))),x=n(42283),Z=n(79665),A=n(97202),P=n(80284),_=n(78215),W=n(2356),E=n(65375),C=n(71247),I=n(46482),J=n(66805),D=n(75838),V=n(83789),$=n(62906),q=n(14347),F=n(95146),R=n(51681),z=function(){var t=[{text:"Select Event",value:""}];return R.qZ.forEach((function(e){t.push({text:e.title,value:e.event})})),t},M=function(t){var e=[{text:"Select Condition",value:""}];return R.Me.forEach((function(n){n.for.includes(t)&&e.push({text:n.title,value:n.name})})),e},N=function(t){var e=[{text:"Select Action",value:""}];return R.aW.forEach((function(n){n.for.includes(t)&&e.push({text:n.title,value:n.action})})),e},T=function(t){var e=[],n=[],o={action:(null===t||void 0===t?void 0:t.action)||"",actionValue:(null===t||void 0===t?void 0:t.actionValue)||"",event:(null===t||void 0===t?void 0:t.event)||"",status:(null===t||void 0===t?void 0:t.status)||"active",title:(null===t||void 0===t?void 0:t.title)||""};return null!==t&&void 0!==t&&t.actionEntityId&&(o.actionSelected={label:t.actionValue,value:t.actionEntityId}),null!==t&&void 0!==t&&t.actions?t.actions.forEach((function(e,i){o["action".concat(i)]=e.action,o["action".concat(i,"Value")]=e.actionValue,e.actionEntityId&&(o["action".concat(i,"Selected")]={label:e.actionValue,value:e.actionEntityId}),n.push({name:"action".concat(i),id:e.id,workflowId:t.id})})):n.push({name:"action0"}),null!==t&&void 0!==t&&t.conditions?t.conditions.forEach((function(n,i){o["condition".concat(i)]=n.condition,o["condition".concat(i,"Value")]=n.conditionValue,n.conditionEntityId&&(o["condition".concat(i,"Selected")]={label:n.conditionValue,value:n.conditionEntityId}),e.push({name:"condition".concat(i),id:n.id,workflowId:t.id})})):e.push({name:"condition0"}),{actions:n,conditions:e,defaultValues:o}},B=function(t,e,n,o){var i=[],r=[],c=[],a=[];e.forEach((function(e){if(e.deleted)e.id&&r.push(e.id);else{var n=R.aW.find((function(n){return n.action===t[e.name]}));if(n){var o,c,a={action:n.action,actionEntity:n.entity,actionEntityId:(null===(o=t["".concat(e.name,"Selected")])||void 0===o?void 0:o.value)||null,actionValue:t["".concat(e.name,"Value")]||(null===(c=t["".concat(e.name,"Selected")])||void 0===c?void 0:c.label)||null};e.id&&(a.id=e.id),e.workflowId&&(a.workflowId=e.workflowId),i.push(a)}}})),n.forEach((function(e){if(e.deleted)e.id&&a.push(e.id);else{var n=R.Me.find((function(n){return n.name===t[e.name]}));if(n){var o,i,r={condition:n.name,conditionEntity:n.entity,conditionEntityId:(null===(o=t["".concat(e.name,"Selected")])||void 0===o?void 0:o.value)||null,conditionValue:t["".concat(e.name,"Value")]||(null===(i=t["".concat(e.name,"Selected")])||void 0===i?void 0:i.label)||null};e.id&&(r.id=e.id),e.workflowId&&(r.workflowId=e.workflowId),c.push(r)}}}));var s={title:t.title,status:t.status,event:t.event};return"add"===o&&(s.WorkflowActions={data:i},s.WorkflowConditions={data:c}),{data:s,actionsData:i,conditionsData:c,deletedActions:r,deletedConditions:a}},H=n(85893);function L(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function Q(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?L(Object(n),!0).forEach((function(e){(0,v.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):L(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var U=function(t){var e=t.actions,n=t.defaultOptions,o=t.eventWatch,i=t.id,r=t.setActions,c=t.watch,a=R.qZ.find((function(t){return t.event===o})),s=function(t,e,o){switch(e.type){case"text":return(0,d.createElement)(C.Z,Q(Q({},n),{},{key:t,name:"".concat(o,"Value")}));case"select":return(0,d.createElement)(F.P,Q(Q({},n),{},{errors:Q({},n.errors),key:t,label:"",name:"".concat(o,"Selected"),type:e.name}));default:return""}},l=function(t,e){var o=c(t),i=R.aW.find((function(t){return t.action===o}));return(0,H.jsxs)(H.Fragment,{children:[(0,H.jsx)(I.Z,Q(Q({},n),{},{name:"action".concat(e),options:N(null===a||void 0===a?void 0:a.entity)})),o&&i&&s(o,i,t)]})};return(0,H.jsxs)(H.Fragment,{children:[e.map((function(t,n){return!t.deleted&&(0,H.jsxs)(P.Z,{open:!0,title:"Then",children:[l(t.name,n),n>0?(0,H.jsx)($.Z,{border:!0,onClick:function(){return function(t){var n=(0,V.Z)(e);n[t].deleted=!0,r(n)}(n)},children:"Remove this action"}):null]},n)})),(0,H.jsx)(q.Z,{content:"Add new action",size:"sm",type:"button",onClick:function(t){t.preventDefault();var n=(0,V.Z)(e),o={name:"action".concat(n.length)};i&&(o.workflowId=i),n.push(o),r(n)}})]})};function G(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function X(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?G(Object(n),!0).forEach((function(e){(0,v.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):G(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var K=function(t){var e=t.defaultOptions,n=t.conditions,o=t.eventWatch,i=t.id,r=t.setConditions,c=t.watch,a=R.qZ.find((function(t){return t.event===o})),s=function(t,n,o){switch(n.type){case"text":return(0,d.createElement)(C.Z,X(X({},e),{},{key:t,name:"".concat(o,"Value")}));case"select":return(0,d.createElement)(F.P,X(X({},e),{},{errors:X({},e.errors),key:t,label:"",name:"".concat(o,"Selected"),type:n.name}))}},l=function(t,n){var o=c(t),i=R.Me.find((function(t){return t.name===o}));return(0,H.jsxs)(H.Fragment,{children:[(0,H.jsx)(I.Z,X(X({},e),{},{name:"condition".concat(n),options:M(null===a||void 0===a?void 0:a.entity)})),o&&i&&s(o,i,t)]})};return(0,H.jsxs)(H.Fragment,{children:[n.map((function(t,e){return!t.deleted&&(0,H.jsxs)(P.Z,{open:!0,title:"And (optional)",children:[l(t.name,e),e>0?(0,H.jsx)($.Z,{border:!0,onClick:function(){return function(t){var e=(0,V.Z)(n);e[t].deleted=!0,r(e)}(e)},children:"Remove this condition"}):null]},e)})),(0,H.jsx)(q.Z,{content:"Add new condition",onClick:function(t){t.preventDefault();var e=(0,V.Z)(n),o={name:"condition".concat(e.length)};i&&(o.workflowId=i),e.push(o),r(e)},size:"sm",type:"button"})]})},Y=n(19501),tt=(0,Y.Ry)().shape({title:(0,Y.Z_)().required(),event:(0,Y.Z_)().required(),action0:(0,Y.Z_)().required(),status:(0,Y.Z_)().oneOf(["active","inactive"]).required()}),et=n(1323);function nt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function ot(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?nt(Object(n),!0).forEach((function(e){(0,v.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var it=function(t){var e=t.data,n=t.id,o=t.onSuccess,i=(0,et.x)().user,r=(0,x.cI)({defaultValues:e.defaultValues,resolver:(0,Z.S)(tt)}),c=r.control,a=r.errors,s=r.handleSubmit,u=r.register,f=r.watch,p=(0,d.useState)(e.actions),v=p[0],b=p[1],j=(0,d.useState)(e.conditions),h=j[0],V=j[1],$=(0,w.D)(k,{onCompleted:function(t){var e=t.insert_Workflow.returning[0].id;o&&o(e)}}),q=(0,l.Z)($,1)[0],F=(0,w.D)(O,{onCompleted:function(t){var e=t.update_Workflow_by_pk.id;o&&o(e)}}),R=(0,l.Z)(F,1)[0],M=(0,w.D)(g),N=(0,l.Z)(M,1)[0],T=(0,w.D)(S),L=(0,l.Z)(T,1)[0],Q=f("event"),G=function(){var t=(0,y.Z)(m().mark((function t(e){var o,r,c,a,s,l,d,u;return m().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=10;break}return o=B(e,v,h,"edit"),r=o.data,c=o.actionsData,a=o.conditionsData,s=o.deletedActions,l=o.deletedConditions,t.next=4,R({variables:{id:n,changes:r,actions:c,conditions:a}});case 4:return t.next=6,N({variables:{ids:s}});case 6:return t.next=8,L({variables:{ids:l}});case 8:t.next=14;break;case 10:return d=B(e,v,h,"add"),(u=d.data).adminId=null===i||void 0===i?void 0:i.accountId,t.next=14,q({variables:{objects:[u]}});case 14:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),X={control:c,errors:a,register:u};return(0,H.jsxs)(A.Z,{handleSubmit:s(G),children:[(0,H.jsx)(P.Z,{open:!0,title:"Workflow Details",children:(0,H.jsxs)(_.Z,{children:[(0,H.jsx)(W.Z,{md:8,children:(0,H.jsx)(E.Z,{label:"Title",children:(0,H.jsx)(C.Z,ot(ot({},X),{},{name:"title"}))})}),(0,H.jsx)(W.Z,{md:4,children:(0,H.jsx)(E.Z,{label:"Status",children:(0,H.jsx)(I.Z,ot(ot({},X),{},{name:"status",options:D.bg}))})})]})}),(0,H.jsxs)(_.Z,{children:[(0,H.jsx)(W.Z,{md:4,children:(0,H.jsx)(P.Z,{open:!0,title:"If",children:(0,H.jsx)(I.Z,ot(ot({},X),{},{name:"event",options:z()}))})}),(0,H.jsx)(W.Z,{md:4,children:(0,H.jsx)(K,{conditions:h,defaultOptions:X,eventWatch:Q,id:n,setConditions:V,watch:f},Q)}),(0,H.jsx)(W.Z,{md:4,children:(0,H.jsx)(U,{actions:v,defaultOptions:X,eventWatch:Q,id:n,setActions:b,watch:f},Q)})]}),(0,H.jsx)(J.H,{content:"Submit",type:"submit"})]})},rt=function(){var t=(0,u.useRouter)().query,e=t.id?parseInt(t.id):null,n=(0,f.t)(p.mJ,{variables:{id:e}}),o=(0,l.Z)(n,2),i=o[0],r=o[1],c=r.loading,a=r.data,s=(a=void 0===a?{workflow:null}:a).workflow;(0,d.useEffect)((function(){e&&i()}),[]);return!c&&(0,H.jsx)(it,{data:T(s),id:e,onSuccess:function(t){u.default.push("".concat("/dashboard/workflows/","view?id=").concat(t))}},e)},ct=function(){return(0,H.jsx)(s.Z,{pageHeading:{heading:"Automated Workflows"},View:(0,H.jsx)(rt,{})})}},97120:function(t,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/workflows/manage",function(){return n(46437)}])}},function(t){t.O(0,[284,4195,5312,7287,7134,3486,9082,3515,6414,5146,9774,2888,179],(function(){return e=97120,t(t.s=e);var e}));var e=t.O();_N_E=e}]);