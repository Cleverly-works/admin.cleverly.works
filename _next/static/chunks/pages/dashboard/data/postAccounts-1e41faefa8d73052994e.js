(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4548],{73704:function(e,n,t){"use strict";t.d(n,{C:function(){return b}});var r=t(92809),o=t(10219),a=t(42426),i=t(78215),c=t(2356),s=t(19716),u=t(22796),d=t(85893),l=["control","errors","nameEnd","nameStart","placeholderEnd","placeholderStart","space"];function m(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?m(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):m(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var b=function(e){var n=e.control,t=e.errors,r=e.nameEnd,m=e.nameStart,b=e.placeholderEnd,j=e.placeholderStart,v=e.space,f=(0,o.Z)(e,l);return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)(i.Z,{children:[(0,d.jsx)(c.Z,{md:6,children:(0,d.jsx)(s.Z,p({control:n,errors:t,locale:a.Z,name:m,placeholder:j},f))}),(0,d.jsx)(c.Z,{md:6,children:(0,d.jsx)(s.Z,p({control:n,errors:t,locale:a.Z,name:r,placeholder:b},f))})]}),v&&(0,d.jsx)(u.Z,{marginBottom:"sm"})]})};b.defaultProps={placeholderStart:"Start date",placeholderEnd:"End date",space:!0}},22384:function(e,n,t){"use strict";t.d(n,{r:function(){return r}});var r=[{text:"All outstanding invoices",value:""},{text:"1 - 30",value:"1-30"},{text:"31 - 60",value:"31-60"},{text:"61 - 90",value:"61-90"},{text:"> 90",value:"90-"}]},28983:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return ie}});var r,o,a,i,c,s=t(66918),u=t(92809),d=t(67294),l=t(93633),m=t(52209),p=t(54397),b=(0,p.Ps)(r||(r=(0,m.Z)(['\n  query GetFinancialJob(\n    $adminId: Int!\n    $customerId: Int\n    $invoiceNumber: jsonb\n    $jobId: String\n    $jobEndDate: timestamptz\n    $jobStartDate: timestamptz\n    $limit: Int\n    $locationId: Int\n    $offset: Int\n    $paymentStartDate: timestamptz\n    $paymentEndDate: timestamptz\n    $supplierId: Int\n  ) {\n    jobFinancial: getDashboard_Job_Financial(\n      limit: $limit\n      offset: $offset\n      where: {\n        job_ispaid: { _eq: true }\n        adminid: { _eq: $adminId }\n        customer_id: { _eq: $customerId }\n        locationid: { _eq: $locationId }\n        supplier_id: { _eq: $supplierId }\n        _and: [\n          { job_date: { _gte: $jobStartDate } }\n          { job_date: { _lte: $jobEndDate } }\n          { pay_date: { _gte: $paymentStartDate } }\n          { pay_date: { _lte: $paymentEndDate } }\n          { _or: [{ job_number: { _eq: $jobId } }, { job_invoicenumber: { _eq: $invoiceNumber } }] }\n        ]\n      }\n      args: { adminId: $adminId }\n    ) {\n      account: customer_name\n      expensesAmount: job_expenses_customer\n      expensesAmountSupplier: job_expenses_supplier\n      invoiceDate: job_date\n      invoiceNumber: job_invoicenumber\n      jobId: job_id\n      jobNumber: job_number\n      jobStatus: job_status\n      jobTotal: customer_amount\n      jobType: job_type\n      payDate: pay_date\n      supplierAmount: supplier_amount\n      serviceLine: service_name\n      serviceName: service_name\n      supplierId: supplier_id\n      supplierName: supplier_name\n      job: Job {\n        sageInvoiceNumber: meta(path: "$.sageInvoiceNumber")\n      }\n      customer: Customer {\n        sageCode: meta(path: "$.sageCode")\n      }\n    }\n    meta: getDashboard_Job_Financial_aggregate(\n      where: {\n        job_ispaid: { _eq: true }\n        adminid: { _eq: $adminId }\n        customer_id: { _eq: $customerId }\n        locationid: { _eq: $locationId }\n        supplier_id: { _eq: $supplierId }\n        _and: [\n          { job_date: { _gte: $jobStartDate } }\n          { job_date: { _lte: $jobEndDate } }\n          { pay_date: { _gte: $paymentStartDate } }\n          { pay_date: { _lte: $paymentEndDate } }\n          { _or: [{ job_number: { _eq: $jobId } }, { job_invoicenumber: { _eq: $invoiceNumber } }] }\n        ]\n      }\n      args: { adminId: $adminId }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n    account: Account_by_pk(id: $adminId) {\n      meta\n    }\n  }\n']))),j=(0,p.Ps)(o||(o=(0,m.Z)(["\n  query sageStatus($url: String!) {\n    sageStatus(url: $url) {\n      online\n    }\n  }\n"]))),v=(0,p.Ps)(a||(a=(0,m.Z)(["\n  mutation sendSageInvoice($invoices: [InvoicesInput]!, $url: String!) {\n    sendSageInvoice(invoices: $invoices, url: $url) {\n      success\n      error\n      invoices\n    }\n  }\n"]))),f=((0,p.Ps)(i||(i=(0,m.Z)(["\n  query sageUrl($accountId: Int!) {\n    Account_by_pk(id: $accountId) {\n      meta\n    }\n  }\n"]))),function(e){var n="";return e.forEach((function(e,t){n+="\n              alias".concat(t,": update_Job_by_pk(pk_columns: { id: ").concat(e.id," },\n                  _append:{meta:{sageInvoiceNumber:").concat(e.sageInvoiceNumber,"}}) {\n                id\n              }\n            ")})),(0,p.Ps)(c||(c=(0,m.Z)(["mutation UpdateJob {\n    ","\n  }"])),n)}),g=t(42283),x=t(43703),_=t(4135),S=t(69119),h=t(83894),I=t(14347),y=t(55657),D=t(80880),Z=t(18944),$=t(18862),w=t(80285),E=t(91126),P=t(80284),N=t(97202),O=t(78215),C=t(2356),A=t(71247),q=t(46482),T=t(22796),F=t(81185),k=t(73704),J=t(68343),z=t(22384),L=t(65570),U=t(95146),B=t(1323),R=t(78586),H=t(49705),V=t(7720),X=t(85893),G=function(e){var n=e.url,t=(0,l.a)(j,{variables:{url:n}}),r=t.data,o=(r=void 0===r?{sageStatus:{online:!1}}:r).sageStatus.online,a=t.error,i=t.loading;return a&&console.error("Error! ".concat(a)),(0,X.jsx)(V.Z,{content:i?"loading...":o?"Connected":"Disconnected",context:o?"success":"danger",shape:"round",size:"sm"})},K=t(80318),M=t(11570),Q=t(66805),W=t(26075),Y=t(75709),ee=function(e){var n=e.rows,t=e.url,r=e.onSuccess,o=(0,d.useState)(),a=o[0],i=o[1],c=(0,d.useState)([]),s=c[0],u=c[1],l=(0,d.useState)([]),m=l[0],p=l[1],b=(0,d.useState)(),j=b[0],g=b[1],x=(0,W.x)(),_=n.filter((function(e){return!e.sageInvoiceNumber})),S=(0,Y.D)(v,{onCompleted:function(e){var n=e.sendSageInvoice.invoices,t=n.filter((function(e){return!!e.number})),o=n.filter((function(e){return!e.number})),a=t.map((function(e){return{id:e.senderJobId,sageInvoiceNumber:e.number}}));a.length>0&&x.mutate({mutation:f(a)}),r(),p(t),u(o),g(!0)},onError:function(e){i(e.message)}}),h=(0,K.Z)(S,1)[0];return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsxs)(Z.Z,{weight:"bold",children:["Send ",_.length," Invoice(s) to Sage"]}),(0,X.jsx)(Q.H,{content:"Submit",disabled:j,handleClick:function(){var e=_.map((function(e){return{accountRef:e.customerSageCode,amount:e.jobTotal,invoiceDate:e.invoiceDate,productCode:"PRD1",senderInvoiceNumber:String(e.invoiceNumber),senderJobId:String(e.jobId)}}));h({variables:{invoices:e,url:t}})}}),a&&(0,X.jsx)(M.Z,{context:"danger",content:a}),s&&s.length>0&&s.map((function(e){return(0,X.jsx)(M.Z,{context:"danger",content:"Job ".concat(e.senderJobId," =>  ").concat(e.result)})})),m&&m.length>0&&(0,X.jsx)(M.Z,{context:"success",content:"".concat(m.length," Invoices sent successfully")})]})};function ne(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function te(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ne(Object(t),!0).forEach((function(n){(0,u.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ne(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var re=function(e){var n=e.onExport,t=e.rows,r=e.url;return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsx)(G,{url:r}),(0,X.jsx)(I.Z,{context:"secondary",onClick:function(e){return n({e:e,rows:t()})},title:"Send Current Page To Sage",size:"sm",children:(0,X.jsx)(y.Z,{context:"white",icon:"file-export",size:"md"})})]})},oe={endDate:(0,_.Z)(new Date),startDate:(0,x.Z)(new Date)},ae=function(){var e,n,t,r=(0,B.x)().user,o=(0,d.useContext)(D.Z),a=(0,R.q)(),i=null===(e=a.admin.jobSetting)||void 0===e?void 0:e.jobNumberPrefix,c=null===(n=a.admin.jobSetting)||void 0===n?void 0:n.jobNumberSuffix,s=(0,d.useState)(oe),u=s[0],m=s[1],p=(0,H.x)({filters:u}),j=p.initialData,v=p.ref,f=(0,g.cI)({defaultValues:u}),x=f.control,_=f.errors,V=f.handleSubmit,G=f.register,K=(0,l.a)(b,{variables:te({adminId:r.accountId},j)}),M=K.data,Q=(M=void 0===M?{jobFinancial:[],meta:{aggregate:{totalCount:0}},account:{}}:M).account,W=M.jobFinancial,Y=M.meta,ne=K.error,ae=K.loading,ie=K.refetch;ne&&console.error("Error! ".concat(ne));var ce=function(e){var n,t=e.e,r=e.rows;t.stopPropagation(),o.show({content:(0,X.jsx)(ee,{rows:r,onSuccess:ie,url:null===Q||void 0===Q||null===(n=Q.meta)||void 0===n?void 0:n.sageUrl}),submit:!1,title:"Send To Sage"})},se=[{hidden:!0},{hidden:!0},{hidden:!0},{text:"Job ID",formatter:function(e){var n=e.row;return(0,X.jsx)(L.D,{id:n.jobId,invoiceNumber:n.invoiceNumber,number:n.jobNumber,numberPrefix:i,numberSuffix:c,openCanvas:!0,type:n.jobType})}},{text:"Sent To Sage",formatter:function(e){return function(e){var n=!!e;return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsx)(y.Z,{context:"".concat(n?"success":"danger"),icon:"".concat(n?"check":"times"),size:"sm",title:"".concat(n?"sent to sage":"not sent")}),n&&(0,X.jsxs)(Z.Z,{size:"xs",children:["Sage invoice number: ",e," "]})]})}(e.row.sageInvoiceNumber)}},{formatter:function(e){var n=e.row;return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsx)(Z.Z,{children:n.account}),(0,X.jsx)(Z.Z,{size:"xs",children:"Sage Code: ".concat(n.customerSageCode||"")})]})},text:"Customer"},{text:"Job Date",formatter:function(e){var n=e.row;return(0,$.Z)(n.invoiceDate)}},{text:"Pay Date",formatter:function(e){var n=e.row;return n.payDate&&(0,$.Z)(n.payDate)}},{text:"Customer Amount",formatter:function(e){var n=e.row;return(0,w.Z)(n.jobTotal)}},{text:"Supplier Amount",formatter:function(e){var n=e.row;return(0,w.Z)(n.supplierAmount)}},{text:"Customer Expenses",formatter:function(e){var n=e.row;return(0,w.Z)(n.expensesAmount)}},{text:"Supplier Expenses",formatter:function(e){var n=e.row;return(0,w.Z)(n.expensesAmountSupplier)}},{text:"Revenue",formatter:function(e){var n=e.row;return(0,w.Z)(n.revenue)}},{text:"Status",formatter:function(e){var n=e.row;return(0,J.B)({value:n.jobStatus})}},{text:"Service"},{hidden:!0},{formatter:E.Z,formatterData:[{context:"secondary",icon:["fa","file-export"],onClick:function(e,n){return ce({e:e,rows:[n]})},tooltip:"Send To Sage"}],text:"Actions"}],ue=function(){return W.map((function(e){return{invoiceNumber:e.invoiceNumber,jobId:e.jobId,jobNumber:e.jobNumber,jobType:e.jobType,sageInvoiceNumber:e.job.sageInvoiceNumber,account:e.account,invoiceDate:e.invoiceDate,payDate:e.payDate,jobTotal:e.jobTotal,supplierAmount:e.supplierAmount,expensesAmount:e.expensesAmount,expensesAmountSupplier:e.expensesAmountSupplier,revenue:e.jobTotal-e.supplierAmount,jobStatus:e.jobStatus,serviceLine:e.serviceLine,customerSageCode:e.customer.sageCode,actions:""}}))},de={control:x,errors:_,register:G};return(0,X.jsxs)(X.Fragment,{children:[(0,X.jsx)(P.Z,{title:"Filters",children:(0,X.jsxs)(N.Z,{handleSubmit:V((function(e){var n,t,r;m({customerId:null===(n=e.customerId)||void 0===n?void 0:n.value,invoiceNumber:e.invoiceNumber||null,jobId:e.invoiceNumber||null,jobEndDate:(0,h.Z)(e.jobEndDate),jobStartDate:(0,S.Z)(e.jobStartDate),locationId:null===(t=e.locationId)||void 0===t?void 0:t.value,outstandingLevel:e.outstandingLevel>-1?e.outstandingLevel:null,paymentEndDate:(0,h.Z)(e.paymentEndDate),paymentStartDate:(0,S.Z)(e.paymentStartDate),startDate:e.startDate,supplierId:null===(r=e.supplierId)||void 0===r?void 0:r.value})})),children:[(0,X.jsx)(k.C,te(te({},de),{},{nameEnd:"jobEndDate",nameStart:"jobStartDate",placeholderEnd:"Job end date",placeholderStart:"Job start date"})),(0,X.jsx)(k.C,te(te({},de),{},{nameEnd:"paymentEndDate",nameStart:"paymentStartDate",placeholderEnd:"Payment end date",placeholderStart:"Payment start date"})),(0,X.jsxs)(O.Z,{children:[(0,X.jsx)(C.Z,{md:6,children:(0,X.jsx)(A.Z,te(te({},de),{},{name:"invoiceNumber",placeholder:"Id / Invoice"}))}),(0,X.jsx)(C.Z,{md:6,children:(0,X.jsx)(q.Z,te(te({},de),{},{name:"outstandingLevel",options:z.r}))})]}),(0,X.jsxs)(O.Z,{children:[(0,X.jsx)(C.Z,{md:6,children:(0,X.jsx)(U.P,te(te({},de),{},{label:"",name:"customerId",placeholder:"Select customer",type:"customer"}))}),(0,X.jsx)(C.Z,{md:6,children:(0,X.jsx)(U.P,te(te({},de),{},{label:"",name:"locationId",placeholder:"Select Location",type:"property"}))})]}),(0,X.jsx)(O.Z,{children:(0,X.jsx)(C.Z,{md:6,children:(0,X.jsx)(U.P,te(te({},de),{},{label:"",name:"supplierId",placeholder:"Select supplier",type:"supplier"}))})}),(0,X.jsx)(T.Z,{marginBottom:"sm"}),(0,X.jsx)(I.Z,{content:"Filter",context:"secondary",size:"sm",type:"submit"})]})}),(0,X.jsx)(P.Z,{dataSet:{"data-cy":"Financial Data"},open:!0,title:"Paid Invoices",toolbar:(0,X.jsx)(re,{onExport:ce,rows:ue,url:null===(t=Q.meta)||void 0===t?void 0:t.sageUrl}),children:(0,X.jsx)(F.t,{columns:se,loading:ae,meta:Y,ref:v,refetch:ie,rows:ue()})})]})},ie=function(){return(0,X.jsx)(s.Z,{pageHeading:{heading:"Post Accounts"},View:(0,X.jsx)(ae,{})})}},75160:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/data/postAccounts",function(){return t(28983)}])}},function(e){e.O(0,[367,284,4195,5312,7287,2002,3086,7134,3486,9082,3515,4712,1265,6996,9666,4177,4894,5146,899,3016,9774,2888,179],(function(){return n=75160,e(e.s=n);var n}));var n=e.O();_N_E=n}]);