(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9312,2880],{380:function(e,t,n){"use strict";n.d(t,{K:function(){return r}});var r=function(e){return 1}},38342:function(e,t,n){"use strict";n.d(t,{z:function(){return ie}});var r,i,o,a,c=n(92809),s=n(30266),u=n(80318),d=n(64687),l=n.n(d),p=n(67294),m=n(93633),f=n(75709),v=n(52209),b=n(54397),h=(0,b.Ps)(r||(r=(0,v.Z)(["\n  mutation InsertExpense($objects: [Expense_insert_input!]!) {\n    insert_Expense(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),y=(0,b.Ps)(i||(i=(0,v.Z)(["\n  mutation UpdateExpense($id: Int!, $changes: Expense_set_input) {\n    update_Expense_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),j=(0,b.Ps)(o||(o=(0,v.Z)(['\n  query GetExpenses($entity: String, $entityId: Int, $jobId: Int) {\n    expenses: Expense(\n      where: { jobId: { _eq: $jobId }, entity: { _eq: $entity }, entityId: { _eq: $entityId } }\n    ) {\n      id\n      categoryId\n      description\n      amount\n      unit\n      markup\n      vat\n      paid\n      jobId\n      total\n      entity\n      entityId\n      occurredAt\n      recurring\n      category: Category {\n        name\n      }\n      media: Media(where: { entity: { _eq: "Expense" } }) {\n        id\n      }\n    }\n  }\n']))),g=(0,b.Ps)(a||(a=(0,v.Z)(["\n  mutation DeleteExpense($id: Int!) {\n    delete_Expense_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),x=n(30493),w=n(42593),I=n(80880),Z=n(80285),O=n(91126),S=n(58448),_=n(14347),P=n(18862),A=n(11417),C=n(78215),D=n(2356),k=n(93443),R=n(52002),q=n(80284),E=n(34112),T=n(50899),$=n(42283),N=n(79665),J=n(97202),H=n(69128),U=n(34868),M=n(65375),F=n(71247),V=n(12757),L=n(83528),z=n(76800),Q=n(95146),B=n(19501),Y=(0,B.Ry)().shape({amount:(0,B.Rx)().required(),unit:(0,B.Rx)().required(),categoryId:(0,B.Ry)().required(),description:(0,B.Z_)().required(),markup:(0,B.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable(),paid:(0,B.Z_)().oneOf(["admin","supplier"]).required(),vatMarkup:(0,B.Rx)().transform((function(e){return isNaN(e)?null:e})).nullable()}),W=n(85893);function G(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?G(Object(n),!0).forEach((function(t){(0,c.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):G(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var X=function(e){e.categories,e.currency;var t=e.defaultValues,n=e.entityId,r=e.submit,i=e.serviceRateExpenses,o=e.showRecurring;null!==t&&void 0!==t&&t.vat&&"20"!==(null===t||void 0===t?void 0:t.vat)&&(t.vatMarkup=t.vat,t.vat="custom");var a=(0,$.cI)({defaultValues:K({vat:"20"},t),resolver:(0,N.S)(Y)}),c=a.control,s=a.errors,u=a.handleSubmit,d=a.register,l=(0,a.watch)("vat"),p=[{id:"admin",label:x.H2.name,value:"admin"},{id:"supplier",label:"Supplier",value:"supplier"}],m={control:c,errors:s,register:d};return(0,W.jsxs)(J.Z,{id:"offCanvasForm",handleSubmit:u(r),children:[(0,W.jsx)(H.Z,K(K({},m),{},{name:"paid",data:p,legend:"Paid by"})),(0,W.jsx)(U.Z,K(K({},m),{},{name:"amount",label:"Unit Cost",vat:"Ex VAT"})),(0,W.jsx)(M.Z,{label:"Units",children:(0,W.jsx)(F.Z,K(K({},m),{},{name:"unit"}))}),(0,W.jsx)(H.Z,K(K({},m),{},{name:"vat",data:[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],legend:"VAT"})),"custom"===l&&(0,W.jsx)(V.Z,K(K({},m),{},{label:"Custom VAT",name:"vatMarkup"})),(0,W.jsx)(V.Z,K(K({},m),{},{label:"Markup ".concat(i?"(Service Rate Expenses and Material : ".concat(i,"%)"):""),name:"markup"})),n&&(0,W.jsx)(M.Z,{label:"Occurred At",children:(0,W.jsx)(z.M,K(K({},m),{},{name:"occurredAt",placeholderText:"Click to select date"}))}),(0,W.jsx)(Q.P,K(K({},m),{},{errors:K({},s),label:"Category",name:"categoryId",type:"expenseCategory"})),(0,W.jsx)(M.Z,{label:"Description",children:(0,W.jsx)(L.Z,K(K({},m),{},{name:"description",rows:2}))}),o&&(0,W.jsx)(H.Z,K(K({},m),{},{name:"recurring",data:[{id:"recurring",label:"Recurring",value:"recurring"},{id:"nextInvoice",label:"Only for next invoice",value:"nextInvoice"}]})),t.id&&(0,W.jsx)(F.Z,K(K({},m),{},{name:"id",type:"hidden"}))]})};X.defaultProps={currency:"GBP",serviceRateExpenses:0,showRecurring:!1};var ee=n(88261),te=n(38596);function ne(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function re(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ne(Object(n),!0).forEach((function(t){(0,c.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ne(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ie=function(e){var t,n,r,i=e.currency,o=e.enableUpdate,a=e.entity,c=e.entityId,d=e.job,v=e.refetchParent,b=e.tab,$=e.withDetails,N=e.showRecurring,J=(0,p.useContext)(w.Z).hasRole,H=(0,p.useContext)(I.Z),U=(0,E.E)(d,"invoiceSent"),M=J("customer")&&!U,F=!d||(J(["admin"])&&!(0,E.E)(d,["validated","unvalidated"])||J(["admin","supplier"])&&!(0,E.E)(d,"reportSent")||o),V=(0,te.B)("serviceRateExpenses",null===d||void 0===d?void 0:d.financeLogs,null===d||void 0===d||null===(t=d.customer)||void 0===t||null===(n=t.meta)||void 0===n||null===(r=n.finance)||void 0===r?void 0:r.serviceRateExpenses)||0,L=b||(!J("admin")&&J("supplier")?"supplier":"admin"),z=(0,m.a)(j,{variables:{entity:a,entityId:c,jobId:null===d||void 0===d?void 0:d.id},skip:M}),Q=z.data,B=(Q=void 0===Q?{expenses:[]}:Q).expenses,Y=z.loading,G=z.refetch,K=(0,ee.E)(B,0,L),ne=K.preparedExpenses,ie=K.totalExpenses,oe=K.totalExpensesExVAT,ae=(0,f.D)(g,{onCompleted:function(e){v?v():G()}}),ce=(0,u.Z)(ae,1)[0],se=(0,f.D)(h,{onCompleted:function(e){H.close(),v?v():G()}}),ue=(0,u.Z)(se,1)[0],de=(0,f.D)(y,{onCompleted:function(e){H.close(),v?v():G()}}),le=(0,u.Z)(de,1)[0],pe=function(){var e=(0,s.Z)(l().mark((function e(t){var n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("custom"===t.vat&&(t.vat=t.vatMarkup),n=t.unit*t.amount,r=n*(t.markup/100)+n,t.total=r*(t.vat/100)+r,delete t.vatMarkup,t.categoryId=t.categoryId.value,!t.id){e.next=11;break}return e.next=9,le({variables:{id:t.id,changes:t}});case 9:e.next=16;break;case 11:return t.jobId=null===d||void 0===d?void 0:d.id,t.entity=a,t.entityId=c,e.next=16,ue({variables:{objects:t}});case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),me=function(e){var t=e.item?re({},null===e||void 0===e?void 0:e.item):{markup:V};null!==t&&void 0!==t&&t.vat&&(t.vat=String(t.vat)),H.show({content:(0,W.jsx)(X,{currency:i,defaultValues:t,entityId:c,submit:pe,serviceRateExpenses:V,showRecurring:N}),title:"Expenses"})},fe=[{context:"secondary",icon:["fas","edit"],onClick:function(e,t){return me(t)},tooltip:"Edit"},{context:"info",icon:["fas","file-upload"],numberOverlay:"mediaCount",onClick:function(e,t){return function(e){H.show({content:(0,W.jsx)(T.G,{entity:"Expenses",entityId:e.item.id}),submit:!1,title:"Media"})}(t)},tooltip:"Media"},{context:"danger",icon:["fas","trash"],onClick:function(e,t){return function(e,t){e.preventDefault(),e.stopPropagation(),ce({variables:{id:t.item.id}})}(e,t)},tooltip:"Delete"}],ve=[{text:"Description"},{formatter:function(e){var t=e.row;return(0,Z.Z)(t.total,i)},text:"Total"},{text:"Occurred At",hidden:!c},{text:"Paid By"},{formatter:O.Z,formatterData:fe,hidden:!F,text:"Actions"},{hidden:!0},{hidden:!0}],be=function(){return(0,W.jsx)(S.Z,{children:(0,W.jsx)(_.Z,{context:"secondary",content:"Add",onClick:me,size:"sm"})})},he=function(){return(0,W.jsxs)(W.Fragment,{children:[!$&&(0,W.jsx)(A.Z,{content:"Expenses",tag:"h3"}),(0,W.jsxs)(C.Z,{children:[(0,W.jsx)(D.Z,{md:6,children:(0,W.jsx)(k.Z,{content:"Total",text:(0,Z.Z)(oe,i)})}),(0,W.jsx)(D.Z,{md:6,children:(0,W.jsx)(k.Z,{content:"VAT Total",text:(0,Z.Z)(ie,i)})})]}),(0,W.jsx)(R.Z,{columns:ve,loading:Y,rows:B.map((function(e){var t,n;return{description:e.description,total:ne.find((function(t){return t.id===e.id})).total,occurredAt:(0,P.Z)(e.occurredAt),paid:"supplier"===e.paid?"Supplier":x.H2.name,actions:"",item:re(re(re({},e),{occurredAt:new Date(e.occurredAt)}),{categoryId:{label:null===(t=e.category)||void 0===t?void 0:t.name,value:e.categoryId}}),mediaCount:null===(n=e.media)||void 0===n?void 0:n.length}}))}),F&&!$&&(0,W.jsx)(S.Z,{align:"flex-end",children:(0,W.jsx)(_.Z,{context:"secondary",content:"Add",onClick:me,size:"sm"})})]})};return $?(0,W.jsx)(q.Z,{toolbar:F&&(0,W.jsx)(be,{}),open:!0,title:"Expenses",children:he()}):he()};ie.defaultProps={currency:"GBP",enableUpdate:!1,withDetails:!0,showRecurring:!1}},88261:function(e,t,n){"use strict";n.d(t,{E:function(){return r}});var r=function(e,t,n){var r=0,i=0;return{preparedExpenses:null===e||void 0===e?void 0:e.map((function(e){var o=e.amount;"supplier"===n&&"supplier"!==e.paid&&(o=0),"supplier"!==n&&(o+=e.markup/100*o,o/=1-t/100);var a=o*(e.unit||1),c=a+a*(e.vat/100);return i+=a,r+=c,{id:e.id,name:e.description,unitCost:o,price:a,total:c,unit:e.unit||1,vatAmount:a*(e.vat/100),vatRate:e.vat/100,markup:e.markup}})),totalExpenses:r,totalExpensesExVAT:i}}},49313:function(e,t,n){"use strict";n.d(t,{n:function(){return f}});var r=n(92809),i=n(80284),o=n(69128),a=n(34868),c=n(11570),s=n(78215),u=n(2356),d=n(7863),l=n(85893);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var f=function(e){var t=e.errors,n=e.register,r=e.pricingWatch,p=e.hasServiceRate,f={register:n,errors:t};return(0,l.jsxs)(i.Z,{dataSet:{"data-cy":"pricing"},open:!0,title:"Pricing",children:[(0,l.jsx)(o.Z,m(m({},f),{},{data:d.Hu,legend:"Pricing",name:"pricing"})),"time-materials"===r&&(0,l.jsx)(a.Z,m(m({},f),{},{label:"Spend Threshold",name:"customerSpendThreshold",vat:"Ex VAT"})),"fixed"===r&&(0,l.jsxs)(l.Fragment,{children:[p?(0,l.jsx)(c.Z,{content:"This Customer has the service rate, The customer cost is calculated with it",context:"info"}):(0,l.jsx)(a.Z,m(m({},f),{},{label:"Customer",name:"amount",vat:"Ex VAT"})),(0,l.jsxs)(s.Z,{children:[(0,l.jsx)(u.Z,{sm:12,md:6,children:(0,l.jsx)(a.Z,m(m({},f),{},{label:"Supplier labour amount",name:"supplierLabourAmount",vat:"Ex VAT"}))}),(0,l.jsx)(u.Z,{sm:12,md:6,children:(0,l.jsx)(a.Z,m(m({},f),{},{label:"Supplier materials amount",name:"supplierMaterialsAmount",vat:"Ex VAT"}))})]})]}),(0,l.jsx)(o.Z,m(m({},f),{},{data:d.ck,legend:"Payment Method",name:"paymentMethod"}))]})}},3391:function(e,t,n){"use strict";n.d(t,{t:function(){return d}});var r=n(92809),i=n(80284),o=n(95146),a=n(72197),c=n(85893);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(e){var t=e.control,n=e.errors,r={control:t,errors:n,register:e.register};return(0,c.jsxs)(i.Z,{dataSet:{"data-cy":"taxonomy"},open:!0,title:"Service",children:[(0,c.jsx)(a.l,u(u({},r),{},{label:"Cost category",name:"costCategorySelected",type:"costCategory"})),(0,c.jsx)(o.P,u(u({},r),{},{errors:u({},n),name:"serviceSelected",label:"Service",type:"service"}))]})}},7566:function(e,t,n){"use strict";n.d(t,{X:function(){return O}});var r=n(92809),i=n(67294),o=n(80284),a=n(65375),c=n(46482),s=n(69128),u=n(78215),d=n(2356),l=n(84550),p=n(76800),m=n(7863),f=[{text:"Select...",value:""},{text:"Today",value:"today"},{text:"This week",value:"thisWeek"},{text:"This month",value:"thisMonth"},{text:"Next Three month",value:"nextThreeMonth"}],v=n(4135),b=n(43703),h=n(11640),y=n(83894),j=n(69119),g=n(67090),x=n(85893);function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function I(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Z=m.KB,O=function(e){var t=e.control,n=e.errors,r=e.hasRole,w=e.query,O=e.register,S=e.setValue,_=e.timingWatch,P=e.watch,A={control:t,errors:n,register:O},C=r("customer")&&!r("admin"),D=P("pricing"),k=P("timingStart"),R=P("timingEnd"),q=P("multipleDays"),E=P("timeSpan"),T=P("timing");(0,i.useEffect)((function(){C&&(Z=m.KB.filter((function(e){return"at"!==e.value})),S("timing","between")),E&&$({time:E,setValue:S})}),[E]),(0,i.useEffect)((function(){"at"===T&&S("timeSpan","")}),[T]);var $=function(e){var t,n,r=e.time,i=e.setValue,o=function(){var e=(0,v.Z)(new Date),t=(0,b.Z)(new Date);return{monthEnd:e,nextThreeEnd:(0,v.Z)((0,h.Z)(new Date(t),2)),todayEnd:(0,y.Z)(new Date),todayStart:(0,j.Z)(new Date),weekEnd:(0,g.Z)(new Date)}}(),a=o.monthEnd,c=o.todayStart,s=o.weekEnd,u=o.todayEnd,d=o.nextThreeEnd;switch(r){case"today":t=c,n=u;break;case"thisWeek":t=c,n=s;break;case"thisMonth":t=c,n=a;break;case"nextThreeMonth":t=c,n=d}i("timing","between"),i("timingStart",t),i("timingEnd",n)},N=function(e){var t=k?new Date(k):new Date,n=new Date(e);return t.getTime()<n.getTime()};return(0,x.jsxs)(o.Z,{dataSet:{"data-cy":"timing"},open:!0,title:"Timing",children:[!(null!==w&&void 0!==w&&w.id)&&S&&(0,x.jsx)(a.Z,{label:"Select Time span",children:(0,x.jsx)(c.Z,I(I({},A),{},{name:"timeSpan",options:f}))}),(0,x.jsx)(s.Z,I(I({},A),{},{data:Z,legend:"Timing",name:"timing"})),(0,x.jsxs)(u.Z,{children:[(0,x.jsxs)(d.Z,{md:12,children:[(0,x.jsx)(a.Z,{label:"Start time"}),(0,x.jsx)(p.M,I(I({},A),{},{dateFormat:"d MMM yyyy HH:mm",maxDate:R?new Date(R):null,minDate:new Date,filterTime:function(e){var t=new Date,n=new Date(e);return t.getTime()<n.getTime()},name:"timingStart",placeholder:"Click to select Start time",showTimeSelect:!0,todayButton:!1}))]}),"at"!==_&&(0,x.jsxs)(d.Z,{md:12,children:[(0,x.jsx)(a.Z,{label:"End time"}),(0,x.jsx)(p.M,I(I({},A),{},{dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,minDate:k?new Date(k):new Date,filterTime:N,name:"timingEnd",showTimeSelect:!0,todayButton:!1}))]})]}),k instanceof Date&&"fixed"===D&&(0,x.jsx)(l.Z,I(I({},A),{},{data:[{id:"multipleDays",label:"Multiple days"}],name:"multipleDays"})),q&&(0,x.jsx)(a.Z,{label:"End Date",children:(0,x.jsx)(p.M,I(I({},A),{},{dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!0,filterTime:N,minDate:k?new Date(k):new Date,name:"endDate",showTimeSelect:!0,todayButton:!1}))}),r("admin")&&(0,x.jsx)(l.Z,I(I({},A),{},{data:[{id:"allowTimingNormalHours",label:"Allow premium rates to be used",value:"allowTimingNormalHours"}],name:"allowTimingNormalHours"}))]})}},56572:function(e,t,n){"use strict";n.d(t,{f:function(){return d}});var r=n(92809),i=n(30266),o=n(64687),a=n.n(o),c=n(53256);n(29575);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(){var e=(0,i.Z)(a().mark((function e(t){var n,r,i,o,s,d,l,p,m,f;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.adminId,o=t.client,e.next=3,o.query({query:c.mP,variables:{id:i}});case 3:return s=e.sent,d=s.data,l=(d=void 0===d?{account:{}}:d).account,p=(null===(n=l.meta)||void 0===n||null===(r=n.finance)||void 0===r?void 0:r.invoicePointer)&&u({},l.meta.finance)||{invoiceStart:1,invoicePointer:1},m=Number(p.invoicePointer||p.invoiceStart),p.invoicePointer=m+1,f={meta:u(u({},l.meta),{finance:p})},e.abrupt("return",{invoiceNumber:m,accountMeta:f});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},53256:function(e,t,n){"use strict";n.d(t,{mP:function(){return s},aO:function(){return u}});var r,i,o,a=n(52209),c=n(54397),s=((0,c.Ps)(r||(r=(0,a.Z)(["\n  mutation UpdateJob(\n    $accountId: Int!\n    $account: Account_set_input\n    $id: Int!\n    $changes: Job_set_input\n    $entries: [AccountEntry_insert_input!]!\n    $timing: [JobTiming_insert_input!]!\n    $updatePointer: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $account)\n      @include(if: $updatePointer) {\n      id\n    }\n    insert_AccountEntry(objects: $entries) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,c.Ps)(i||(i=(0,a.Z)(["\n  query GetInvoicePointer($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n      meta\n    }\n  }\n"])))),u=(0,c.Ps)(o||(o=(0,a.Z)(["\n  mutation createInvoiceJob($invoiceJobInput: InvoiceJobInput!) {\n    createInvoiceJob(invoiceJobInput: $invoiceJobInput) {\n      data\n    }\n  }\n"])))},29918:function(e,t,n){"use strict";n.d(t,{eW:function(){return l},Hj:function(){return p},FB:function(){return m}});var r=n(83789),i=n(92809),o=n(30266),a=n(64687),c=n.n(a),s=n(84774);function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){(0,i.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var l=function(){var e=(0,o.Z)(c().mark((function e(t,n,r){var i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p(t,n,r);case 2:i=e.sent,t.mutate({mutation:s.qD,variables:{id:n.id,changes:{meta:i}}});case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),p=function(){var e=(0,o.Z)(c().mark((function e(t,n,i){var o,a,s,u,l;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,m(t,n.id);case 2:return o=e.sent,a=o.financeSupplier,s=o.financeCustomer,delete(u=d({},n.meta)).revisions,(l=d({},n.meta)).revisions?l.revisions=(0,r.Z)(n.meta.revisions):l.revisions=[],l.revisions.push({user:i||"system update",date:new Date,data:u}),l.supplierInvoice=a,l.customerVATInvoice=s,e.abrupt("return",l);case 13:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),m=function(){var e=(0,o.Z)(c().mark((function e(t,n){var r,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.mutate({mutation:s.iU,variables:{jobId:n,invoiceType:"supplier"}}).then((function(e){var t;r=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData}));case 2:return e.next=4,t.mutate({mutation:s.iU,variables:{jobId:n,invoiceType:"customerVat"}}).then((function(e){var t;i=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData}));case 4:return e.abrupt("return",{financeSupplier:r,financeCustomer:i});case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},85997:function(e,t,n){"use strict";n.d(t,{Lq:function(){return d},yG:function(){return l},Io:function(){return p}});var r=n(92809),i=n(83789),o=n(73165),a=n(18862),c=n(6608);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(e,t){var n=e.itemType,r=e.paymentStatus;return"paymentReceipt"===n?t.COLOUR.black:"creditNote"===n?t.COLOUR.dark:"paid"===r?t.COLOUR.success:"partial"===r?t.COLOUR.female:t.COLOUR.danger},l=function(e,t){var n=t||{},r=n.numberPrefix,i=void 0===r?"":r,s=n.numberSuffix,u=void 0===s?"":s;return e.map((function(e){var t,n,r,s,d,l,p,m,f,v,b,h,y,j,g,x,w=(null===e||void 0===e||null===(t=e.invoice)||void 0===t||null===(n=t.reconciledAmounts)||void 0===n||null===(r=n.aggregate)||void 0===r||null===(s=r.sum)||void 0===s?void 0:s.amount)||null;return{itemType:(0,o.Z)(e.type),invoice:"Location"===e.entity?"PM / ".concat((null===e||void 0===e?void 0:e.meta.invoiceNumber)||""):null!==e&&void 0!==e&&null!==(d=e.job)&&void 0!==d&&d.number?"".concat((0,c.y)((null===e||void 0===e||null===(l=e.job)||void 0===l?void 0:l.type)||null)," ").concat(i," ").concat(null===e||void 0===e||null===(p=e.job)||void 0===p?void 0:p.number," ").concat(u," / ").concat(null===e||void 0===e||null===(m=e.invoice)||void 0===m?void 0:m.id):null,reference:(null===e||void 0===e||null===(f=e.job)||void 0===f?void 0:f.reference)||(null===(v=e.meta)||void 0===v?void 0:v.paymentReference),date:(0,a.Z)(e.createdAt),daysOutstanding:null===e||void 0===e?void 0:e.outstandingdays,status:null===e||void 0===e||null===(b=e.job)||void 0===b?void 0:b.status,service:null===e||void 0===e||null===(h=e.job)||void 0===h||null===(y=h.service)||void 0===y?void 0:y.name,address:null===e||void 0===e||null===(j=e.job)||void 0===j||null===(g=j.location)||void 0===g?void 0:g.name,debit:e.debit,credit:e.credit,reconciledAmount:null!==w&&void 0!==w?w:0,amountOutstanding:"invoice"===e.type?e.debit-w:null,paymentStatus:"-",comment:null===(x=e.meta)||void 0===x?void 0:x.comment}}))},p=function(e){var t=e.accountId,n=e.from,r=void 0===n?null:n,o=e.jobNumber,a=e.locationId,c=e.outstandingLevel,s=e.paymentStatus,d=e.to,l=void 0===d?null:d,p=e.type,m={_or:[{Invoice:{invoiceType:{_neq:"supplier"}}},{type:{_in:["paymentReceipt","creditNote"]}}]},f={},v=[],b=[],h=[];return a&&(v=[{_and:[{Invoice:{entity:{_eq:"Location"},entityId:{_eq:a}}}]},{_and:[{Invoice:{Job:{Location:{id:{_eq:a}}}}}]}]),p&&(m.type={_in:[].concat((0,i.Z)(p),["invoice"])}),s&&(m.paymentStatus={_in:(0,i.Z)(s)}),t&&(m.accountId={_eq:t}),c&&(m.outstandingdays={_gte:c.split("-")[0]||null,_lte:c.split("-")[1]||null}),(l||r)&&(h=[{_and:[{_or:[{_and:[{createdAt:{_gte:r}},{createdAt:{_lte:l}}]}]}]}]),o&&(b=[{_and:[{_or:[{_and:[{Invoice:{id:{_eq:o}}}]},{_and:[{Job:{number:{_ilike:o}}}]}]}]}]),(v.length>0||b.length>0||h.length>0)&&(f={_and:[].concat((0,i.Z)(v),(0,i.Z)(b),(0,i.Z)(h))}),u(u({},m),f)}},13886:function(e,t,n){"use strict";n.d(t,{q:function(){return L}});var r=n(92809),i=n(30266),o=n(80318),a=n(64687),c=n.n(a),s=n(67294),u=n(93633),d=n(75709),l=n(38094),p=n(75472),m=n.n(p),f=n(42283),v=n(79665),b=n(24237),h=n(43566),y=n(80880),j=n(58448),g=n(71247),x=n(14347),w=n(55657),I=n(80285),Z=n(18862),O=n(97202),S=n(78215),_=n(2356),P=n(65375),A=n(34868),C=n(83528),D=n(34610),k=n(52002),R=n(7720),q=n(11570),E=n(76800),T=n(380),$=n(12517),N=n(7145),J=n(19501),H=(0,J.Ry)().shape({dateReceived:(0,J.hT)().required(),paymentReference:(0,J.Z_)().required(),amountReceived:(0,J.Rx)().required(),comment:(0,J.Z_)(),connectedAmount:(0,J.IX)().of((0,J.Ry)().shape({jobId:(0,J.Rx)().required(),entityId:(0,J.Rx)().required(),outstandingAmount:(0,J.Rx)().required(),amount:(0,J.Rx)().max((0,J.iH)("outstandingAmount")).min(0).required(),isPPM:(0,J.O7)().required()})).required()}),U=n(85997),M=n(85893);function F(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function V(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?F(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):F(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var L=function(e){var t=e.accountId,n=e.adminId,r=(e.jobId,e.jobNumber),a=e.refetch,p=e.toggleShow,b=(0,s.useContext)(h.Z).user,J=(0,s.useContext)(y.Z),F=(0,s.useState)({item:"date",order:"asc"}),L=F[0],Y=F[1],W=(0,s.useState)(!1),G=W[0],K=W[1],X=(0,s.useState)(0),ee=X[0],te=X[1],ne=(0,s.useState)(),re=ne[0],ie=ne[1],oe=(0,f.cI)({resolver:(0,v.S)(H)}),ae=oe.control,ce=oe.errors,se=oe.getValues,ue=oe.handleSubmit,de=oe.register,le=oe.setValue;(0,f.Dq)({control:ae,name:"connectedAmount"});var pe=(0,f.qo)({control:ae,name:"amountReceived",defaultValue:0}),me=(0,u.a)(l.v8,{variables:{where:(0,U.Io)({accountId:t,adminId:n,jobNumber:r?"".concat(r):null,invoiceNumber:r?Number(r):null,paymentStatus:["partial","unpaid"]})}}).data,fe=(me=void 0===me?{accountEntries:[]}:me).accountEntries,ve=(0,d.D)(l.qD,{onCompleted:function(e){a(),p()}}),be=(0,o.Z)(ve,1)[0],he=(0,d.D)(l.tT,{onCompleted:function(e){a(),p()}}),ye=(0,o.Z)(he,1)[0],je=(0,d.D)(l.Vr),ge=(0,o.Z)(je,1)[0],xe=function(){var e=(0,i.Z)(c().mark((function e(n){var r,i,o,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(Number(ee).toFixed(2)>Number(pe).toFixed(2))){e.next=2;break}return e.abrupt("return",ie("you can not reconcile more than payment amount"));case 2:if(!(Number(ee).toFixed(2)<Number(pe).toFixed(2))){e.next=4;break}return e.abrupt("return",ie("you can not reconcile less than payment amount"));case 4:return r=n.connectedAmount.filter((function(e){return e.amount>0})),i={accountId:t,balance:0,credit:parseFloat(n.amountReceived).toFixed(2),currencyId:(0,T.K)(t),debit:0,entity:"PaymentReceipt",meta:{paymentReference:n.paymentReference,comment:n.paymentReference},type:"paymentReceipt",paymentStatus:"paymentReceipt",dateReceived:(0,N.v)(n.dateReceived),AccountEntry_Invoice:{data:r.map((function(e){return{invoiceId:e.entityId}}))}},e.next=8,ge({variables:{object:i}}).then((function(e){return e.data.insert_AccountEntry_one.id}));case 8:o=e.sent,a="customerPaid",r.forEach((function(e){var t=e.amount,n=e.entityId,r=e.jobId,i=e.isPPM,c={creditEntity:"PaymentReceipt",creditEntityId:o,debitEntity:"Invoice",debitEntityId:n,amount:t},s={changes:{},id:parseInt(r),insertTiming:!1,reconciliation:c,timing:{}};if(i){var u=fe.find((function(e){return e.id===n}));if(t>=Number(u.debit)){var d={changes:{status:a,paid:!0},ids:u.meta.jobIds.split(",").map((function(e){return parseInt(e,10)}))};ye({variables:d})}}else{var l,p,m,f,v=fe.find((function(e){return e.entityId===n}));t>=Number(v.debit-(null===v||void 0===v||null===(l=v.invoice)||void 0===l||null===(p=l.reconciledAmounts)||void 0===p||null===(m=p.aggregate)||void 0===m||null===(f=m.sum)||void 0===f?void 0:f.amount)||0)&&(s.changes.status=a,s.changes.paid=!0,s.insertTiming=!0,s.timing={status:a,jobId:parseInt(r),userId:b.id})}be({variables:s})}));case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),we={control:ae,errors:ce,register:de},Ie=function(e){return(0,M.jsx)(Q,{onClick:function(){return function(e){J.show({title:"Job Details",content:(0,M.jsx)($.g,{jobId:e.jobId,toggleShow:J.close}),submit:!1,width:"50%"})}(e)},children:e.invoiceNumber})},Ze=function(){var e=se().connectedAmount.reduce((function(e,t){return e+Number(t.amount)}),0);te(e),ie()},Oe=function(){Ze()},Se=function(e){var t=e.amount,n=e.connectedAmount,r=(e.id,e.entity),i=e.entityId,o=e.jobId,a=e.index,c=n===t?"success":"info";return le("connectedAmount[".concat(a,"].jobId"),o),le("connectedAmount[".concat(a,"].entityId"),i),le("connectedAmount[".concat(a,"].isPPM"),!1),le("connectedAmount[".concat(a,"].outstandingAmount"),t),"Location"===r&&le("connectedAmount[".concat(a,"].isPPM"),!0),n||(c="danger"),G&&Oe(),(0,M.jsxs)(j.Z,{children:[(0,M.jsx)(g.Z,V(V({},we),{},{name:"connectedAmount[".concat(a,"].jobId"),type:"hidden"})),(0,M.jsx)(g.Z,V(V({},we),{},{name:"connectedAmount[".concat(a,"].entityId"),type:"hidden"})),(0,M.jsx)(g.Z,V(V({},we),{},{name:"connectedAmount[".concat(a,"].isPPM"),type:"hidden"})),(0,M.jsx)(g.Z,V(V({},we),{},{name:"connectedAmount[".concat(a,"].outstandingAmount"),type:"hidden"})),(0,M.jsx)(B,V(V({},we),{},{context:G?c:null,name:"connectedAmount[".concat(a,"].amount"),onChange:Oe,size:"sm",type:"number",defaultValue:n})),(0,M.jsx)(x.Z,{context:"light","data-tip":"Button",onClick:function(){!function(e,t){le(e,t),Ze()}("connectedAmount[".concat(a,"].amount"),t)},size:"xs",title:"copy amount",children:(0,M.jsx)(w.Z,{context:"secondary",icon:"clone",size:"lg"})})]})},_e=[{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Number",formatter:function(e){var t=e.row;return Ie(t)}},{sortable:!0,sortName:"date",text:"Date"},{sortable:!0,sortName:"daysOutstanding",text:"Days Outstanding"},{sortable:!0,sortName:"amount",text:"Amount Outstanding",formatter:function(e){var t=e.row;return(0,I.Z)(t.amount)}},{text:"Reconciled Amount",formatter:function(e){var t=e.row;return Se(t)}}];return(0,M.jsxs)(O.Z,{id:"offCanvasForm",handleSubmit:ue(xe),children:[(0,M.jsxs)(S.Z,{children:[(0,M.jsxs)(_.Z,{md:6,children:[(0,M.jsx)(P.Z,{label:"Date Received"}),(0,M.jsx)(E.M,V(V({},we),{},{name:"dateReceived"}))]}),(0,M.jsx)(_.Z,{md:6,children:(0,M.jsx)(P.Z,{label:"Payment Reference",children:(0,M.jsx)(g.Z,V(V({},we),{},{name:"paymentReference"}))})})]}),(0,M.jsxs)(S.Z,{children:[(0,M.jsx)(_.Z,{md:6,children:(0,M.jsx)(z,{align:"center",children:(0,M.jsx)(A.Z,V(V({},we),{},{name:"amountReceived",label:"Amount Received",vat:!0}))})}),(0,M.jsx)(_.Z,{md:6,children:(0,M.jsx)(P.Z,{label:"Comment",children:(0,M.jsx)(C.Z,V(V({},we),{},{name:"comment",rows:2}))})})]}),(0,M.jsx)(P.Z,{label:"Auto reconcile",children:(0,M.jsx)(D.Z,V(V({},we),{},{onToggle:function(e){K(!G)},size:"sm",toggled:G}))}),(0,M.jsx)(k.Z,{columns:_e,rows:function(){var e;return e=fe.filter((function(e){return e.debit>0})).map((function(e){var t,n,r,i,o,a,c,s,u,d,l,p=e.debit-((null===e||void 0===e||null===(t=e.invoice)||void 0===t||null===(n=t.reconciledAmounts)||void 0===n||null===(r=n.aggregate)||void 0===r||null===(i=r.sum)||void 0===i?void 0:i.amount)||0);return{id:e.id,jobId:e.jobId,entity:null===e||void 0===e||null===(o=e.invoice)||void 0===o?void 0:o.entity,entityId:null===(a=e.invoice)||void 0===a?void 0:a.id,invoiceNumber:"Location"===(null===e||void 0===e||null===(c=e.invoice)||void 0===c?void 0:c.entity)?"PM / ".concat(null===(s=e.meta)||void 0===s||null===(u=s.invoiceNumbers)||void 0===u?void 0:u[0]):e.jobId?"".concat(null===(d=e.job)||void 0===d?void 0:d.number," / ").concat(null===(l=e.invoice)||void 0===l?void 0:l.id):null,date:(0,Z.Z)(e.createdAt),daysOutstanding:e.outstandingdays,amount:p,connectedAmount:0}})),m()(e,[L.item],[L.order]).map((function(e,t){return V(V({index:t},e),{},{amount:Number(null===e||void 0===e?void 0:e.amount).toFixed(2)})}))}(),sort:L,setSort:function(e){return Y(V({},e))}}),(0,M.jsxs)(z,{reverse:!0,pr:!0,children:[(0,M.jsx)(R.Z,{content:"Sum: ".concat((0,I.Z)(ee)),context:Number(ee).toFixed(2)===Number(pe).toFixed(2)?"success":"danger"}),re&&(0,M.jsx)(q.Z,{content:re,context:"danger"})]})]})},z=(0,b.ZP)(S.Z).withConfig({displayName:"paymentReceivedForm__StyledRow",componentId:"sc-1wl4d2h-0"})(["padding-left:1rem;padding-right:",";flex-flow:",";"],(function(e){return e.pr?"5rem":null}),(function(e){return e.reverse?"row-reverse":null})),Q=b.ZP.a.withConfig({displayName:"paymentReceivedForm__StyledLink",componentId:"sc-1wl4d2h-1"})(["color:",";cursor:pointer;"],(function(e){return e.theme.COLOUR.secondary})),B=(0,b.ZP)(g.Z).withConfig({displayName:"paymentReceivedForm__StyledInput",componentId:"sc-1wl4d2h-2"})(["border:1px solid ",";"],(function(e){return e.theme.COLOUR[e.context]}))},38094:function(e,t,n){"use strict";n.d(t,{Dn:function(){return g},Vr:function(){return x},v8:function(){return w},tT:function(){return I},qD:function(){return Z},zn:function(){return O},to:function(){return S},HR:function(){return _},DI:function(){return P}});var r,i,o,a,c,s,u,d,l,p,m,f,v,b,h,y=n(52209),j=n(54397),g=(0,j.Ps)(r||(r=(0,y.Z)(["\n  query GetFinance($accountId: Int!) {\n    financial: Account_by_pk(id: $accountId) {\n      name\n      website\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n      bankAccounts: BankAccounts {\n        id\n        stripeId\n        bank\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        default\n        createdAt\n      }\n      cards: Cards {\n        id\n        stripeId\n        type\n        last4\n        expYear\n        expMonth\n        status\n        default\n        createdAt\n      }\n    }\n  }\n"]))),x=(0,j.Ps)(i||(i=(0,y.Z)(["\n  mutation AddPaymentReceipt($object: AccountEntry_insert_input!) {\n    insert_AccountEntry_one(object: $object) {\n      id\n    }\n  }\n"]))),w=((0,j.Ps)(o||(o=(0,y.Z)(["\n  mutation UpdateFinancial($id: Int!, $changes: Financial_set_input) {\n    update_Financial_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      approvalThreshold\n      arrangementFee\n      serviceRate\n      spendThreshold\n      stripeId\n    }\n  }\n"]))),(0,j.Ps)(a||(a=(0,y.Z)(["\n  mutation UpdateFinancial($id: Int!, $changes: Financial_set_input) {\n    update_Financial_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      creditLimit\n      creditRating\n    }\n  }\n"]))),(0,j.Ps)(c||(c=(0,y.Z)(["\n  query GetBalance($accountId: Int) {\n    lastEntry: AccountEntry(\n      where: { accountId: { _eq: $accountId } }\n      limit: 1\n      order_by: { createdAt: desc }\n    ) {\n      balance\n    }\n  }\n"]))),(0,j.Ps)(s||(s=(0,y.Z)(["\n  mutation UpdateFinancial($id: Int!, $changes: Financial_set_input) {\n    update_Financial_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      invoicing\n      defaultPaymentMethod\n    }\n  }\n"]))),(0,j.Ps)(u||(u=(0,y.Z)(["\n  query GetAccountEntries(\n    $accountId: Int!\n    $adminId: Int!\n    $from: timestamptz\n    $invoiceNumber: Int\n    $jobId: String\n    $limit: Int\n    $locationId: Int\n    $offset: Int\n    $outstandingLevel: Int\n    $to: timestamptz\n    $type: [String!]\n  ) {\n    accountEntries: getDashboard_AccountEntry_calculatebalance(\n      args: {\n        accountId_param: $accountId\n        adminId: $adminId\n        endTime: $to\n        invoiceNumber_param: $invoiceNumber\n        jobNumber_param: $jobId\n        locationId_param: $locationId\n        outstanding_levels: $outstandingLevel\n        startTime: $from\n      }\n      limit: $limit\n      offset: $offset\n      order_by: { createdAt: desc }\n      where: { paymentStatus: { _in: $type } }\n    ) {\n      id\n      outstandingAmount\n      type\n      entryId\n      entity\n      entityId\n      jobId\n      number: job_number\n      jobType: job_type\n      currencyId\n      createdAt\n      balance\n      debit\n      credit\n      accountId\n      updatedAt\n      status\n      meta\n      location\n      service\n      reference\n      invoice\n      paid\n      outstandingDays\n      paymentStatus\n      reconciledAmounts\n    }\n    meta: getDashboard_AccountEntry_calculatebalance_aggregate(\n      args: {\n        accountId_param: $accountId\n        adminId: $adminId\n        endTime: $to\n        invoiceNumber_param: $invoiceNumber\n        jobNumber_param: $jobId\n        locationId_param: $locationId\n        outstanding_levels: $outstandingLevel\n        startTime: $from\n      }\n      where: { paymentStatus: { _in: $type } }\n    ) {\n      aggregate {\n        debitTotal: sum {\n          debit\n        }\n        creditTotal: sum {\n          credit\n        }\n        reconciledAmounts: sum {\n          amount: reconciledAmounts\n        }\n        totalCount: count\n      }\n    }\n  }\n"]))),(0,j.Ps)(d||(d=(0,y.Z)(["\n  query GetAccountEntries(\n    $where: AccountEntry_bool_exp\n    $limit: Int\n    $offset: Int\n    $accountId: Int\n  ) {\n    accountEntries: AccountEntry(\n      limit: $limit\n      offset: $offset\n      order_by: { createdAt: desc }\n      where: $where\n    ) {\n      id\n      outstandingAmount\n      outstandingdays\n      type\n      entryId\n      entity\n      entityId\n      jobId\n      currencyId\n      createdAt\n      balance\n      debit\n      credit\n      accountId\n      updatedAt\n      status\n      paymentStatus\n      meta\n      invoices: AccountEntry_Invoice {\n        invoiceId\n        Invoice {\n          Job {\n            id\n          }\n        }\n      }\n      invoice: Invoice {\n        id\n        items\n        status\n        createdAt\n        rebate\n        meta\n        totals\n        invoiceType\n        invoiceNumber\n        invoiceDate\n        expenses\n        entityId\n        entity\n        configs\n        amounts\n        addendum\n        addresses\n        adminId\n        reconciledAmounts: Reconciliations_aggregate {\n          aggregate {\n            sum {\n              amount\n            }\n          }\n        }\n      }\n      job: Job {\n        id\n        paid\n        reference\n        type\n        meta\n        number\n        status\n        location: Location {\n          id\n          name\n        }\n        service: Service {\n          name\n          id\n        }\n      }\n    }\n\n    meta: AccountEntry_aggregate(where: $where) {\n      aggregate {\n        debitTotal: sum {\n          debit\n        }\n        creditTotal: sum {\n          credit\n        }\n        outstandingAmount: sum {\n          outstandingAmount\n        }\n        balance: sum {\n          balance\n        }\n        totalCount: count\n      }\n      nodes {\n        Invoice {\n          Reconciliations_aggregate {\n            aggregate {\n              sum {\n                amount\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n"])))),I=((0,j.Ps)(l||(l=(0,y.Z)(["\n  query GetJobMeta($id: Int!) {\n    job: Job(where: { id: { _eq: $id } }) {\n      id\n      meta\n    }\n  }\n"]))),(0,j.Ps)(p||(p=(0,y.Z)(["\n  mutation UpdateJob($changes: Job_set_input, $ids: [Int]) {\n    update_Job(where: { id: { _in: $ids } }, _set: $changes) {\n      affected_rows\n    }\n  }\n"])))),Z=(0,j.Ps)(m||(m=(0,y.Z)(["\n  mutation UpdateJob(\n    $id: Int!\n    $changes: Job_set_input\n    $reconciliation: [Reconciliation_insert_input!]!\n    $timing: [JobTiming_insert_input!]!\n    $insertTiming: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $timing) @include(if: $insertTiming) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    insert_Reconciliation(objects: $reconciliation) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),O=(0,j.Ps)(f||(f=(0,y.Z)(['\n  mutation DeletePayment($jobIds: [Int!], $paymentId: Int!) {\n    update_Job(where: { id: { _in: $jobIds } }, _set: { status: "invoiceSent", paid: "false" }) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["closed", "customerPaid"] }, jobId: { _in: $jobIds } }\n    ) {\n      returning {\n        id\n      }\n    }\n\n    delete_Reconciliation(\n      where: {\n        creditEntity: { _in: ["PaymentReceipt", "CreditNote"] }\n        creditEntityId: { _eq: $paymentId }\n      }\n    ) {\n      returning {\n        id\n      }\n    }\n\n    delete_AccountEntry(\n      where: { type: { _in: ["paymentReceipt", "creditNote"] }, id: { _eq: $paymentId } }\n    ) {\n      returning {\n        id\n      }\n    }\n  }\n']))),S=(0,j.Ps)(v||(v=(0,y.Z)(['\n  query GetRelatedAccountEntries($invoiceIds: [Int!]!, $accountEntryId: Int!) {\n    reconciliations: Reconciliation(\n      where: {\n        creditEntityId: { _eq: $accountEntryId }\n        Invoice: { id: { _in: $invoiceIds } }\n        creditEntity: { _in: ["PaymentReceipt", "CreditNote"] }\n      }\n    ) {\n      id\n      amount\n      createdAt\n      amount\n      accountEntry: AccountEntry {\n        id\n        entity\n      }\n      invoice: Invoice {\n        id\n        job: Job {\n          id\n          number\n          type\n        }\n      }\n    }\n  }\n']))),_=(0,j.Ps)(b||(b=(0,y.Z)(['\n  query GetCalendarJobs($customerId: Int!) {\n    jobs: Job(\n      order_by: { timingStart: asc }\n      where: {\n        customerId: { _eq: $customerId }\n        jobScheduleId: { _is_null: false }\n        status: { _neq: "canceled" }\n      }\n    ) {\n      id\n      number\n      title\n      description\n      quoted\n      reference\n      timingStart\n      timingEnd\n      createdAt\n      status\n      jobScheduleId\n      supplierNotes\n      amount\n      supplierLabourAmount\n      rag\n      type\n      timings: JobTimings {\n        id\n        status\n        createdAt\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n    }\n  }\n']))),P=(0,j.Ps)(h||(h=(0,y.Z)(["\n  mutation AddCreditNote($object: AccountEntry_insert_input!) {\n    insert_AccountEntry_one(object: $object) {\n      id\n    }\n  }\n"])))},7802:function(e,t,n){"use strict";n.d(t,{Ms:function(){return f},RV:function(){return v},EW:function(){return b},YW:function(){return h},B6:function(){return y},mJ:function(){return j}});var r,i,o,a,c,s,u,d,l,p=n(52209),m=n(54397),f=((0,m.Ps)(r||(r=(0,p.Z)(["\n  query GetAssetParents($ids: [Int!]!) {\n    asset: Asset(where: { id: { _in: $ids } }) {\n      id\n      name\n      parent: ParentAsset {\n        id\n        name\n        parent: ParentAsset {\n          id\n          name\n        }\n      }\n    }\n  }\n"]))),(0,m.Ps)(i||(i=(0,p.Z)(["\n  mutation DeleteJobSchedule($id: Int!) {\n    delete_JobSchedule(where: { id: { _eq: $id } }) {\n      returning {\n        id\n      }\n    }\n  }\n"])))),v=(0,m.Ps)(o||(o=(0,p.Z)(['\n  query GetJobSchedule($orderBy: JobSchedule_order_by!, $locationId: Int) {\n    JobSchedule(where: { locationId: { _eq: $locationId } }, order_by: [$orderBy]) {\n      contractId\n      frequency\n      frequencyDescription\n      id\n      meta\n      paymentMethod\n      assets: Assets {\n        id\n        status\n        entity\n        entityId\n        Asset {\n          name\n          serialNumber\n          id\n        }\n      }\n      media: Media(where: { entity: { _eq: "JobSchedule" } }) {\n        id\n      }\n      contract: JobScheduleContract {\n        name\n        invoiceDate\n        startDate\n        contractLength\n        contractValue\n        status\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        unit\n        vat\n      }\n      jobs: Jobs(where: { status: { _neq: "canceled" } }) {\n        id\n        rag\n        title\n        timingStart\n        shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n          id\n          taxonomyId\n          comments\n          taxonomy: Taxonomy {\n            name\n          }\n        }\n      }\n    }\n    meta: JobSchedule_aggregate(where: { locationId: { _eq: $locationId } }) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),b=(0,m.Ps)(a||(a=(0,p.Z)(['\n  query GetJobSchedule($id: Int!) {\n    jobSchedule: JobSchedule_by_pk(id: $id) {\n      contractId\n      frequency\n      frequencyDescription\n      id\n      meta\n      paymentMethod\n      jobs: Jobs(where: { status: { _neq: "canceled" } }) {\n        id\n        rag\n        title\n        timingStart\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n        shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n          id\n          taxonomyId\n          comments\n          taxonomy: Taxonomy {\n            name\n          }\n        }\n      }\n    }\n  }\n']))),h=(0,m.Ps)(c||(c=(0,p.Z)(['\n  query GetJobCompliance($locationId: Int!, $where: Job_bool_exp!) {\n    jobSchedule: JobSchedule(where: { locationId: { _eq: $locationId } }, order_by: { id: asc }) {\n      id\n      shortDescriptionName: meta(path: "$.shortDescriptionName")\n      serviceName: meta(path: "$.serviceName")\n      costCustomer: meta(path: "$.costCustomer")\n      costSupplier: meta(path: "$.costSupplier")\n      frequency\n      jobs: Jobs(where: $where) {\n        id\n        rag\n        timingStart\n      }\n      totalJobs: Jobs_aggregate {\n        aggregate {\n          count\n        }\n      }\n    }\n  }\n']))),y=(0,m.Ps)(s||(s=(0,p.Z)(['\n  query GetCalendarJobs($locationId: Int!) {\n    jobs: Job(\n      order_by: { timingStart: asc }\n      where: {\n        Location: { id: { _eq: $locationId } }\n        jobScheduleId: { _is_null: false }\n        status: { _neq: "canceled" }\n      }\n    ) {\n      id\n      number\n      title\n      description\n      quoted\n      reference\n      timingStart\n      timingEnd\n      createdAt\n      status\n      jobScheduleId\n      supplierNotes\n      amount\n      supplierLabourAmount\n      rag\n      type\n      timings: JobTimings {\n        id\n        status\n        createdAt\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n    }\n  }\n']))),j=((0,m.Ps)(u||(u=(0,p.Z)(["\n  query GetStatusLog($entity: String!, $entityId: Int!) {\n    statusLog: StatusLog(where: { entityId: { _eq: $entityId }, entity: { _eq: $entity } }) {\n      id\n      createdAt\n      notes\n      status\n    }\n  }\n"]))),(0,m.Ps)(d||(d=(0,p.Z)(["\n  mutation AddJob($objects: [Job_insert_input!]!) {\n    insert_Job(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,m.Ps)(l||(l=(0,p.Z)(["\n  mutation MyMutation($objects: [CreateJobInput]!, $adminId: Int!) {\n    createJob(adminId: $adminId, objects: $objects) {\n      data\n    }\n  }\n"]))))},84619:function(e,t,n){"use strict";n.d(t,{u:function(){return d}});var r=n(92809),i=n(30266),o=n(64687),a=n.n(o),c=n(55863);function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(){var e=(0,i.Z)(a().mark((function e(t){var n,r,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.invoice,r=u(u({},n),{},{title:"Proforma Invoice"}),i=window.open("/download","_blank"),e.next=5,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/invoice/proforma/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(r)}).then((function(e){return e.json()})).then((function(e){i.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,c.Tb)({message:e,section:"fetch"})}));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},2880:function(e,t,n){"use strict";n.d(t,{ys:function(){return f},l1:function(){return v},R7:function(){return b},KQ:function(){return h},D7:function(){return y},lk:function(){return j},G5:function(){return g}});var r,i,o,a,c,s,u,d,l,p=n(52209),m=n(54397),f=(0,m.Ps)(r||(r=(0,p.Z)(['\n  query GetSuppliers(\n    $limit: Int\n    $offset: Int\n    $orderBy: Account_order_by!\n    $where: Account_bool_exp\n  ) {\n    suppliers: Account(limit: $limit, offset: $offset, where: $where, order_by: [$orderBy]) {\n      id\n      createdAt\n      name\n      status\n      companyNumber\n      vatId\n      website\n      jobs: SupplierJobs_aggregate {\n        aggregate {\n          count\n          max {\n            scheduledAt\n          }\n          sum {\n            amount\n          }\n        }\n      }\n      jobList: SupplierJobs(order_by: { createdAt: desc }) {\n        id\n      }\n      services: Services(where: { entity: { _eq: "Account" } }) {\n        id\n        service: Service {\n          id\n          name\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(where: $where) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),v=(0,m.Ps)(i||(i=(0,p.Z)(['\n  query GetSupplier($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      companyNumber\n      createdAt\n      name\n      status\n      type\n      updatedAt\n      website\n      clientType\n      managerId\n      vatId\n      meta\n      statusLogs: StatusLog(where: { entity: { _eq: "Account" } }) {\n        id\n        status\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      manager: Manager {\n        id\n        fullName\n      }\n      accountEntries: AccountEntries {\n        amount\n        balance\n        createdAt\n        entryId\n        outstandingAmount\n        type\n        currency: Currency {\n          id\n          iso\n          name\n          symbol\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      bookings: SupplierJobs {\n        id\n        title\n        createdAt\n        customerId\n        amount\n        locationId\n        managerId\n        quoteNumber\n        reference\n        status\n        serviceId\n        meta\n        admin: Admin {\n          id\n          name\n        }\n        customer: Customer {\n          id\n          name\n        }\n        location: Location {\n          id\n          name\n          addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n            id\n            registered\n            operating\n            trading\n            invoice\n            status\n            createdAt\n            address: Address {\n              id\n              name\n              addressLine1\n              addressLine2\n              addressLine3\n              city\n              county\n              geo\n              postCode\n              country: Country {\n                id\n                name\n              }\n            }\n          }\n        }\n        manager: Manager {\n          id\n          nameFirst\n          nameLast\n        }\n        sla: SLA {\n          id\n          name\n          notes\n        }\n        supplier: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n          media: Media {\n            id\n            medium: Medium {\n              id\n              category\n              filename\n              meta\n              type\n            }\n          }\n          manager: Manager {\n            id\n            fullName\n          }\n        }\n        supplierOffers: SupplierOffers {\n          status\n          rate\n          supplier: Supplier {\n            id\n            companyNumber\n            createdAt\n            name\n            status\n            type\n            updatedAt\n            website\n            clientType\n            managerId\n            vatId\n            meta\n            media: Media {\n              id\n              medium: Medium {\n                id\n                category\n                filename\n                meta\n                type\n              }\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n          }\n        }\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n      details: SupplierDetail {\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n        accountId\n      }\n      finance: Financial {\n        id\n        amountOutstanding\n        approvalThreshold\n        arrangementFee\n        createdAt\n        creditLimit\n        creditRating\n        defaultPaymentMethod\n        invoicing\n        serviceRate\n        spendThreshold\n        stripeId\n        totalRevenue\n        unpaidInvoices\n      }\n      locations: Account_Locations {\n        location: Location {\n          id\n          access\n          createdAt\n          name\n          contactUserId\n        }\n      }\n      manager: Manager {\n        id\n        name: nameFirst\n        nameFirst\n        nameLast\n        phone\n        status\n        email\n        createdAt\n        fullName\n        accounts: Account_Users {\n          id\n          role\n          position\n          isContact\n          status\n          account: Account {\n            id\n            name\n            type\n          }\n        }\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n      quotes: SupplierQuotes {\n        id\n        createdAt\n        jobId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        rebate\n        status\n        totalDuration\n        totalDurationUnit\n        meta\n        updatedAt\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          supplierTotal\n          total\n          type\n          unitRate\n        }\n      }\n      compliances: Compliances(where: { entity: { _eq: "Account" } }, order_by: { expiryAt: asc }) {\n        id\n        createdAt\n        entity\n        entityId\n        expiryAt\n        regNum\n        insuranceAmount\n        meta\n        compliance: Compliance {\n          id\n          type\n          name\n          status\n          hasInsuranceAmount\n          regNumExample\n          questions: Taxonomies(where: { entity: { _eq: "Compliance" } }) {\n            id\n            name\n            meta\n          }\n        }\n      }\n      coverage: PostcodeAreas(where: { status: { _eq: "active" } }) {\n        id\n        status\n        createdAt\n        area: PostcodeArea {\n          id\n          name\n          area\n        }\n      }\n      services: Services {\n        serviceId\n        createdAt\n      }\n      references: References {\n        id\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n    }\n  }\n']))),b=(0,m.Ps)(o||(o=(0,p.Z)(["\n  query GetSupplierManage($id: Int!) {\n    supplier: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      status\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n      supplierDetails: SupplierDetail {\n        id\n        cisRegistered\n        quotingEmail\n        typeOfOrganisation\n        utrNumber\n      }\n    }\n  }\n"]))),h=(0,m.Ps)(a||(a=(0,p.Z)(["\n  mutation AddSupplier($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),y=((0,m.Ps)(c||(c=(0,p.Z)(["\n  mutation AddSupplierDetail($objects: [SupplierDetail_insert_input!]!) {\n    insert_SupplierDetail(objects: $objects) {\n      returning {\n        id\n        accountId\n      }\n    }\n  }\n"]))),(0,m.Ps)(s||(s=(0,p.Z)(["\n  mutation AddSupplierOffer($objects: [SupplierOffer_insert_input!]!) {\n    insert_SupplierOffer(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,m.Ps)(u||(u=(0,p.Z)(["\n  mutation UpdateSupplier(\n    $supplierId: Int!\n    $supplier: Account_set_input\n    $supplierDetails: SupplierDetail_set_input\n  ) {\n    update_SupplierDetail(where: { accountId: { _eq: $supplierId } }, _set: $supplierDetails) {\n      returning {\n        id\n      }\n    }\n\n    update_Account_by_pk(pk_columns: { id: $supplierId }, _set: $supplier) {\n      id\n    }\n  }\n"])))),j=(0,m.Ps)(d||(d=(0,p.Z)(['\n  query GetPostCodeAreas(\n    $limit: Int\n    $offset: Int\n    $q: String\n    $supplierId: Int\n    $status: String = "active"\n  ) {\n    coverage: PostcodeArea_Entity(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n      order_by: { PostcodeArea: { name: asc } }\n      limit: $limit\n      offset: $offset\n    ) {\n      id\n      status\n      createdAt\n      area: PostcodeArea {\n        id\n        name\n        area\n      }\n    }\n    meta: PostcodeArea_Entity_aggregate(\n      where: {\n        entity: { _eq: "Account" }\n        entityId: { _eq: $supplierId }\n        status: { _eq: $status }\n        PostcodeArea: { name: { _ilike: $q } }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),g=(0,m.Ps)(l||(l=(0,p.Z)(["\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $startDate: timestamptz\n    $endDate: timestamptz\n    $limit: Int\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $status: [String!]\n    $q: String\n    $type: [String!]\n    $jobNumber: String\n    $invoiceNumber: jsonb\n    $orderBy: job_financial_order_by!\n    $userId: Int\n  ) {\n    jobs: getDashboard_Job_Financial(\n      limit: $limit\n      offset: $offset\n      args: {\n        adminId: $adminId\n        managerId: $managerId\n        customerId: $customerId\n        locationId: $locationId\n        supplierId: $supplierId\n        startTime: $startDate\n        endTime: $endDate\n      }\n      where: {\n        _and: [\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledat: { _gte: $startDate } }, { scheduledat: { _lte: $endDate } }] }\n            ]\n          }\n          {\n            _or: [\n              { job_number: { _eq: $jobNumber } }\n              { job_invoicenumber: { _contains: $invoiceNumber } }\n            ]\n          }\n        ]\n        Job: { supplierUserId: { _eq: $userId } }\n        status: { _in: $status }\n        job_type: { _in: $type }\n      }\n      order_by: [$orderBy]\n    ) {\n      customerName: customer_name\n      customerId: customer_id\n      expensesAmountCustomer: job_expenses_customer\n      expensesAmountSupplier: job_expenses_supplier\n      invoiceDate: job_date\n      invoiceNumber: job_invoicenumber\n      jobId: job_id\n      jobNumber: job_number\n      jobStatus: job_status\n      jobTotal: customer_amount\n      jobType: job_type\n      payDate: pay_date\n      priorityId: sla_id\n      revenue: job_revenue\n      service: service_name\n      serviceLine: service_name\n      serviceName: service_name\n      supplierAmount: supplier_amount\n      supplierId: supplier_id\n      supplierName: supplier_name\n      job: Job {\n        description\n        supplierUserId\n        location: Location {\n          name\n        }\n        sla: SLA {\n          name\n        }\n        manager: Manager {\n          fullName\n          nameLast\n          nameFirst\n          id\n        }\n        supplierUser: SupplierUser {\n          id\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        supplier: Supplier {\n          id\n          contactUsers: Account_Users {\n            role\n            userId\n            user: User {\n              id\n              fullName\n              accounts: Account_Users {\n                id\n                role\n                position\n                isContact\n                status\n                account: Account {\n                  id\n                  name\n                  type\n                  __typename\n                }\n                __typename\n              }\n              __typename\n            }\n            __typename\n          }\n\n          __typename\n        }\n      }\n      scheduledat\n      timingStart\n      status\n      createdAt\n    }\n    meta: getDashboard_Job_Financial_aggregate(\n      args: {\n        adminId: $adminId\n        managerId: $managerId\n        customerId: $customerId\n        locationId: $locationId\n        supplierId: $supplierId\n        startTime: $startDate\n        endTime: $endDate\n      }\n      where: {\n        _and: [\n          {\n            _or: [\n              { _and: [{ timingStart: { _gte: $startDate } }, { timingStart: { _lte: $endDate } }] }\n              { _and: [{ scheduledat: { _gte: $startDate } }, { scheduledat: { _lte: $endDate } }] }\n            ]\n          }\n          {\n            _or: [\n              { job_number: { _eq: $jobNumber } }\n              { job_invoicenumber: { _contains: $invoiceNumber } }\n            ]\n          }\n        ]\n        Job: { supplierUserId: { _eq: $userId } }\n        status: { _in: $status }\n        job_type: { _in: $type }\n      }\n      order_by: [$orderBy]\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"])))},74369:function(e,t,n){"use strict";n.d(t,{T:function(){return c}});var r=n(80284),i=n(93443),o=n(18254),a=n(85893),c=function(e){var t,n,c=e.open,s=e.supplier,u="";return o.E.forEach((function(e){var t;e.value===(null===(t=s.details)||void 0===t?void 0:t.typeOfOrganisation)&&(u=e.text)})),(0,a.jsxs)(r.Z,{open:c,title:"Company",children:[(0,a.jsx)(i.Z,{content:"Organization Type",text:u}),(0,a.jsx)(i.Z,{content:"Company Number",text:s.companyNumber}),(0,a.jsx)(i.Z,{content:"VAT Number",text:s.vatId}),(0,a.jsx)(i.Z,{content:"UTR Number",text:null===(t=s.details)||void 0===t?void 0:t.utrNumber}),(0,a.jsx)(i.Z,{content:"CIS Registered",text:"yes"===(null===(n=s.details)||void 0===n?void 0:n.cisRegistered)?"Yes":"No"}),(0,a.jsx)(i.Z,{content:"Website",text:s.website})]})};c.defaultProps={open:!0}},98307:function(e,t,n){"use strict";n.d(t,{D:function(){return c}});var r=n(80284),i=n(93443),o=n(77417),a=n(85893),c=function(e){var t=e.supplier;return(0,a.jsx)(r.Z,{open:!0,title:"Contact",children:t.contactUsers.map((function(e){var n;return(0,a.jsxs)("div",{children:[(0,a.jsx)(i.Z,{content:"Name",text:"".concat(e.user.fullName)}),(0,a.jsx)(i.Z,{content:"Phone",text:e.user.phone}),(0,a.jsx)(i.Z,{content:"Email",text:e.user.email}),(0,a.jsx)(i.Z,{content:"Quoting Email",text:(null===(n=t.details)||void 0===n?void 0:n.quotingEmail)||"-"}),(0,a.jsx)(o.Z,{})]},e.user.id)}))})}},19905:function(e,t,n){"use strict";n.d(t,{B:function(){return te}});var r,i,o,a,c,s=n(92809),u=n(67294),d=n(93633),l=n(85088),p=n(52209),m=n(54397),f=(0,m.Ps)(r||(r=(0,p.Z)(["\n  fragment TaskFields on Task {\n    id\n    action\n    content\n    dueDate\n    priority\n    status\n    entity\n    entityId\n    assignedAccount: AssignedAccount {\n      id\n      type\n      name\n    }\n    assignedUser: AssignedUser {\n      id\n      fullName\n    }\n  }\n"]))),v=(0,m.Ps)(i||(i=(0,p.Z)(["\n  query GetTasks(\n    $accountId: Int\n    $action: String\n    $entity: String\n    $entityId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n    $priority: Int\n    $q: String\n    $status: String\n    $userId: Int\n  ) {\n    tasks: Task(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        accountId: { _eq: $accountId }\n        userId: { _eq: $userId }\n        action: { _eq: $action }\n        content: { _ilike: $q }\n        entity: { _eq: $entity }\n        entityId: { _eq: $entityId }\n        priority: { _eq: $priority }\n        status: { _eq: $status }\n      }\n    ) {\n      ...TaskFields\n    }\n    meta: Task_aggregate(\n      where: {\n        accountId: { _eq: $accountId }\n        userId: { _eq: $userId }\n        action: { _eq: $action }\n        content: { _ilike: $q }\n        entity: { _eq: $entity }\n        entityId: { _eq: $entityId }\n        priority: { _eq: $priority }\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n  ","\n"])),f),b=(0,m.Ps)(o||(o=(0,p.Z)(["\n  subscription GetTasks(\n    $accountId: Int\n    $action: String\n    $entity: String\n    $entityId: Int\n    $limit: Int\n    $offset: Int\n    $orderBy: Task_order_by!\n    $q: String\n    $status: String\n    $userId: Int\n  ) {\n    tasks: Task(\n      limit: $limit\n      offset: $offset\n      order_by: [$orderBy]\n      where: {\n        accountId: { _eq: $accountId }\n        userId: { _eq: $userId }\n        action: { _eq: $action }\n        content: { _ilike: $q }\n        entity: { _eq: $entity }\n        entityId: { _eq: $entityId }\n        status: { _eq: $status }\n      }\n    ) {\n      ...TaskFields\n    }\n  }\n  ","\n"])),f),h=(0,m.Ps)(a||(a=(0,p.Z)(["\n  mutation AddTask($objects: [Task_insert_input!]!) {\n    insert_Task(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),y=(0,m.Ps)(c||(c=(0,p.Z)(["\n  mutation UpdateTask($id: Int!, $changes: Task_set_input) {\n    update_Task_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),j=n(80880),g=n(91126),x=n(18862),w=n(58448),I=n(14347),Z=n(80284),O=n(81185),S=n(12517),_=n(20154),P=n(30266),A=n(80318),C=n(64687),D=n.n(C),k=n(75709),R=n(42283),q=n(79665),E=n(97202),T=n(65375),$=n(83528),N=n(78215),J=n(2356),H=n(46482),U=n(76800),M=n(95146),F=n(75838),V=n(19501),L=(0,V.Ry)().shape({assignedUser:(0,V.Ry)().required(),content:(0,V.Z_)().required(),status:(0,V.Z_)().oneOf(["open","closed","resolved"]).required(),dueDate:(0,V.hT)().nullable()}),z=n(1323),Q=n(85893);function B(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Y(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?B(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):B(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var W=function(e){var t=e.defaultValues,n=e.onSuccess,r=(0,z.x)().user,i=(0,R.cI)({defaultValues:t,resolver:(0,q.S)(L)}),o=i.control,a=i.errors,c=i.handleSubmit,s=i.register,u=(0,k.D)(h,{onCompleted:function(e){var t=e.insert_Task.returning[0].id;n&&n(t)}}),d=(0,A.Z)(u,1)[0],l=(0,k.D)(y,{onCompleted:function(e){var t=e.update_Task_by_pk.id;n&&n(t)}}),p=(0,A.Z)(l,1)[0],m=function(){var e=(0,P.Z)(D().mark((function e(n){var r;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n).userId=n.assignedUser.value,delete r.assignedUser,!t.id){e.next=8;break}return e.next=6,p({variables:{id:t.id,changes:r}});case 6:e.next=13;break;case 8:return r.accountId=t.accountId,r.entity=t.entity,r.entityId=t.entityId,e.next=13,d({variables:{objects:[r]}});case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),f={control:o,errors:a,register:s};return(0,Q.jsxs)(E.Z,{id:"offCanvasForm",handleSubmit:c(m),children:[(0,Q.jsx)(T.Z,{label:"Task",children:(0,Q.jsx)($.Z,Y(Y({},f),{},{name:"content",rows:3}))}),(0,Q.jsxs)(N.Z,{children:[(0,Q.jsx)(J.Z,{md:4,children:(0,Q.jsx)(T.Z,{label:"Priority",children:(0,Q.jsx)(H.Z,Y(Y({},f),{},{name:"priority",options:_.t}))})}),(0,Q.jsxs)(J.Z,{md:8,children:[(0,Q.jsx)(T.Z,{label:"Due Date"}),(0,Q.jsx)(U.M,Y(Y({},f),{},{dateFormat:"d MMM yyyy HH:mm",name:"dueDate",showTimeSelect:!0}))]})]}),(0,Q.jsxs)(N.Z,{children:[(0,Q.jsx)(J.Z,{md:4,children:(0,Q.jsx)(T.Z,{label:"Status",children:(0,Q.jsx)(H.Z,Y(Y({},f),{},{name:"status",options:F.WG}))})}),(0,Q.jsx)(J.Z,{md:8,children:(0,Q.jsx)(M.P,Y(Y({},f),{},{accountId:r.accountId,errors:Y({},a),label:"Assigned to",name:"assignedUser",type:"manager"}))})]})]})},G=n(49705);function K(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function X(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?K(Object(n),!0).forEach((function(t){(0,s.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):K(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ee={item:"dueDate",order:"desc"},te=function(e){var t=e.filters,n=e.showMyTaskButton,r=e.view,i=e.onSuccess,o=(0,u.useState)(!1),a=o[0],c=o[1],s=(0,z.x)().user,p=X({},X({status:"open"},t)),m=(0,G.x)({filters:p,initialSort:ee}),f=m.initialData,h=m.ref,y=(0,u.useContext)(j.Z),P=X(X({accountId:s.accountId},f),{},{userId:a?s.id:f.userId}),A=(0,d.a)(v,{variables:X({},P),skip:"compact"===r}),C=A.loading,D=A.data,k=(D=void 0===D?{tasks:[],meta:{aggregate:{totalCount:0}}}:D).tasks,R=D.meta,q=A.refetch,E=(0,l.m)(b,{variables:X({},P),skip:"compact"!==r}),T=E.loading,$=E.data,N=($=void 0===$?{tasks:[]}:$).tasks,J=function(e){y.close(),q(),i&&i()},H=function(e,n){e.preventDefault(),e.stopPropagation();var r,i,o,a={};null!==n&&void 0!==n&&n.item?((a=X({},n.item)).dueDate=n.item.dueDate?new Date(n.item.dueDate):null,a.assignedUser=n.item.assignedUser?{value:n.item.assignedUser.id,label:n.item.assignedUser.fullName}:null):a={accountId:null!==(r=null===t||void 0===t?void 0:t.accountId)&&void 0!==r?r:s.accountId,entity:null!==(i=null===t||void 0===t?void 0:t.entity)&&void 0!==i?i:null,entityId:null!==(o=null===t||void 0===t?void 0:t.entityId)&&void 0!==o?o:null,priority:3,status:"open"};y.show({content:(0,Q.jsx)(W,{defaultValues:a,onSuccess:J}),title:null!==n&&void 0!==n&&n.id?"Edit Task":"Add Task"})},U=[{context:"secondary",icon:["fas","edit"],onClick:H,tooltip:"Edit"}],M=[{hidden:!0},{text:"Priority",formatter:function(e){var t,n=e.row;return(null===(t=_.t.find((function(e){return e.value===n.priority})))||void 0===t?void 0:t.text)||"-"}},{text:"Task"},{text:"Due date",sortable:!0,sortName:"dueDate"},{text:"Assigned To"},{hidden:!0},{formatter:g.Z,formatterData:U,text:"Actions"}],F=function(e){e.stopPropagation(),c(!a)},V=function(){return(0,Q.jsxs)(w.Z,{children:[(0,Q.jsx)(I.Z,{context:"secondary",content:"New Task",onClick:H,size:"sm"}),n&&(0,Q.jsx)(I.Z,{context:"secondary",content:a?"All Tasks":"My Tasks",onClick:F,size:"sm"})]})};return(0,Q.jsx)(Z.Z,{open:!0,title:"Tasks",toolbar:(0,Q.jsx)(V,{}),children:(0,Q.jsx)(O.t,{columns:M,history:!1,initialSort:ee,loading:"compact"===r?T:C,meta:R,ref:h,refetch:q,rowClick:function(e){var t=e.item;"Job"===t.entity&&t.entityId&&y.show({content:(0,Q.jsx)(S.g,{jobId:t.entityId,toggleShow:y.close}),submit:!1,title:"Job details",width:"50%"})},rows:("compact"===r?N:k).map((function(e){var t;return{id:e.id,priority:e.priority,content:e.content||"",date:e.dueDate?(0,x.Z)(e.dueDate,!0):"-",assignedUser:null===(t=e.assignedUser)||void 0===t?void 0:t.fullName,item:e,actions:""}}))})})};te.defaultProps={showMyTaskButton:!1}},87086:function(e,t,n){"use strict";n.d(t,{U:function(){return r}});var r=[{elementType:"geometry",stylers:[{color:"#75cccf"}]},{elementType:"labels.text.fill",stylers:[{color:"#523735"}]},{elementType:"labels.text.stroke",stylers:[{color:"#f5f1e6"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#004e49"}]},{featureType:"administrative.land_parcel",elementType:"geometry.stroke",stylers:[{color:"#75cccf"}]},{featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#ae9e90"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#F6F6F4"}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#ECEEED"}]},{featureType:"landscape.man_made",elementType:"geometry",stylers:[{color:"#a8e3e6"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#ECEEED"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#FFFFFF"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#E8EDEB"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#CAD2D3"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#"}]},{featureType:"road.highway.controlled_access",elementType:"geometry.stroke",stylers:[{color:"#"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#"}]},{featureType:"transit.line",elementType:"geometry",stylers:[{color:"#"}]},{featureType:"transit.line",elementType:"labels.text.fill",stylers:[{color:"#"}]},{featureType:"transit.line",elementType:"labels.text.stroke",stylers:[{color:"#"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#CAD2D3"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#"}]}]},7863:function(e,t,n){"use strict";n.d(t,{ck:function(){return r},Hu:function(){return i},KB:function(){return o},sT:function(){return a},M2:function(){return c}});var r=[{id:"invoice",label:"Invoice",value:"invoice"},{id:"card",label:"Card",value:"card"},{id:"N/A",label:"N/A",value:"N/A"}],i=[{id:"time-materials",label:"Time & Materials",value:"time-materials"},{id:"fixed",label:"Fixed",value:"fixed"}],o=[{id:"at",label:"At",value:"at"},{id:"between",label:"Between",value:"between"}],a=function(e){return[{icon:"file-alt",tooltip:"Create follow up"},{icon:"edit",tooltip:"Edit issue",to:"quote"===e.type?"/dashboard/issues/manage?id=".concat(e.number,"&quoted=1"):"/dashboard/issues/manage?id=".concat(e.number)}]},c=[{id:"complete",label:"Job complete",value:"complete"},{id:"completeCertificate",label:"Job complete, certificate to follow",value:"completeCertificate"},{id:"returnVisit",label:"Return visit required",value:"returnVisit"},{id:"returnVisitByAnother",label:"Visit required by another supplier",value:"returnVisitByAnother"},{id:"couldNotDo",label:"Could not do",value:"couldNotDo"}]},18254:function(e,t,n){"use strict";n.d(t,{E:function(){return r}});var r=[{text:"Select Type Of Organisation",value:""},{text:"Sole trader",value:"soleTrader"},{text:"Limited company",value:"limitedCompany"},{text:"Partnership",value:"partnership"},{text:"LLP",value:"llp"},{text:"PLC",value:"plc"}]},20154:function(e,t,n){"use strict";n.d(t,{t:function(){return r}});var r=[{text:"P1",value:1},{text:"P2",value:2},{text:"P3",value:3},{text:"P4",value:4},{text:"P5",value:5}]},84116:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return Fs}});var r,i,o,a=n(92809),c=n(11163),s=n(66918),u=n(80318),d=n(67294),l=n(93633),p=n(38460),m=n(75709),f=n(29678),v=n(84774),b=n(52209),h=n(54397),y=n(38478),j=n(76585),g=n(88402),x=n(27834),w=(0,h.Ps)(r||(r=(0,b.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      jobScheduleId\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      customerId\n      customerUserId\n      locationId\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n        type\n      }\n      admin: Admin {\n        id\n        name\n        meta\n        bankAccounts: BankAccounts {\n          id\n          bank\n          stripeId\n          accountNumber\n          routingNumber\n          bic\n          iban\n          status\n          default\n          createdAt\n        }\n        addresses: Addresses {\n          id\n          registered\n          operating\n          trading\n          invoice\n          status\n          createdAt\n          address: Address {\n            id\n            name\n            addressLine1\n            addressLine2\n            addressLine3\n            city\n            county\n            geo\n            postCode\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n      }\n      customer: Customer {\n        id\n        name\n      }\n\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n\n      expenses: Expenses {\n        id\n        amount\n        description\n        markup\n        total\n        unit\n        vat\n        paid\n      }\n      location: Location {\n        id\n        name\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        createdAt\n        updatedAt\n        meta\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        statusLog\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n          accountUsers: Account_Users {\n            user: User {\n              id\n              fullName\n              nameFirst\n              nameLast\n              phone\n              email\n              devices: UserDevices(where: { status: { _eq: "active" } }) {\n                id\n                playerId\n              }\n            }\n          }\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        createdAt\n        meta\n        quoteId\n        user: User {\n          id\n          fullName\n        }\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),j.z,g.WW,g.MR,y.aL,y.pf,y.H_,x.Px),I=(0,h.Ps)(i||(i=(0,b.Z)(['\n  query GetJob($adminId: Int!, $number: String!) {\n    job: Job(where: { adminId: { _eq: $adminId }, number: { _eq: $number } }) {\n      ...JobFields\n      ...JobQuoteFields\n      ...JobSupplierFields\n      invoices: Invoices {\n        reconciledAmount: Reconciliations_aggregate {\n          aggregate {\n            sum {\n              amount\n            }\n          }\n        }\n        amountPaid: Reconciliations_aggregate(where: { creditEntity: { _eq: "PaymentReceipt" } }) {\n          aggregate {\n            sum {\n              amount\n            }\n          }\n        }\n        amountDeducted: Reconciliations_aggregate(where: { creditEntity: { _eq: "CreditNote" } }) {\n          aggregate {\n            sum {\n              amount\n            }\n          }\n        }\n      }\n      financeLogs: JobFinanceLogs(order_by: { createdAt: desc }) {\n        id\n        type\n        value\n        difference\n        createdAt\n      }\n      admin: Admin {\n        id\n        name\n      }\n      customer: Customer {\n        id\n        name\n      }\n      compliances: Compliances(where: { entity: { _eq: "Job" } }) {\n        id\n        compliance: Compliance {\n          id\n          name\n        }\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        vat\n      }\n      location: Location {\n        id\n        name\n        addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n          ...AddressEntityFields\n          address: Address {\n            ...AddressFields\n            country: Country {\n              id\n              name\n            }\n          }\n        }\n        slas: SLAs(where: { entity: { _eq: "Location" } }) {\n          id\n          entity\n          entityId\n          onSite\n          onSiteUnit\n          jobReport\n          jobReportUnit\n          completion\n          completionUnit\n          notes\n          inUse\n          normalRate\n          oohRate\n          premiumRate\n          minimumInterval\n          minimumLength\n          slaId\n          sla: SLA {\n            id\n            name\n            notes\n            normalRate\n            oohRate\n            premiumRate\n            onSite\n            onSiteUnit\n            jobReport\n            jobReportUnit\n            completion\n            completionUnit\n            minimumInterval\n            minimumLength\n          }\n        }\n        services: Services(where: { entity: { _eq: "Location" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      report: JobReport {\n        id\n        completion\n        notes\n        timing\n        createdAt\n        updatedAt\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n        customerDayRate\n        customerDayRateOOH\n        customerDayRatePremium\n        customerHourRate\n        customerHourRateOOH\n        customerHourRatePremium\n        supplierDayRate\n        supplierDayRateOOH\n        supplierDayRatePremium\n        supplierHourRate\n        supplierHourRateOOH\n        supplierHourRatePremium\n        minimumInterval\n        minimumLength\n        status\n        createdAt\n      }\n      sla: SLA {\n        id\n        name\n        notes\n        normalRate\n        oohRate\n        premiumRate\n        onSite\n        onSiteUnit\n        jobReport\n        jobReportUnit\n        completion\n        completionUnit\n        minimumInterval\n        minimumLength\n      }\n      media: Media {\n        id\n        item: Medium {\n          id\n          category\n          filename\n          meta\n          name\n          type\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n        contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n          role\n          position\n          isContact\n          lastSignInAt\n          userId\n          user: User {\n            ...UserFields\n          }\n        }\n        services: Services(where: { entity: { _eq: "Account" } }) {\n          id\n          dayRate\n          dayRateOOH\n          dayRatePremium\n          hourRate\n          hourRateOOH\n          hourRatePremium\n          minimumInterval\n          minimumLength\n          callOutHourRate\n          callOutHourRateOOH\n          callOutHourRatePremium\n          notes\n          delivery\n          createdAt\n          updatedAt\n          entity\n          entityId\n          serviceId\n          service: Service {\n            id\n            name\n            countryId\n            currencyId\n            customerDayRate\n            customerDayRateOOH\n            customerDayRatePremium\n            customerHourRate\n            customerHourRateOOH\n            customerHourRatePremium\n            supplierDayRate\n            supplierDayRateOOH\n            supplierDayRatePremium\n            supplierHourRate\n            supplierHourRateOOH\n            supplierHourRatePremium\n            minimumInterval\n            minimumLength\n          }\n        }\n      }\n      supplierOffers: SupplierOffers {\n        id\n        status\n        rate\n        dayRate\n        meta\n        notes\n        account: Supplier {\n          id\n          type\n          name\n        }\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      tenantUser: TenantUser {\n        ...UserFields\n      }\n      quotations: SupplierQuotes(\n        where: { status: { _neq: "cancelled" } }\n        order_by: { quoteNumber: asc }\n      ) {\n        id\n        quoteNumber\n        accountId\n        methodStatement\n        notes\n        quoteNumber\n        recommended\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        createdAt\n        updatedAt\n        siteVisitAt\n        type\n        lineItems: SupplierQuoteLineItems {\n          id\n          description\n          item\n          qty\n          qtyUnit\n          quoteId\n          total\n          type\n          unitRate\n          supplierTotal\n        }\n        supplier: Supplier {\n          id\n          type\n          name\n        }\n      }\n      timings: JobTimings(order_by: { id: desc }) {\n        id\n        status\n        createdAt\n        meta\n        quoteId\n        user: User {\n          id\n          fullName\n        }\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      answers: Taxonomy(\n        where: { Taxonomy: { type: { _eq: "jobQuestion" } } }\n        order_by: { taxonomyId: asc }\n      ) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n      costCategoryTaxonomy: CostCategory {\n        id\n        name\n      }\n      parentJob: ParentJob {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n      childJobs: Jobs {\n        createdAt\n        id\n        number\n        reference\n        status\n        title\n      }\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),j.z,g.WW,g.MR,y.aL,y.pf,y.H_,x.Px),Z=((0,h.Ps)(o||(o=(0,b.Z)(["\n  mutation calculateJobFinance($jobId: Int!, $invoiceType: String!) {\n    calculateJobFinance(jobId: $jobId, invoiceType: $invoiceType) {\n      data\n    }\n  }\n"]))),n(78215)),O=n(2356),S=n(22796),_=n(66639),P=n(70448),A=n(48080),C=n(8046),D=n(30266),k=n(64687),R=n.n(k),q=n(45697),E=n(80880),T=n(58448),$=n(71070),N=n(14347),J=n(55657),H=n(80284),U=n(18944),M=n(92743),F=n(38342),V=n(80285),L=n(93443),z=n(52002),Q=n(24237),B=n(7720),Y=n(26496),W=n(85893),G=function(e,t){var n,r=e.customerInfo.customerSpendThreshold,i=e.addendum,o=i.additions,a=i.deductions,c=i.discount,s=i.customerDeposit,u=e.amountInfo,d=u.amount,l=u.amountIncludingRebate,p=u.supplierLabourAmount,m=u.supplierMaterialsAmount,f=u.vatAmount,v=u.vatRate,b=u.vatTotal,h=e.expensesInfo.expensesTotalExVAT,y=e.rateInfo,j=y.calcWithServiceRate,g=y.costWithServiceRateExVat,x=y.pricing,w=y.selectedSla,I=y.serviceRateExpenses,Z=y.serviceRateLabour,O=y.selectedService,S=e.invoiceInfo.invoiceType,_=e.rebate,P=e.hidden,A=function(e){if(!e)return null;if(0!==e){var t=e>0?"green":"red",n=e>0?"+":"-";return(0,W.jsx)(K,{color:t,children:"".concat(n).concat((0,V.Z)(Math.abs(e)))})}},C=0;C="supplier"===S?p+m+h:l+h;var D=[{key:"Labour",value:null,calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(p)})},show:j},{key:"Service Rate Labour",value:"",calcAmount:function(){return(0,W.jsx)(K,{children:"".concat(Z,"%")})},show:j},{key:"Materials",value:null,calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(m)})},show:j},{key:"Service Rate Expenses and Material",value:"",calcAmount:function(){return(0,W.jsx)(K,{children:"".concat(I,"%")})},show:j},{key:"Amount",value:null!==_&&void 0!==_&&_.percent?"".concat(d," (+").concat(_.percent,"% rebate)"):"",calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(l)})},show:!("supplier"===S||j)},{key:"Labour",value:null,calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(p)})},show:"supplier"===S},{key:"Materials",value:null,calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(m)})},show:"supplier"===S},{key:"Service Rate",value:null!==O&&void 0!==O&&O.percent?"".concat(O.percent,"%"):"-",calcAmount:function(){return A(null===O||void 0===O?void 0:O.amount)},show:!("supplier"===S)&&(null===O||void 0===O?void 0:O.percent)},{key:"Expenses",value:null!==_&&void 0!==_&&_.percent?"".concat((0,V.Z)(h*(1-_.percent/100))," (+").concat(_.percent,"% rebate)"):"",calcAmount:function(){return A(h)},show:!0},{key:(0,W.jsx)(K,{color:"black",children:"Net"}),value:null,calcAmount:function(){return(0,W.jsx)(K,{children:"=".concat((0,V.Z)(C))})},show:!j},{key:(0,W.jsx)(K,{color:"black",children:"Cost"}),value:null,calcAmount:function(){return(0,W.jsx)(K,{children:"=".concat((0,V.Z)(g))})},show:j},{key:"VAT",value:"(".concat(100*v,"%)"),calcAmount:function(){return A(f)},show:!0},{key:"Discount",value:null,calcAmount:function(){return A(-1*c)},show:!!c},{key:"Additions",value:null,calcAmount:function(){return A(o)},show:o&&!("supplier"===S)||!1},{key:"Deductions",value:null,calcAmount:function(){return A(-1*a)},show:a&&!("supplier"===S)||!1},{key:(0,W.jsx)(K,{color:"black",children:"Gross"}),value:null,calcAmount:function(){return(0,W.jsx)(K,{color:"black",children:"=".concat((0,V.Z)(b))})},show:!0},{key:"Rebate",value:null!==_&&void 0!==_&&_.percent?"(".concat(_.percent,"%)"):"",calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(null===_||void 0===_?void 0:_.amount)})},show:(null===_||void 0===_?void 0:_.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,W.jsx)(K,{children:(0,V.Z)(b-(null===_||void 0===_?void 0:_.amount))})},show:(null===_||void 0===_?void 0:_.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,V.Z)(s)},show:!!s},{key:"Reconciled Amount",value:null,calcAmount:(0,W.jsx)(X,{content:(0,V.Z)(t),isPaid:(0,Y.l)(t,2)>=(0,Y.l)(b-(null===_||void 0===_?void 0:_.amount),2)}),show:t>0&&"supplier"!==S}],k=[{key:"Pricing",value:j?"Service Rate":x||"Fixed"},{key:"Threshold",value:r&&(0,V.Z)(r)},{key:"SLA",value:(null===w||void 0===w?void 0:w.name)||(null===w||void 0===w||null===(n=w.sla)||void 0===n?void 0:n.name)}];return{amounts:D.map((function(e){return e.show&&{key:e.key,value:e.value,calcAmount:P||e.calcAmount}})),texts:k}},K=Q.ZP.span.withConfig({displayName:"fixed__StyledValue",componentId:"sc-1wf0kg-0"})(["color:",";font-weight:bold;"],(function(e){return e.color})),X=(0,Q.ZP)(B.Z).withConfig({displayName:"fixed__StyledBadge",componentId:"sc-1wf0kg-1"})(["background-color:",";"],(function(e){return e.isPaid?e.theme.COLOUR.success:e.theme.COLOUR.female})),ee=function(e,t){var n=e.customerInfo.customerSpendThreshold,r=e.addendum,i=r.additions,o=r.deductions,a=r.discount,c=r.customerDeposit,s=e.amountInfo,u=s.supplierAmountByTiming,d=s.vatAmount,l=s.vatRate,p=s.vatTotal,m=e.expensesInfo.expensesTotalExVAT,f=e.rateInfo,v=f.calcWithServiceRate,b=f.callOutRate,h=f.costWithServiceRateExVat,y=f.displayTime,j=f.hasCallOutRate,g=f.holidayRate,x=f.initialRate,w=f.isCustomRate,I=f.pricing,Z=f.rate,O=f.rateIncludingRebate,S=f.rateIncludingRebateAndMinutesAndSLA,_=f.rateIncludingRebateAndSLA,P=f.selectedSla,A=f.serviceRateExpenses,C=f.serviceRateLabour,D=f.slaMultiplier,k=f.timing,R=f.selectedService,q=e.invoiceInfo.invoiceType,E=e.rebate,T=e.hidden,N=function(e){if(0!==e){var t=e>0?"green":"red",n=e>0?"+":"-";return(0,W.jsx)(te,{color:t,children:"".concat(n).concat((0,V.Z)(Math.abs(e)))})}},H=[{key:"Labour",value:null,calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(u)})},show:v},{key:"Service Rate Labour",value:"".concat(C,"%"),calcAmount:null,show:v},{key:"Service Rate Expenses and Material",value:"".concat(A,"%"),calcAmount:null,show:v},{key:"Time",value:y,calcAmount:null,show:!v},{key:"First hour rate",value:null,calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(b)})},show:!v&&j},{key:g?(0,W.jsx)($.Z,{content:"Holiday rates applied",context:"black",children:(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(J.Z,{context:"success",icon:"sleigh",size:"lg"}),"Rate \xa3/H"]})}):"Rate \xa3/H",value:(null!==E&&void 0!==E&&E.percent?"".concat((0,V.Z)(Z)," (+").concat(null===E||void 0===E?void 0:E.percent,"% rebate)"):"")+" (".concat(w?"Custom Rate":R.entity,")"),calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(O)})},show:!v},{key:"SLA",value:"".concat(D,"X (").concat(null===P||void 0===P?void 0:P.name," -").concat(P.entity,")"),calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(_)})},show:!v},{key:"Labour",value:null,calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(S)})},show:!v&&!("supplier"===q)},{key:"Service Rate",value:null!==R&&void 0!==R&&R.percent?"".concat(R.percent,"%"):"-",calcAmount:function(){return N(null===R||void 0===R?void 0:R.amount)},show:!v&&(null===R||void 0===R?void 0:R.amount)||!1},{key:"Expenses",value:null!==E&&void 0!==E&&E.percent?"".concat((0,V.Z)(m*(1-E.percent/100))," (+").concat(E.percent,"% rebate)"):"",calcAmount:function(){return N(m)},show:m||!1},{key:(0,W.jsx)(te,{color:"black",children:"Cost"}),value:null,calcAmount:function(){return(0,W.jsx)(te,{StyledValue:!0,color:"black",children:"=".concat((0,V.Z)(h))})},show:v},{key:(0,W.jsx)(te,{color:"black",children:"Net"}),value:null,calcAmount:function(){return(0,W.jsx)(te,{StyledValue:!0,color:"black",children:"=".concat((0,V.Z)(S+m))})},show:!v&&m||!1},{key:"VAT",value:"(".concat(100*l,"%)"),calcAmount:function(){return N(d)},show:!0},{key:"Additions",value:null,calcAmount:function(){return N(i)},show:i&&!("supplier"===q)||!1},{key:"Deductions",value:null,calcAmount:function(){return N(-1*o)},show:o&&!("supplier"===q)||!1},{key:"Discount",value:null,calcAmount:function(){return N(-1*a)},show:a||!1},{key:(0,W.jsx)(te,{color:"black",children:"Gross"}),value:null,calcAmount:function(){return(0,W.jsx)(te,{color:"black",children:"=".concat((0,V.Z)(p))})},show:!0},{key:"Rebate",value:null!==E&&void 0!==E&&E.percent?"(".concat(E.percent,"%)"):"",calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(null===E||void 0===E?void 0:E.amount)})},show:(null===E||void 0===E?void 0:E.percent)||!1},{key:"Due from Customer",value:null,calcAmount:function(){return(0,W.jsx)(te,{children:(0,V.Z)(p-(null===E||void 0===E?void 0:E.amount))})},show:!v&&(null===E||void 0===E?void 0:E.percent)||!1},{key:"Deposit",value:null,calcAmount:function(){return(0,V.Z)(c)},show:c||!1},{key:"Reconciled Amount",value:null,calcAmount:(0,W.jsx)(ne,{content:(0,V.Z)(t),isPaid:(0,Y.l)(t,2)>=(0,Y.l)(p-(null===E||void 0===E?void 0:E.amount),2)}),show:t>0&&"supplier"!==q}],U=[{key:"Pricing",value:v?"Service Rate":"time-materials"===I?"Time & Materials":"Fixed"},{key:"Threshold",value:n&&(0,V.Z)(n)},{key:v?"":"Rate \xa3/H",value:v?"":"".concat(x&&(0,V.Z)(x)+":"," Adjusted by\n      ").concat("supplier"===q?"":function(e){var t=e.holidayRate,n=e.rebate,r=e.slaMultiplier,i=t?"/ Holiday":"",o=(null===n||void 0===n?void 0:n.amount)>0?"/ Rebate":"",a=1!==r?"/ SLA ":"";return"".concat("Service ").concat(a).concat(o).concat(i)}({holidayRate:g,rebate:E,slaMultiplier:D}))},{key:"Timing",value:"OOH"===k?"Out of Hours":k}];return{amounts:H.map((function(e){return e.show&&{key:e.key,value:e.value,calcAmount:T||e.calcAmount}})),texts:U}},te=Q.ZP.span.withConfig({displayName:"time__StyledValue",componentId:"sc-9gf8dg-0"})(["color:",";font-weight:bold;"],(function(e){return e.color})),ne=(0,Q.ZP)(B.Z).withConfig({displayName:"time__StyledBadge",componentId:"sc-9gf8dg-1"})(["background-color:",";"],(function(e){return e.isPaid?e.theme.COLOUR.success:e.theme.COLOUR.female})),re=n(34112),ie=function(e){var t=e.isCustomer,n=e.isSupplier,r=e.job,i=(e.refetch,e.tab),o=e.user,a=e.financeSupplier,c=e.financeCustomer,s=(0,d.useState)(),u=s[0],l=s[1],p=(0,d.useState)(),m=p[0],f=p[1],v=(0,d.useState)(),b=v[0],h=v[1],y=(0,d.useState)(),j=y[0],g=y[1],x=(0,re.E)(r,"invoiceSent"),w=function(){var e=(0,D.Z)(R().mark((function e(){var o,s,u,d,p,m,v,b,y,j,w,I,Z,O,S;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:u=i||"customervat",d=null,n&&(u="supplier"),t&&!x&&(d="N/A"),m=null===(p=a)||void 0===p?void 0:p.amountInfo.vatTotal,(v="supplier"===u?a:c).hidden=d,b=null===v||void 0===v?void 0:v.amountInfo.vatTotal,y=b-(null===v||void 0===v||null===(o=v.amountInfo)||void 0===o?void 0:o.vatAmount),j=(0,Y.l)((b-m)/1.2,2),w=(0,Y.l)(j/y*100,2),m>0?(h((0,V.Z)(j)),g("".concat(w,"%"))):(h("0"),g("0%")),I=null===r||void 0===r||null===(s=r.invoices)||void 0===s?void 0:s.reduce((function(e,t){return e+t.reconciledAmount.aggregate.sum.amount}),0),Z="time-materials"===r.pricing?ee(v,I):G(v,I),O=Z.amounts,S=Z.texts,f(S),l(O);case 17:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,d.useEffect)((function(){w()}),[r]);return(0,W.jsxs)(W.Fragment,{children:[m&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(L.Z,{content:m[0].key,text:m[0].value||""}),(0,W.jsx)(L.Z,{content:m[1].key,text:m[1].value||""}),(0,W.jsx)(L.Z,{content:m[2].key,text:m[2].value||""}),(0,W.jsx)(L.Z,{content:"Normal rate only",text:r.timingNormalHours?"Yes":"No"}),m.length>3&&(0,W.jsx)(L.Z,{content:m[3].key,text:m[3].value})]}),u&&(0,W.jsx)(z.Z,{rows:u}),"admin"===o.accountType&&"customerVat"===i&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(L.Z,{content:"Net profit",text:b||""}),(0,W.jsx)(L.Z,{content:"Net profit margin",text:j||""})]})]})},oe=n(43566),ae=n(42283),ce=n(79665),se=n(19501),ue=function(e){return(0,se.Ry)().shape((0,a.Z)({},e,(0,se.Rx)().required()))},de=n(97202),le=n(34868),pe=n(21269),me=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=e.vat,a=e.clearLogs,c=(0,ae.cI)({resolver:(0,ce.S)(ue(r))}),s=c.errors,u=c.handleSubmit,l=c.register,p=c.reset,m=c.setValue;(0,d.useEffect)((function(){t&&m(r,t)}),[t]);return(0,W.jsx)(de.Z,{handleSubmit:u((function(e){i(r,e[r]),p()})),children:(0,W.jsx)(Z.Z,{align:"center",children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(le.Z,{errors:s,name:r,register:l,label:n,vat:o,children:(0,W.jsxs)(pe.Z,{addonType:"append",children:[a&&(0,W.jsx)(N.Z,{content:"Clear",context:"danger",onClick:function(){a(r,p)},size:"sm"}),(0,W.jsx)(N.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})]})})})})})};me.defaultProps={vat:"Ex Vat"};var fe=n(65375),ve=n(12757),be=n(44442),he=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=(0,ae.cI)({resolver:(0,ce.S)(ue(r))}),a=o.errors,c=o.handleSubmit,s=o.register,u=o.reset,l=o.setValue;(0,d.useEffect)((function(){t&&l(r,t)}),[t]);return(0,W.jsx)(de.Z,{handleSubmit:c((function(e){i(r,e[r]),u()})),children:(0,W.jsx)(Z.Z,{align:"center",children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:n,children:(0,W.jsxs)(ye,{children:[(0,W.jsx)(ve.Z,{errors:a,name:r,register:s}),(0,W.jsx)(je,{children:(0,W.jsx)(be.Z,{children:(0,W.jsx)(pe.Z,{addonType:"append",children:(0,W.jsx)(N.Z,{content:"Save",context:"secondary",type:"submit",size:"sm"})})})})]})})})})})},ye=Q.ZP.div.withConfig({displayName:"percentInput__StyledWrapper",componentId:"sc-14c0oiw-0"})(["display:flex;"]),je=Q.ZP.div.withConfig({displayName:"percentInput__StyledInputGroup",componentId:"sc-14c0oiw-1"})(["display:flex;align-items:center;margin-bottom:9px;"]),ge=n(18862),xe=function(e){var t=e.loading,n=e.logs;return(0,W.jsx)(H.Z,{open:!0,title:"Changes Logs",children:(0,W.jsx)(z.Z,{columns:[{hidden:!0},{text:"Type"},{text:"Value"},{text:"User"},{text:"Date"}],loading:t,rows:n.map((function(e){var t;return{id:e.id,type:e.type,value:e.value?"".concat(e.value," (").concat(e.difference>0?"+".concat(e.difference):e.difference||"-",")"):"clear",user:(null===(t=e.meta)||void 0===t?void 0:t.username)||"-",date:(0,ge.Z)(e.createdAt)}}))})})},we=n(46482),Ie=n(93710),Ze=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=(0,ae.cI)(),a=o.errors,c=o.handleSubmit,s=o.register,u=o.reset,l=o.setValue;(0,d.useEffect)((function(){t&&l(r,t)}),[t]);return(0,W.jsx)(de.Z,{handleSubmit:c((function(e){i(r,e[r]),u()})),children:(0,W.jsx)(Z.Z,{align:"end",children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:n,children:(0,W.jsxs)(be.Z,{children:[(0,W.jsx)(we.Z,{errors:a,name:r,options:(0,Ie.g)().map((function(e){return{text:e.name,value:e.id}})),register:s,style:{width:"80%"}}),(0,W.jsx)(pe.Z,{addonType:"append",children:(0,W.jsx)(N.Z,{content:"Save",context:"secondary",size:"sm",type:"submit"})})]})})})})})},Oe=n(71247),Se=function(e){var t=e.defaultValue,n=e.label,r=e.name,i=e.onSubmit,o=(0,ae.cI)({defaultValues:t,resolver:(0,ce.S)(ue(r))}),a=o.errors,c=o.handleSubmit,s=o.register,u=o.reset,l=o.setValue;(0,d.useEffect)((function(){t&&l(r,t)}),[t]);return(0,W.jsx)(de.Z,{handleSubmit:c((function(e){i(r,e[r]),u()})),children:(0,W.jsx)(Z.Z,{align:"end",children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:n,children:(0,W.jsxs)(be.Z,{children:[(0,W.jsx)(Oe.Z,{errors:a,min:0,name:r,register:s,type:"number"}),(0,W.jsx)(pe.Z,{addonType:"append",children:(0,W.jsx)(N.Z,{content:"Save",context:"secondary",size:"sm",type:"submit"})})]})})})})})},_e=n(38596),Pe=function(e){var t,n,r,i,o,a,c=e.job,s=e.refetchJob,p=e.activeTab,f=(0,d.useContext)(oe.Z).user,b=(!(null===(t=c.customer)||void 0===t||null===(n=t.meta)||void 0===n||null===(r=n.finance)||void 0===r||!r.serviceRateLabour)||!(null===(i=c.customer)||void 0===i||null===(o=i.meta)||void 0===o||null===(a=o.finance)||void 0===a||!a.serviceRateExpenses))&&"supplier"!==p,h=(0,l.a)(v.bZ,{variables:{jobId:c.id}}),y=h.loading,j=h.data,g=(j=void 0===j?{logs:[]}:j).logs,x=h.refetch,w=(0,m.D)(v.Tw,{onCompleted:function(){x(),s()}}),I=(0,u.Z)(w,1)[0],S=function(){var e=(0,D.Z)(R().mark((function e(t,n){var r,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="timing"!==t?n-(0,_e.B)(t,g)||0:null,i={type:t,value:n,jobId:c.id,difference:r,meta:{username:"".concat(f.nameFirst," ").concat(f.nameLast),userId:f.id}},e.next=4,I({variables:{objects:[i]}});case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),_=function(){var e=(0,D.Z)(R().mark((function e(t,n){var r;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null,r={type:t,value:null,jobId:c.id,difference:null,meta:{username:"".concat(f.nameFirst," ").concat(f.nameLast),userId:f.id}},e.next=4,I({variables:{objects:[r]}}).then((function(){return n()}));case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();return(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:6,children:(0,W.jsxs)(M.Z,{handleChange:!1,children:[(0,W.jsxs)("div",{active:"customer"===p||!p,label:"Customer",children:[b&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(he,{defaultValue:(0,_e.B)("serviceRateLabour",g),label:"Service Rate Labour ",name:"serviceRateLabour",onSubmit:S}),(0,W.jsx)(he,{defaultValue:(0,_e.B)("serviceRateExpenses",g),label:"Service Rate Expenses and Material",name:"serviceRateExpenses",onSubmit:S})]}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("discount",g),label:"Customer Discount",name:"discount",onSubmit:S,vat:"Incl Vat"}),!b&&"fixed"===c.pricing&&(0,W.jsx)(me,{defaultValue:(0,_e.B)("amount",g),label:"Amount",name:"amount",onSubmit:S,vat:"Ex Vat"}),"time-materials"===c.pricing&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Ze,{defaultValue:(0,_e.B)("timing",g),label:"Timing",name:"timing",onSubmit:S}),!b&&(0,W.jsx)(me,{defaultValue:(0,_e.B)("callOutCustomer",g),label:"First hour rate",name:"callOutCustomer",onSubmit:S,clearLogs:_,vat:"Ex Vat"}),!b&&(0,W.jsx)(me,{defaultValue:(0,_e.B)("customerRate",g),label:"Customer Rate",name:"customerRate",onSubmit:S,vat:"Ex Vat"}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("additions",g),label:"Additions",name:"additions",onSubmit:S,vat:"Incl Vat"}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("deductions",g),label:"Deductions",name:"deductions",onSubmit:S,vat:"Incl Vat"})]})]}),(0,W.jsxs)("div",{active:"supplier"===p,label:"Supplier",children:[(0,W.jsx)(Se,{defaultValue:(0,_e.B)("time",g),label:"Time (Minutes)",name:"time",onSubmit:S}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("supplierDiscount",g),label:"Supplier Discount",name:"supplierDiscount",onSubmit:S,vat:"Incl Vat"}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("supplierDeposit",g)||c.supplierDeposit,label:"Deposit paid to supplier",name:"supplierDeposit",onSubmit:S,vat:"Incl Vat"}),"fixed"===c.pricing&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(me,{defaultValue:(0,_e.B)("supplierLabourAmount",g)||c.supplierLabourAmount,label:"Supplier labour amount",name:"supplierLabourAmount",onSubmit:S,vat:"Ex Vat"}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("supplierMaterialsAmount",g)||c.supplierMaterialsAmount,label:"Supplier materials amount",name:"supplierMaterialsAmount",onSubmit:S,vat:"Ex Vat"})]}),"time-materials"===c.pricing&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(me,{defaultValue:(0,_e.B)("supplierRate",g),label:"Supplier Rate",name:"supplierRate",onSubmit:S,vat:"Ex Vat"}),(0,W.jsx)(me,{defaultValue:(0,_e.B)("callOutSupplier",g),label:"First hour rate",name:"callOutSupplier",onSubmit:S,clearLogs:_,vat:"Ex Vat"})]})]})]})}),(0,W.jsx)(O.Z,{md:6,children:(0,W.jsx)(xe,{loading:y,logs:g})})]})},Ae=n(50899),Ce=n(83789),De=n(30381),ke=n.n(De),Re=n(66805),qe=n(76800);function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Te(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var $e,Ne=[1,2,3].map((function(e){return{text:e,value:e,disabled:!1}})),Je=function(e){var t=e.job,n=e.toggleShow,r=e.updateJob,i=e.addJobTiming,o=e.user,a=(0,ae.cI)(),c=a.control,s=a.errors,u=a.handleSubmit,d=a.register,l=function(){var e=(0,D.Z)(R().mark((function e(a){var c;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a.status="quoteNew",a.type="quote",a.quoteDue=ke()(a.quoteDue).format(),a.quoted=!0,c={notes:"Compliance to Quote",status:"quoteNew",jobId:t.id,userId:o.id},e.next=7,i({variables:{objects:[c]}});case 7:return e.next=9,r({variables:{id:t.id,changes:a}}).then((function(){n()}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),p={control:c,errors:s,register:d};return(0,W.jsxs)(de.Z,{handleSubmit:u(l),children:[(0,W.jsx)(fe.Z,{label:"Number of Quotes",children:(0,W.jsx)(we.Z,Te(Te({},p),{},{name:"quoteNumber",options:[{text:"Select Type",value:"",disabled:!1}].concat((0,Ce.Z)(Ne))}))}),(0,W.jsx)(fe.Z,{label:"Quote due date"}),(0,W.jsx)(qe.M,Te(Te({},p),{},{name:"quoteDue"})),(0,W.jsx)(Re.H,{content:"Create quote",size:"md",type:"submit"})]})},He=n(38401),Ue=function(e){var t=e.job,n=e.refetch;return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:6,children:(0,W.jsx)(F.z,{enableUpdate:!0,job:t,open:!0,refetchParent:n},"expenses-".concat(t.id))}),(0,W.jsx)(O.Z,{md:6,children:(0,W.jsx)(He.j,{edit:!0,job:t,refetch:n},"workDescription-".concat(t.id))})]}),(0,W.jsx)(H.Z,{title:"Amounts",open:!0,children:(0,W.jsx)(Pe,{job:t,refetchJob:n})})]})},Me=(0,h.Ps)($e||($e=(0,b.Z)(['\n  mutation UpdateJobTiming(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "timingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_SupplierOffer(where: { jobId: { _eq: $id } }, _set: { status: "offered" }) {\n      returning {\n        id\n      }\n    }\n  }\n']))),Fe=n(42593),Ve=n(7566),Le=(0,se.Ry)().shape({timing:(0,se.Z_)().required().oneOf(["at","between"]),timingStart:(0,se.hT)().required(),timingEnd:(0,se.hT)().when("timing",{is:"between",then:(0,se.hT)().required()}),timingNormalHours:(0,se.Z_)()});function ze(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Qe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ze(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ze(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Be,Ye=function(e){var t=e.job,n=e.refetch,r=e.toggleShow,i=(0,c.useRouter)().query,o=(0,d.useContext)(oe.Z).user,a=(0,d.useContext)(Fe.Z).hasRole,s=(0,ae.cI)({defaultValues:{timing:t.timing,timingEnd:t.timingEnd?new Date(t.timingEnd):null,allowTimingNormalHours:!t.timingNormalHours,timingStart:t.timingStart?new Date(t.timingStart):null},resolver:(0,ce.S)(Le)}),l=s.control,p=s.errors,f=s.handleSubmit,v=s.register,b=s.setValue,h=s.watch,y=h("timing",t.timing),j=(0,m.D)(Me,{onCompleted:function(){n&&n(),r()}}),g=(0,u.Z)(j,1)[0],x=function(){var e=(0,D.Z)(R().mark((function e(n){var r,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=n,["timingEnd","timingStart"].forEach((function(e){i[e]&&(i[e]=ke()(i[e]).utc().format())})),"allowTimingNormalHours"===i.allowTimingNormalHours?i.timingNormalHours=!1:i.timingNormalHours=!0,delete i.allowTimingNormalHours,i.timing&&"at"===i.timing&&(i.timingEnd=null),i.scheduledAt=null,i.status="offered",null!==(r=t.meta)&&void 0!==r&&r.arrivalAnytime&&(i.meta=Qe(Qe({},t.meta),{},{arrivalAnytime:!1})),delete i.timeSpan,g({variables:{id:t.id,changes:Qe({},i),timing:{status:"timingChanged",meta:{timingEnd:ke()(t.timingEnd).utc().format(),timingStart:ke()(t.timingStart).utc().format()},jobId:t.id,userId:o.id}}});case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),w={control:l,errors:p,register:v};return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:f(x),children:(0,W.jsx)(Ve.X,Qe(Qe({},w),{},{hasRole:a,timingWatch:y,setValue:b,watch:h,query:i}))})},We=(0,h.Ps)(Be||(Be=(0,b.Z)(['\n  mutation UpdateJobPricing(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n    $offerId: Int!\n    $offerChanges: SupplierOffer_set_input\n    $hasOfferAccept: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $offerId }, _set: $offerChanges)\n      @include(if: $hasOfferAccept) {\n      id\n    }\n    delete_JobTiming(\n      where: { status: { _in: ["accepted", "lateArrival", "pricingChanged"] }, jobId: { _eq: $id } }\n    ) {\n      affected_rows\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']))),Ge=n(49313),Ke=n(3391),Xe=function(e){var t={};return["amount","customerSpendThreshold","paymentMethod","pricing","supplierLabourAmount","supplierMaterialsAmount"].forEach((function(n){var r=e[n];"number"===typeof r&&(r=r.toString()),t[n]=r})),e.service&&(t.serviceSelected={value:e.service.id,label:e.service.name}),e.costCategoryTaxonomy&&(t.costCategorySelected={value:e.costCategoryTaxonomy.id,label:e.costCategoryTaxonomy.name}),t},et=function(e){["amount","customerSpendThreshold","supplierLabourAmount","supplierMaterialsAmount"].forEach((function(t){e[t]?e[t]=parseInt(e[t]):e[t]=null}));return["costCategory","service"].forEach((function(t){e[t+"Selected"]&&e[t+"Selected"].value&&(e[t+"Id"]=e[t+"Selected"].value),delete e[t+"Selected"]})),e},tt=(0,se.Ry)().shape({costCategorySelected:(0,se.Ry)().required(),serviceSelected:(0,se.Ry)().required(),pricing:(0,se.Z_)().oneOf(["time-materials","fixed"]),customerSpendThreshold:(0,se.Z_)(),amount:(0,se.Z_)(),supplierLabourAmount:(0,se.Z_)(),supplierMaterialsAmount:(0,se.Z_)(),paymentMethod:(0,se.Z_)().oneOf(["card","invoice","N/A"])});function nt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function rt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nt(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var it,ot,at=function(e){var t,n,r=e.job,i=e.refetch,o=e.toggleShow,a=(0,d.useContext)(oe.Z).user,c=(0,ae.cI)({defaultValues:Xe(r),resolver:(0,ce.S)(tt)}),s=c.control,l=c.errors,p=c.handleSubmit,f=c.register,v=c.watch,b=v("pricing",r.pricing),h=v("serviceSelected",{value:null===(t=r.service)||void 0===t?void 0:t.id,label:null===(n=r.service)||void 0===n?void 0:n.name}),y=(0,m.D)(We,{onCompleted:function(){i&&i(),o()}}),j=(0,u.Z)(y,1)[0],g=function(){var e=(0,D.Z)(R().mark((function e(t){var n,i,o,c,s;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(n=et(t)).status="offered",i=r.supplierOffers.find((function(e){return"accepted"===e.status})),o=(null===i||void 0===i?void 0:i.statusLog)||[],c=(null===i||void 0===i?void 0:i.id)||0,s=[].concat((0,Ce.Z)(o),[{createdAt:new Date,status:"offered",userId:a.id}]),j({variables:{id:r.id,changes:rt({},n),timing:{status:"pricingChanged",jobId:r.id,userId:a.id},offerId:c,hasOfferAccept:!!c,offerChanges:{status:"offered",statusLog:s}}});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),x={control:s,errors:l,register:f};return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:p(g),children:[(0,W.jsx)(Ke.t,rt({},x)),(0,W.jsx)(Ge.n,rt(rt({},x),{},{pricingWatch:b,serviceSelectedWatch:h}))]})},ct=(0,h.Ps)(it||(it=(0,b.Z)(["\n  mutation AssignSupplier($object: AssignSupplierInput!) {\n    assignSupplier(assignSupplierInput: $object) {\n      data\n      success\n    }\n  }\n"]))),st=(0,h.Ps)(ot||(ot=(0,b.Z)(['\n  query GetSuppliers($area: String!, $jobId: Int!, $serviceId: Int, $status: String) {\n    suppliers: Account(\n      where: {\n        type: { _eq: "supplier" }\n        status: { _eq: $status }\n        Services: { serviceId: { _eq: $serviceId }, status: { _eq: "active" } }\n        PostcodeAreas: { PostcodeArea: { area: { _eq: $area } }, status: { _eq: "active" } }\n      }\n    ) {\n      id\n      createdAt\n      name\n      status\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          nameFirst\n          nameLast\n          email\n        }\n      }\n      services: Services(where: { serviceId: { _eq: $serviceId }, status: { _eq: "active" } }) {\n        id\n        hourRate\n        hourRateOOH\n        hourRatePremium\n        dayRate\n        dayRateOOH\n        dayRatePremium\n        service: Service {\n          id\n          name\n          supplierHourRate\n          supplierHourRateOOH\n          supplierHourRatePremium\n          supplierDayRate\n          supplierDayRateOOH\n          supplierDayRatePremium\n        }\n      }\n      postcodeAreas: PostcodeAreas {\n        id\n        status\n        area: PostcodeArea {\n          id\n          name\n          area\n        }\n      }\n      offers: SupplierOffers(where: { jobId: { _eq: $jobId } }) {\n        id\n        status\n        jobId\n        accountId\n      }\n      quotesOffers: SupplierQuotes(where: { jobId: { _eq: $jobId }, type: { _eq: "quote" } }) {\n        id\n        status\n        jobId\n        accountId\n      }\n    }\n  }\n']))),ut=n(44658),dt=n(11570);function lt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?lt(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):lt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var mt=function(e,t,n){var r,i,o,a=n.callOutHourRate&&{callOutHourRate:n.callOutHourRate,callOutHourRateOOH:n.callOutHourRateOOH,callOutHourRatePremium:n.callOutHourRatePremium},c=n.serviceId&&{supplierDayRate:n.dayRate,supplierDayRateOOH:n.datRateOOH,supplierDayRatePremium:n.dayRatePremium,supplierHourRate:n.hourRate,supplierHourRateOOH:n.hourRateOOH,supplierHourRatePremium:n.hourRatePremium,minimumInterval:n.minimumInterval,minimumLength:n.minimumLength};return(null===(r=e.meta)||void 0===r||null===(i=r.customerVATInvoice)||void 0===i||null===(o=i.rateInfo)||void 0===o?void 0:o.supplierService)||pt(pt(pt({},c),a),null===t||void 0===t?void 0:t.meta)},ft=function(e){var t=e.callOutHourRate&&{callOutHourRate:e.callOutHourRate,callOutHourRateOOH:e.callOutHourRateOOH,callOutHourRatePremium:e.callOutHourRatePremium};return e.serviceId&&pt(pt({},{customerDayRate:e.dayRate,customerDayRateOOH:e.datRateOOH,customerDayRatePremium:e.dayRatePremium,customerHourRate:e.hourRate,customerHourRateOOH:e.hourRateOOH,customerHourRatePremium:e.hourRatePremium,minimumInterval:e.minimumInterval,minimumLength:e.minimumLength,meta:e.meta}),t)},vt=n(34610),bt=n(39715),ht=function(e,t){var n,r,i;return"Normal"===e?t.hourRate||(null===(n=t.service)||void 0===n?void 0:n.supplierHourRate):"OOH"===e?t.hourRateOOH||(null===(r=t.service)||void 0===r?void 0:r.supplierHourRateOOH):"Premium"===e?t.hourRatePremium||(null===(i=t.service)||void 0===i?void 0:i.supplierHourRatePremium):void 0},yt=function(e,t){var n,r,i;return"Normal"===e?t.dayRate||(null===(n=t.service)||void 0===n?void 0:n.supplierDayRate):"OOH"===e?t.dayRateOOH||(null===(r=t.service)||void 0===r?void 0:r.supplierDayRateOOH):"Premium"===e?t.dayRatePremium||(null===(i=t.service)||void 0===i?void 0:i.supplierDayRatePremium):void 0},jt=function(e){var t=e.customerHourRate,n=e.job,r=e.onToggle,i=e.repost,o=(e.service,e.suppliers),a=(0,bt.K)(n),c=[{hidden:!0},{text:"Supplier"},{formatter:function(e){var t=e.row;return(0,W.jsx)(gt,{color:t.above?"red":null,children:(0,V.Z)(t.hourRate,"GBP")})},text:"Hour Rate/".concat(a)},{formatter:function(e){var t=e.row;return(0,V.Z)(t.dayRate,"GBP")},text:"Day Rate/".concat(a)},{formatter:function(e){var t=e.row;return(0,W.jsx)(vt.Z,{context:"secondary",size:"sm",onToggle:function(e){return r(t.above,t.id,e)},toggled:t.assigned})},text:(0,W.jsx)(vt.Z,{context:"secondary",size:"sm",onToggle:function(e){return m(e)}})},{hidden:!0},{hidden:!0}],s=function(e){var n=[];return o.forEach((function(r){var o,c=r.id,s=r.name,u=r.offers,d=r.services,l=r.quotesOffers,p=d[0],m=!1,f=!1;!i&&u.length&&u.forEach((function(e){"cancelled"!==e.status&&(m=!0)})),!i&&l.length&&l.forEach((function(e){"supplierQuoteRequested"===e.status&&(f=!0)})),!m&&!f&&n.push({id:c,name:s,hourRate:ht(a,p),dayRate:yt(a,p),actions:"",assigned:e,above:(p.hourRate||(null===(o=p.service)||void 0===o?void 0:o.supplierHourRate))>t})})),n.sort((function(e,t){return e.hourRate-t.hourRate}))},u=(0,d.useState)(s(!1)),l=u[0],p=u[1],m=function(e){p(s(e)),l.map((function(t){return r(t.above,t.id,e)}))};return(0,W.jsx)(z.Z,{columns:c,rows:l})},gt=Q.ZP.span.withConfig({displayName:"table__StyledValue",componentId:"sc-1illdtd-0"})(["color:",";"],(function(e){return e.color}));function xt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function wt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xt(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var It=function(e){var t,n,r,i,o,a,c=e.job,s=(e.deleteJobTiming,e.repost),p=e.refetch,f=e.toggleShow,v=(0,d.useContext)(oe.Z).user,b=(0,d.useState)({}),h=b[0],y=b[1],j=(0,d.useState)(null),g=j[0],x=j[1],w=(0,ae.cI)().handleSubmit,I=(0,P.WE)(null===c||void 0===c?void 0:c.location,"registered"),Z=(0,ut.Z)({postCode:null===I||void 0===I||null===(t=I.address)||void 0===t?void 0:t.postCode,country:null===I||void 0===I||null===(n=I.address)||void 0===n||null===(r=n.country)||void 0===r?void 0:r.code}),O=null!==Z&&void 0!==Z&&Z.area?Z.area.toUpperCase():null,_={area:O,jobId:c.id,serviceId:"quote"!==c.type?null===(i=c.service)||void 0===i?void 0:i.id:null,status:"active"},A=(0,l.a)(st,{skip:!O,variables:wt({},_)}),C=A.data,k=(C=void 0===C?{suppliers:[]}:C).suppliers,q=A.loading,E=(0,m.D)(ct,{onCompleted:function(e){p&&p(),f()},onError:function(e){x(e.message)}}),T=(0,u.Z)(E,1)[0],$=function(e){var t,n,r,i,o,a,c,s,u,d;if(null!==(t=e.meta)&&void 0!==t&&t.customerVATInvoice)return{customerService:null===(u=e.meta)||void 0===u?void 0:u.customerVATInvoice.rateInfo.selectedService,supplierService:null===(d=e.meta)||void 0===d?void 0:d.customerVATInvoice.rateInfo.supplierService};var l=pt({},e.service);l.entity="Job";var p=pt({},null===(n=e.customer)||void 0===n||null===(r=n.services)||void 0===r?void 0:r.find((function(e){return e.serviceId===(null===l||void 0===l?void 0:l.id)})));null!==p&&void 0!==p&&p.serviceId&&(p.entity="Customer");var m=pt({},null===(i=e.location)||void 0===i||null===(o=i.services)||void 0===o?void 0:o.find((function(e){return e.serviceId===(null===l||void 0===l?void 0:l.id)})));null!==m&&void 0!==m&&m.serviceId&&(m.entity="Property");var f=pt({},null===(a=e.supplier)||void 0===a||null===(c=a.services)||void 0===c?void 0:c.find((function(e){return e.serviceId===(null===l||void 0===l?void 0:l.id)})));null!==f&&void 0!==f&&f.serviceId&&(f.entity="Supplier");var v=null===(s=e.supplierOffers)||void 0===s?void 0:s.find((function(t){var n,r;return(null===(n=t.account)||void 0===n?void 0:n.id)===(null===(r=e.supplier)||void 0===r?void 0:r.id)}));return{customerService:pt(pt(pt({},l),ft(p)),ft(m)),supplierService:pt(pt({},l),mt(e,v,f))}}(c).customerService,N=function(){var e=(0,D.Z)(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],k.forEach((function(e){h[e.id]&&n.push(e.id)})),n.length?T({variables:{object:{jobId:c.id,repost:s,supplierIds:n,userId:v.id}}}):x("At least one supplier needs to be selected");case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return!q&&(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:w(N),children:[(0,W.jsx)(U.Z,{children:"Suppliers have been pruned based on the location of the customer and assigned services."}),(0,W.jsxs)(U.Z,{children:["Service: ",(0,W.jsx)("strong",{children:null===(o=c.service)||void 0===o?void 0:o.name})]}),"quote"!==c.type&&(0,W.jsxs)(U.Z,{children:["Customer rates:"," ",(0,W.jsxs)("strong",{children:[(0,V.Z)(null===$||void 0===$?void 0:$.customerHourRate),"/hour,"," ",(0,V.Z)(null===$||void 0===$?void 0:$.customerDayRate),"/day"]})]}),s&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(S.Z,{}),(0,W.jsx)(dt.Z,{context:"help",content:"Note: Reposting the job will cancel previous offers"})]}),"quote"!==c.type&&(null===(a=$.meta)||void 0===a?void 0:a.supplierHourRate)&&(0,W.jsx)(dt.Z,{context:"warning",content:(0,W.jsxs)(W.Fragment,{children:["Customer rates for supplier:",(0,W.jsxs)("strong",{children:[(0,V.Z)($.meta.supplierHourRate),"/hour,"," ",(0,V.Z)($.meta.supplierDayRate),"/day"]})," "]})}),"quote"===c.type&&c.quoteNumber&&(0,W.jsxs)(U.Z,{children:[(0,W.jsx)("strong",{children:c.quoteNumber})," supplier(s) needed for quote."]}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(jt,{customerHourRate:$.customerHourRate,job:c,onToggle:function(e,t,n){var r=h;r[t]=n,y(r),x(e&&n?"Supplier rate is above customer rate":null)},repost:s,service:c.service,suppliers:k}),(0,W.jsx)(S.Z,{}),g&&(0,W.jsx)(dt.Z,{context:"help",content:g}),!O&&(0,W.jsx)(dt.Z,{context:"info",content:"this location does not have an address associated"})]})},Zt=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(It,{job:t,refetch:r,toggleShow:n.show}),placement:"left",title:"Assign Supplier",width:"50%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Ot=function(){var e=(0,D.Z)(R().mark((function e(t,n,r,i,o){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Je,{addJobTiming:i,job:t,toggleShow:n.show,updateJob:r,user:o}),placement:"left",title:"Create Quote",width:"50%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r,i,o){return e.apply(this,arguments)}}(),St=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(at,{job:t,toggleShow:n.show,refetch:r}),title:"Change job pricing/service",width:"40%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),_t=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ye,{job:t,toggleShow:n.show,refetch:r}),title:"Change job timing",width:"40%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Pt=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ue,{job:t,refetch:r}),submit:!1,title:"Change job finance",width:"50%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),At=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.job,r=t.deleteJobTiming,i=t.offCanvas,o=t.refetch,i.show({content:(0,W.jsx)(It,{job:n,deleteJobTiming:r,repost:!0,refetch:o,toggleShow:i.show}),placement:"left",title:"Repost Job",width:"50%"});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();(0,se.Ry)().shape({amount:(0,se.Rx)().required()});var Ct=function(e){var t,n=e.hasRole,r=e.job,i=e.refetch,o=e.user,a=n("admin"),c=n("supplier"),s=n("customer"),l=(0,d.useContext)(E.Z),p=(0,d.useState)({}),f=p[0],v=p[1],b=(0,d.useState)({}),h=b[0],j=b[1],g=(0,re.E)(r,["validated","unvalidated"]),x="pending"===r.status,w=(0,d.useState)("customerVat"),I=w[0],Z=w[1],O=(null===(t=r.media)||void 0===t?void 0:t.filter((function(e){var t;return"invoice"===(null===(t=e.item)||void 0===t?void 0:t.category)})).length)||0,_=(0,m.D)(y.iU),P=(0,u.Z)(_,1)[0],A=function(){var e=(0,D.Z)(R().mark((function e(){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,P({variables:{jobId:r.id,invoiceType:"supplier"}}).then((function(e){var t,n=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData;v&&v(n)}));case 2:return e.next=4,P({variables:{jobId:r.id,invoiceType:"customerVat"}}).then((function(e){var t,n=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData;j(n)}));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();(0,d.useEffect)((0,D.Z)(R().mark((function e(){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A();case 2:case"end":return e.stop()}}),e)}))),[]);var C=function(e){var t=e.tab;return(0,W.jsxs)(W.Fragment,{children:[(a||c||s)&&(null===h||void 0===h?void 0:h.amountInfo)&&(0,W.jsx)(ie,{isCustomer:s,isSupplier:c,job:r,refetch:i,tab:t,user:o,financeSupplier:f,financeCustomer:h}),!1,(0,W.jsx)(S.Z,{}),(0,re.E)(r,"accepted")&&(0,W.jsx)(F.z,{job:r,open:!0,refetchParent:i,tab:t,withDetails:!1},"expenses-".concat(r.id))]})},k=function(e){e.stopPropagation(),l.show({content:(0,W.jsx)(Ae.G,{category:"invoice",entity:"Job",entityId:r.id,onMediaAdd:i,type:"document"}),submit:!1,title:"Upload Invoice"})},q=function(e){e.stopPropagation(),l.show({content:(0,W.jsx)(Pe,{job:r,refetchJob:i,activeTab:I}),title:"Update Amounts",submit:!1,width:"50%"})},V=function(){return(0,W.jsxs)(T.Z,{children:[(0,W.jsx)($.Z,{content:"".concat(O," Invoice Uploaded"),children:(0,W.jsx)(N.Z,{content:c?"Upload Invoice":(0,W.jsx)(J.Z,{icon:"file-upload"}),context:"info",onClick:k,itemCount:"".concat(O),size:"sm",startIconProps:{size:"lg"}})}),a&&null!==r.pricing&&(0,W.jsx)(N.Z,{content:(0,W.jsx)(J.Z,{icon:"edit"}),context:"secondary",onClick:q,size:"sm"})]})};return(0,W.jsx)(H.Z,{open:!0,title:"Finance",iconComponent:null,fitParentHeight:!0,toolbar:i&&!s&&!g&&(0,W.jsx)(V,{}),children:null===r.pricing?(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(U.Z,{context:"danger",children:"Pricing is not set, please update the pricing details"}),a&&!x&&(0,W.jsx)(S.Z,{marginTop:"md",children:(0,W.jsx)(N.Z,{context:"danger",onClick:function(){return St(r,l,i)},children:"Change job pricing or service"})})]}):(0,W.jsxs)(W.Fragment,{children:[a&&(0,W.jsxs)(M.Z,{handleChange:!1,onTabChange:function(e){Z(e)},children:[(0,W.jsx)("div",{active:!0,label:"Customer",children:(0,W.jsx)(C,{tab:"customerVat"},"1")}),(0,W.jsx)("div",{label:"Supplier",children:(0,W.jsx)(C,{tab:"supplier"},"2")},"2")]}),!a&&c&&(0,W.jsx)(C,{tab:"supplier"},"supplier"),!a&&s&&(0,W.jsx)(C,{tab:"customerVat"},"customerVat")]})})};Ct.proptypes={hasRole:q.func,job:q.object,refetch:q.func,user:q.object};var Dt,kt,Rt=function(e,t){var n,r;if(Array.isArray(t)){var i=null;return t.forEach((function(t){var n,r,o=null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));i=(null===o||void 0===o||null===(r=o.user)||void 0===r?void 0:r.fullName)||i})),i}var o=null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));return(null===o||void 0===o||null===(r=o.user)||void 0===r?void 0:r.fullName)||null},qt=function(e,t){var n;if(Array.isArray(t)){var r=null;return t.forEach((function(t){var n,i=null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));r=(null===i||void 0===i?void 0:i.id)||r})),r}var i=null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));return(null===i||void 0===i?void 0:i.id)||null},Et=function(e,t){return!e||e>t},Tt=n(12841),$t=n(28865),Nt=n(11417),Jt=(0,h.Ps)(Dt||(Dt=(0,b.Z)(["\n  mutation UpsertJobReport($objects: [JobReport_insert_input!]!) {\n    insert_JobReport(\n      objects: $objects\n      on_conflict: {\n        constraint: uc_JobReport_jobId\n        update_columns: [completion, meta, notes, timing]\n      }\n    ) {\n      returning {\n        id\n        completion\n        meta\n        notes\n        timing\n        createdAt\n        updatedAt\n      }\n    }\n  }\n"]))),Ht=(0,h.Ps)(kt||(kt=(0,b.Z)(["\n  mutation UpdateJob($id: Int!, $update: Job_set_input!) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $update) {\n      id\n    }\n  }\n"]))),Ut=n(68159),Mt=n(83528),Ft=n(77417),Vt=n(69128),Lt=n(84550),zt=n(88261),Qt=n(7863),Bt=(0,se.Ry)({id:(0,se.Rx)(),completion:(0,se.Z_)().oneOf(Qt.M2.map((function(e){return e.value}))).required(),notes:(0,se.Z_)(),timing:(0,se.Z_)().oneOf(["correct","incorrect"]).required(),completionNotes:(0,se.Z_)(),houseKeepingExpenses:(0,se.nK)(),houseKeepingPhotos:(0,se.nK)(),correctStart:(0,se.hT)().max(new Date),correctEnd:(0,se.hT)().when("correctStart",(function(e,t){return e?t.min(e).max(new Date):t.max(new Date)})),correctDuration:(0,se.Rx)().min(1).when(["correctStart","correctEnd"],(function(e,t,n){var r=ke()(t).diff(e,"minutes");return n.max(r)}))});function Yt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Wt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yt(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Gt=function(e){var t,n,r,i,o,a,c,s,d,l,p=e.job,f=e.offCanvas,v=e.refetch,b={id:null===(t=p.report)||void 0===t?void 0:t.id,completion:null===(n=p.report)||void 0===n?void 0:n.completion,notes:null===(r=p.report)||void 0===r?void 0:r.notes,timing:p.timingStatus,completionNotes:(null===(i=p.report)||void 0===i||null===(o=i.meta)||void 0===o?void 0:o.completionNotes)||"",houseKeepingExpenses:null===(a=p.report)||void 0===a||null===(c=a.meta)||void 0===c?void 0:c.houseKeepingExpenses,houseKeepingPhotos:null===(s=p.report)||void 0===s||null===(d=s.meta)||void 0===d?void 0:d.houseKeepingPhotos,correctDuration:p.correctDuration,correctStart:p.correctStart?new Date(p.correctStart):"",correctEnd:p.correctEnd?new Date(p.correctEnd):""},h=(0,ae.cI)({defaultValues:b,resolver:(0,ce.S)(Bt)}),y=h.errors,j=h.handleSubmit,g=h.register,x=h.watch,w=h.control,I=h.setValue,Z=x("timing"),O=x("completion"),S=x("correctStart"),_=x("correctEnd"),P=(0,Ut.Z)({autoStart:!1,startTime:(0,re.E)(p,"inProgress"),endTime:(0,re.E)(p,"completed")}).time,A=P.seconds,C=P.minutes,D=P.hours,k=(0,m.D)(Jt,{onCompleted:function(e){f.close(),v&&v()}}),R=(0,u.Z)(k,1)[0],q=(0,m.D)(Ht,{onCompleted:function(e){f.close(),v&&v()}}),E=(0,u.Z)(q,1)[0],T=(null===p||void 0===p||null===(l=p.media)||void 0===l?void 0:l.length)||0,$={control:w,errors:y,register:g},N=null;switch(O){case"returnVisit":N="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":N="Please indicate the type of works and engineer required";break;case"couldNotDo":N="Please advise why you were unable to do these works"}return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:j((function(e){var t={id:e.id,jobId:p.id,completion:e.completion,notes:e.notes,meta:{houseKeepingExpenses:e.houseKeepingExpenses,houseKeepingPhotos:e.houseKeepingPhotos}};e.completionNotes&&(t.meta.completionNotes=e.completionNotes),R({variables:{objects:[t]}}),E({variables:{id:p.id,update:{timingStatus:e.timing,correctDuration:"incorrect"===e.timing?e.correctDuration:null,correctStart:"incorrect"===e.timing?e.correctStart:null,correctEnd:"incorrect"===e.timing?e.correctEnd:null}}})})),children:[(0,W.jsx)(fe.Z,{label:"Notes",children:(0,W.jsx)(Mt.Z,Wt(Wt({},$),{},{name:"notes",rows:4}))}),(0,re.E)(p,"completed")&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(fe.Z,{label:"Timing",children:(0,W.jsx)(Vt.Z,Wt(Wt({},$),{},{data:[{id:"correct",label:"I confirm that the job took ".concat(D,":").concat(C,":").concat(A),value:"correct"},{id:"incorrect",label:"The timing is incorrect",value:"incorrect"}],name:"timing",stacked:!0}))}),"incorrect"===Z&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(fe.Z,{label:"Enter correct time of starting ",children:(0,W.jsx)(qe.M,Wt(Wt({},$),{},{errors:y,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select Start time",name:"correctStart",showTimeSelect:!0,todayButton:!1,maxDate:_?new Date(_):new Date,onChange:function(e){I("correctStart",e),I("correctDuration",ke()(_).diff(e,"minutes"))}}))}),(0,W.jsx)(fe.Z,{label:"Enter correct time of ending ",children:(0,W.jsx)(qe.M,Wt(Wt({},$),{},{errors:y,dateFormat:"d MMM yyyy HH:mm",disableInitialDateBackground:!1,placeholder:"Click to select End time",name:"correctEnd",showTimeSelect:!0,todayButton:!1,minDate:S?new Date(S):new Date,maxDate:new Date,onChange:function(e){I("correctEnd",e),I("correctDuration",ke()(e).diff(S,"minutes"))}}))}),(0,W.jsx)(fe.Z,{label:"Enter correct job duration",children:(0,W.jsxs)(be.Z,{children:[(0,W.jsx)(Oe.Z,{errors:y,min:0,name:"correctDuration",register:g,type:"number"}),(0,W.jsx)(pe.Z,Wt(Wt({},$),{},{addonType:"append",size:"sm",text:!0,children:"Minutes"}))]})})]}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(fe.Z,{label:"Job status",children:(0,W.jsx)(Vt.Z,Wt(Wt({},$),{},{data:Qt.M2,name:"completion",stacked:!0}))}),N&&(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(fe.Z,{label:N,children:(0,W.jsx)(Mt.Z,Wt(Wt({},$),{},{name:"completionNotes",rows:2}))})}),(0,W.jsx)(Ft.Z,{}),(0,W.jsxs)(fe.Z,{label:"Requirements",children:[(0,W.jsx)(Lt.Z,Wt(Wt({},$),{},{data:[{id:"expensesAdded",label:"Expenses added",value:"expensesAdded"}],name:"houseKeepingExpenses"})),(0,W.jsxs)(Kt,{children:["Confirm all expenses have been added, expenses not added before completing a job may not be paid",function(){var e=(0,zt.E)(p.expenses,0,"supplier").totalExpenses;return(0,W.jsx)(L.Z,{content:"Total submitted",text:(0,V.Z)(e)})}()]}),(0,W.jsx)(Lt.Z,Wt(Wt({},$),{},{data:[{id:"photosAdded",label:"Photos added",value:"photosAdded"}],name:"houseKeepingPhotos"})),(0,W.jsxs)(Kt,{children:["You must add at least 1 photo, but please include before and after photos as a minimum (",T," Photo(s) added)"]})]})]})]})},Kt=Q.ZP.small.withConfig({displayName:"form__StyledSmall",componentId:"sc-d1alez-0"})(["margin-top:-0.75rem;display:block;"]);function Xt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function en(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Xt(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Xt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var tn=function(e){var t,n=e.job,r=(null===(t=Qt.M2.find((function(e){var t;return e.value===(null===n||void 0===n||null===(t=n.report)||void 0===t?void 0:t.completion)})))||void 0===t?void 0:t.label)||"Unconfirmed";return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(B.Z,{context:function(){var e;switch(null===n||void 0===n||null===(e=n.report)||void 0===e?void 0:e.completion){case"complete":return"success";case"couldNotDo":return"danger";default:return"info"}}(),content:r,size:"sm"}),(0,W.jsx)(B.Z,en(en({},function(){switch(null===n||void 0===n?void 0:n.timingStatus){case"correct":return{context:"success",content:"Timing: Correct"};case"incorrect":return{context:"danger",content:"Timing: Incorrect"};default:return{context:"info",content:"Timing: Unconfirmed"}}}()),{},{size:"sm"}))]})};tn.defaultProps={job:{}};var nn=function(e){for(var t="",n=e.slice().sort((function(e,t){return Number(e.id)-Number(t.id)})),r=n.length-1;r>=0;r--){var i=n[r].status;if("onHold"===i||"resumed"===i||"paused"===i||"continued"===i){t=n[r].status;break}}return t},rn=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"QuoteThresholdApproval")&&n===t.quoteId}))},on=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"QuoteThresholdApproved")&&n===t.quoteId}))},an=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"QuoteThresholdRejected")&&n===t.quoteId}))},cn=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"ThresholdApproval")}))},sn=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"ThresholdApproved")}))},un=function(e,t,n){var r,i=null===t||void 0===t||null===(r=t.slice())||void 0===r?void 0:r.sort((function(e,t){return t.id-e.id}));return null===i||void 0===i?void 0:i.find((function(t){return t.status==="".concat(e,"ThresholdRejected")}))},dn=n(1323),ln=n(78777),pn=function(e){var t,n,r,i,o,a,c,s,l=e.job,p=e.user,f=e.refetch,v=(0,d.useContext)(E.Z),b=(0,dn.x)().hasRole,h=null===p||void 0===p||null===(t=p.meta)||void 0===t||null===(n=t.threshold)||void 0===n?void 0:n.invoice,j=null===l||void 0===l||null===(r=l.quotations)||void 0===r?void 0:r.find((function(e){return"quotationRejected"!==e.status})),g=null===j||void 0===j||null===(i=j.lineItems)||void 0===i?void 0:i.reduce((function(e,t){return e+t.supplierTotal}),0),x="onHold"===nn(l.timings),w=sn("supplier",null===l||void 0===l?void 0:l.timings),I=(0,m.D)(y.xY,{onCompleted:function(){f&&f()}}),Z=(0,u.Z)(I,1)[0],O=function(){Z({variables:{id:l.id,changes:{},timing:{jobId:l.id,status:"reportSentSupplier",userId:p.id}}})};return(0,W.jsxs)(H.Z,{open:!!(0,re.E)(l,"completed"),title:"Report",children:[l.report&&(0,re.E)(l,"completed")&&(0,W.jsx)(tn,{job:l}),(null===(o=l.report)||void 0===o?void 0:o.notes)&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Nt.Z,{tag:"h3",content:"Notes",noMargin:!0}),(0,W.jsx)("p",{children:l.report.notes})]}),!x&&(0,W.jsxs)(T.Z,{align:"flex-end",children:[(0,W.jsx)(N.Z,{content:l.report?"Update Report":"Create Report",context:"secondary",onClick:function(){v.show({content:(0,W.jsx)(Gt,{job:l,offCanvas:v,refetch:f}),title:"Job Report"})},size:"sm"}),b("supplier")&&(Et(h,g)||w)&&(0,W.jsx)(N.Z,{content:"Submit Report",onClick:O,size:"sm",disabled:!(null!==(a=l.report)&&void 0!==a&&a.completion)}),b("supplier")&&!(Et(h,g)||w)&&(0,W.jsx)(N.Z,{content:"Request threshold",onClick:function(){return(0,ln.I_)({type:"issue",role:"supplier",jobId:l.id,accountId:p.accountId,quotationId:null===j||void 0===j?void 0:j.id,threshold:h,offCanvas:v})},size:"sm",disabled:!(null!==(c=l.report)&&void 0!==c&&c.completion)}),!b("supplier")&&(0,W.jsx)(N.Z,{content:"Submit Report",onClick:O,size:"sm",disabled:!(null!==(s=l.report)&&void 0!==s&&s.completion)})]})]})};function mn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function fn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?mn(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var vn=function(e){e.accountId,e.quotationId;var t=e.onSuccess,n=(0,ae.cI)(),r=n.control,i=n.errors,o=n.handleSubmit,a={control:r,errors:i,register:n.register},c=function(){var e=(0,D.Z)(R().mark((function e(n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t(n.acceptedNotes);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:o(c),children:[(0,W.jsx)(fe.Z,{label:"Notes",children:(0,W.jsx)(Mt.Z,fn(fn({},a),{},{name:"acceptedNotes",rows:3}))}),(0,W.jsx)(N.Z,{content:"Accept",context:"primary",type:"submit"})]})},bn=function(e){e.accountId,e.quotationId;var t=e.onSuccess,n=(0,ae.cI)(),r=n.control,i=n.errors,o=n.handleSubmit,a={control:r,errors:i,register:n.register},c=function(){var e=(0,D.Z)(R().mark((function e(n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t(n.acceptedNotes);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:o(c),children:[(0,W.jsx)(fe.Z,{label:"Notes",children:(0,W.jsx)(Mt.Z,fn(fn({},a),{},{name:"acceptedNotes",rows:3}))}),(0,W.jsx)(N.Z,{content:"Reject",context:"danger",type:"submit"})]})},hn=n(55863),yn=n(48764).Buffer,jn=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){var i,o,a,c,s,u,d,l,p,m,f;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=[],u=[],d=null,d=n?t.quotations.find((function(e){return e.id===n})):t.quotations.find((function(e){return"supplierQuoteSent"===e.status}))){e.next=6;break}return e.abrupt("return",null);case 6:return d.lineItems.forEach((function(e){var t={name:e.description,price:e.total,vatRate:.2,qty:e.qty,unit:e.qtyUnit,rate:e.unitRate};"Materials"===e.type?u.push(t):"Labour"===e.type&&s.push(t)})),l=(0,P.WE)(null===t||void 0===t?void 0:t.location,"registered"),p=(0,P.WE)(null===t||void 0===t?void 0:t.customer,"invoice"),m=(null===(i=d.meta)||void 0===i?void 0:i.terms)||(null===t||void 0===t||null===(o=t.admin)||void 0===o||null===(a=o.meta)||void 0===a||null===(c=a.quote)||void 0===c?void 0:c.terms),f={adminId:r,job:{currency:"\xa3",currencyId:1,customerName:t.customer.name,startDate:d.startDate,description:yn.from(t.description).toString("base64"),duration:d.totalDuration?1===d.totalDuration?"".concat(d.totalDuration," ").concat(d.totalDurationUnit):"".concat(d.totalDuration," ").concat(d.totalDurationUnit,"s"):"-",id:t.id,number:t.number,invoiceToAddress:null===p||void 0===p?void 0:p.address,labour:s,materials:u,methodStatement:d.methodStatement,propertyAddress:null===l||void 0===l?void 0:l.address,terms:yn.from(m).toString("base64")}},e.abrupt("return",f);case 12:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),gn=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o,a=arguments;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:null,r=a.length>2?a[2]:void 0,e.next=4,jn(t,n,r);case 4:if(!(i=e.sent)){e.next=9;break}return o=window.open("/download","_blank"),e.next=9,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/quote/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(i)}).then((function(e){return e.json()})).then((function(e){o.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,hn.Tb)({message:e,section:"fetch"})}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),xn=n(91110),wn=n(55148),In=(0,se.Ry)().shape({terms:(0,se.Z_)().required()});function Zn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function On(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Zn(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Zn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Sn=function(e){var t,n,r,i=e.refetch,o=e.quotation,a=e.toggleShow,c=e.PublicQuoteTerms,s=(0,m.D)(f.Dg,{onCompleted:function(){a(),i&&i()}}),d=(0,u.Z)(s,1)[0],l=(0,ae.cI)({defaultValues:{terms:null!==(t=null!==(n=null===(r=o.meta)||void 0===r?void 0:r.terms)&&void 0!==n?n:c)&&void 0!==t?t:""},resolver:(0,ce.S)(In)}),p=l.control,v=l.errors,b=l.handleSubmit,h=l.register,y=function(){var e=(0,D.Z)(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=On({},o.meta)||{}).terms=t.terms,e.next=4,d({variables:{changes:{meta:n},supplierOffer:[],id:o.id}});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),j={control:p,errors:v,register:h};return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:b(y),children:(0,W.jsx)(Mt.Z,On(On({},j),{},{name:"terms",rows:8}))})},_n=n(56257);function Pn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function An(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Pn(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Cn=function(e){var t,n,r,i,o,a,c,s,p=e.quote,v=e.quotes,b=e.job,h=e.refetch,j=e.isHideAllQuotation,g=(0,dn.x)(),w=g.user,I=g.hasRole,Z=(0,l.a)(x.nh,{variables:{id:w.id}}).data,O=(Z=void 0===Z?{user:{}}:Z).user,S=null===(t=w=An(An({},w),O))||void 0===t||null===(n=t.meta)||void 0===n||null===(r=n.threshold)||void 0===r?void 0:r.quote,_=p.lineItems.reduce((function(e,t){return e+t.supplierTotal}),0),P=(null===p||void 0===p||null===(i=p.lineItems)||void 0===i?void 0:i.reduce((function(e,t){return e+t.total}),0))||0,A=P+.2*P,C=(0,d.useContext)(E.Z),D=["supplierQuoteRequested","thresholdApproved","quotationRejected"].includes(p.status),k=(0,m.D)(y.xY,{onCompleted:function(){h&&h()}}),R=(0,u.Z)(k,1)[0],q=(0,m.D)(f.Dg),$=(0,u.Z)(q,1)[0],U=(0,m.D)(f.lx),M=(0,u.Z)(U,1)[0],F=(0,m.D)(f.HI),L=(0,u.Z)(F,1)[0],Q=(0,l.a)(x.nE,{variables:{id:w.adminId}}),B=Q.data;if(Q.loading)return null;var Y=null===(o=B.account)||void 0===o||null===(a=o.meta)||void 0===a||null===(c=a.quote)||void 0===c?void 0:c.terms,G=function(){C.show({content:(0,W.jsx)(Ae.G,{entity:"Quotation",entityId:p.id}),submit:!1,title:"View media"})},K=function(e){var t=e.status;if("supplierQuoteComplete"!==t&&"supplierQuoteRefused"!==t&&"waitingThresholdApproval"!==t||"quoteOffered"!==b.status&&"waitingThresholdApproval"!==b.status)h&&h();else{var n="quoteReceived";R({variables:{id:b.id,changes:{status:n},timing:{status:n,jobId:b.id,userId:w.id,quoteId:p.id}}})}C.close()},X=wn.E6.find((function(e){return e.value===p.status}))||{text:"-",context:"info"},ee=function(){C.show({title:"Quotation Number: ".concat(p.quoteNumber),content:(0,W.jsx)(xn.m,{onSuccess:K,quotationId:p.id}),width:"50%",submit:!1})},te=function(e){var t,n,r="offered";n=(null===(t=b.compliances)||void 0===t?void 0:t.length)>0?"cppm":b.ppm?"ppm":"reactive";var i=p.lineItems.filter((function(e){return"Labour"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0),o=p.lineItems.filter((function(e){return"Materials"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0),a=p.lineItems.reduce((function(e,t){return e+t.total}),0);R({variables:{id:b.id,changes:{amount:a,status:r,supplierId:p.supplier.id,supplierLabourAmount:i,supplierMaterialsAmount:o,type:n},timing:[{status:"quoteAccepted",jobId:b.id,notes:e,userId:w.id},{status:r,jobId:b.id,notes:e,userId:w.id}]}});var c={jobId:b.id,status:"offered",accountId:p.supplier.id};$({variables:{id:p.id,changes:{status:"quotationAccepted"},supplierOffer:c}}),M({variables:{jobId:b.id,changes:{status:"quotationRejected",notes:"Accepted another quotation"}}}),C.close()},ne=function(e){L({variables:{id:p.id,changes:{status:"quotationRejected",notes:e},recommend:!1}}),C.close()},ie=function(){C.show({title:"Accept Quotation Number: ".concat(p.quoteNumber),width:"25%",submit:!1,content:(0,W.jsx)(vn,{accountId:p.supplier.id,quotationId:p.id,quote:p,toggleShow:C.close,onSuccess:te})})},oe=function(){C.show({title:"Reject Quotation Number: ".concat(p.quoteNumber),width:"25%",submit:!1,content:(0,W.jsx)(bn,{accountId:p.supplier.id,quotationId:p.id,quote:p,toggleShow:C.close,onSuccess:ne})})},ae=function(){C.show({content:(0,W.jsx)(Sn,{refetch:h,quotation:p,toggleShow:C.close,PublicQuoteTerms:Y}),title:"Terms of quote",width:"30%"})},ce=[{key:"Quotation",value:function(){return(0,W.jsx)(T.Z,{align:"left",children:(0,W.jsx)(N.Z,{content:"View Quotation",context:"secondary",onClick:ee,size:"sm"})})}},{key:"Accept / Reject",hidden:j||D||!I(["admin"]),value:function(){return(0,W.jsxs)(T.Z,{align:"left",children:[(0,W.jsx)(N.Z,{content:"Accept",context:"primary",onClick:ie,size:"xs"}),(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:oe,size:"xs"})]})}},{key:"Accept / Reject",hidden:j||D||!I(["customer"]),value:function(){return(0,W.jsxs)(T.Z,{align:"left",children:[(0,W.jsx)(N.Z,{content:"Accept",context:"primary",onClick:function(){return Et(S,A)||on(w.accountType,null===b||void 0===b?void 0:b.timings,p.id)?ie():(0,ln.I_)({type:"quote",role:"customer",quotations:v,quotationId:p.id,jobId:b.id,accountId:b.customer.id,threshold:S,offCanvas:C})},size:"xs"}),(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:oe,size:"xs"})]})}},{hidden:!(I([].concat((0,Ce.Z)(_n.nx),(0,Ce.Z)(_n.n)))&&rn(w.accountType,null===b||void 0===b?void 0:b.timings,p.id)&&Et(S,"supplier"===w.accountType?_:A)),key:"Manager Approved",value:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[!on(w.accountType,null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"quote",role:w.accountType,job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"}),!an(w.accountType,null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"quote",role:w.accountType,job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"})]})}},{hidden:!(I((0,Ce.Z)(_n.Sf))&&rn("adminSupplier",null===b||void 0===b?void 0:b.timings,p.id)&&Et(S,_)),key:"Manager Approved(supplier)",value:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[!on("adminSupplier",null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"quote",role:"adminSupplier",job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"}),!an("adminSupplier",null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"quote",role:"adminSupplier",job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"})]})}},{hidden:!(I((0,Ce.Z)(_n.Sf))&&rn("adminCustomer",null===b||void 0===b?void 0:b.timings,p.id)&&Et(S,A)),key:"Manager Approved(customer)",value:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[!on("adminCustomer",null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"quote",role:"adminCustomer",job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"}),!an("adminCustomer",null===b||void 0===b?void 0:b.timings,p.id)&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"quote",role:"adminCustomer",job:b,quoteId:p.id,offCanvas:C,refetch:h})},size:"sm"})]})}},{key:"Status",value:X.text},{key:"Supplier",value:(null===p||void 0===p||null===(s=p.supplier)||void 0===s?void 0:s.name)||b.quotations[0].supplier.name},{key:"Date received",value:(0,ge.Z)(p.createdAt)},{hidden:!I(["admin","customer"]),key:"Labour Total",value:(0,V.Z)(p.lineItems.filter((function(e){return"Labour"===e.type})).reduce((function(e,t){return e+t.total*t.qty}),0))},{hidden:!I(["admin","customer"]),key:"Materials Total",value:(0,V.Z)(p.lineItems.filter((function(e){return"Materials"===e.type})).reduce((function(e,t){return e+t.total*t.qty}),0))},{hidden:!I(["admin","customer"]),key:"Quote Total",value:(0,V.Z)(p.lineItems.reduce((function(e,t){return e+t.total*t.qty}),0))},{hidden:!I(["admin","supplier"]),key:"Labour Supplier Total",value:(0,V.Z)(p.lineItems.filter((function(e){return"Labour"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0))},{hidden:!I(["admin","supplier"]),key:"Materials Supplier Total",value:(0,V.Z)(p.lineItems.filter((function(e){return"Materials"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0))},{hidden:!I(["admin","supplier"]),key:"Supplier Total",value:(0,V.Z)(p.lineItems.reduce((function(e,t){return e+t.supplierTotal}),0))},{key:"Duration",value:p.totalDuration?"".concat(p.totalDuration," ").concat(p.totalDurationUnit):"-"},{key:"Start date",value:p.startDate?(0,ge.Z)(p.startDate):"-"},{key:"Site Visit",value:p.siteVisitAt&&(0,ge.Z)(p.siteVisitAt,!0),hidden:!b.siteVisitStart||!p.siteVisitAt},{key:"Attachments",value:function(){var e,t;return(0,W.jsx)(N.Z,{content:"View Attachments",context:"secondary",itemCount:(null===p||void 0===p||null===(e=p.media)||void 0===e?void 0:e.length)>0?null===p||void 0===p||null===(t=p.media)||void 0===t?void 0:t.length:null,onClick:G,size:"sm"})}}];return I(["admin","Supplier"])&&ce.push({key:"Terms",value:function(){return(0,W.jsx)(N.Z,{content:"Terms of the Quote",context:"secondary",onClick:ae,size:"sm"})}}),"quoteSent"!==b.status&&"quoteReceived"!==b.status&&"quotationAccepted"!==p.status||ce.push({key:"PDF",value:function(){return(0,W.jsx)(N.Z,{context:"white",onClick:function(){return gn(b,p.id,b.adminId)},size:"sm",children:(0,W.jsx)(J.Z,{context:"secondary",icon:"download",size:"lg"})})}}),(0,W.jsx)(H.Z,{open:!((0,re.E)(b,"accepted")&&"quotationAccepted"!==p.status),title:"Quotation ".concat(p.quoteNumber," ").concat(p.recommended?" (Recommended)":""," ").concat("quotationAccepted"===p.status?" (Accepted)":"","  "),children:(0,W.jsx)(z.Z,{rows:ce})})},Dn=function(e){var t,n=e.quotes,r=e.job,i=e.refetch,o=(0,dn.x)().hasRole,a=["supplierQuoteSent","quotationRejected","quotationAccepted","supplierQuoteUpdated","waitingThresholdApproval"],c=n.slice().filter((function(e){return"uplift"!==e.type&&(!o("customer")||a.find((function(t){return t===e.status})))}));return t=!!c.find((function(e){return"quotationAccepted"===e.status})),c.sort((function(e){return"quotationAccepted"===e.status?-1:0})).map((function(e){return(0,W.jsx)(Cn,{quote:e,job:r,refetch:i,quotes:c,isHideAllQuotation:t},e.quoteNumber)}))};Dn.defaultProps={quotes:[]};var kn,Rn,qn=function(e){var t=e.job,n=e.refetch;return(0,W.jsx)(W.Fragment,{children:t.id&&(0,W.jsx)(Dn,{quotes:t.quotations,job:t,refetch:n})})},En=n(94673),Tn=n(76972),$n=n(69690),Nn=n(23855),Jn=function(e){var t,n,r=e.job,i=([].concat((0,Ce.Z)(wn.iz),(0,Ce.Z)(wn.yW)).find((function(e){return e.value===r.status}))||{text:"-"}).text,o=r.siteVisitStart&&(0,ge.Z)(r.siteVisitStart,!0),a=r.siteVisitEnd&&(0,ge.Z)(r.siteVisitEnd,!0),c=r.siteVisitWeekends,s=[{key:"Status",value:i},{key:"Required quotes",value:r.quoteNumber},{key:"Quote due date",value:(0,ge.Z)(r.quoteDue)},{hidden:r.quotations.find((function(e){return"quotationAccepted"===e.status})),key:"Sent quotations",value:(null===(t=r.quotations)||void 0===t?void 0:t.filter((function(e){return"supplierQuoteSent"===e.status})).map((function(e){return e.quoteNumber})).join(", "))||"-"},{hidden:!r.quotations.find((function(e){return"quotationAccepted"===e.status})),key:"Accepted quotation",value:null===(n=r.quotations.find((function(e){return"quotationAccepted"===e.status})))||void 0===n?void 0:n.quoteNumber},{hidden:!r.quotations.find((function(e){return"quotationAccepted"===e.status})),key:"Acceptance time",value:function(e){var t=(0,En.Z)((0,Nn.Z)((0,re.E)(e,"quoteAccepted")),(0,Nn.Z)((0,re.E)(e,"quoteReceived"))),n=(0,Tn.Z)((0,Nn.Z)((0,re.E)(e,"quoteAccepted")),(0,Nn.Z)((0,re.E)(e,"quoteReceived"))),r=(0,$n.Z)((0,Nn.Z)((0,re.E)(e,"quoteAccepted")),(0,Nn.Z)((0,re.E)(e,"quoteReceived")));return"".concat(t>0?t+" day ":"").concat(n>0?n+" hours ":"").concat(r+" minutes")}(r)},{key:"Site Visit Start",value:o,hidden:!o},{key:"Site Visit End",value:a,hidden:!a},{key:"Include Weekends",value:c&&"Yes",hidden:!c}];return(0,W.jsx)(H.Z,{open:!0,title:"Quote details",children:(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(z.Z,{rows:s})})})})},Hn=n(87883),Un=n(48764).Buffer,Mn=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o,a,c,s,u,d,l,p,m,f,v,b,h,y,j;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=t.adminId,d=t.job,l=t.openReport,p=void 0===l||l,m=function(){return d.media.filter((function(e){return"image"===e.item.type})).map((function(e){var t,n;if(null!==(t=e.item)&&void 0!==t&&null!==(n=t.meta)&&void 0!==n&&n.thumbnails){var r=e.item.meta.thumbnails.find((function(e){return"small"===e.name}));if(r)return r.relativePath}return e.item.filename}))},f=(0,P.WE)(d.location,"registered"),v=wn.hD.find((function(e){var t;return e.value===(null===(t=d.report)||void 0===t?void 0:t.completion)})),b=v.text,e.next=6,{job:{address:null===f||void 0===f?void 0:f.address,contractor:null===(n=d.supplier)||void 0===n?void 0:n.name,completedAt:"incorrect"===d.timingStatus?d.correctEnd:(0,ge.Z)((0,re.E)(d,"completed")),customer:null===(r=d.customer)||void 0===r?void 0:r.name,description:Un.from(d.description).toString("base64"),expenses:null===(i=d.expenses)||void 0===i?void 0:i.map((function(e){return e.description})),further:b,id:d.id,notes:null!==(o=d.report)&&void 0!==o&&o.notes?Un.from(null===d||void 0===d||null===(a=d.report)||void 0===a?void 0:a.notes).toString("base64"):"",number:d.number,raisedBy:Rt(d,"pending"),reference:d.reference,service:null===(c=d.service)||void 0===c?void 0:c.name,dateStart:"incorrect"===d.timingStatus?d.correctStart:(0,re.E)(d,"inProgress"),dateEnd:"incorrect"===d.timingStatus?d.correctEnd:(0,re.E)(d,"completed"),priority:null===(s=d.sla)||void 0===s?void 0:s.name},adminId:u,media:m()};case 6:return h=e.sent,y=p&&window.open("/download","_blank"),e.next=10,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/job-report/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(h)}).then((function(e){return e.json()})).then((function(e){return p&&y.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key)),e})).catch((function(e){(0,hn.Tb)({message:e,section:"fetch"})}));case 10:return j=e.sent,e.abrupt("return",j);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Fn=n(13886),Vn=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Fn.q,{accountId:t.customerId,adminId:t.adminId,jobId:t.id,jobNumber:t.number,refetch:r,toggleShow:n.show}),title:"Payment",width:"50%"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Ln=function(e){var t=e.job,n=e.refetch,r=e.status,i=e.toggleShow,o=(0,d.useContext)(oe.Z).user,a=(0,ae.cI)({defaultValues:{comments:""}}),c=a.errors,s=a.handleSubmit,l=a.register,p=(0,m.D)(v.r2,{onCompleted:function(){n&&n(),i()}}),f=(0,u.Z)(p,1)[0],b=function(){var e=(0,D.Z)(R().mark((function e(n){var i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i={notes:n.comments,status:r,jobId:t.id,userId:o.id},f({variables:{objects:[i]}});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:s(b),children:(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,{errors:c,name:"comments",register:l,rows:3})})})},zn=function(e,t){var n=e.addJobTiming,r=e.entityId,i=e.job,o=e.onlyShow,a=void 0!==o&&o,c=e.userId,s={status:"complianceReportSent",jobId:i.id,userId:c};t.show({content:(0,W.jsx)(Ae.G,{entity:"Compliance_Entity",entityId:r,showActionButtons:!a,showItemActions:!a,onMediaAdd:function(){n({variables:{objects:[s]}}),t.close()}}),submit:!1,title:a?"Compliance report":"Upload report"})},Qn=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ln,{job:t,refetch:r,status:"complianceApproved",toggleShow:n.show}),title:"Approve report"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Bn=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ln,{job:t,refetch:r,status:"complianceRejected",toggleShow:n.show}),title:"Reject report"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Yn=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ln,{job:t,refetch:r,status:"complianceRequestedDocumentation",toggleShow:n.show}),title:"Request Documentation"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Wn=n(7755),Gn=n(26075),Kn=(0,h.Ps)(kn||(kn=(0,b.Z)(['\n  mutation UpdateJob(\n    $id: Int!\n    $changes: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n    $invoiceCustomer: InvoiceJobInput!\n    $createInvoice: Boolean!\n  ) {\n    update_Job_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    delete_InvoiceAmount(\n      where: {\n        Invoice: { invoiceType: { _in: ["customerVat", "supplier"] }, Job: { id: { _eq: $id } } }\n      }\n    ) {\n      affected_rows\n    }\n    delete_Invoice(\n      where: {\n        entity: { _eq: "Job" }\n        entityId: { _eq: $id }\n        invoiceType: { _in: ["customerVat", "supplier"] }\n      }\n    ) {\n      affected_rows\n    }\n\n    createInvoiceJob(invoiceJobInput: $invoiceCustomer) @include(if: $createInvoice) {\n      data\n    }\n  }\n']))),Xn=(0,h.Ps)(Rn||(Rn=(0,b.Z)(['\n  mutation UpdateJob($id: Int!, $timing: [JobTiming_insert_input!]!) {\n    delete_JobTiming(where: { jobId: { _eq: $id }, status: { _eq: "validated" } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n']))),er=n(53256),tr=n(29918);function nr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function rr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nr(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ir=function(e){e.addJobTiming;var t=e.deleteJobTiming,n=e.job,r=e.refetch,i=e.status,o=e.toggleShow,a=(0,d.useContext)(oe.Z).user,c=(0,Gn.x)(),s=(0,d.useState)(!1),l=s[0],p=s[1],f=(0,ae.cI)({defaultValues:{notes:""}}),v=f.errors,b=f.handleSubmit,h=f.register,y=(0,m.D)(er.aO,{onCompleted:function(){r&&r(),o()}}),j=(0,u.Z)(y,1)[0],g=(0,m.D)(Kn,{onCompleted:function(){l&&j({variables:{invoiceJobInput:{adminId:n.adminId,entity:"Job",entityId:n.id,invoiceType:"supplier",jobId:n.id,userId:a.id}}}),r&&r(),o()}}),x=(0,u.Z)(g,1)[0],w=(0,m.D)(Xn,{onCompleted:function(){r&&r(),o()}}),I=(0,u.Z)(w,1)[0],Z=function(){var e=(0,D.Z)(R().mark((function e(r){var o,s,u,d,l,m,f,v,b;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("validated"!==i){e.next=21;break}if(s={},u=!1,!(0,re.E)(n,"unvalidated")){e.next=10;break}return e.next=6,(0,tr.Hj)(c,n,"".concat(a.nameFirst," ").concat(a.nameLast));case 6:o=e.sent,(0,re.E)(n,"invoiceSent")?(s={adminId:n.adminId,entity:"Job",entityId:n.id,invoiceType:"customer",jobId:n.id,userId:a.id},p(!0),u=!0):p(!1),e.next=18;break;case 10:return o=rr({},n.meta)||{},e.next=13,(0,tr.FB)(c,n.id);case 13:d=e.sent,l=d.financeSupplier,m=d.financeCustomer,o.customerVATInvoice=m,o.supplierInvoice=l;case 18:x({variables:{id:n.id,changes:{meta:o},timing:{notes:r.notes,status:i,jobId:n.id,userId:a.id},invoiceCustomer:s,createInvoice:u}}),e.next=22;break;case 21:"unvalidated"===i&&(f={id:n.id,status:"waitingForThresholdApproval",userId:a.id},t({variables:f}),v={id:n.id,status:"thresholdRejected",userId:a.id},t({variables:v}),b={id:n.id,status:"thresholdApproved",userId:a.id},t({variables:b}),I({variables:{id:n.id,timing:{notes:r.notes,status:i,jobId:n.id,userId:a.id}}}));case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:b(Z),children:["validated"===i&&(0,W.jsx)(U.Z,{children:"Once marked as validated, changing job financials will be disabled."}),"unvalidated"===i&&(0,W.jsx)(U.Z,{children:"Changing job financials will be enabled. "}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(fe.Z,{label:"Notes",children:(0,W.jsx)(Mt.Z,{errors:v,name:"notes",register:h,rows:4})})]})},or=n(5597),ar=n(78606);function cr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function sr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cr(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ur=null,dr=function(e){var t,n,r,i,o,a,c,s=e.defaultOptions,u=e.job,l=e.showSubmit,p=e.watch,m=(0,dn.x)(),f=m.hasRole,v=m.user,b=(0,Gn.x)();f(["admin","superadmin"])&&v.accountId&&(ur=v.accountId);var h=p("sendEmail"),y=p("revisions"),j=(0,d.useState)(!1),g=j[0],x=j[1],w=(null===(t=u.meta)||void 0===t||null===(n=t.revisions)||void 0===n?void 0:n.map((function(e,t){return{text:"".concat((0,or.Z)(new Date(e.date),"yyyy-MM-dd HH:mm")," by ").concat(e.user),value:t}})))||[];w=[{text:"current version",value:-1}].concat((0,Ce.Z)(w));var I=y&&"-1"!==y?"warning":"secondary";return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(lr,{md:10,children:(0,W.jsx)(U.Z,{children:l?"Preview PDF":"Download PDF"})}),(0,W.jsx)(O.Z,{md:2,children:w.length>1&&(0,W.jsx)(N.Z,{context:"white",title:"History",onClick:function(){x(!g)},children:(0,W.jsx)(J.Z,{context:"secondary",icon:"history",size:"lg"})})})]}),g&&(0,W.jsx)(we.Z,sr(sr({},s),{},{name:"revisions",options:w})),(0,W.jsx)(S.Z,{}),(0,W.jsxs)(T.Z,{align:"flex-start",children:[(0,W.jsx)(N.Z,{content:"Customer VAT",context:I,onClick:function(){return(0,ar._)({adminId:ur,job:u,revisionIndex:y,type:"customerVat",client:b})},size:"sm"}),(0,W.jsx)(N.Z,{content:"Customer FEE",context:I,onClick:function(){return(0,ar._)({adminId:ur,job:u,revisionIndex:y,type:"customerFee",client:b})},size:"sm"})]}),l&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(S.Z,{}),(0,W.jsx)(L.Z,{content:"Customer",text:null===(r=u.customer)||void 0===r?void 0:r.name}),(0,W.jsx)(L.Z,{content:"Customer Contact",text:null===(i=u.customerUser)||void 0===i?void 0:i.fullName}),(0,W.jsx)(L.Z,{content:"Phone",text:null===(o=u.customerUser)||void 0===o?void 0:o.phone}),(0,W.jsx)(L.Z,{content:"Email",text:null===(a=u.customerUser)||void 0===a?void 0:a.email}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(Vt.Z,sr(sr({},s),{},{legend:"Invoice type",name:"invoiceType",data:[{id:"vat",label:"VAT",value:"vat"},{id:"fee",label:"FEE",value:"fee"},{id:"novat",label:"NO VAT",value:"novat"}]})),(0,W.jsx)(Vt.Z,sr(sr({},s),{},{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===h&&(0,W.jsx)(fe.Z,{label:"Send to email address",children:(0,W.jsx)(Oe.Z,sr(sr({},s),{},{defaultValue:null===(c=u.customerUser)||void 0===c?void 0:c.email,name:"customerEmail"}))})]})]})},lr=(0,Q.ZP)(O.Z).withConfig({displayName:"customer__StyledColumn",componentId:"sc-1fgc93a-0"})(["align-self:center;"]);function pr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function mr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pr(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var fr=function(e){var t,n,r,i,o,a=e.defaultOptions,c=e.job,s=e.showSubmit,u=e.watch,l=(0,dn.x)(),p=l.hasRole,m=l.user,f=(0,Gn.x)(),v=null;p(["admin","superadmin"])&&m.accountId&&(v=m.accountId);var b=(null===c||void 0===c||null===(t=c.supplier)||void 0===t||null===(n=t.contactUsers[0])||void 0===n?void 0:n.user)||null,h=u("sendEmail"),y=u("revisions"),j=(0,d.useState)(!1),g=j[0],x=j[1],w=(null===(r=c.meta)||void 0===r||null===(i=r.revisions)||void 0===i?void 0:i.map((function(e,t){return{text:"".concat((0,or.Z)(new Date(e.date),"yyyy-MM-dd HH:mm")," by ").concat(e.user),value:t}})))||[];w=[{text:"current version",value:-1}].concat((0,Ce.Z)(w));var I=y&&"-1"!==y?"warning":"secondary";return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(vr,{md:10,children:(0,W.jsx)(U.Z,{children:s?"Preview PDF":"Download PDF"})}),(0,W.jsx)(O.Z,{md:2,children:w.length>1&&(0,W.jsx)(N.Z,{context:"white",title:"History",onClick:function(){x(!g)},children:(0,W.jsx)(J.Z,{context:"secondary",icon:"history",size:"lg"})})})]}),g&&(0,W.jsx)(we.Z,mr(mr({},a),{},{name:"revisions",options:w})),(0,W.jsx)(N.Z,{content:"Supplier",context:I,onClick:function(){return(0,ar._)({adminId:v,type:"supplier",job:c,revisionIndex:y,client:f})},size:"md"}),s&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(S.Z,{}),(0,W.jsx)(L.Z,{content:"Supplier",text:null===(o=c.supplier)||void 0===o?void 0:o.name}),b&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(L.Z,{content:"Supplier Contact",text:b.fullName}),(0,W.jsx)(L.Z,{content:"Phone",text:b.phone}),(0,W.jsx)(L.Z,{content:"Email",text:b.email})]}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(Vt.Z,mr(mr({},a),{},{data:[{id:"sendEmail",label:"Send invoice via email",value:"sendEmail"},{id:"markAsInvoiceSent",label:"Mark invoice as sent",value:"markAsInvoiceSent"}],name:"sendEmail"})),"sendEmail"===h&&(0,W.jsx)(fe.Z,{label:"Send to email address",children:(0,W.jsx)(Oe.Z,mr(mr({},a),{},{defaultValue:b.email,name:"supplierEmail"}))})]})]})},vr=(0,Q.ZP)(O.Z).withConfig({displayName:"supplier__StyledColumn",componentId:"sc-v4o4fk-0"})(["align-self:center;"]),br=(0,se.Ry)().shape({invoiceType:(0,se.Z_)()}),hr=function(e){var t=e.job,n=e.refetch,r=e.showSubmit,i=e.toggleShow,o=e.type,a=(0,d.useContext)(oe.Z).user,c=(0,ae.cI)({resolver:(0,ce.S)(br)}),s=c.errors,l=c.handleSubmit,p=c.register,f=c.watch,v=(0,m.D)(er.aO,{onCompleted:function(){n&&n(),i()}}),b=(0,u.Z)(v,1)[0],h=function(){var e=(0,D.Z)(R().mark((function e(n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:b({variables:{invoiceJobInput:{adminId:t.adminId,entity:"Job",entityId:t.id,customerEmail:n.customerEmail,invoiceType:o,jobId:t.id,sendEmail:n.sendEmail,supplierEmail:n.supplierEmail,type:n.invoiceType,userId:a.id}}});case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y={errors:s,register:p};return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:l(h),children:["customer"===o?(0,W.jsx)(dr,{defaultOptions:y,job:t,showSubmit:r,watch:f}):(0,W.jsx)(fr,{defaultOptions:y,job:t,showSubmit:r,watch:f}),r&&(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},yr=function(e){var t,n="customerVat",r=null===(t=e.meta)||void 0===t?void 0:t.sendCustomerInvoiceType;if(r)switch(r){case"novat":n="customer";break;case"fee":n="customerFee"}return n},jr=function(e,t,n,r,i){n.show({content:(0,W.jsx)(hr,{job:t,refetch:r,showSubmit:i,toggleShow:n.show,type:e}),submit:!1,title:i?"Send ".concat(e," invoice"):"Download ".concat(e," invoice")})},gr=function(e){var t=e.job,n=e.refetch,r=e.status,i=e.toggleShow,o=(0,d.useContext)(oe.Z).user,a=(0,ae.cI)({defaultValues:{comments:""}}),c=a.errors,s=a.handleSubmit,l=a.register,p=(0,m.D)(y.xY,{onCompleted:function(){n&&n(),i()}}),f=(0,u.Z)(p,1)[0],v=function(){var e=(0,D.Z)(R().mark((function e(n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f({variables:{id:t.id,changes:{status:r},timing:{notes:n.comments,status:r,jobId:t.id,userId:o.id}}});case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:s(v),children:[(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,{errors:c,name:"comments",register:l,rows:3})}),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},xr=function(){var e=(0,D.Z)(R().mark((function e(t,n,r,i){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.show({content:(0,W.jsx)(gr,{job:t,status:n,toggleShow:r.show,refetch:i}),submit:!1,title:"Job status change"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r,i){return e.apply(this,arguments)}}();function wr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ir(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wr(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Zr=function(e){var t=e.job,n=e.refetch,r=e.toggleShow,i=(0,d.useContext)(oe.Z).user,o=(0,ae.cI)({defaultValues:{comments:""}}),a=o.errors,c=o.handleSubmit,s=o.register,l=(0,m.D)(v.Tw,{onCompleted:function(){n&&n()}}),p=(0,u.Z)(l,1)[0],f=(0,m.D)(y.xY,{onCompleted:function(){n&&n(),r()}}),b=(0,u.Z)(f,1)[0],h=function(){var e=(0,D.Z)(R().mark((function e(n){var r,o,a,c,s,u,d,l,m,f,v,h,y,j,g,x;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={value:0,jobId:t.id,difference:0,meta:{username:"".concat(i.nameFirst," ").concat(i.nameLast),userId:i.id,notes:n.comments}},o=Ir({type:"discount"},r),a=Ir({type:"customerDeposit"},r),c=Ir({type:"callOutCustomer"},r),s=Ir({type:"supplierDeposit"},r),u=Ir({type:"supplierDiscount"},r),d=Ir({type:"amount"},r),l=Ir({type:"supplierMaterialsAmount"},r),m=Ir({type:"supplierLabourAmount"},r),f=Ir({type:"supplierRate"},r),v=Ir({type:"customerRate"},r),h=Ir({type:"additions"},r),y=Ir({type:"deductions"},r),j=Ir({type:"callOutSupplier"},r),g=[o,c,s,u,a],x="fixed"===t.pricing?[d,l,m]:[f,v,h,y,j],e.next=18,p({variables:{objects:[].concat(g,x)}}).then((function(e){b({variables:{id:t.id,changes:{status:"closed"},timing:{notes:n.comments,status:"closed",jobId:t.id,userId:i.id}}})}));case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:c(h),children:[(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,{errors:a,name:"comments",register:s,rows:3})}),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},Or=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Zr,{job:t,toggleShow:n.show,refetch:r}),submit:!1,title:"Close and zero value job"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Sr=function(e,t){var n,r={};return r.JobTimings={data:[{status:"quoteNew",userId:t.id}]},r.Taxonomy={data:[{entity:"Job",taxonomyId:null===(n=e.shortJobDesc[0])||void 0===n?void 0:n.taxonomyId}]},r.access=e.access,r.adminId=e.adminId,r.assetCategoryId=null,r.customerId=e.customerId,r.customerSpendThreshold=e.customerSpendThreshold||null,r.customerUserId=e.customerUserId,r.description=e.description,r.endDate=e.endDate||null,r.locationId=e.locationId,r.managerId=e.managerId||null,r.parentId=e.id,r.pricing="fixed",r.quoted=!0,r.quoteDue=new Date,r.quoteNumber="3",r.reference=e.reference||"",r.serviceId=null,r.siteVisitEnd=null,r.siteVisitStart=null,r.siteVisitWeekends=!1,r.slaId=e.slaId,r.source=e.source,r.status="quoteOffered",r.timingNormalHours=e.timingNormalHours,r.title=null,r.type="quote",r};function _r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_r(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ar,Cr,Dr=function(e){var t=e.job,n=e.toggleShow,r=e.refetch,i=(0,dn.x)(),o=i.hasRole,a=i.user,c=(0,ae.cI)({defaultValues:{isRecall:!1}}),s=c.handleSubmit,d=c.errors,l=c.register,p=(0,m.D)(v.mJ,{onCompleted:function(){n(),r()}}),f=(0,u.Z)(p,1)[0],b=(0,m.D)(ct,{onCompleted:function(e){r&&r(),n()}}),h=(0,u.Z)(b,1)[0],y=function(){var e=(0,D.Z)(R().mark((function e(n){var r,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Sr(t,o),i=n.description,e.next=4,f({variables:{adminId:a.adminId,objects:[Pr(Pr({},r),{},{description:i})]}}).then((function(e){var n,r,i=(null===e||void 0===e?void 0:e.data.createJob.data.insert_Job.returning[0]).id;(null===t||void 0===t||null===(n=t.supplier)||void 0===n?void 0:n.id)&&h({variables:{object:{jobId:i,repost:!1,supplierIds:[null===t||void 0===t||null===(r=t.supplier)||void 0===r?void 0:r.id],userId:a.id}}})}));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:s(y),children:[(0,W.jsx)(fe.Z,{label:"Description",children:(0,W.jsx)(Mt.Z,{errors:d,name:"description",register:l,rows:3})}),(0,W.jsx)(Re.H,{content:"Create remedial quote",type:"submit"})]})},kr=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Dr,{job:t,toggleShow:n.close,refetch:r}),title:"Remedial quote",submit:!1});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Rr=function(){var e=(0,D.Z)(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c.default.push("/dashboard/issues/view?id=".concat(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),qr=n(12778),Er=(0,h.Ps)(Ar||(Ar=(0,b.Z)(["\n  mutation AcceptJob($object: AcceptJobOfferInput!) {\n    acceptJobOffer(acceptOfferInput: $object) {\n      data\n      success\n    }\n  }\n"]))),Tr=(0,h.Ps)(Cr||(Cr=(0,b.Z)(["\n  mutation UpdateSupplierOffer(\n    $assignedReject: Boolean!\n    $changes: SupplierOffer_set_input\n    $id: Int!\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    insert_JobTiming(objects: $timing) @include(if: $assignedReject) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) @include(if: $assignedReject) {\n      id\n    }\n    update_SupplierOffer_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),$r=n(95146),Nr=(0,se.Ry)().shape({arrivalTime:(0,se.hT)().required(),acceptedContractor:(0,se.Ry)().required(),time:(0,se.Xg)()}),Jr=(0,se.Ry)().shape({rejectedNotes:(0,se.Z_)().required()}),Hr=n(7145);function Ur(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Mr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ur(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ur(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Fr=function(e){var t,n,r,i=e.accountId,o=e.job,a=e.offCanvas,c=e.refetch,s=e.edit,l=(0,d.useState)(),p=l[0],f=l[1],v=(0,dn.x)(),b=v.hasRole,h=v.user,y=i||"supplier"===h.accountType&&h.accountId,j=(null===o||void 0===o||null===(t=o.quotations.find((function(e){return"quotationAccepted"===e.status})))||void 0===t?void 0:t.startDate)||new Date,g=o.quoted?j:o.timingStart,x=null,w=null,I=(null===o||void 0===o?void 0:o.scheduledAt)&&new Date(o.scheduledAt)||null;o.timingEnd?(x=new Date(g),w=new Date(o.timingEnd)):(x=(0,qr.Z)(new Date(g),1),w=o.quoted?new Date(new Date(g).getTime()+5184e6):new Date(g));var Z=null;o.supplierOffers.forEach((function(e){e.account.id===y&&(Z=e)}));var O=(0,m.D)(Er,{onCompleted:function(e){c&&c(),a.close()},onError:function(e){f(e.message)}}),_=(0,u.Z)(O,1)[0],P=function(){var e=(0,D.Z)(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:_({variables:{object:{arrivalAnytime:"anytime"===t.time,jobId:o.id,scheduledAt:t.arrivalTime?(0,Hr.v)(t.arrivalTime):null,supplierId:y,supplierUserId:null===(n=t.acceptedContractor)||void 0===n?void 0:n.value,supplierOfferId:Z.id,offerStatusLog:JSON.stringify(Z.statusLog),userId:h.id,edit:s}}});case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),A=(0,ae.cI)({defaultValues:{arrivalTime:I||(o.timingEnd?x:w),acceptedContractor:null!==o&&void 0!==o&&null!==(n=o.supplier)&&void 0!==n&&null!==(r=n.contactUsers)&&void 0!==r&&r.length?{value:o.supplier.contactUsers[0].user.id,label:o.supplier.contactUsers[0].user.fullName}:null},resolver:(0,ce.S)(Nr)}),C=A.control,k=A.errors,q=A.handleSubmit,E=A.register,T=(0,A.watch)("time"),$={control:C,errors:k,register:E};return(0,W.jsxs)(de.Z,{handleSubmit:q(P),children:[(0,W.jsxs)("div",{children:[(0,W.jsx)("strong",{children:"Scheduled:"})," ",(0,W.jsx)("span",{children:(0,or.Z)(new Date(g),"d MMM yyyy HH:mm")}),o.timingEnd&&(0,W.jsxs)("span",{children:[" - ",(0,or.Z)(new Date(o.timingEnd),"d MMM yyyy HH:mm")]})]}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(fe.Z,{label:"Arrival time"}),b("admin")&&(0,W.jsx)(Lt.Z,Mr(Mr({},$),{},{data:[{id:"anytime",label:"Anytime",value:"anytime"}],name:"time"})),(0,W.jsx)(qe.M,Mr(Mr({},$),{},{dateFormat:"anytime"!==T?"d MMM yyyy HH:mm":"d MMM yyyy",maxDate:w,minDate:x,maxTime:o.timingEnd?null:w,minTime:o.timingEnd?null:x,name:"arrivalTime",showTimeSelect:"anytime"!==T,timeIntervals:15,todayButton:!1})),(0,W.jsx)(S.Z,{}),(0,W.jsx)($r.P,Mr(Mr({},$),{},{accountId:y,errors:Mr({},k),label:"Operative",name:"acceptedContractor",type:"user"})),(0,W.jsx)(Re.H,{content:"Confirm",type:"submit"}),p&&(0,W.jsx)(dt.Z,{content:p,context:"danger"})]})};function Vr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Lr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vr(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}Fr.defaultProps={edit:!1};var zr=function(e){var t,n,r=e.accountId,i=e.job,o=e.offCanvas,a=e.refetch,s=e.cancelMod,l=(0,d.useContext)(oe.Z).user,p=r||"supplier"===l.accountType&&l.accountId,f=!(null===(t=i.supplier)||void 0===t||!t.id),v=null;i.supplierOffers.forEach((function(e){e.account.id===p&&(v=e)}));var b=(0,m.D)(Tr,{onCompleted:function(e){o.close(),"supplier"===l.accountType?c.default.push("/dashboard"):a&&a()}}),h=(0,u.Z)(b,1)[0],y=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,o,a,c,u;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],o=null,a=null,c=s?"cancelBySupplier":"rejected",u={createdAt:(0,Hr.v)(),notes:t.rejectedNotes,status:c,userId:l.id},null!==(n=v)&&void 0!==n&&n.statusLog?(o=(0,Ce.Z)(v.statusLog)).push(u):o=[u],f&&(a={scheduledAt:null,status:c,supplierId:null,supplierUserId:null},r.push({status:c,jobId:i.id,userId:l.id,notes:t.rejectedNotes})),h({variables:{assignedReject:f,changes:{status:c,notes:t.rejectedNotes,statusLog:o},id:v.id,jobChanges:a,jobId:i.id,timing:r,cancelMod:s}});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),j=(0,ae.cI)({defaultValues:{rejectedNotes:null===(n=v)||void 0===n?void 0:n.notes},resolver:(0,ce.S)(Jr)}),g=j.control,x=j.errors,w=j.handleSubmit,I={control:g,errors:x,register:j.register};return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:w(y),children:(0,W.jsx)(fe.Z,{label:"Notes",children:(0,W.jsx)(Mt.Z,Lr(Lr({},I),{},{name:"rejectedNotes",rows:3}))})})};zr.defaultProps={cancelMod:!1};var Qr=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.job,r=t.offCanvas,i=t.refetch,o=t.accountId,r.show({content:(0,W.jsx)(Fr,{accountId:o||null,job:n,offCanvas:r,refetch:i}),submit:!1,title:"Accept Job"});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Br=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.job,r=t.offCanvas,i=t.refetch,o=t.accountId,r.show({content:(0,W.jsx)(zr,{accountId:o||null,job:n,offCanvas:r,refetch:i}),title:"Reject Job"});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Yr=n(64509),Wr=function(e){var t,n,r,i,o,a,c,s,u,d=e.job,l={completion:null===(t=d.report)||void 0===t?void 0:t.completion,notes:null===(n=d.report)||void 0===n?void 0:n.notes,timing:d.timingStatus,completionNotes:(null===(r=d.report)||void 0===r||null===(i=r.meta)||void 0===i?void 0:i.completionNotes)||"",houseKeepingExpenses:null===(o=d.report)||void 0===o||null===(a=o.meta)||void 0===a?void 0:a.houseKeepingExpenses,houseKeepingPhotos:null===(c=d.report)||void 0===c||null===(s=c.meta)||void 0===s?void 0:s.houseKeepingPhotos,correctDuration:d.correctDuration,correctStart:d.correctStart?new Date(d.correctStart):"",correctEnd:d.correctEnd?new Date(d.correctEnd):""},p=(0,Ut.Z)({autoStart:!1,startTime:(0,re.E)(d,"inProgress"),endTime:(0,re.E)(d,"completed")}).time,m=p.seconds,f=p.minutes,v=p.hours,b=null;switch(l.completionNotes){case"returnVisit":b="Please provide description of works and time required in hours/days";break;case"returnVisitByAnother":b="Please indicate the type of works and engineer required";break;case"couldNotDo":b="Please advise why you were unable to do these works"}return(0,W.jsxs)("div",{children:[(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(L.Z,{content:"Notes",text:l.notes}),(0,W.jsx)(Ft.Z,{})]}),(0,re.E)(d,"completed")&&(0,W.jsxs)(W.Fragment,{children:["correct"===l.timing&&(0,W.jsx)(L.Z,{content:"Timing",text:"I confirm that the job took ".concat(v,":").concat(f,":").concat(m)}),"incorrect"===l.timing&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(L.Z,{content:"The timing is incorrect",text:"incorrect"}),l.correctStart&&(0,W.jsx)(L.Z,{content:"Correct start",text:"".concat((0,ge.Z)(l.correctStart)," - ").concat((0,Yr.Z)(l.correctStart))}),l.correctEnd&&(0,W.jsx)(L.Z,{content:"Correct end",text:"".concat((0,ge.Z)(l.correctEnd)," - ").concat((0,Yr.Z)(l.correctEnd))}),l.correctDuration&&(0,W.jsx)(L.Z,{content:"Correct duration",text:"".concat(l.correctDuration," - minutes")})]}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(L.Z,{content:"Job status",text:null===(u=Qt.M2.find((function(e){return e.value===l.completion})))||void 0===u?void 0:u.label}),b&&(0,W.jsx)(L.Z,{content:b,text:l.completionNotes}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(Nt.Z,{tag:"h4",content:"Requirements"}),"expensesAdded"===l.houseKeepingExpenses&&(0,W.jsxs)(Kr,{children:[(0,W.jsx)(J.Z,{context:"success",icon:"check",size:"sm"}),(0,W.jsx)(L.Z,{content:"",text:"Expenses added"}),(0,W.jsx)(Gr,{children:function(){var e=(0,zt.E)(d.expenses,0,"supplier").totalExpenses;return(0,W.jsx)(L.Z,{content:"Total submitted",text:(0,V.Z)(e)})}()})]}),"photosAdded"===l.houseKeepingPhotos&&(0,W.jsxs)(Kr,{children:[(0,W.jsx)(J.Z,{context:"success",icon:"check",size:"sm"}),(0,W.jsx)(L.Z,{content:"",text:"Photos added"})]})]})]})},Gr=Q.ZP.small.withConfig({displayName:"details__StyledSmall",componentId:"sc-zc4e8j-0"})(["display:block;"]),Kr=Q.ZP.div.withConfig({displayName:"details__StyledIconBox",componentId:"sc-zc4e8j-1"})(["display:flex;align-items:center;"]),Xr=n(93515);function ei(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ti(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ei(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ei(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ni,ri,ii,oi,ai,ci,si,ui,di,li=function(e){var t,n,r,i,o=e.job,a=e.refetch,c=e.toggleShow,s=(0,d.useContext)(oe.Z).user,l=o.location,p=o.customer,f=(null===p||void 0===p?void 0:p.addresses.filter((function(e){var t;return"active"===e.status&&(null===(t=e.address.meta)||void 0===t?void 0:t.invoicingEmail)})).map((function(e){return{label:e.address.meta.invoicingEmail,value:e.address.meta.invoicingEmail}})))||null,v=(null===l||void 0===l?void 0:l.addresses.filter((function(e){var t;return"active"===e.status&&(null===(t=e.address.meta)||void 0===t?void 0:t.invoicingEmail)})).map((function(e){return{label:e.address.meta.invoicingEmail,value:e.address.meta.invoicingEmail}})))||null,b=(0,ae.cI)({defaultValues:{email:f||{label:o.customerUser.email,value:o.customerUser.email}}}),h=b.errors,j=b.control,g=b.handleSubmit,x=b.register,w=(0,b.watch)("sendEmail"),I=(0,m.D)(y.xY,{onCompleted:function(){a&&a(),c()}}),Z=(0,u.Z)(I,1)[0],O=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n="reportSent",r=o.meta||{},t.email&&(r=ti(ti({},r),{},{sendReportTo:t.email.value})),Z({variables:{id:o.id,changes:{meta:r,status:n},timing:{status:n,jobId:o.id,userId:s.id}}});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),_={errors:h,register:x,control:j};return(0,W.jsxs)(de.Z,{handleSubmit:g(O),children:[(0,W.jsx)(L.Z,{content:"Customer",text:null===(t=o.customer)||void 0===t?void 0:t.name}),(0,W.jsx)(L.Z,{content:"Customer Contact",text:null===(n=o.customerUser)||void 0===n?void 0:n.fullName}),(0,W.jsx)(L.Z,{content:"Phone",text:null===(r=o.customerUser)||void 0===r?void 0:r.phone}),(0,W.jsx)(L.Z,{content:"Email",text:null===(i=o.customerUser)||void 0===i?void 0:i.email}),(0,W.jsx)(S.Z,{}),(0,W.jsx)(Vt.Z,ti(ti({},_),{},{data:[{id:"sendEmail",label:"Send report via email",value:"sendEmail"},{id:"markAsReportSent",label:"Mark report as sent",value:"markAsReportSent"}],name:"sendEmail"})),"sendEmail"===w&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(fe.Z,{label:"Send to email address"}),(0,W.jsx)(Xr.Z,ti(ti({options:function(){var e,t;return[{label:null===(e=o.customerUser)||void 0===e?void 0:e.email,value:null===(t=o.customerUser)||void 0===t?void 0:t.email}].concat((0,Ce.Z)(v),(0,Ce.Z)(f))}()},_),{},{name:"email"}))]}),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},pi=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(li,{job:t,refetch:r,toggleShow:n.show}),submit:!1,title:"Send Report"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),mi=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Gt,{job:t,offCanvas:n,refetch:r}),title:t.report?"Update Report":"Create Report"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),fi=function(){var e=(0,D.Z)(R().mark((function e(t,n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({submit:!1,content:(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Wr,{job:t})}),title:"Details Report"});case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),vi=((0,h.Ps)(ni||(ni=(0,b.Z)(["\n  mutation AddQuotation($objects: [SupplierQuote_insert_input!]!) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,h.Ps)(ri||(ri=(0,b.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $jobId: Int\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      status\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"])))),bi=((0,h.Ps)(ii||(ii=(0,b.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $supplierOffer: [SupplierOffer_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_SupplierOffer(objects: $supplierOffer) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,h.Ps)(oi||(oi=(0,b.Z)(["\n  query GetQuotationLineItems($quotationId: Int!, $type: String) {\n    lineItems: SupplierQuoteLineItem(\n      where: { quoteId: { _eq: $quotationId }, type: { _eq: $type } }\n    ) {\n      id\n      description\n      item\n      qty\n      qtyUnit\n      quoteId\n      supplierTotal\n      total\n      type\n      unitRate\n    }\n  }\n"])))),hi=(0,h.Ps)(ai||(ai=(0,b.Z)(['\n  query GetQuoteUplift($jobId: Int) {\n    SupplierQuote: SupplierQuote(where: { jobId: { _eq: $jobId }, type: { _eq: "uplift" } }) {\n      status\n      quotationId: id\n      jobId\n      totalDuration\n      totalDurationUnit\n      startDate\n      methodStatement\n      notes\n    }\n  }\n']))),yi=(0,h.Ps)(ci||(ci=(0,b.Z)(["\n  mutation InsertSupplierQuoteLineItem($objects: [SupplierQuoteLineItem_insert_input!]!) {\n    insert_SupplierQuoteLineItem(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),ji=(0,h.Ps)(si||(si=(0,b.Z)(["\n  mutation UpdateSupplierQuoteLineItem($id: Int!, $changes: SupplierQuoteLineItem_set_input) {\n    update_SupplierQuoteLineItem_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),gi=(0,h.Ps)(ui||(ui=(0,b.Z)(["\n  mutation DeleteSupplierQuoteLineItem($id: Int!) {\n    delete_SupplierQuoteLineItem_by_pk(id: $id) {\n      id\n    }\n  }\n"]))),xi=(0,h.Ps)(di||(di=(0,b.Z)(["\n  mutation InsertSupplierQuoteLineItem(\n    $objects: [SupplierQuote_insert_input!]!\n    $objectJobTiming: [JobTiming_insert_input!]!\n  ) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n        status\n      }\n    }\n    insert_JobTiming(objects: $objectJobTiming) {\n      returning {\n        id\n        status\n        notes\n        createdAt\n      }\n    }\n  }\n"]))),wi=n(91126),Ii=n(97721),Zi=n(4513),Oi=n(88338),Si=function(e){return(0,se.Ry)().shape({qty:(0,se.Rx)().required(),unitRate:(0,se.Rx)().required(),qtyUnit:"Labour"===e&&(0,se.Z_)().oneOf(["hours","days"]).required()})};function _i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_i(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ai=function(e){var t=e.editMode,n=e.onSuccess,r=e.rawData,i=e.quotationId,o=(e.setQuote,e.supplierId),a=e.type,c=e.toggleShow,s=e.jobId,d=e.refetchView,l=(0,dn.x)(),p=l.hasRole,f=l.user,v=(0,ae.cI)({defaultValues:{description:t?r.description:"",qty:t?r.qty:"",qtyUnit:t?r.qtyUnit:"hours",unitRate:t?r.unitRate:"",item:t?r.item:"",total:t?r.total:null},resolver:(0,ce.S)(Si(a))}),b=v.control,h=v.errors,y=v.handleSubmit,j=v.register,g=v.watch,x={control:b,errors:h,register:j},w=g("qty"),I=g("unitRate"),S=g("total"),_=(0,m.D)(yi,{onCompleted:function(e){var t=e.insert_SupplierQuoteLineItem.returning[0].id;n&&n(t)}}),P=(0,u.Z)(_,2),A=P[0],C=P[1].loading,k=(0,m.D)(xi),q=(0,u.Z)(k,2),E=q[0],T=q[1].loadingInsert,$=(0,m.D)(ji,{onCompleted:function(e){var t=e.update_SupplierQuoteLineItem_by_pk.id;n&&n(t)}}),J=(0,u.Z)($,2),H=J[0],M=J[1].loadingUpdate,F=function(){var e=(0,D.Z)(R().mark((function e(n){var c,u,l,p,m;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.total=Number(n.total),!t){e.next=7;break}return n.supplierTotal=n.qty*n.unitRate,e.next=5,H({variables:{id:null===r||void 0===r?void 0:r.id,changes:n}});case 5:e.next=28;break;case 7:if(n.accountId=Number(o),n.type=a,n.quoteId=Number(i),n.supplierTotal=n.qty*n.unitRate,!i){e.next=16;break}return e.next=14,A({variables:{objects:[n]}});case 14:e.next=28;break;case 16:return c={accountId:o,jobId:s,status:"upliftDraft",quoteNumber:"Uplift",type:"uplift"},u={notes:"Create uplift draft with insert line item",status:"upliftDraft",jobId:s,userId:f.id},e.next=20,E({variables:{objects:[c],objectJobTiming:[u]}});case 20:return l=e.sent,e.next=23,l.data.insert_SupplierQuote.returning[0];case 23:return p=e.sent,m=p.id,e.next=27,A({variables:{objects:[Pi(Pi({},n),{},{quoteId:m})]}});case 27:d();case 28:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:y(F),children:[(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:"Description",children:(0,W.jsx)(Mt.Z,Pi(Pi({},x),{},{name:"description",rows:2}))})})}),(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:4,children:(0,W.jsx)(fe.Z,{label:"Quantity",children:(0,W.jsx)(Oe.Z,Pi(Pi({},x),{},{name:"qty",type:"number"}))})}),"Labour"===a&&(0,W.jsx)(O.Z,{md:4,children:(0,W.jsx)(fe.Z,{label:"Quantity Unit",children:(0,W.jsx)(we.Z,Pi(Pi({},x),{},{name:"qtyUnit",options:[{text:"Hours",value:"hours",disabled:!1},{text:"Days",value:"days",disabled:!1}]}))})}),(0,W.jsx)(O.Z,{md:4,children:(0,W.jsx)(le.Z,Pi(Pi({},x),{},{label:p("supplier")?"Unit Rate":"Supplier Unit Rate",name:"unitRate",vat:"Ex VAT"}))})]}),(0,W.jsxs)(U.Z,{children:["Supplier Total: ",(0,V.Z)(w*I)]}),(0,W.jsx)(Ft.Z,{}),p("admin")&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(le.Z,Pi(Pi({},x),{},{label:"Customer Unit Rate",name:"total",vat:"Ex VAT"}))})}),(0,W.jsxs)(U.Z,{children:["Customer Total (Labour Item): ",(0,V.Z)(w*S)]}),(0,W.jsx)(Ft.Z,{})]}),(0,W.jsxs)(Z.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,W.jsx)(N.Z,{content:"Cancel",onClick:c,style:{margin:"0 5px"}}),(0,W.jsx)(N.Z,{content:t?"Save":"Add",disabled:C||M||T,type:"submit"})]}),(0,W.jsx)("div",{style:{clear:"both"}})]})};Ai.defaultProps={rawData:{}};var Ci=function(e){var t=e.type,n=e.updateTotal,r=e.quotationId,i=e.jobId,o=e.supplierId,a=e.success,c=e.readOnly,s=e.refetchView,p=(0,d.useContext)(Fe.Z).hasRole,f=(0,d.useContext)(E.Z),v=(0,l.a)(bi,{skip:!r,variables:{quotationId:r,type:t}}),b=v.data,h=(b=void 0===b?{lineItems:[]}:b).lineItems,y=v.loading,j=v.refetch,g=(0,m.D)(gi,{onCompleted:function(e){j(),a()}}),x=(0,u.Z)(g,1)[0];(0,d.useEffect)((function(){(null===h||void 0===h?void 0:h.length)&&n(h)}),[h]);var w=function(){j(),a(),f.close()},I=function(e,n){f.show({content:(0,W.jsx)(Ai,{editMode:!(null===n||void 0===n||!n.rawData),onSuccess:w,rawData:null===n||void 0===n?void 0:n.rawData,toggleShow:f.close,quotationId:r,supplierId:o,type:t,jobId:i,readOnly:c,refetchView:s}),submit:!1,title:"".concat(n?"Edit":"Insert"," ").concat(t," Item")})},Z=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!p(["admin","supplier","customer"]),text:"Qty"},{hidden:!p(["admin","supplier"]),text:"Supplier Rate"},{hidden:!p(["admin","supplier"]),text:"Supplier Total"},{hidden:!p(["admin","customer"]),text:"Customer Rate"},{hidden:!p(["admin","customer"]),text:"Customer Total"},{hidden:!p(["admin","supplier"])||c,formatter:wi.Z,formatterData:(0,Oi.N)("",{onEditClick:I,onDeleteClick:function(e,t){x({variables:{id:t.id}})}}),text:"Actions"},{text:"Raw Data",hidden:!0}],O=h.reduce((function(e,t){return e+t.total*t.qty}),0),S=h.reduce((function(e,t){return e+t.supplierTotal}),0);return y?(0,W.jsx)(Ii.Z,{indicator:(0,W.jsx)(Zi.Z,{})}):(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Nt.Z,{content:(0,W.jsxs)(Di,{align:"center",justify:"between",children:[(0,W.jsx)("span",{children:t}),p(["admin","supplier"])&&!c&&(0,W.jsx)(N.Z,{content:"Insert ".concat(t," Item"),context:"secondary",onClick:I,size:"sm"})]}),tag:"h4"}),(0,W.jsx)(z.Z,{columns:Z,rows:h.map((function(e){return{id:e.id,description:e.description,qty:"Labour"===e.type?"".concat(e.qty," ").concat(e.qtyUnit):e.qty,rate:(0,V.Z)(e.unitRate),supplierTotal:(0,V.Z)(e.supplierTotal),customerRate:e.total,total:(0,V.Z)(e.total*e.qty),action:"",rawData:e}}))}),(0,W.jsxs)("div",{style:{textAlign:"right"},children:[p(["admin","supplier"])&&(0,W.jsxs)(ki,{children:["Subtotal - ",t," ",p(["admin"])&&"- Supplier",": ",(0,V.Z)(S)]}),p(["admin","customer"])&&(0,W.jsxs)(ki,{children:["Subtotal - ",t,": ",(0,V.Z)(O)]})]})]})},Di=(0,Q.ZP)(Z.Z).attrs((function(){return{align:"center",justify:"between"}})).withConfig({displayName:"lineItemTable__StyledRow",componentId:"sc-1uniqd1-0"})(["margin:0 5px;"]),ki=Q.ZP.p.withConfig({displayName:"lineItemTable__StyledP",componentId:"sc-1uniqd1-1"})(["margin:0;"]);function Ri(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function qi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ri(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ri(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ei=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;return e.reduce((function(e,n){return e+="total"===t?n[t]*n.qty:n[t]}),0)},Ti=function(e){var t=e.quotationId,n=e.jobId,r=e.supplierId,i=e.success,o=e.readOnly,c=e.refetchView,s=e.total,u=e.setTotal,l=(e.supplierTotal,e.setSupplierTotal),p=(e.customerTotal,e.setCustomerTotal),m=(0,d.useContext)(Fe.Z).hasRole,f=function(e,t){return u((function(n){return qi(qi({},n),{},(0,a.Z)({},e,Ei(t,"total")))}))},v=function(e,t){return l((function(n){return qi(qi({},n),{},(0,a.Z)({},e,Ei(t,"supplierTotal")))}))},b=function(e,t){return p((function(n){return qi(qi({},n),{},(0,a.Z)({},e,Ei(t,"total")))}))},h=s.labour+s.materials,y=.2*h,j=h+y;return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(Ci,{jobId:n,quotationId:t,readOnly:o,success:i,supplierId:r,type:"Labour",updateTotal:function(e){f("labour",e),v("labour",e),b("labour",e)},refetchView:c})})}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(Ci,{jobId:n,quotationId:t,readOnly:o,success:i,supplierId:r,type:"Materials",updateTotal:function(e){f("materials",e),v("materials",e),b("materials",e)},refetchView:c})})}),(0,W.jsx)(Ft.Z,{}),m(["admin","customer"])&&(0,W.jsx)(Z.Z,{children:(0,W.jsxs)(O.Z,{md:12,style:{textAlign:"right"},children:[(0,W.jsxs)("div",{children:["Sub Total: ",(0,V.Z)(h)]}),(0,W.jsxs)("div",{children:["VAT (20%): ",(0,V.Z)(y)]}),(0,W.jsxs)("div",{children:["Total: ",(0,V.Z)(j)]})]})})]})},$i=(0,se.Ry)().shape({notes:(0,se.Z_)()});function Ni(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ji(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ni(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ni(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Hi=function(e){var t=e.jobId,n=e.onSuccess,r=e.supplierId,i=e.readOnly,o=e.refetchView,a=(0,d.useContext)(E.Z),c=(0,dn.x)(),s=c.hasRole,p=c.user,f=(0,d.useState)(),v=f[0],b=f[1],h=(0,d.useState)(),y=h[0],j=h[1],g=(0,d.useState)({text:"-",context:"info"}),x=g[0],w=g[1],I=(0,d.useState)({labour:0,materials:0}),S=I[0],_=I[1],P=(0,d.useState)({labour:0,materials:0}),A=P[0],C=P[1],k=(0,d.useState)({labour:0,materials:0}),q=k[0],$=k[1],J=(0,m.D)(vi,{skip:i,onCompleted:function(e){var t=e.update_SupplierQuote_by_pk,r=t.id,i=t.status;n&&n({id:r,status:i}),a.close()}}),H=(0,u.Z)(J,1)[0],U=(0,m.D)(xi,{skip:i,onCompleted:function(e){var t=e.insert_SupplierQuote.returning[0],r=t.id,i=t.status;n&&n({id:r,status:i}),a.close()}}),M=(0,u.Z)(U,1)[0],F=(0,l.a)(hi,{variables:{jobId:t},onCompleted:function(e){var t;b(null===(t=e.SupplierQuote[0])||void 0===t?void 0:t.quotationId),j(e.SupplierQuote[0])}}).refetch,V=(0,ae.cI)({resolver:(0,ce.S)($i)}),L=V.handleSubmit,z=V.setValue;(0,d.useEffect)((function(){z("totalDuration",null===y||void 0===y?void 0:y.totalDuration),z("totalDurationUnit",null===y||void 0===y?void 0:y.totalDurationUnit),z("methodStatement",null===y||void 0===y?void 0:y.methodStatement),y&&w(wn.AK.find((function(e){return e.value===(null===y||void 0===y?void 0:y.status)})))}),[y]);var Q=function(){var e=(0,D.Z)(R().mark((function e(n){var i,o,a,c;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.status=s("supplier")?"supplierUpliftRequested":"upliftRequestSendCustomer",i={jobId:t,userId:p.id,notes:"Supplier Uplift requested ",status:"supplierUpliftRequested",meta:{total:A.labour+A.materials}},o={jobId:t,userId:p.id,notes:"Uplift requested sent customer ",status:"upliftRequestSendCustomer",meta:{total:1.2*(S.labour+S.materials)}},a=s("supplier")?[i]:"supplierUpliftRequested"===(null===y||void 0===y?void 0:y.status)?[o]:[i].concat([o]),!v){e.next=9;break}return e.next=7,H({variables:{id:v,changes:n,objectJobTiming:a}});case 7:e.next=12;break;case 9:return c=Ji(Ji({},n),{},{accountId:r,jobId:t,quoteNumber:"Uplift",type:"uplift"}),e.next=12,M({variables:{objects:[c],objectJobTiming:a}});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:L(Q),children:[(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(dt.Z,{content:"This is the total amount to be paid for the job and includes any time spent on the job thus far.",context:"info"})}),(0,W.jsxs)(O.Z,{md:12,children:["Status: ",(0,W.jsx)(B.Z,{content:null===x||void 0===x?void 0:x.text,size:"md",context:null===x||void 0===x?void 0:x.context})]})]}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(Ti,{quotationId:v,jobId:t,supplierId:r,success:F,readOnly:i,refetchView:o,total:S,setTotal:_,supplierTotal:A,setSupplierTotal:C,customerTotal:q,setCustomerTotal:$}),(0,W.jsx)(Z.Z,{justify:"end",style:{margin:"0 5px"},children:(0,W.jsxs)(T.Z,{children:[s(["admin","supplier"])&&!i&&(0,W.jsx)(N.Z,{content:"Cancel",context:"danger",onClick:function(){a.close(),o()},type:"button",size:"sm"}),s(["admin","supplier"])&&!i&&(0,W.jsx)(N.Z,{content:"Submit ".concat(s(["admin"])?"(send to customer)":""),type:"submit",size:"sm"})]})}),(0,W.jsx)("div",{style:{clear:"both"}})]})};Hi.defaultProps={readOnly:!1};var Ui=function(e){var t=e.jobId,n=e.onSuccess,r=e.readOnly,i=e.supplierId,o=e.refetch;return(0,W.jsx)(Hi,{jobId:t,onSuccess:n,supplierId:i,readOnly:r,refetchView:o})};function Mi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Fi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mi(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Vi=function(e){var t,n=e.job,r=e.refetch,i=e.status,o=e.toggleShow,a=(0,d.useContext)(oe.Z).user,c=null===(t=n.quotations.find((function(e){return"uplift"===e.type})))||void 0===t?void 0:t.lineItems,s="customerUpliftApproved"===i,l=null===n||void 0===n?void 0:n.financeLogs,p=(0,ae.cI)({defaultValues:{comments:""}}),f=p.errors,b=p.handleSubmit,h=p.register,y=(0,m.D)(v.wU,{onCompleted:function(){r&&r(),o()}}),j=(0,u.Z)(y,1)[0],g=c.reduce((function(e,t){return e+t.total}),0),x=c.filter((function(e){return"Materials"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0),w=c.filter((function(e){return"Labour"===e.type})).reduce((function(e,t){return e+t.supplierTotal}),0),I=function(){var e=(0,D.Z)(R().mark((function e(){var t,r;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={jobId:n.id,meta:{username:"".concat(a.nameFirst," ").concat(a.nameLast),userId:a.id}},(r=[]).push(Fi(Fi({},t),{},{type:"supplierLabourAmount",value:w,difference:w-(0,_e.B)("supplierLabourAmount",l)})),r.push(Fi(Fi({},t),{},{type:"supplierMaterialsAmount",value:x,difference:x-(0,_e.B)("supplierMaterialsAmount",l)})),r.push(Fi(Fi({},t),{},{type:"amount",value:g,difference:g-(0,_e.B)("amount",l)})),e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Z=function(){var e=(0,D.Z)(R().mark((function e(t){var r,o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={notes:t.comments,status:i,jobId:n.id,userId:a.id},e.t0=s,!e.t0){e.next=6;break}return e.next=5,I();case 5:e.t0=e.sent;case 6:o=e.t0,j({variables:{financeLog:o,hasFinanceLog:s,jobChange:{pricing:"fixed"},jobId:n.id,timing:[r]}});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:b(Z),children:(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,{errors:f,name:"comments",register:h,rows:3})})})},Li=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){var i,o,a=arguments;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=a.length>3&&void 0!==a[3]&&a[3],o=function(){n.close(),r()},n.show({content:(0,W.jsx)(Ui,{jobId:t.id,onSuccess:o,readOnly:i,supplierId:t.supplier.id,refetch:r}),submit:!1,title:"".concat(i?"Uplift details":"Uplift request"),width:"50%"});case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),zi=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Vi,{job:t,refetch:r,status:"customerUpliftApproved",toggleShow:n.show}),title:"Approve uplift"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Qi=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Vi,{job:t,refetch:r,status:"customerUpliftRejected",toggleShow:n.show}),title:"Reject uplift"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),Bi=function(e){var t,n=e.timings,r=(void 0===n?[]:n).find((function(e){return"reportSentSupplier"===e.status}));return r&&"Report Sent by ".concat((null===r||void 0===r||null===(t=r.user)||void 0===t?void 0:t.fullName)||"")},Yi=function(e){var t,n=e.timings,r=void 0===n?[]:n,i=null===r||void 0===r?void 0:r.find((function(e){return"invoiceSent"===e.status}));return i&&"Invoice sent by ".concat((null===i||void 0===i||null===(t=i.user)||void 0===t?void 0:t.fullName)||"")},Wi=function(e,t,n,r,i,o,a,c){var s,u,d,l,p,m,f,v,b,h,y,j,g,x,w,I,Z,O,S,_,A,C,D=null;a(["admin","superadmin"])&&c.accountId&&(D=c.accountId);var k=null===c||void 0===c||null===(s=c.meta)||void 0===s||null===(u=s.threshold)||void 0===u?void 0:u.invoice,R=null===n||void 0===n||null===(d=n.quotations)||void 0===d?void 0:d.find((function(e){return"quotationRejected"!==e.status})),q=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=null===e||void 0===e?void 0:e.reduce((function(e,n){return e+("total"===t?n[t]*n.qty:n[t])}),0);return isNaN(n)?null:n}(null===R||void 0===R?void 0:R.lineItems,"total"),E=q+.2*q,$="onHold"===nn(n.timings),H=(0,re.E)(n,"accepted"),M=(0,re.E)(n,"closed"),F="incorrect"===n.timingStatus?n.correctEnd:(0,re.E)(n,"completed"),L=(0,re.E)(n,"complianceRejected"),z=(0,re.E)(n,"complianceApproved"),Q=(0,re.E)(n,"complianceRequestedDocumentation"),B=(0,re.E)(n,"customerPaid"),Y=(null===(l=n.compliances)||void 0===l?void 0:l.length)>0,G="incorrect"===n.timingStatus?n.correctStart:(0,re.E)(n,"inProgress"),K=(0,re.E)(n,"supplierUpliftRequested"),X=(0,re.E)(n,"upliftRequestSendCustomer"),ee=(0,re.E)(n,"customerUpliftApproved"),te=(0,re.E)(n,"customerUpliftRejected"),ne=(0,re.E)(n,"invoiceSent"),ie=(0,re.E)(n,"invoiceSentSupplier"),oe=(0,re.E)(n,"offered"),ae=(0,re.E)(n,"pending"),ce=(0,re.E)(n,"pricingChanged"),se=(0,re.E)(n,"quoteAccepted"),ue=(0,re.E)(n,"quoteNew"),de=(0,re.E)(n,"raised"),le=(0,re.E)(n,"rejected"),pe=(0,re.E)(n,"reportSent"),me=(0,re.E)(n,"reportSentSupplier"),fe=(0,re.E)(n,"supplierPaid"),ve=(0,re.E)(n,"timingChanged"),be=(0,re.E)(n,"unvalidated"),he=(0,re.E)(n,"validated"),ye=(null===n||void 0===n||null===(p=n.invoices)||void 0===p?void 0:p.reduce((function(e,t){return e+t.reconciledAmount.aggregate.sum.amount}),0))||null,je=Number((null===(m=n.meta)||void 0===m||null===(f=m.customerVATInvoice)||void 0===f||null===(v=f.amountInfo)||void 0===v?void 0:v.vatTotal)||0)-ye,ge=null===(b=n.childJobs)||void 0===b?void 0:b.find((function(e){return"quote"===e.type})),xe=(0,re.E)(n,"updateAcceptOfferInput"),we=(0,re.E)(n,"supplierCancel"),Ie=n.scheduledAt?null!==(h=n.meta)&&void 0!==h&&h.arrivalAnytime?"".concat(ke()(n.scheduledAt).format("D MMM YYYY")," (anytime)"):ke()(n.scheduledAt).format("D MMM YYYY HH:mm"):ke()(se||H).format("D MMM YYYY HH:mm"),Ze=n.supplierOffers.filter((function(e){return"cancelled"!==e.status})).length,Oe=cn("adminUplift",null===n||void 0===n?void 0:n.timings),Se=sn("adminUplift",null===n||void 0===n?void 0:n.timings),_e=un("adminUplift",null===n||void 0===n?void 0:n.timings),Pe=cn("adminInvoice",null===n||void 0===n?void 0:n.timings),Ae=sn("adminInvoice",null===n||void 0===n?void 0:n.timings),Ce=un("adminInvoice",null===n||void 0===n?void 0:n.timings);return"pending"!==n.status&&"closed"!==n.status||de||ue?[{id:1,label:"Job raised",date:(0,re.E)(n,["raised","quoteNew"]),content:[{id:1,active:!0,data:"Created By ".concat((null===n||void 0===n||null===(y=n.timings[0])||void 0===y||null===(j=y.user)||void 0===j?void 0:j.fullName)||"")}]},{id:2,label:"Job offered",info:"no assigned suppliers",date:oe,active:"quote"!==n.type&&!(0,re.E)(n,"quoteAccepted"),content:[{id:1,active:!$&&oe&&!G&&!H&&!ve&&!ce&&n.supplierOffers&&n.supplierOffers.length>0,data:"Offered to ".concat(Ze," suppliers")},{id:2,active:!$&&le,data:"Job rejected by supplier"}],actions:[{id:1,active:!$&&de&&!G&&!oe&&!n.jobScheduleId,content:"Create Quote",context:"secondary",handleClick:function(){return Ot(n,r,i,e,c)},type:"button"},{id:2,active:!M&&!$&&de&&!G&&!H&&!le&&!n.supplier,content:"Assign Suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){return Zt(n,r,o)},type:"button"},{id:3,active:!M&&!$&&(!G&&n.supplier||oe||le)&&!(0,re.E)(n,"quoteAccepted"),content:"Repost Job",context:"danger",handleClick:function(){return At({job:n,deleteJobTiming:t,offCanvas:r,refetch:o})},type:"button"}]},{id:3,label:"Accepted",info:"waiting for supplier to accept",date:(0,re.E)(n,["accepted","quoteAccepted"]),content:[{id:1,active:(H||se||ve||ce)&&n.supplier,data:"Assigned to ".concat(null===(g=n.supplier)||void 0===g?void 0:g.name)},{id:2,active:(H||se)&&n.supplierUser,data:"Operative: ".concat(null===(x=n.supplierUser)||void 0===x?void 0:x.fullName)},{id:3,active:H||se,data:"Arrival time: ".concat(Ie)},{id:4,active:ve&&!H&&n.supplier,data:"Job timing has changed, supplier needs to Accept the job again and set new\n          attendance time"},{id:5,active:ce&&!H&&n.supplier,data:"Job service or pricing has changed, supplier needs to Accept the job again and\n          confirm attendance and operative"},{id:6,active:xe,data:"Attendance and operative has changed by ".concat(Rt(n,"updateAcceptOfferInput"))},{id:7,active:we,data:"Job canceled by ".concat(Rt(n,"supplierCancel"))},{id:8,active:!0,data:function(){var e;return(0,W.jsx)(T.Z,{align:"flex-start",size:"xs",children:!M&&"offered"===n.status&&(null===(e=n.supplier)||void 0===e?void 0:e.id)&&!H&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(N.Z,{content:"Accept job",context:"primary",onClick:function(){var e;return Qr({job:n,offCanvas:r,refetch:o,accountId:null===n||void 0===n||null===(e=n.supplier)||void 0===e?void 0:e.id})},size:"xs"})," ",(0,W.jsx)(N.Z,{content:"Reject job",context:"danger",onClick:function(){var e;return Br({job:n,offCanvas:r,refetch:o,accountId:null===n||void 0===n||null===(e=n.supplier)||void 0===e?void 0:e.id})},size:"xs"})]})})}}],actions:[{id:1,active:!$&&!G&&(H||ve||ce)&&n.supplier,content:"Change job timing",context:"danger",handleClick:function(){return _t(n,r,o)},type:"button"},{id:2,active:!$&&!G&&(H||ve||ce)&&n.supplier,content:"Change job pricing or service",context:"danger",handleClick:function(){return St(n,r,o)},type:"button"}]},{id:4,label:"In progress",info:"waiting for supplier to start",date:G,actions:[{id:1,active:!$&&G&&!(ee||te)&&"reactive"===n.type&&!F,content:"".concat(K?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return Li(n,r,o,!1)},type:"button"},{id:2,active:G&&"reactive"===n.type&&!ge,content:"Create remedial quote",context:"success",handleClick:function(){return kr(n,r,o)},type:"button"},{id:3,active:ge,content:"Remedial quote Q ".concat(null===ge||void 0===ge?void 0:ge.number),context:"info",handleClick:function(){return Rr(null===ge||void 0===ge?void 0:ge.number,r)},type:"button"}]},{id:5,label:"Uplift requested",info:"waiting for customer",date:G&&(X||K),active:!(!G||!X&&!K)&&"reactive"===n.type,content:[{id:1,active:ee,data:"Uplift approved by ".concat(Rt(n,"customerUpliftApproved"))},{id:2,active:te,data:"Uplift rejected by ".concat(Rt(n,"customerUpliftRejected"))},{id:4,active:K,data:function(){var e=X&&!(ee||te),t=X||K;return(0,W.jsx)(W.Fragment,{children:(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[e&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return Et(k,E)||Se?zi(n,r,o):(0,ln.I_)({type:"issue",role:"adminUplift",jobId:n.id,accountId:c.accountId,quotationId:null===R||void 0===R?void 0:R.id,threshold:k,offCanvas:r})},size:"xs"}),t&&(0,W.jsx)(N.Z,{content:"Details",context:"info",onClick:function(){return Li(n,r,o,!0)},size:"xs"}),e&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){Et(k,E)||Se?Qi(n,r,o):(0,ln.I_)({type:"issue",role:"adminUplift",jobId:n.id,accountId:c.accountId,quotationId:null===R||void 0===R?void 0:R.id,threshold:k,offCanvas:r})},size:"xs"})]})})}}]},{id:6,label:"Manager Approved",info:"",date:(null===Se||void 0===Se?void 0:Se.createdAt)||(null===_e||void 0===_e?void 0:_e.createdAt),active:!!(Oe||Se||_e),content:[{id:1,active:Oe&&!Se&&!_e,data:"Waiting threshold approval"},{id:2,active:Se,data:"Threshold approved by ".concat(null===Se||void 0===Se||null===(w=Se.user)||void 0===w?void 0:w.fullName)},{id:3,active:_e,data:"Threshold rejected by ".concat(null===_e||void 0===_e||null===(I=_e.user)||void 0===I?void 0:I.fullName)},{id:4,active:!$&&Oe&&Et(k,E),data:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[Oe&&!ne&&!Se&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"issue",role:"adminUplift",job:n,quoteId:null===R||void 0===R?void 0:R.id,offCanvas:r,refetch:o})},size:"xs"}),Oe&&!ne&&!_e&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"issue",role:"adminUplift",job:n,quoteId:null===R||void 0===R?void 0:R.id,offCanvas:r,refetch:o})},size:"xs"})]})}}]},{id:7,label:"Complete",info:"waiting for supplier to complete",date:F,content:[{id:1,active:F&&Y&&Q,data:(0,W.jsxs)("div",{style:{alignItems:"center",display:"flex"},children:[(0,W.jsx)(U.Z,{as:"span",size:"sm",children:"Upload compliance Documentation"}),(0,W.jsx)(N.Z,{content:(0,W.jsx)(J.Z,{icon:"file-upload"}),context:"info",onClick:function(){var t;return zn({addJobTiming:e,job:n,entityId:null===(t=n.compliances[0])||void 0===t?void 0:t.id,userId:c.id},r)},size:"xs",style:{marginLeft:".5rem"}})]})}],actions:[{id:1,active:!$&&F&&Y&&!Q,content:"Request Documentation",context:"secondary",handleClick:function(){return Yn(n,r,o)},type:"button"},{id:2,active:!$&&F&&Y&&Q,content:"No Documentation Required",context:"info",handleClick:function(){return function(e){var t=e.deleteJobTiming,n=e.job,r=e.userId;t({variables:{id:n.id,status:"complianceRequestedDocumentation",userId:r}})}({job:n,userId:c.id,deleteJobTiming:t})},type:"button"},{id:3,active:!$&&F&&null===n.pricing,content:"Change job pricing or service",context:"danger",handleClick:function(){return St(n,r,o)},type:"button"}]},{id:8,label:"Report sent",info:"after job complete",date:pe,content:[{id:1,active:me,data:"Report submitted by supplier"},{id:2,active:!0,data:Bi(n)}],actions:[{id:1,active:(me||pe)&&n.report,content:"Download job report",context:"secondary",handleClick:function(){return Mn({job:n,adminId:D})},type:"button"},{id:2,active:!$&&(me||pe)&&n.report,content:n.report?"Update report":"Create report",context:"info",handleClick:function(){return mi(n,r,o)},type:"button"},{id:3,active:!$&&me&&!pe&&n.report,content:"Send to customer",context:"primary",handleClick:function(){return pi(n,r,o)},type:"button"}]},{id:9,label:"Customer Sign Off",info:"",date:Y&&(z||L),active:Y,content:[{id:1,active:z,data:"Compliance sing off by ".concat(Rt(n,"complianceApproved"))},{id:2,active:L,data:"Compliance rejected by ".concat(Rt(n,"complianceRejected"))},{id:3,active:!$&&Y&&Q&&!(z||L),data:function(){return(0,W.jsx)(W.Fragment,{children:(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return Qn(n,r,o)},size:"xs"}),(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return Bn(n,r,o)},size:"xs"})]})})}}]},{id:10,label:"Invoices sent",info:"after validation",date:ne,active:!n.jobScheduleId,content:[{id:1,active:he,data:"Job validated"},{id:2,active:ne&&(null===(Z=n.meta)||void 0===Z||null===(O=Z.invoiceNumbers)||void 0===O?void 0:O[0]),data:"Invoice number ".concat(null===n||void 0===n||null===(S=n.invoiceNumbers)||void 0===S||null===(_=S[0])||void 0===_?void 0:_.id," sent")},{id:3,active:!0,data:Yi(n)}],actions:[{id:1,active:!$&&be&&!he,content:"Change finance",context:"danger",handleClick:function(){return Pt(n,r,o)},type:"button"},{id:2,active:!$&&be&&!he,content:"Update invoice address",context:"danger",handleClick:function(){return function(e,t,n){var r=(0,P.Hv)(e,"customer");t.show({content:(0,W.jsx)(Wn.H,{entity:"Location",entityId:e.location.id,id:r.id,onSubmit:function(e){e&&n()},addressId:r.address.id,type:"invoice"}),submit:!1,title:"Manage addresses"})}(n,r,o)},type:"button"},{id:3,active:!$&&!he&&pe,content:"Validate job",context:"info",handleClick:function(){return Et(k,E)||Ae?function(e,t,n,r,i){r.show({content:(0,W.jsx)(ir,{job:e,addJobTiming:t,deleteJobTiming:n,refetch:i,status:"validated",toggleShow:r.show}),title:"Validate job"})}(n,e,t,r,o):(0,ln.I_)({type:"issue",role:"adminInvoice",jobId:n.id,accountId:c.accountId,quotationId:null===R||void 0===R?void 0:R.id,threshold:k,offCanvas:r})},type:"button"},{id:5,active:!$&&he,content:"Un-Validate job",context:"danger",handleClick:function(){return function(e,t,n,r,i){r.show({content:(0,W.jsx)(ir,{addJobTiming:t,deleteJobTiming:n,job:e,refetch:i,status:"unvalidated",toggleShow:r.show}),title:"Unvalidate job"})}(n,e,t,r,o)},type:"button"},{id:6,active:!$&&(!Pe||Pe&&Ae)&&!ne&&he,content:"Send customer invoice",context:"primary",handleClick:function(){return jr("customer",n,r,o,!0)},type:"button"},{id:7,active:!$&&(!Pe||Pe&&Ae)&&!ie&&he,content:"Send supplier invoice",context:"primary",handleClick:function(){return jr("supplier",n,r,o,!0)},type:"button"},{id:8,active:ne,content:"Download customer invoice",context:"secondary",handleClick:function(){return jr("customer",n,r,o,!1)},type:"button"},{id:9,active:ie,content:"Download supplier invoice",context:"secondary",handleClick:function(){return jr("supplier",n,r,o,!1)},type:"button"}]},{id:111,label:"Manager Approved",info:"",date:(null===Ae||void 0===Ae?void 0:Ae.createdAt)||(null===Ce||void 0===Ce?void 0:Ce.createdAt),active:!!(Pe||Ae||Ce),content:[{id:1,active:Pe&&!Ae&&!Ce,data:"Waiting threshold approval"},{id:2,active:Ae,data:"Threshold approved by ".concat(null===Ae||void 0===Ae||null===(A=Ae.user)||void 0===A?void 0:A.fullName)},{id:3,active:Ce,data:"Threshold rejected by ".concat(null===Ce||void 0===Ce||null===(C=Ce.user)||void 0===C?void 0:C.fullName)},{id:4,active:!$&&Pe&&Et(k,E),data:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[Pe&&!ne&&!Ae&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"issue",role:"adminInvoice",job:n,quoteId:null===R||void 0===R?void 0:R.id,offCanvas:r,refetch:o})},size:"xs"}),Pe&&!ne&&!Ce&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"issue",role:"adminInvoice",job:n,quoteId:null===R||void 0===R?void 0:R.id,offCanvas:r,refetch:o})},size:"xs"})]})}}]},{id:12,label:"Customer paid",info:!B&&(ye?"Partially paid":"not paid"),date:B,active:!n.jobScheduleId,actions:[{id:1,active:!$&&!B&&ne&&he,content:"Mark customer paid",context:"info",handleClick:function(){return Vn(n,r,o)},type:"button"}],content:[{id:1,active:!B&&ye,data:"Reconciled amount ".concat((0,V.Z)(ye))},{id:2,active:!B&&ye,data:"Amount outstanding ".concat((0,V.Z)(je))}]},{id:11,label:"Supplier paid",info:"not paid",date:fe,active:!n.jobScheduleId,actions:[{id:1,active:!$&&!fe&&ie&&he,content:"Mark supplier paid",context:"info",handleClick:function(){return xr(n,"supplierPaid",r,o)},type:"button"}]},{id:13,label:"Closed",info:"automatically after steps complete",date:M,actions:[{id:1,active:!$&&!M,content:"Close job",context:"danger",handleClick:function(){return xr(n,"closed",r,o)},type:"button"},{id:2,active:!$&&!G&&!M,content:"Close and zero value job",context:"danger",handleClick:function(){return Or(n,r,o)},type:"button"}]}]:[{id:1,label:"Issue Reported",date:ae,actions:[{id:1,active:!de,content:"Approve job",context:"primary",handleClick:function(){return xr(n,"raised",r,o)},type:"button"}]},{id:2,label:"Closed",date:M,actions:[{id:1,active:!M,content:"Close request",context:"danger",handleClick:function(){return xr(n,"closed",r,o)},type:"button"}]}]},Gi=n(26933),Ki=function(e){var t=e.job,n=e.refetch,r=e.status,i=e.toggleShow,o=(0,d.useContext)(E.Z),a=(0,d.useContext)(oe.Z).user,c=(0,ae.cI)({defaultValues:{comments:""}}),s=c.errors,l=c.handleSubmit,p=c.register,f=(0,m.D)(v.r2,{onCompleted:function(e){var t=e.insert_JobTiming.returning[0].id;t&&"inDispute"===r?h(t):(n&&n(),i())}}),b=(0,u.Z)(f,1)[0],h=function(e){o.show({content:(0,W.jsx)(Gi.z,{accept:"image/*",category:null,entity:"JobTiming",entityId:e,expiryShow:!1,onSuccess:function(){return y(e)},showSubmitButton:!0}),title:"Upload Photo",submit:!1})},y=function(e){n&&n(),i(),o.close()},j=function(){var e=(0,D.Z)(R().mark((function e(n){var i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i={notes:n.comments,status:r,jobId:t.id,userId:a.id},b({variables:{objects:[i]}});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:l(j),children:(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,{errors:s,name:"comments",register:p,rows:3})})})},Xi=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ki,{job:t,status:"inDispute",toggleShow:n.show,refetch:r}),title:"Dispute"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),eo=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ki,{job:t,status:"disputeResolved",toggleShow:n.show,refetch:r}),title:"Resolve Dispute"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),to=function(){var e=(0,D.Z)(R().mark((function e(t,n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Ae.G,{entity:"JobTiming",entityId:t}),title:"Dispute media"});case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),no=function(e,t,n,r){var i,o,a,c,s,u,d=(0,Gn.x)(),l=null===t||void 0===t||null===(i=t.meta)||void 0===i||null===(o=i.threshold)||void 0===o?void 0:o.invoice,p=null===e||void 0===e||null===(a=e.quotations)||void 0===a?void 0:a.find((function(e){return"quotationRejected"!==e.status})),m=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=null===e||void 0===e?void 0:e.reduce((function(e,n){return e+("total"===t?n[t]*n.qty:n[t])}),0);return isNaN(n)?null:n}(null===p||void 0===p?void 0:p.lineItems,"total"),f=m+.2*m,v="onHold"===nn(e.timings),b="incorrect"===e.timingStatus?e.correctEnd:(0,re.E)(e,"completed"),h=(0,re.E)(e,"complianceRejected"),y=(0,re.E)(e,"complianceApproved"),j=(null===(c=e.compliances)||void 0===c?void 0:c.length)>0,g=(0,re.E)(e,"inDispute"),x=(0,re.E)(e,"reportSent"),w=(0,re.E)(e,"invoiceSent"),I=(0,re.E)(e,"complianceRequestedDocumentation"),Z="incorrect"===e.timingStatus?e.correctStart:(0,re.E)(e,"inProgress"),O=(0,re.E)(e,"upliftRequestSendCustomer"),S=(0,re.E)(e,"customerUpliftApproved"),_=(0,re.E)(e,"customerUpliftRejected"),P=cn("customer",null===e||void 0===e?void 0:e.timings),A=sn("customer",null===e||void 0===e?void 0:e.timings),C=un("customer",null===e||void 0===e?void 0:e.timings);return[{id:1,label:"Issue reported",info:"no assigned suppliers",date:(0,re.E)(e,"pending")||(0,re.E)(e,"raised")||(0,re.E)(e,"quoteNew")},{id:2,label:"Job offered",info:"no assigned suppliers",date:(0,re.E)(e,"offered")||(0,re.E)(e,"quoteNew")},{id:3,label:"Accepted",info:"waiting for supplier to accept the job",date:(0,re.E)(e,["accepted","quoteAccepted"])},{id:4,label:"In progress",info:"waiting for supplier to start the job",date:Z},{id:44,label:"Uplift requested",info:"waiting for you",date:Z&&O,active:!(!Z||!O)&&"reactive"===e.type,content:[{id:1,active:S,data:"Uplift approved by ".concat(Rt(e,"customerUpliftApproved"))},{id:2,active:_,data:"Uplift rejected by ".concat(Rt(e,"customerUpliftRejected"))},{id:4,active:O&&"reactive"===e.type,data:function(){var i=O&&!(S||_),o=O;return(0,W.jsx)(W.Fragment,{children:(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[i&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return Et(l,f)||A?zi(e,n,r):(0,ln.I_)({type:"issue",role:"customer",jobId:null===e||void 0===e?void 0:e.id,accountId:null===t||void 0===t?void 0:t.accountId,quotationId:null===p||void 0===p?void 0:p.id,threshold:l,offCanvas:n})},size:"xs"}),o&&(0,W.jsx)(N.Z,{content:"Details",context:"info",onClick:function(){return Li(e,n,r,!0)},size:"xs"}),i&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return Et(l,f)||A?Qi(e,n,r):(0,ln.I_)({type:"issue",role:"customer",jobId:null===e||void 0===e?void 0:e.id,accountId:null===t||void 0===t?void 0:t.accountId,quotationId:null===p||void 0===p?void 0:p.id,threshold:l,offCanvas:n})},size:"xs"})]})})}}]},{id:8,label:"Manager Approved",info:"",date:(null===A||void 0===A?void 0:A.createdAt)||(null===C||void 0===C?void 0:C.createdAt),active:!!(P||A||C),content:[{id:1,active:P&&!A&&!C,data:"Waiting threshold approval"},{id:2,active:A,data:"Threshold approved by ".concat(null===A||void 0===A||null===(s=A.user)||void 0===s?void 0:s.fullName)},{id:3,active:C,data:"Threshold rejected by ".concat(null===C||void 0===C||null===(u=C.user)||void 0===u?void 0:u.fullName)},{id:4,active:!v&&P&&Et(l,f),data:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[P&&!w&&!A&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"issue",role:"customer",job:e,quoteId:null===p||void 0===p?void 0:p.id,offCanvas:n,refetch:r})},size:"xs"}),P&&!w&&!C&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"issue",role:"customer",job:e,quoteId:null===p||void 0===p?void 0:p.id,offCanvas:n,refetch:r})},size:"xs"})]})}}]},{id:5,label:"Complete",info:"waiting for supplier to complete the job",date:b,actions:[{id:1,active:b&&!g,content:"Dispute",context:"danger",handleClick:function(){return Xi(e,n,r)},type:"button"}],content:[{id:1,active:g,data:(0,W.jsxs)("div",{style:{alignItems:"center",display:"flex"},children:[(0,W.jsx)(U.Z,{as:"span",size:"sm",children:"Dispute media"}),(0,W.jsx)(N.Z,{content:(0,W.jsx)(J.Z,{icon:"file-upload"}),context:"info",onClick:function(){return to(qt(e,"inDispute"),n)},size:"xs",style:{marginLeft:".5rem"}})]})}]},{id:6,label:"Report sent",info:"waiting for supplier to send report",date:x,actions:[{id:1,active:x,content:"Download job report",context:"secondary",handleClick:function(){return Mn({adminId:e.adminId,job:e})},type:"button"}]},{id:7,label:"Customer Sign Off",info:"",date:j&&(y||h),active:j,content:[{id:1,active:y,data:"Compliance report sang off by ".concat(Rt(e,"complianceApproved"))},{id:3,active:j&&I&&!(y||h),data:function(){return(0,W.jsx)(W.Fragment,{children:(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return Qn(e,n,r)},size:"xs"}),(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return Bn(e,n,r)},size:"xs"})]})})}}]},{id:8,label:"Invoice sent",info:"",date:(0,re.E)(e,"invoiceSent"),actions:[{id:1,active:(0,re.E)(e,"invoiceSent"),content:"Download invoice",context:"secondary",handleClick:function(){return(0,ar._)({adminId:e.adminId,type:yr(e),job:e,client:d})},type:"button"}]}]},ro=function(e,t,n,r,i,o,a,c){var s;return n("admin")?s=Wi(e,t,r,i,o,a,n,c):n("supplier")?s=function(e,t,n,r,i){var o,a,c,s,u,d,l,p,m=(0,Gn.x)(),f=null===i||void 0===i||null===(o=i.meta)||void 0===o||null===(a=o.threshold)||void 0===a?void 0:a.invoice,v=null===t||void 0===t||null===(c=t.quotations)||void 0===c?void 0:c.find((function(e){return"quotationRejected"!==e.status})),b=null===v||void 0===v||null===(s=v.lineItems)||void 0===s?void 0:s.reduce((function(e,t){return e+t.supplierTotal}),0),h=(null===t||void 0===t||null===(u=t.compliances)||void 0===u?void 0:u.length)>0,y=(0,re.E)(t,"complianceRequestedDocumentation"),j="incorrect"===t.timingStatus?t.correctEnd:(0,re.E)(t,"completed"),g="incorrect"===t.timingStatus?t.correctStart:(0,re.E)(t,"inProgress"),x=(0,re.E)(t,"closed"),w=(0,re.E)(t,"accepted"),I=(0,re.E)(t,"supplierUpliftRequested"),Z=(0,re.E)(t,"customerUpliftApproved"),O=(0,re.E)(t,"customerUpliftRejected"),S=(0,re.E)(t,"upliftRequestSendCustomer"),_=null===(d=t.childJobs)||void 0===d?void 0:d.find((function(e){return"quote"===e.type})),P=cn("supplier",null===t||void 0===t?void 0:t.timings),A=sn("supplier",null===t||void 0===t?void 0:t.timings),C=un("supplier",null===t||void 0===t?void 0:t.timings);return[{id:1,label:"Job offered",info:"no assigned suppliers",date:(0,re.E)(t,"offered"),active:"quote"!==t.type&&!(0,re.E)(t,"quoteAccepted")},{id:2,label:"Accepted",info:"need to accept the job",date:(0,re.E)(t,["accepted","quoteAccepted"]),content:[{id:1,active:(0,re.E)(t,"timingChanged")&&!(0,re.E)(t,"accepted")&&t.supplier,data:"Job timing has changed, click Accept to set new attendance time or Reject if you\n          can\n        not make it"},{id:2,active:(0,re.E)(t,"pricingChanged")&&!(0,re.E)(t,"accepted")&&t.supplier,data:"Job service or pricing has changed, click Accept to confirm attendance"},{id:3,active:!0,data:function(){return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(T.Z,{align:"flex-start",size:"xs",children:!x&&"offered"===t.status&&!w&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(N.Z,{content:"Accept job",context:"primary",onClick:function(){return Qr({job:t,offCanvas:n,refetch:r,accountId:i.accountId})},size:"xs"})," ",(0,W.jsx)(N.Z,{content:"Reject job",context:"danger",onClick:function(){return Br({job:t,offCanvas:n,refetch:r,accountId:i.accountId})},size:"xs"})]})})})}}]},{id:3,label:"In progress",info:"click the timer to start",date:(0,re.E)(t,"inProgress"),actions:[{id:1,active:g&&!(Z||O)&&"reactive"===t.type&&!j&&!S,content:"".concat(I?"Edit":"Request"," uplift"),context:"danger",handleClick:function(){return Li(t,n,r,!1)},type:"button"},{id:2,active:g&&"reactive"===t.type&&!_,content:"Create remedial quote",context:"success",handleClick:function(){return kr(t,n,r)},type:"button"},{id:3,active:_,content:"Remedial quote Q ".concat(null===_||void 0===_?void 0:_.number),context:"info",handleClick:function(){return Rr(null===_||void 0===_?void 0:_.number,n)},type:"button"}]},{id:44,label:"Uplift requested",info:"",date:"reactive"===t.type&&g&&I,active:!(!g||!I),content:[{id:1,active:Z,data:"Uplift request approved"},{id:2,active:O,data:"Uplift request rejected"},{id:3,active:I,data:function(){return(0,W.jsx)(N.Z,{content:"Uplift details ",context:"info",onClick:function(){return Li(t,n,r,!0)},size:"xs"})}}]},{id:4,label:"Complete",info:"upload a photo and stop timer",date:j,content:[{id:1,active:h&&y,data:(0,W.jsxs)("div",{style:{alignItems:"center",display:"flex"},children:[(0,W.jsx)(U.Z,{as:"span",size:"sm",children:"Upload compliance Documentation"}),(0,W.jsx)(N.Z,{content:(0,W.jsx)(J.Z,{icon:"file-upload"}),context:"info",onClick:function(){var r;return zn({addJobTiming:e,job:t,entityId:null===(r=t.compliances[0])||void 0===r?void 0:r.id,userId:i.id},n)},size:"xs",style:{marginLeft:".5rem"}})]})}]},{id:8,label:"Manager Approved",info:"",date:(null===A||void 0===A?void 0:A.createdAt)||(null===C||void 0===C?void 0:C.createdAt),active:!!(P||A||C),content:[{id:1,active:P&&!A&&!C,data:"Waiting threshold approval"},{id:2,active:A,data:"Threshold approved by ".concat(null===A||void 0===A||null===(l=A.user)||void 0===l?void 0:l.fullName)},{id:3,active:C,data:"Threshold rejected by ".concat(null===C||void 0===C||null===(p=C.user)||void 0===p?void 0:p.fullName)},{id:4,active:P&&Et(f,b),data:function(){return(0,W.jsxs)(T.Z,{align:"flex-start",size:"xs",children:[P&&!A&&(0,W.jsx)(N.Z,{content:"Approve",context:"primary",onClick:function(){return(0,ln.i$)({type:"issue",role:"supplier",job:t,quoteId:null===v||void 0===v?void 0:v.id,offCanvas:n,refetch:r})},size:"xs"}),P&&!C&&(0,W.jsx)(N.Z,{content:"Reject",context:"danger",onClick:function(){return(0,ln.Ii)({type:"issue",role:"supplier",job:t,quoteId:null===v||void 0===v?void 0:v.id,offCanvas:n,refetch:r})},size:"xs"})]})}}]},{id:5,label:"Report sent",info:"after job complete",date:(0,re.E)(t,"reportSentSupplier"),actions:[{id:1,active:(0,re.E)(t,"reportSentSupplier")||(0,re.E)(t,"invoiceSent"),content:"View job report",context:"info",handleClick:function(){return fi(t,n)},type:"button"}]},{id:6,label:"Invoice sent",info:"",date:(0,re.E)(t,"invoiceSent"),actions:[{id:1,active:(0,re.E)(t,"invoiceSent"),content:"Download invoice",context:"secondary",handleClick:function(){return(0,ar._)({adminId:t.adminId,type:"supplier",job:t,client:m})},type:"button"}]}]}(e,r,i,a,c):n("customer")&&(s=no(r,c,i,a)),s.forEach((function(e){e.date&&(e.date=ke()(e.date).format("D MMM YYYY HH:mm"))})),s},io=function(e){var t,n=(0,re.E)(e,"quoteAccepted"),r=(0,re.E)(e,"accepted"),i=[],o=e.scheduledAt?null!==(t=e.meta)&&void 0!==t&&t.arrivalAnytime?"".concat(ke()(e.scheduledAt).format("D MMM YYYY")," (anytime)"):ke()(e.scheduledAt).format("D MMM YYYY HH:mm"):ke()(n||r).format("D MMM YYYY HH:mm");return i.push({label:"Scheduled start:",value:e.timingStart?ke()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&i.push({label:"Scheduled end:",value:e.timingEnd?ke()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),i.push({label:"Supplier arrival:",value:o}),i},oo=(0,se.Ry)().shape({serviceSelected:(0,se.Ry)().required()});function ao(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function co(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ao(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ao(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var so=function(e){var t=e.job,n=e.refetch,r=e.toggleShow,i=(0,d.useContext)(oe.Z).user,o=(0,ae.cI)({defaultValues:{serviceSelected:t.serviceId},resolver:(0,ce.S)(oo)}),a=o.errors,c=o.handleSubmit,s=o.register,l=o.control,p=(0,m.D)(y.xY,{onCompleted:function(){n&&n(),r()}}),f=(0,u.Z)(p,1)[0],v=function(){var e=(0,D.Z)(R().mark((function e(n){var o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o={status:"raised",quoted:!1,type:"reactive",serviceId:n.serviceSelected.value},e.next=3,f({variables:{id:t.id,changes:o,timing:{notes:n.comments,status:"raised",jobId:t.id,userId:i.id}}}).then((function(){return r()}));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),b={control:l,errors:a,register:s};return(0,W.jsxs)(de.Z,{handleSubmit:c(v),children:[(0,W.jsx)($r.P,co(co({},b),{},{errors:co({},a),name:"serviceSelected",label:"Service",type:"service"})),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},uo=function(){var e=(0,D.Z)(R().mark((function e(t,n,r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(so,{job:t,toggleShow:n.show,refetch:r}),submit:!1,title:"Make reactive"});case 1:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),lo=function(){var e=function(){var e=(0,D.Z)(R().mark((function e(){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(U.Z,{children:"No completed quotes"}),(0,W.jsx)(N.Z,{content:"Resend notification to selected supplier(s)",size:"sm",onClick:e})]})};function po(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function mo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?po(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):po(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var fo=function(e){var t,n,r,i=e.job,o=e.user,a=e.quotations,c=e.refetch,s=e.toggleShow,l=(0,d.useContext)(E.Z),p=null===o||void 0===o||null===(t=o.meta)||void 0===t||null===(n=t.threshold)||void 0===n?void 0:n.quote,v=a.filter((function(e){return["supplierQuoteComplete","supplierQuoteSent","thresholdApproved","waitingThresholdApproval"].includes(e.status)})),b=(0,ae.cI)({defaultValues:{selectedQuotes:i.selectedQuotes||[]}}),h=b.errors,j=b.handleSubmit,g=b.register,x=b.watch,w=(0,d.useState)(!1),I=w[0],Z=w[1],O=x(),S=O.selectedQuotes,_=O.sendQuote,P=S&&S.length>0,A=(0,m.D)(f.Dg),C=(0,u.Z)(A,1)[0],k=(0,m.D)(y.xY,{onCompleted:function(){c&&c()}}),q=(0,u.Z)(k,1)[0],T=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=mo({},i.meta)||{},"string"===typeof t.selectedQuotes&&(t.selectedQuotes=[t.selectedQuotes]),!a.filter((function(e){return t.selectedQuotes.includes("".concat(e.id))})).filter((function(e){var t=e.lineItems.reduce((function(e,t){return e+t.total}),0);return!Et(p,t+.2*t)&&!on("adminCustomer",null===i||void 0===i?void 0:i.timings,e.id)})).length){e.next=5;break}return e.abrupt("return",Z(!0));case 5:return e.next=7,Promise.all(t.selectedQuotes.map((function(e){return C({variables:{id:e,changes:{status:"supplierQuoteSent"},supplierOffer:[]}})})));case 7:r="quoteSent",t.sendQuote&&t.quotingEmail&&(n.sendQuoteTo=t.quotingEmail),q({variables:{id:i.id,changes:{status:r,meta:n},timing:{status:r,jobId:i.id,userId:o.id}}}),s();case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();if(0===v.length)return(0,W.jsx)(lo,{});var $,J={errors:h,register:g};return(0,W.jsxs)(de.Z,{handleSubmit:j(T),children:[I&&(0,W.jsx)(dt.Z,{content:"Your threshold is less than quotation total",context:"warning"}),(0,W.jsx)(Lt.Z,mo(mo({},J),{},{data:($=v,$.map((function(e){return{id:e.id,label:e.quoteNumber,value:e.id}}))),legend:"Select quotations",name:"selectedQuotes"})),(0,W.jsx)(Vt.Z,mo(mo({},J),{},{data:[{id:"sendQuote",label:"Send quote via email",value:"sendQuote"},{id:"markAsQuoteSent",label:"Mark quote as sent",value:"markAsQuoteSent"}],name:"sendQuote",stacked:!0})),"sendQuote"===_&&(0,W.jsx)(fe.Z,{label:"Send to email address",children:(0,W.jsx)(Oe.Z,mo(mo({},J),{},{defaultValue:null===(r=i.supplier)||void 0===r?void 0:r.details[0].quotingEmail,name:"quotingEmail"}))}),!I&&(0,W.jsx)("div",{style:{marginTop:"10px"},children:(0,W.jsx)(N.Z,{content:"Send Quotation(s)",size:"md",type:"submit",disabled:!P})}),I&&(0,W.jsx)(N.Z,{content:"Request threshold",size:"md",disabled:!P,onClick:function(){return(0,ln.I_)({type:"quote",role:"adminCustomer",quotations:v,jobId:i.id,accountId:o.accountId,threshold:p,offCanvas:l})}})]})};function vo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function bo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vo(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ho=function(e){var t=e.job,n=e.quotation,r=e.refetch,i=e.toggleShow,o=(0,ae.cI)({defaultValues:{siteVisitAt:n.siteVisitAt?new Date(n.siteVisitAt):null}}),a=o.control,c=o.errors,s=o.handleSubmit,d=o.register,l={control:a,errors:c,register:d},p=t.siteVisitEnd,v=t.siteVisitStart,b=t.siteVisitWeekends,h=(0,m.D)(f.HI,{onCompleted:function(e){r&&r(),i()}}),y=(0,u.Z)(h,1)[0],j=function(){var e=(0,D.Z)(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.startDate&&(t.startDate=(0,or.Z)(new Date(t.startDate))),e.next=3,y({variables:{id:n.id,changes:t,recommend:!1}});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:s(j),children:[(0,W.jsx)(fe.Z,{label:"Site visit time"}),(0,W.jsx)(qe.M,bo(bo({},l),{},{register:d,dateFormat:"d MMM yyyy HH:mm",minDate:v?new Date(v):new Date,maxDate:p&&new Date(p),filterTime:function(e){var t=new Date(e);return t.getHours()>=8&&t.getHours()<17&&t.getTime()<=new Date(p).getTime()&&t.getTime()>=new Date(v).getTime()},filterDate:!b&&function(e){var t=e.getDay();return 0!==t&&6!==t},name:"siteVisitAt",showTimeSelect:!0,todayButton:!1})),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},yo=function(e,t,n,r){n.show({content:(0,W.jsx)(ho,{job:e,quotation:t,refetch:r,toggleShow:n.close}),submit:!1,title:"Site visit time",width:"40%"})},jo=function(e,t,n,r,i,o){var a,c,s,u=n.siteVisitStart,d="reactive"===(null===(a=n.parentJob)||void 0===a?void 0:a.type),l=(0,re.E)(n,"quoteClosed");return"closed"===n.status?[{id:1,label:"New Quote",date:(0,re.E)(n,"quoteOffered")||(0,re.E)(n,"closed")},{id:2,label:"Quote Closed",date:(0,re.E)(n,"closed"),actions:[{id:1,active:(0,re.E)(n,"closed"),content:"Repost job",context:"danger",handleClick:function(){return xr(n,o,"quoteNew")},type:"button"}]}]:[{id:1,label:"New Quote",date:(0,re.E)(n,"quoteNew"),content:[{id:1,active:!0,data:"Created By ".concat((null===n||void 0===n||null===(c=n.timings[0])||void 0===c||null===(s=c.user)||void 0===s?void 0:s.fullName)||"")}],actions:[{id:1,active:(0,re.E)(n,"quoteNew")&&!(0,re.E)(n,"inProgress")&&!(0,re.E)(n,"quoteOffered"),content:"Make reactive",context:"secondary",handleClick:function(){return uo(n,r,i)},type:"button"},{id:2,active:d,content:"Related works",context:"info",handleClick:function(){var e;return Rr(null===(e=n.parentJob)||void 0===e?void 0:e.number)},type:"button"}]},{id:2,label:"Sent to Supplier(s)",info:n.quotations.length<n.quoteNumber?"".concat(n.quoteNumber," supplier(s) needed for this quote\n            (").concat(n.quotations.length,"/").concat(n.quoteNumber," selected)"):"no assigned suppliers",date:n.quotations.length>0&&(0,re.E)(n,"quoteOffered"),actions:[{id:1,active:n.quotations.length<n.quoteNumber&&("quoteNew"===n.status||(0,re.E)(n,"quoteNew"))&&!(0,re.E)(n,"inProgress"),content:"Assign suppliers",context:"info",data:{"data-cy":"supplierAssign"},handleClick:function(){r.show({title:"Assign Supplier",content:(0,W.jsx)(It,{deleteJobTiming:t,job:n,refetch:i,toggleShow:r.show},n.id),width:"50%",placement:"left"})},type:"button"},{id:2,active:!l&&n.quotations.length>=n.quoteNumber&&(0,re.E)(n,"quoteOffered")&&!(0,re.E)(n,"quoteAccepted"),content:"Repost job",context:"danger",handleClick:function(){return At({job:n,deleteJobTiming:t,offCanvas:r,refetch:i})},type:"button"}]},{id:3,label:"Received from Supplier(s)",info:"waiting for supplier to submit",date:(0,re.E)(n,"quoteReceived"),content:n.quotations.map((function(e,t){return{id:t,active:!(0,re.E)(n,"supplierQuoteComplete")&&e.siteVisitAt&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,data:function(){return(0,W.jsxs)(W.Fragment,{children:["Site visit at ".concat(e.quoteNumber),":",(0,W.jsxs)("b",{children:[" ",(0,ge.Z)(e.siteVisitAt,!0)]})]})}}})),actions:n.quotations.map((function(e,t){return{id:t,active:!(0,re.E)(n,"supplierQuoteComplete")&&u&&"supplierQuoteComplete"!==e.status&&"supplierQuoteRefused"!==e.status,content:e.siteVisitAt?"Edit site visit time ".concat(e.quoteNumber):"Select site visit time ".concat(e.quoteNumber),context:"secondary",handleClick:function(){return yo(n,e,r,i)},type:"button"}}))},{id:4,label:"Sent to Customer",info:"not sent",date:(0,re.E)(n,"quoteSent"),actions:[{id:1,active:!!n.quotations.find((function(e){return"supplierQuoteSent"===e.status}))&&(0,re.E)(n,"quoteSent"),content:"Download quote",context:"secondary",handleClick:function(){return gn(n,null,n.adminId)},type:"button"},{id:2,active:(0,re.E)(n,"quoteReceived")&&!(0,re.E)(n,"quoteSent"),content:"Send quote",context:"secondary",handleClick:function(){return function(e,t,n,r){n.show({content:(0,W.jsx)(fo,{job:e,user:t,quotations:e.quotations,refetch:r,toggleShow:n.close}),submit:!1,title:"Send Quote"})}(n,e,r,i)},type:"button"}]},{id:5,label:"Accepted / Rejected",info:"waiting for customer to accept",date:(0,re.E)(n,"quoteAccepted")},{id:6,label:"Closed",date:(0,re.E)(n,"quoteClosed")}]},go=function(e,t,n,r,i,o,a,c){var s;(0,Gn.x)();return n("admin")?s=jo(c,t,r,i,o,a):n("supplier")?s=function(e,t,n,r){var i,o="reactive"===(null===(i=e.parentJob)||void 0===i?void 0:i.type),a=e.quotations.length>0?e.quotations.find((function(e){return e.accountId===r.accountId})):{},c=!a||"supplierQuoteDraft"!==a.status&&"supplierQuoteComplete"!==a.status?null:a.updatedAt,s=a&&"supplierQuoteComplete"===a.status?a.updatedAt:null,u=e.siteVisitStart;return a.rejectAt?[{id:1,label:"Quotation offered",date:(0,re.E)(e,"quoteOffered")},{id:2,label:"Quotation rejected",date:a&&a.rejectAt||null}]:[{id:1,label:"Quotation offered",date:(0,re.E)(e,"quoteOffered"),actions:[{id:2,active:o,content:"Related works",context:"info",handleClick:function(){var t;return Rr(null===(t=e.parentJob)||void 0===t?void 0:t.number)},type:"button"}]},{id:2,label:"Quotation",info:"need to complete the quotation",date:c,content:e.quotations.map((function(t,n){return{id:n,active:!(0,re.E)(e,"supplierQuoteComplete")&&t.siteVisitAt&&"supplierQuoteComplete"!==t.status&&"supplierQuoteRefused"!==t.status,data:function(){return(0,W.jsxs)(W.Fragment,{children:["Site visit at ".concat(t.quoteNumber),":",(0,W.jsxs)("b",{children:[" ",(0,ge.Z)(t.siteVisitAt,!0)]})]})}}})),actions:e.quotations.map((function(r,i){return{id:i,active:!(0,re.E)(e,"supplierQuoteComplete")&&u&&"supplierQuoteComplete"!==r.status&&"supplierQuoteRefused"!==r.status,content:r.siteVisitAt?"Edit site visit time ".concat(r.quoteNumber):"Select site visit time ".concat(r.quoteNumber),context:"secondary",handleClick:function(){return yo(e,r,t,n)},type:"button"}}))},{id:3,label:"Completed",date:s}]}(r,i,o,c):n("customer")&&(s=function(e,t,n){var r,i="Accept / Reject";return(0,re.E)(e,"quoteRejected")&&(i="Rejected",r="quote has been rejected"),(0,re.E)(e,"quoteAccepted")&&(i="Accepted",r="quote has been accepted"),[{id:1,label:"Quote raised",info:"quote is with contractor for pricing",date:(0,re.E)(e,"quoteNew")||(0,re.E)(e,"quoteOffered")},{id:2,label:"In review",info:"currently being reviewed",date:(0,re.E)(e,"quoteReceived")},{id:3,label:"Awaiting acceptance",info:"awaiting your acceptance",date:(0,re.E)(e,"quoteSent")},{id:4,label:i,info:r,date:(0,re.E)(e,"quoteAccepted")||(0,re.E)(e,"quoteRejected")},{id:5,label:"Closed",date:(0,re.E)(e,"quoteClosed")}]}(r)),s.forEach((function(e){e.date&&(e.date=ke()(e.date).format("D MMM YYYY HH:mm"))})),s},xo=function(e){var t=[];return t.push({label:"Scheduled start:",value:e.timingStart?ke()(e.timingStart).format("D MMM YYYY HH:mm"):""}),e.timingEnd&&t.push({label:"Scheduled end:",value:e.timingEnd?ke()(e.timingEnd).format("D MMM YYYY HH:mm"):""}),"chargable"===e.quoteCharge&&t.push({label:"Quote charge:",value:(0,V.Z)(e.quoteChargeAmount)}),t};function wo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Io(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wo(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Zo=function(e){var t=e.job,n=e.toggleShow,r=(0,ae.cI)({defaultValues:{isRecall:!1}}),i=r.errors,o=r.handleSubmit,a={errors:i,register:r.register},s=function(){var e=(0,D.Z)(R().mark((function e(r){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:"true"===r.isRecall?Mn({adminId:t.adminId,job:t,openReport:!1}).then((function(e){c.default.push("/dashboard/issues/manage?recall=true&parentId=".concat(t.id,"&report=").concat(encodeURIComponent(e.key)))})):c.default.push("/dashboard/issues/manage?recall=false&parentId=".concat(t.id)),n();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsx)(de.Z,{id:"offCanvasForm",handleSubmit:o(s),children:(0,W.jsx)(fe.Z,{label:"",children:(0,W.jsx)(Lt.Z,Io(Io({},a),{},{name:"isRecall",data:[{label:"Is this a recall?",key:"recall",value:!0}]}))})})},Oo=function(){var e=(0,D.Z)(R().mark((function e(t,n){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.show({content:(0,W.jsx)(Zo,{job:t,toggleShow:n.close}),title:"Follow On"});case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),So=n(72197);function _o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Po(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_o(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ao,Co=function(e){var t=e.job,n=e.refetch,r=e.toggleShow,i=(0,d.useContext)(oe.Z).user,o=(0,ae.cI)({defaultValues:{comments:"",jobHoldReason:null}}),a=o.control,c=o.errors,s=o.handleSubmit,l=o.register,p=(0,m.D)(y.yT,{onCompleted:function(){n&&n(),r()}}),f=(0,u.Z)(p,1)[0],v=function(){var e=(0,D.Z)(R().mark((function e(n){var r,o;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:"onHold",o={},null!==(r=n.jobHoldReason)&&void 0!==r&&r.value&&(o.jobHoldReason={},o.jobHoldReason.value=n.jobHoldReason.value,o.jobHoldReason.label=n.jobHoldReason.label),f({variables:{timing:{jobId:t.id,meta:o,notes:n.comments,status:"onHold",userId:i.id}}});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),b={errors:c,register:l,control:a};return(0,W.jsxs)(de.Z,{handleSubmit:s(v),children:[(0,W.jsx)(So.l,Po(Po({},b),{},{label:"Reason",name:"jobHoldReason",type:"jobHoldReason"})),(0,W.jsx)(fe.Z,{label:"Comments",children:(0,W.jsx)(Mt.Z,Po(Po({},b),{},{name:"comments",rows:3}))}),(0,W.jsx)(Re.H,{content:"Submit",type:"submit"})]})},Do=(0,h.Ps)(Ao||(Ao=(0,b.Z)(['\n  mutation UpdateSupplierOffer(\n    $jobId: Int!\n    $jobChanges: Job_set_input\n    $timing: [JobTiming_insert_input!]!\n  ) {\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _in: ["accepted", "offered"] } }) {\n      returning {\n        jobId\n      }\n    }\n    insert_JobTiming(objects: $timing) {\n      returning {\n        id\n        status\n        createdAt\n      }\n    }\n\n    update_SupplierOffer(where: { jobId: { _eq: $jobId } }, _set: { status: "cancelled" }) {\n      returning {\n        id\n      }\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']))),ko=(0,se.Ry)().shape({cancellingReason:(0,se.Z_)().required()});function Ro(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function qo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ro(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ro(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Eo,To=function(e){var t,n=e.job,r=e.refetch,i=e.offCanvas,o=(0,d.useContext)(oe.Z).user,a=(0,ae.cI)({defaultValues:{notes:""},resolver:(0,ce.S)(ko)}),s=a.errors,l=a.handleSubmit,p=a.register,f=(0,a.watch)("canNotMakeDate"),v={errors:s,register:p},b=(0,m.D)(Do,{onCompleted:function(e){i.close(),"supplier"===o.accountType?c.default.push("/dashboard"):r&&r()}}),h=(0,u.Z)(b,1)[0],y=function(){var e=(0,D.Z)(R().mark((function e(t){var r,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null,i={scheduledAt:null,status:"raised",supplierId:null,supplierUserId:null},(r=[]).push({status:"supplierCancel",jobId:n.id,userId:o.id,notes:t.cancellingReason}),h({variables:{jobChanges:i,jobId:n.id,timing:r}});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Vt.Z,qo(qo({},v),{},{data:[{id:"yes",label:"Yes",value:!0},{id:"no",label:"No",value:!1}],legend:"Are you cancelling because you cannot make the scheduled date and time?",name:"canNotMakeDate",stacked:!0})),"true"===f&&(0,W.jsx)(Fr,{accountId:null===(t=n.supplier)||void 0===t?void 0:t.id,edit:!0,job:n,offCanvas:i,refetch:r}),"false"===f&&(0,W.jsxs)(de.Z,{handleSubmit:l(y),children:[(0,W.jsx)(fe.Z,{label:"Please provide a reason for cancelling this job",children:(0,W.jsx)(Mt.Z,qo(qo({},v),{},{name:"cancellingReason",rows:3}))}),(0,W.jsx)(Re.H,{content:"Confirm",type:"submit"})]})]})},$o=function(e){var t=e.addJobTiming,n=(e.addQuotation,e.deleteJobTiming),r=e.hasRole,i=e.job,o=e.refetch,a=e.updateJob,c=e.user,s=(0,d.useContext)(E.Z),l=nn(i.timings),p="onHold"===l,f="paused"===l,v=(0,re.E)(i,"quoteOffered"),b=(0,re.E)(i,"accepted"),h="incorrect"===i.timingStatus?i.correctEnd:(0,re.E)(i,"completed"),j="incorrect"===i.timingStatus?i.correctStart:(0,re.E)(i,"inProgress"),g=(0,re.E)(i,"disputeResolved"),x=(0,re.E)(i,"inDispute"),w=(0,re.E)(i,"quoteClosed"),I=(0,re.E)(i,"quoteCancelled"),Z=(0,m.D)(y.yT,{onCompleted:function(){o&&o()}}),O=(0,u.Z)(Z,1)[0],_=(r("admin")||r("supplier")&&!(!b&&!v))&&!f&&!p&&"quote"!==i.type,P=(r("admin")||r("supplier")&&!(!b&&!v))&&p&&"quote"!==i.type;return(0,W.jsxs)(H.Z,{open:!0,title:"Workflow",children:[(0,W.jsx)(Hn.Z,{items:"quote"!==i.type||(0,re.E)(i,"quoteAccepted")?ro(t,n,r,i,s,a,o,c):go(0,n,r,i,s,o,a,c),summary:"quote"===i.type?xo(i):io(i)},"stepper-".concat(i.id)),(0,W.jsx)(S.Z,{}),(0,W.jsxs)(T.Z,{align:"flex-start",children:[!p&&r("admin")&&h&&(0,W.jsx)(N.Z,{context:"secondary",content:"Follow On","data-cy":"followOn",onClick:function(){Oo(i,s)},size:"xs"}),r(["admin","supplier"])&&!p&&!j&&b&&"quote"!==i.type&&(0,W.jsx)(N.Z,{content:"Cancel",onClick:function(){s.show({content:(0,W.jsx)(To,{job:i,refetch:o,offCanvas:s}),submit:!1,title:"Cancel"})},context:"danger",size:"xs"}),r(["admin","customer"])&&"quote"===i.type&&!I&&(0,W.jsx)(N.Z,{context:"secondary",content:"Cancel","data-cy":"cancel",onClick:function(){xr(i,"quoteCancelled",s,o)},size:"xs"}),r(["admin","customer"])&&"quote"===i.type&&!w&&(0,W.jsx)(N.Z,{context:"danger",content:"Close",onClick:function(){xr(i,"quoteClosed",s,o)},size:"xs"}),!p&&h&&!x&&(0,W.jsx)(N.Z,{context:"secondary",content:"Dispute","data-cy":"dispute",onClick:function(){Xi(i,s,o)},size:"xs"}),(r("admin")||r("supplier"))&&x&&!g&&!("onHold"===l)&&(0,W.jsx)(N.Z,{context:"secondary",content:"Resolve Dispute","data-cy":"resolveDispute",onClick:function(){eo(i,s,o)},size:"xs"}),_&&(0,W.jsx)(N.Z,{content:"On Hold","data-cy":"onHold",onClick:function(){s.show({content:(0,W.jsx)(Co,{job:i,refetch:o,toggleShow:s.show}),submit:!1,title:"Put the job on hold"})},size:"xs"}),P&&(0,W.jsx)(N.Z,{content:"Resume","data-cy":"resume",onClick:function(){return function(e){O({variables:{timing:{status:e,jobId:i.id,userId:c.id}}})}("resumed")},size:"xs"})]}),!p&&x&&!g&&(0,W.jsxs)("div",{style:{alignItems:"start",display:"flex",marginTop:"1rem"},children:[(0,W.jsx)(U.Z,{as:"span",size:"sm",children:"Dispute media"}),(0,W.jsx)(N.Z,{content:(0,W.jsx)(J.Z,{icon:"file-upload"}),context:"info",onClick:function(){return to(qt(i,"inDispute"),s)},size:"xs",style:{marginLeft:".5rem"}})]})]})},No=n(86353),Jo=n(30493),Ho=n(87086),Uo=n(85088),Mo=(0,h.Ps)(Eo||(Eo=(0,b.Z)(["\n  query GetUserLocations($accountId: Int, $jobId: Int) {\n    supplierLocations: UserLocation(\n      limit: 10\n      order_by: { id: desc }\n      where: { jobId: { _eq: $jobId }, accountId: { _eq: $accountId } }\n    ) {\n      id\n      geo\n      meta\n      createdAt\n    }\n  }\n"]))),Fo=n(4337),Vo=n(74516);function Lo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function zo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Lo(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Lo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Qo,Bo,Yo,Wo,Go,Ko,Xo,ea,ta=function(e){var t,n=e.job,r=(0,P.WE)(null===n||void 0===n?void 0:n.location,"registered"),i=null,o=null;null!==r&&void 0!==r&&null!==(t=r.address)&&void 0!==t&&t.geo&&(i=(0,P.Pk)(r.address.geo));var a={jobId:n.id,accountId:n.supplier.id},c=(0,Uo.m)(Mo,{skip:!i,variables:zo({},a)}).data,s=(c=void 0===c?{supplierLocations:[]}:c).supplierLocations;if(s.length){var u=s[0];o=(0,P.Pk)(u.geo)}return i&&o?(0,W.jsxs)(H.Z,{open:!0,title:"Supplier Operative Location",children:[(0,W.jsxs)(Fo.Z,{apiKey:Jo.ie.map,defaultCenter:i,containerHeight:"400px",zoom:12,defaultOptions:{styles:Ho.U},children:[i&&(0,W.jsx)(Vo.Z,{icon:"https://maps.google.com/mapfiles/ms/icons/red-dot.png",position:i}),o&&(0,W.jsx)(Vo.Z,{icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",position:o})]}),(0,W.jsx)("br",{}),(0,W.jsx)(z.Z,{columns:[{text:"Distance"},{text:"Arrival"},{text:"Last update"}],rows:s.map((function(e){var t,n,r=e.meta;return{distance:null!==r&&void 0!==r&&null!==(t=r.distance)&&void 0!==t&&t.text?r.distance.text:"-",duration:null!==r&&void 0!==r&&null!==(n=r.duration)&&void 0!==n&&n.text?r.duration.text:"-",time:(0,ge.Z)(e.createdAt,!0)}}))})]}):null},na=n(2880),ra=n(28323),ia=n(77567),oa=n(74369),aa=n(98307),ca=function(e){var t=e.supplierId,n=e.toggleShow,r=(0,c.useRouter)();(0,d.useEffect)((function(){var e=function(e){n()};return r.events.on("routeChangeComplete",e),function(){r.events.off("routeChangeComplete",e)}}),[]);var i=(0,l.a)(na.l1,{variables:{id:t}}),o=i.loading,a=i.refetch,s=i.data,u=(s=void 0===s?{supplier:{}}:s).supplier;if(o)return(0,W.jsx)(Ii.Z,{indicator:(0,W.jsx)(Zi.Z,{})});var p=(0,P.WE)(u,"registered"),m=(0,P.WE)(u,"operating");return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(ia.g,{avatar:(0,ra.Q)(u.media),editable:!1,entity:u,entityName:"Account",linkTitleTo:"/dashboard/suppliers/view?id=".concat(u.id)}),(0,W.jsx)(aa.D,{supplier:u}),(0,W.jsx)(oa.T,{open:!1,supplier:u}),p&&(0,W.jsx)(_.f,{address:p.address,entity:"Account",entityId:u.id,id:p.id,open:!1,refetch:a,title:"Registered Address",type:"registered"}),m&&(0,W.jsx)(_.f,{address:m.address,entity:"Account",entityId:u.id,id:m.id,open:!1,refetch:a,title:"Operating Address",type:"operating"})]})},sa=function(e){var t=e.job,n=e.refetch,r=(0,d.useContext)(E.Z),i=(0,d.useContext)(Fe.Z).hasRole,o="onHold"===nn(t.timings),a=function(e,i,o){e.stopPropagation(),"accepted"===o?r.show({content:(0,W.jsx)(Fr,{accountId:i.accountId,job:t,offCanvas:r,refetch:n}),submit:!1,title:"Accept Job"}):r.show({content:(0,W.jsx)(zr,{accountId:i.accountId,job:t,offCanvas:r,refetch:n}),title:"Reject Job"})},c=[{context:"primary",icon:["fas","check"],onClick:function(e,t){return a(e,t,"accepted")},tooltip:"Accept"},{context:"danger",icon:["fas","times"],onClick:function(e,t){return a(e,t,"rejected")},tooltip:"Reject"}],s=[{hidden:!0},{hidden:!0},{text:"Supplier"},{formatter:function(e){var t=e.row;return(0,V.Z)(t.rate,"GBP")},text:"Rate/h"},{hidden:!0},{text:"Status"},{formatter:wi.Z,formatterData:c,text:"Actions"}],u=function(){return t.supplierOffers.filter((function(e){return"cancelled"!==e.status})).map((function(e){var t=e.account,n=e.dayRate,r=e.id,i=e.status,o=e.rate;return{id:r,accountId:t.id,name:t.name,rate:o,dayRate:n,status:i||"pending",actions:""}}))};return!o&&t.supplierOffers&&t.supplierOffers.length>0&&u().length>0&&(0,W.jsx)(H.Z,{open:!0,title:"Supplier Offers",children:i("admin")&&t.supplierOffers&&t.supplierOffers.length>0&&(0,W.jsx)(z.Z,{columns:s,rows:u(),rowClick:function(e){r.show({title:"Supplier information",content:(0,W.jsx)(ca,{supplierId:e.accountId,toggleShow:r.close})})}})})},ua=n(73303),da=n.n(ua),la=n(7802),pa=function(e){for(var t=null,n=(0,Ce.Z)(null===e||void 0===e?void 0:e.timings).sort((function(e,t){return e.id-t.id})),r=n.length-1;r>=0;r--){var i=n[r].status;if("inProgress"===i||"resumed"===i||"continued"===i){var o;t=(null===(o=n[r])||void 0===o?void 0:o.createdAt)||t;break}}return t},ma=n(44744),fa=function(e){var t=e.job,n=e.refetch,r=(0,d.useContext)(oe.Z).user,i=(0,d.useState)(null),o=i[0],a=i[1],c=(0,d.useState)(!0),s=c[0],l=c[1],f="fixed"===t.pricing,v=(0,ma._)(t.timings),b=da()(v,"duration"),h=Math.round(b/60),j="incorrect"===t.timingStatus,g=(0,Ut.Z)({autoStart:!1,startTime:pa(t),endTime:(0,re.E)(t,"completed")}),x=g.time,w=x.seconds,I=x.minutes,Z=x.hours,O=g.start,_=(0,p.t)(la.EW,{variables:{id:o}}),P=(0,u.Z)(_,2),A=P[0],C=P[1].data,D=(0,m.D)(y.xY,{onCompleted:function(){n&&n()}}),k=(0,u.Z)(D,1)[0],R=nn(t.timings),q=(0,re.E)(t,"inProgress")&&!(0,re.E)(t,"completed"),E="onHold"===R,J="paused"===R,U=!t.media||0===t.media.length;(0,d.useEffect)((function(){!q||J||E||O(),t.jobScheduleId&&(a(t.jobScheduleId),A())}),[t]);var M=function(e){if("ppm"!==t.type||function(e,t){var n=t.jobs.slice().sort((function(e,t){return Number(e.id)-Number(t.id)})),r=n.findIndex((function(t){return t.id===e}));if(r>0){var i=n[r-1];if(!(0,re.E)(i,"completed")&&!(0,re.E)(i,"closed"))return!1}return!0}(t.id,C.jobSchedule)){var n={status:e};k({variables:{id:t.id,changes:n,timing:{status:e,jobId:t.id,userId:r.id}}})}else l(!1)},F=function(e){return function(){return(0,W.jsx)($.Z,{content:(0,W.jsxs)(W.Fragment,{children:["From: ".concat(e.from),(0,W.jsx)("br",{}),"To: ".concat(e.to)]}),context:"info",children:(0,W.jsx)("span",{children:Math.round(e.duration/60)})})}};return(0,W.jsxs)(H.Z,{title:"Timer",open:!!(0,re.E)(t,["accepted","quoteAccepted"]),children:[(0,W.jsx)(va,{content:"".concat(Z,":").concat(I,":").concat(w)}),q&&U&&(0,W.jsx)(dt.Z,{content:"You must add at least one photo in order to end the timer.",context:"light"}),"ppm"===t.type&&!s&&(0,W.jsx)(dt.Z,{content:"the previous job has not been completed yet",context:"light"}),j&&(0,W.jsx)(dt.Z,{content:"Timer has been marked as incorrect supplier",context:"warning"}),(0,W.jsxs)(T.Z,{children:[!E&&!!(0,re.E)(t,["accepted","quoteAccepted"])&&!(0,re.E)(t,"inProgress")&&(0,W.jsx)(N.Z,{content:"Start",onClick:function(){return M("inProgress")}}),!!(0,re.E)(t,"inProgress")&&!(0,re.E)(t,"completed")&&!J&&!E&&(0,W.jsx)(N.Z,{content:"Pause",context:"danger",onClick:function(){return M("paused")}}),!(0,re.E)(t,"completed")&&J&&!E&&(0,W.jsx)(N.Z,{content:"Continue",onClick:function(){return M("continued")}}),!!(0,re.E)(t,"inProgress")&&!(0,re.E)(t,"completed")&&!E&&!J&&!U&&(0,W.jsx)(N.Z,{content:"End",context:"danger",onClick:function(){return M("completed")}})]}),(0,W.jsx)(S.Z,{}),!f&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(z.Z,{columns:[{text:"Date"},{text:"Minutes"},{hidden:!0},{hidden:!0}],rows:v.map((function(e){return{startDate:e.startDate,duration:F(e),from:e.from,until:e.until}})),striped:!1}),(0,W.jsx)(L.Z,{content:"Total",text:h})]})]})},va=(0,Q.ZP)(Nt.Z).withConfig({displayName:"module__StyledHeading",componentId:"sc-15xcwmv-0"})(["text-align:center;"]),ba=(0,h.Ps)(Qo||(Qo=(0,b.Z)(['\n  fragment CommunicationFields on Communication {\n    content\n    from\n    icon\n    id\n    more\n    status\n    statusLog\n    to\n    createdAt\n    media: Media(where: { entity: { _eq: "Communication" } }) {\n      id\n      medium: Medium {\n        id\n        category\n        filename\n        meta\n        type\n      }\n    }\n    user: User {\n      id\n      nameFirst\n      email\n    }\n  }\n']))),ha=(0,h.Ps)(Bo||(Bo=(0,b.Z)(['\n  fragment BroadcastFields on Broadcast {\n    content\n    from\n    icon\n    id\n    createdAt\n    media: Media(where: { entity: { _eq: "Communication" } }) {\n      id\n      medium: Medium {\n        id\n        category\n        filename\n        meta\n        type\n      }\n    }\n\n    senderAccount: SenderAccount {\n      id\n    }\n  }\n']))),ya=(0,h.Ps)(Yo||(Yo=(0,b.Z)(['\n  query getCommunications(\n    $accountId: Int\n    $filter: String\n    $jobId: Int\n    $search: String\n    $neqFilter: String\n  ) {\n    communications: Communication(\n      order_by: { id: asc }\n      where: {\n        accountId: { _eq: $accountId }\n        content: { _ilike: $search, _nlike: "" }\n        icon: { _eq: $filter, _neq: $neqFilter }\n        jobId: { _eq: $jobId }\n      }\n    ) {\n      ...CommunicationFields\n    }\n  }\n  ',"\n"])),ba),ja=((0,h.Ps)(Wo||(Wo=(0,b.Z)(['\n  query getBroadcast($senderUserId: Int, $filter: String, $search: String) {\n    broadcast: Broadcast(\n      order_by: { createdAt: asc }\n      where: {\n        senderUserId: { _eq: $senderUserId }\n        content: { _ilike: $search, _nlike: "" }\n        icon: { _eq: $filter }\n      }\n    ) {\n      ...BroadcastFields\n    }\n  }\n  ',"\n"])),ha),(0,h.Ps)(Go||(Go=(0,b.Z)(['\n  subscription getCommunications($accountId: Int, $filter: String, $jobId: Int, $search: String) {\n    communications: Communication(\n      order_by: { createdAt: desc }\n      where: {\n        accountId: { _eq: $accountId }\n        content: { _ilike: $search, _nlike: "" }\n        icon: { _eq: $filter }\n        jobId: { _eq: $jobId }\n      }\n      limit: 1\n    ) {\n      ...CommunicationFields\n    }\n  }\n  ',"\n"])),ba)),ga=(0,h.Ps)(Ko||(Ko=(0,b.Z)(["\n  mutation AddCommunication($objects: [Communication_insert_input!]!) {\n    insert_Communication(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),xa=(0,h.Ps)(Xo||(Xo=(0,b.Z)(["\n  mutation AddBroadcast($objects: [Broadcast_insert_input!]!) {\n    insert_Broadcast(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),wa=(0,h.Ps)(ea||(ea=(0,b.Z)(["\n  query getAccounts($adminId: Int) {\n    accountAdmin: Account_Admin(where: { adminId: { _eq: $adminId } }) {\n      accountId\n      account: Account {\n        type\n        accountUsers: Account_Users {\n          user: User {\n            id\n            email\n            fullName\n          }\n        }\n      }\n    }\n  }\n"]))),Ia=n(34770),Za=function(e,t,n,r,i){if(e)return{entity:"Communication",status:"active",Medium:{data:{meta:"internal"===i?{adminOnly:!0}:{allUser:!0},adminId:r.adminId,filename:e,extension:t,type:n,userId:r.id}}}},Oa=n(3805);function Sa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Sa(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Sa(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Pa=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o,c,s,u,d,l,p,m,f,v,b,h,y,j,g;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.form,i=t.scope,o=t.user,c=t.id,s=t.AddCommunication,u=r.audience,d=r.message,l=r.voice,p=null,e.t0=i,e.next="job"===e.t0?6:"customer"===e.t0||"supplier"===e.t0||"admin"===e.t0?8:"property"===e.t0?10:"broadcast"===e.t0?12:14;break;case 6:return p="jobId",e.abrupt("break",14);case 8:return p="accountId",e.abrupt("break",14);case 10:return p="locationId",e.abrupt("break",14);case 12:return p="broadcast",e.abrupt("break",14);case 14:if(p){e.next=16;break}return e.abrupt("return",null);case 16:if(m=u,n={},(0,a.Z)(n,p,c),(0,a.Z)(n,"content",JSON.stringify(d)),(0,a.Z)(n,"from","".concat(o.nameFirst," <").concat(o.email,">")),(0,a.Z)(n,"icon","comment"),(0,a.Z)(n,"status","delivered"),(0,a.Z)(n,"to",m),(0,a.Z)(n,"userId",o.id),(0,a.Z)(n,"Media",{data:[]}),f=n,y=[],r.attachments&&r.attachments.length>0)for(j=0;j<r.attachments.length;j++)"application/pdf"===(g=r.attachments[j]).type?(b="document",h="pdf"):g.type.startsWith("image/")&&(b="image",h=g.type.split("/")[1]),y.push((0,Oa.V)(g,b).then((function(e){if("image"===b){var t=e.key,n=e.data.find((function(e){return"large"===e.name}));v=n?n.relativePath:t}else v=e.key;f.Media.data.push(Za(v,h,b,o,u))})).catch((function(e){(0,hn.Tb)({message:e,section:"upload"})})));l&&(r.voice.name="audio.mpeg",h="mpeg",b="audio",y.push((0,Oa.V)(r.voice,"audio").then((function(e){v=e.key,f.Media.data=Za(v,h,b,o.id)})).catch((function(e){(0,hn.Tb)({message:e,section:"upload"})})))),Promise.all(y).then((function(e){s({variables:{objects:f}})}));case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Aa=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i,o,c,s,u,d,l,p,m,f,v,b,h,y,j,g,x;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.form,i=t.accountAdmin,o=t.user,c=t.id,s=t.AddCommunication,u=t.AddBroadcast,d=r.audience,l=r.message,p=r.voice,m=d||"all","accountId",n={},(0,a.Z)(n,"accountId",c),(0,a.Z)(n,"content",JSON.stringify(l)),(0,a.Z)(n,"from","".concat(o.nameFirst," <").concat(o.email,">")),(0,a.Z)(n,"icon","comment"),(0,a.Z)(n,"status","delivered"),(0,a.Z)(n,"to",m),(0,a.Z)(n,"userId",o.id),(0,a.Z)(n,"Media",{data:[]}),f=n,y=[],r.attachments&&r.attachments.length>0)for(j=0;j<r.attachments.length;j++)"application/pdf"===(g=r.attachments[j]).type?(b="document",h="pdf"):g.type.startsWith("image/")&&(b="image",h=g.type.split("/")[1]),y.push((0,Oa.V)(g,b).then((function(e){if("image"===b){var t=e.key,n=e.data.find((function(e){return"large"===e.name}));v=n?n.relativePath:t}else v=e.key;var r=Za(v,h,b,o.id);f.Media.data.push(r)})).catch((function(e){(0,hn.Tb)({message:e,section:"upload"})})));p&&(r.voice.name="audio.mpeg",h="mpeg",b="audio",y.push((0,Oa.V)(p,"audio").then((function(e){v=e.key,f.Media.data=Za(v,h,b,o.id)})).catch((function(e){(0,hn.Tb)({message:e,section:"upload"})})))),Promise.all(y).then((function(e){return s({variables:{objects:f}})})).then((function(e){x=e.data.insert_Communication.returning[0].id;var t=[];t="customer"===m?i.filter((function(e){return"customer"===e.account.type})):"supplier"===m?i.filter((function(e){return"supplier"===e.account.type})):i;var n=[];t.forEach((function(e){e.account.accountUsers.forEach((function(e){n.push(e.user)}))}));var r=n.map((function(e){return{content:JSON.stringify(l),from:"".concat(o.nameFirst," <").concat(o.email,">"),icon:"comment",receiverUserId:e.id,adminId:o.id,senderUserId:o.id,communicationId:x}}));u({variables:{objects:r}})}));case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Ca=function(e){var t=/<|>/gi;if("string"!==typeof e.content){var n,r,i=/@\[.+?\]\(.+?\)/gm,o=/@\[.+?\]/g,a=/\(.+?\)/g,c=null===(n=e.content)||void 0===n||null===(r=n.blocks[0])||void 0===r?void 0:r.text.match(i),s=[];c&&c.forEach((function(e){var t=e.match(a)[0].replace("(","").replace(")",""),n=e.match(o)[0].replace("@[","").replace("]","");s.push({id:t,display:n})}));for(var u=e.content.blocks[0].text.split(i),d="",l=0;l<u.length;l++){var p=u[l];l===u.length-1?d+=String(p).replace(t,(function(e){return"&#"+e.charCodeAt(0)+";"})).toString():d+=p+'<span style="color: blue; font-weight: bold">'.concat(String(s[l].display).replace(t,(function(e){return"&#"+e.charCodeAt(0)+";"})).toString(),"</span>")}return d}return String(e.content).replace(t,(function(e){return"&#"+e.charCodeAt(0)+";"})).toString()},Da=function(e){return e.user,e.from},ka=n(99216),Ra=n(64680),qa=n(45116),Ea=n(69041),Ta=n(90461),$a=n(42761),Na=n(71508),Ja=n(76446),Ha=n(27666),Ua=n(34186),Ma=n(91753),Fa=function(e){var t=e.filter,n=e.setFilter;return(0,W.jsx)(Na.Z,{sx:{minWidth:120},children:(0,W.jsxs)(Ja.Z,{fullWidth:!0,children:[(0,W.jsx)(Ha.Z,{children:"filter"}),(0,W.jsx)(Ua.Z,{value:null===t?"all":t,label:"Filter",onChange:function(e){return t=e.target.value,void n("all"===t?null:t);var t},children:["all","email","notification","comment"].map((function(e){var t=e.charAt(0).toUpperCase()+e.slice(1);return(0,W.jsx)(Ma.Z,{value:e,children:t},e)}))})]})})},Va=n(67109),La=n(2658),za=n(65817),Qa=n(50891),Ba=n(14603),Ya=n(14563),Wa=function(e){switch(e.icon){case"notification":return(0,W.jsx)(za.Z,{});case"email":return(0,W.jsx)(Qa.Z,{});case"comment":return(0,W.jsx)(Ba.Z,{});default:return(0,W.jsx)(W.Fragment,{})}},Ga=function(e){var t=e.audience,n="in"===e.type?"right":"left";switch(t){case"supplier":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"Supplier only",placement:n,children:(0,W.jsx)(Va.Z,{src:"S",alt:"S",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})})});case"customer":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"Customer only",placement:n,children:(0,W.jsx)(Va.Z,{src:"C",alt:"C",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})})});case"all":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"All",placement:n,children:(0,W.jsx)(Va.Z,{src:"A",alt:"A",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})})});case"admin":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"Internal",placement:n,children:(0,W.jsx)(Va.Z,{src:"I",alt:"I",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})})});case"admin-supplier":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"Admin and supplier",placement:n,children:(0,W.jsxs)("div",{style:{display:"flex"},children:[(0,W.jsx)(Va.Z,{src:"A",alt:"A",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}}),(0,W.jsx)(Va.Z,{src:"+",alt:"+",sx:{pb:"5px",color:"black",backgroundColor:"transparent",width:"20px",height:"20px"}}),(0,W.jsx)(Va.Z,{src:"S",alt:"S",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})]})})});case"admin-customer":return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(Ya.Z,{title:"Admin and customer",placement:n,children:(0,W.jsxs)("div",{style:{display:"flex"},children:[(0,W.jsx)(Va.Z,{src:"A",alt:"A",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}}),(0,W.jsx)(Va.Z,{src:"+",alt:"+",sx:{pb:"5px",color:"black",backgroundColor:"transparent",width:"20px",height:"20px"}}),(0,W.jsx)(Va.Z,{src:"C",alt:"C",sx:{color:"white",backgroundColor:"black",width:"20px",height:"20px"}})]})})});default:return(0,W.jsx)(W.Fragment,{})}},Ka=n(62665),Xa=function(e){var t=e.documentAttachmentArray;return(0,W.jsx)(W.Fragment,{children:t.map((function(e){return(0,W.jsx)(Na.Z,{sx:{border:"solid grey 0.5px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",mb:"5px"},children:(0,W.jsxs)("a",{href:e.src,without:!0,rel:"noopener noreferrer",target:"_blank",children:[(0,W.jsx)(Ka.Z,{sx:{mr:"10px"}}),e.name]})})}))})},ec=n(734),tc=function(e){var t=e.imageAttachmentArray,n=(0,d.useState)(0),r=n[0],i=n[1],o=(0,d.useState)(!1),a=o[0],c=o[1],s=t.map((function(e){return e.src})),u=(0,d.useCallback)((function(e){i(e),c(!0)}),[]);return(0,W.jsxs)(Na.Z,{children:[s.map((function(e,t){return(0,W.jsx)("img",{src:e,onClick:function(){return u(t)},style:{margin:"2px",width:"90%"},alt:""},t)})),a&&(0,W.jsx)(ec.Z,{src:s,currentIndex:r,disableScroll:!1,closeOnClickOutside:!0,onClose:function(){i(0),c(!1)}})]})},nc=function(e){var t=e.attachmentArray;return t[0].type.startsWith("application")?(0,W.jsx)(Xa,{documentAttachmentArray:t}):t[0].type.startsWith("image")?(0,W.jsx)(tc,{imageAttachmentArray:t}):null},rc={position:"relative",marginLeft:"20px",marginBottom:"10px",padding:"10px",backgroundColor:"#A8DDFD",width:"250px",textAlign:"left",font:"400 .9em 'Open Sans', sans-serif",border:"1px solid #97C6E3",borderRadius:"10px","&:after":{content:"''",position:"absolute",width:"0",height:"0",borderTop:"15px solid #A8DDFD",borderLeft:"15px solid transparent",borderRight:"15px solid transparent",top:"0",left:"-15px"},"&:before":{content:"''",position:"absolute",width:"0",height:"0",borderTop:"17px solid #97C6E3",borderLeft:"16px solid transparent",borderRight:"16px solid transparent",top:"-1px",left:"-17px"}},ic=function(e){var t=e.messageData,n=Ca(t),r=Da(t),i=t.time?t.time:"";return(0,W.jsx)(W.Fragment,{children:(0,W.jsxs)(ka.Z,{direction:"row",justifyContent:"flex-start",children:[(0,W.jsx)(Va.Z,{alt:r,src:r,sx:{color:"white",backgroundColor:"blue",width:"40px",height:"40px"}}),(0,W.jsxs)(Na.Z,{children:[(0,W.jsx)(Na.Z,{sx:{ml:"20px",fontSize:"0.8rem"},children:r}),(0,W.jsxs)(Na.Z,{sx:rc,children:[(0,W.jsxs)(Na.Z,{children:[(0,W.jsxs)(ka.Z,{flexDirection:"row",children:[(0,W.jsx)(Wa,{icon:t.icon}),(0,W.jsx)(Ga,{audience:t.to,type:t.type})]}),Boolean(t.attachments.length)&&(0,W.jsx)(nc,{attachmentArray:t.attachments}),(0,W.jsx)(La.Z,{sx:{padding:0,margin:0,overflowWrap:"break-word"},children:(0,W.jsx)("div",{dangerouslySetInnerHTML:{__html:n}})})]}),(0,W.jsx)(Na.Z,{sx:cc,children:i})]})]})]})})},oc={position:"relative",marginRight:"20px",marginBottom:"10px",padding:"10px",backgroundColor:"#f8e896",width:"250px",textAlign:"left",font:"400 .9em 'Open Sans', sans-serif",border:"1px solid #dfd087",borderRadius:"10px","&:after":{content:"''",position:"absolute",width:"0",height:"0",borderTop:"15px solid #f8e896",borderLeft:"15px solid transparent",borderRight:"15px solid transparent",top:"0",right:"-15px"},"&:before":{content:"''",position:"absolute",width:"0",height:"0",borderTop:"17px solid #dfd087",borderLeft:"16px solid transparent",borderRight:"16px solid transparent",top:"-1px",right:"-17px"}},ac=function(e){var t=e.messageData,n=t.time?t.time:"",r=Da(t),i=Ca(t);return(0,W.jsxs)(ka.Z,{direction:"row",justifyContent:"flex-end",children:[(0,W.jsxs)(Na.Z,{width:"100%",ml:"100%",children:[(0,W.jsx)(ka.Z,{flexDirection:"row",justifyContent:"end",sx:{mr:"20px"},children:(0,W.jsx)(La.Z,{sx:{fontSize:"0.8rem"},children:r})}),(0,W.jsx)(Na.Z,{children:(0,W.jsxs)(Na.Z,{sx:oc,children:[(0,W.jsxs)(ka.Z,{flexDirection:"row",justifyContent:"end",children:[(0,W.jsx)(Ga,{audience:t.to,type:t.type}),(0,W.jsx)(Wa,{icon:t.icon})]}),Boolean(t.attachments.length)&&(0,W.jsx)(nc,{attachmentArray:t.attachments}),(0,W.jsx)(La.Z,{sx:{padding:0,margin:0,overflowWrap:"break-word"},children:(0,W.jsx)("div",{dangerouslySetInnerHTML:{__html:i}})}),(0,W.jsx)(Na.Z,{sx:cc,children:n})]})})]}),(0,W.jsx)(Va.Z,{src:r,alt:r,sx:{color:"white",backgroundColor:"blue",width:"40px",height:"40px"}})]})},cc={position:"absolute",fontSize:".85em",fontWeight:"300",marginTop:"10px",bottom:"-3px",right:"5px",marginBottom:"5px"},sc=function(e){var t=e.messageData;return"in"===t.type?(0,W.jsx)(ic,{messageData:t}):(0,W.jsx)(ac,{messageData:t})},uc=n(6867),dc=n(26307),lc=n(95543),pc=n(62224),mc=n(76914),fc=n(67720),vc={position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"50%",marginTop:"100px",bgcolor:"background.paper",border:"1px solid grey",boxShadow:5,p:4,borderRadius:"8px",zIndex:10};function bc(e){var t=e.openModal,n=e.setOpenModal,r=e.handleSubmit,i=e.attachment,o=e.setAttachment,a=e.audience,c=(0,d.useState)(""),s=c[0],u=c[1];(0,d.useEffect)((function(){return function(){o([])}}),[]);return(0,W.jsx)("div",{children:(0,W.jsx)(pc.Z,{open:t,onClose:function(){return n(!1)},sx:{overflow:"scroll"},children:(0,W.jsxs)(ka.Z,{alignItems:"center",justifyContent:"center",sx:vc,children:[i&&i.map((function(e){return(0,W.jsx)(W.Fragment,{children:(0,W.jsx)(hc,{file:e},e.lastModified)})})),i.length?(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(qa.Z,{value:s,onChange:function(e){return u(e.target.value)},label:"Add a caption",sx:{width:"100%"}}),(0,W.jsx)(mc.Z,{sx:{width:"50%",mt:"2rem"},variant:"outlined",onClick:function(){r({attachments:i,audience:a,message:{blocks:[{data:{},depth:0,entityRanges:[],key:"21ddd2ss",text:s,type:"unstyled"}]},entityMap:{}}),u(""),n(!1)},children:"Send"})]}):null]})})})}var hc=function(e){var t=e.file;return"application/pdf"===t.type?(0,W.jsxs)(ka.Z,{mb:"2rem",width:"100%",flexDirection:"row",children:[(0,W.jsx)(Ka.Z,{sx:{color:"red",mr:"0.5rem"}}),(0,W.jsx)(La.Z,{children:t.name}),(0,W.jsx)(fc.Z,{})]}):(0,W.jsx)(ka.Z,{width:"100%",mb:"2rem",flexDirection:"row",children:(0,W.jsx)("img",{style:{width:"100%",height:"10%",borderRadius:"8px",border:"1px solid grey",marginBottom:"0.5rem"},src:URL.createObjectURL(t),alt:t.name})})},yc=n(62206),jc=n(56693),gc=function(e){var t=e.anchorEl,n=e.setAnchorEl,r=e.handleSubmit,i=(0,d.useState)([]),o=i[0],a=i[1],c=(0,d.useState)(!1),s=c[0],u=c[1],l=function(e){var t=e.target.files,n=(0,Ce.Z)(t);a(n)};(0,d.useEffect)((function(){u(!0),n(null)}),[o]);var p=Boolean(t),m=p?"simple-popover":void 0;return(0,W.jsxs)(W.Fragment,{children:[0!==o.length&&(0,W.jsx)(bc,{handleSubmit:r,openModal:s,setOpenModal:u,attachment:o,setAttachment:a}),(0,W.jsx)(yc.ZP,{open:p,id:m,anchorEl:t,onClose:function(){n(null)},anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:(0,W.jsxs)(Na.Z,{children:[(0,W.jsxs)(mc.Z,{startIcon:(0,W.jsx)(jc.Z,{}),sx:{width:"100%"},variant:"outlined",component:"label",children:["Upload image",(0,W.jsx)("input",{onChange:l,type:"file",accept:"image/*",hidden:!0,multiple:!0})]}),(0,W.jsxs)(mc.Z,{startIcon:(0,W.jsx)(Ka.Z,{}),sx:{width:"100%"},variant:"outlined",component:"label",children:["Upload PDF",(0,W.jsx)("input",{onChange:l,type:"file",accept:".pdf",hidden:!0,multiple:!0})]})]})})]})},xc=n(31039),wc={control:{backgroundColor:"#fff",fontSize:14,fontWeight:"normal"},"&multiLine":{control:{fontFamily:"monospace",minHeight:63},highlighter:{padding:"25px 50px 20px 50px",border:"1px solid transparent"},input:{padding:"25px 50px 20px 50px",border:"1px solid silver"}},"&singleLine":{display:"inline-block",width:180,highlighter:{padding:1,border:"2px inset transparent"},input:{padding:1,border:"2px inset"}},suggestions:{list:{backgroundColor:"white",border:"1px solid rgba(0,0,0,0.15)",fontSize:14,maxHeight:"200px",overflowY:"auto"},item:{padding:"5px 15px",borderBottom:"1px solid rgba(0,0,0,0.15)",height:"40px","&focused":{backgroundColor:"#add8e6"}}}},Ic={backgroundColor:"#add8e6"},Zc=function(e){var t=e.audienceOptions,n=e.setAudience,r=e.audience;return t.length>0?(0,W.jsx)(Ja.Z,{variant:"standard",sx:{minWidth:60,ml:"3px",position:"absolute",zIndex:999,top:0},children:(0,W.jsx)(Ua.Z,{value:r,onChange:function(e){n(e.target.value)},label:"Audience options",disableUnderline:!0,MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"right"},getContentAnchorEl:null},sx:{fontSize:"12px",fontFamily:"monospace",color:"#6b7a87"},children:t.map((function(e){return(0,W.jsx)(Ma.Z,{value:e.id,children:e.name},e.id)}))})}):(0,W.jsx)(W.Fragment,{})};function Oc(e){var t=e.handleSubmit,n=e.mentions,r=e.audience,i=e.setAudience,o=e.audienceOptions,a=(0,d.useState)(""),c=a[0],s=a[1],u=(0,d.useState)(!1),l=u[0],p=u[1],m=(0,d.useState)(null),f=m[0],v=m[1],b=(0,d.useState)([]),h=b[0],y=b[1],j=function(e,t){var n={};return e.filter((function(e){return t.some((function(t){return Number(t.id)===e.id}))})).forEach((function(e,t){n[t]={data:{mention:e},mutability:"SEGMENTED",type:"mention"}})),n},g=n.map((function(e){return{id:e.id,display:e.name}})),x=function(){return{attachments:[],audience:r,message:{blocks:[{data:{},depth:0,entityRanges:[],key:"21dd23d2ss",text:String(c).replace(/<|>/gi,(function(e){return"&#"+e.charCodeAt(0)+";"})).toString(),type:"unstyled"}],entityMap:j(n,h)}}};return(0,W.jsxs)(W.Fragment,{children:[l&&(0,W.jsx)(bc,{handleSubmit:t,openModal:l,setOpenModal:p,audience:r}),(0,W.jsxs)(Na.Z,{sx:{width:"100%",position:"relative"},children:[(0,W.jsx)(Zc,{audience:r,setAudience:i,audienceOptions:o}),(0,W.jsx)(uc.Z,{onClick:function(e){v(e.currentTarget)},sx:{position:"absolute",top:"15px",left:0,zIndex:100,ml:"10px"},children:(0,W.jsx)(lc.Z,{})}),(0,W.jsx)(xc.r,{value:c,onChange:function(e,t,n,r){s(e.target.value),y(r)},placeholder:"Leave a message...",allowSuggestionsAboveCursor:!0,style:wc,children:(0,W.jsx)(xc.p,{data:g,style:Ic})}),c.length?(0,W.jsx)(uc.Z,{onClick:function(){t(x()),s(""),y([])},sx:{position:"absolute",top:"15px",right:0,mr:"10px"},children:(0,W.jsx)(dc.Z,{})}):null]}),(0,W.jsx)(gc,{handleSubmit:t,anchorEl:f,setAnchorEl:v})]})}function Sc(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Sc(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Sc(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Pc=function(e){var t,n=e.id,r=e.mentions,i=e.scope,o=(0,d.useContext)(oe.Z).user,a=[];"job"===i?"supplier"===o.accountType?a=[{name:"Internal",id:"supplier"},{name:"Include others",id:"admin-supplier"}]:"customer"===o.accountType?a=[{name:"Internal",id:"customer"},{name:"Include others ",id:"admin-customer"}]:"admin"===o.accountType&&(a=[{name:"Internal",id:"admin"},{name:"All",id:"all"},{name:"Customer Only",id:"admin-customer"},{name:"Supplier Only",id:"admin-supplier"}]):"broadcast"===i&&(a=[{name:"All",id:"all"},{name:"Customer Only",id:"customer"},{name:"Supplier Only",id:"supplier"}]);var c=(0,d.useState)(null),s=c[0],p=c[1],f=(0,d.useState)(""),v=f[0],b=f[1],h=(0,d.useState)(null),y=h[0],j=h[1],g=(0,d.useState)(null===(t=a[0])||void 0===t?void 0:t.id),x=g[0],w=g[1],I={accountId:n,filter:s||null,search:v?"%".concat(v,"%"):null};"job"===i&&(delete I.accountId,I.jobId=n),"broadcast"===i&&(I.neqFilter="email");var Z=(0,l.a)(ya,{variables:I,fetchPolicy:"cache-and-network"}),O=Z.data,S=(O=void 0===O?{communications:[]}:O).communications,_=Z.subscribeToMore,P=Z.refetch,A=Z.loading;(0,d.useEffect)((function(){P()}),[P]),(0,d.useEffect)((function(){var e=function(e,t){return(0,Ce.Z)(e).map((function(e){var n=_a({},e);return n.time=ke()(n.createdAt).format("D MMM YYYY HH:mm"),n.from=n.user?"".concat(n.user.nameFirst," <").concat(n.user.email,">"):n.from,n.type=n.user&&n.user.id===t.id?"out":"in",n.statusText=n.status,n.content=(0,Ia.s)(n.content)?JSON.parse(n.content):n.content,n.attachments=[],n.media.forEach((function(e){var t,r,i;"audio"===(null===e||void 0===e||null===(t=e.medium)||void 0===t?void 0:t.type)?n.voice="".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.medium.filename):"image"===(null===e||void 0===e||null===(r=e.medium)||void 0===r?void 0:r.type)?n.attachments.push({type:"image/png",src:"".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.medium.filename),name:""}):"document"===(null===e||void 0===e||null===(i=e.medium)||void 0===i?void 0:i.type)&&n.attachments.push({type:"application/pdf",src:"".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.medium.filename),name:"".concat(e.medium.filename)})})),n}))}(S,o),t=function(e){var t=null===e||void 0===e?void 0:e.map((function(e){return _a(_a({},e),{},{time:ke()(e.time).format("D MMM YYYY")})}));return null===t||void 0===t?void 0:t.reduce((function(e,t){return e[t.time]?(e[t.time].push(t),e):(e[t.time]=[_a({},t)],e)}),{})}(function(e,t){switch(e.accountType){case"customer":var n=null===t||void 0===t?void 0:t.filter((function(e){return"customer"===e.to})),r=null===t||void 0===t?void 0:t.filter((function(e){return"all"===e.to})),i=null===t||void 0===t?void 0:t.filter((function(e){return"admin-customer"===e.to}));return[].concat((0,Ce.Z)(n),(0,Ce.Z)(r),(0,Ce.Z)(i)).sort((function(e,t){return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()}));case"supplier":var o=null===t||void 0===t?void 0:t.filter((function(e){return"supplier"===e.to})),a=null===t||void 0===t?void 0:t.filter((function(e){return"all"===e.to})),c=null===t||void 0===t?void 0:t.filter((function(e){return"admin-supplier"===e.to}));return[].concat((0,Ce.Z)(o),(0,Ce.Z)(a),(0,Ce.Z)(c)).sort((function(e,t){return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()}));case"admin":default:return t}}(o,e));j(t)}),[S]);var C=(0,d.useCallback)((function(){return _({document:ja,variables:I,updateQuery:function(e,t){var n=t.subscriptionData;if(!n.data)return e;if(e.communications){var r=n.data.communications;return Object.assign({},e,{communications:[].concat((0,Ce.Z)(e.communications),(0,Ce.Z)(r))})}}})}),[_]);(0,d.useEffect)((function(){C()}),[]);var D=(0,l.a)(wa,{variables:{adminId:o.id}}).data,k=(D=void 0===D?{accountAdmin:[]}:D).accountAdmin,R=(0,m.D)(ga),q=(0,u.Z)(R,1)[0],E=(0,m.D)(xa),T=(0,u.Z)(E,1)[0],$=!!y&&!A;return(0,W.jsx)(ka.Z,{direction:"row",width:"100%",alignItems:"center",justifyContent:"center",children:(0,W.jsxs)(Ra.Z,{sx:{width:"100%",maxHeight:"800px",display:"flex",alignItems:"center",flexDirection:"column",position:"relative"},children:[(0,W.jsxs)(ka.Z,{flexDirection:"row",justifyContent:"space-between",mb:"1rem",width:"100%",children:[(0,W.jsx)(qa.Z,{value:v,onChange:function(e){!function(e){b(e)}(e.target.value)},label:"message",sx:{width:"100%"},InputProps:{startAdornment:(0,W.jsx)($a.Z,{})}}),(0,W.jsx)(Fa,{filter:s,setFilter:p})]}),(0,W.jsxs)(Ra.Z,{sx:{width:"calc( 100% - 20px )",mt:1,mb:1,overflowY:"scroll",height:"calc( 100% - 80px )"},children:[(0,W.jsx)(W.Fragment,{children:!$&&(0,W.jsx)(Ea.Z,{})}),(0,W.jsx)(W.Fragment,{children:!!y&&Object.keys(y).map((function(e){return(0,W.jsxs)("div",{children:[(0,W.jsx)(ka.Z,{flexDirection:"row",justifyContent:"center",children:(0,W.jsx)(Ta.Z,{label:e})}),y[e].map((function(e){var t=_c(_c({},e),{},{time:ke()(e.createdAt).format("HH:mm")});return(0,W.jsx)(sc,{messageData:t},e.createdAt)}))]},e)}))})]}),(0,W.jsx)(Oc,{audience:x,audienceOptions:a,setAudience:w,handleSubmit:function(e){"broadcast"===i?Aa({form:e,accountAdmin:k,user:o,id:n,AddCommunication:q,AddBroadcast:T}):Pa({form:e,scope:i,user:o,id:n,AddCommunication:q})},mentions:r})]})})};Pc.defaultProps={mentions:[],scope:"job"};var Ac=n(19905),Cc=n(26398),Dc=(0,se.Ry)().shape({relatedSelected:(0,se.Ry)().required(),relType:(0,se.Z_)().required()});function kc(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Rc(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kc(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kc(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var qc,Ec,Tc,$c,Nc,Jc,Hc=function(e){var t,n,r,i,o,a=e.job,c=e.submit,s=(0,ae.cI)({resolver:(0,ce.S)(Dc)}),u=s.control,d=s.errors,l=s.handleSubmit,p=s.register,m=s.watch,f={control:u,errors:d,register:p},v=m("relatedSelected"),b=m("relType");return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:l((function(e){c(e)})),children:[(0,W.jsx)(Vt.Z,Rc(Rc({},f),{},{legend:"Relation Type",name:"relType",data:[{id:"parent",label:"Parent",value:"parent"},{id:"child",label:"Child",value:"child"}]})),(0,W.jsx)($r.P,Rc(Rc({},f),{},{errors:Rc({},d),label:"Work Orders",locationId:a.locationId,name:"relatedSelected",type:"job"})),v&&(0,W.jsxs)("div",{children:[(0,W.jsx)(L.Z,{content:"Id",text:v.number}),(0,W.jsx)(L.Z,{content:"Title",text:v.title}),(0,W.jsx)(L.Z,{content:"Date",text:(0,ge.Z)(v.timingStart)}),(0,W.jsx)(L.Z,{content:"Short Job Description",text:(null===v||void 0===v?void 0:v.Taxonomy.length)>0&&null!==(t=null===v||void 0===v||null===(n=v.Taxonomy[0].Taxonomy)||void 0===n?void 0:n.shortJobDescription)&&void 0!==t?t:"-"}),(0,W.jsx)(L.Z,{content:"Address",text:null!==(r=null===v||void 0===v||null===(i=v.Location)||void 0===i?void 0:i.name)&&void 0!==r?r:""}),(0,W.jsx)(L.Z,{content:"Status",text:null===(o=wn.yW.find((function(e){return e.value===v.status})))||void 0===o?void 0:o.text}),(0,W.jsx)("br",{})]}),"parent"===b&&a.parentId&&(0,W.jsx)(dt.Z,{content:"This job already has a parent job defined. Do you want to update it?",context:"warning"})]})},Uc=n(65570),Mc=function(e){var t,n,r=e.job,i=e.refetch,o=e.updateJob,a=e.numberPrefix,c=e.numberSuffix,s=(0,d.useContext)(Fe.Z).hasRole,u=(0,d.useContext)(E.Z),l=[],p=[{context:"danger",icon:["fas","trash"],onClick:function(e,t){return f(e,t)},tooltip:"Delete"}],m=[{text:"Relation"},{hidden:!0},{hidden:!0},{formatter:function(e){var t=e.row;return(0,W.jsx)(Uc.D,{id:t.id,number:t.number,openCanvas:!0,type:t.type,numberPrefix:a,numberSuffix:c})},sortable:!0,sortName:"number",text:"Id"},{hidden:!0,text:"Reference"},{hidden:!0,text:"Status"},{hidden:!0,text:"Created"},{hidden:!s("admin"),formatter:wi.Z,formatterData:p,text:"Actions"}];r.parentJob&&l.push({relType:"parent",id:r.parentJob.id,type:r.parentJob.type,number:r.parentJob.number,reference:r.parentJob.reference,status:(null===(t=wn.yW.find((function(e){return e.value===r.parentJob.status})))||void 0===t?void 0:t.text)||"",date:(0,ge.Z)(r.parentJob.createdAt),actions:""}),(null===(n=r.childJobs)||void 0===n?void 0:n.length)&&r.childJobs.forEach((function(e){var t=(wn.yW.find((function(t){return t.value===e.status}))||"").text;l.push({relType:"child",id:e.id,type:e.type,number:e.number,reference:e.reference,status:t,date:(0,ge.Z)(e.createdAt),actions:""})}));var f=function(e,t){o({variables:{id:"child"===t.relType?t.id:r.id,changes:{parentId:null}}}),e.stopPropagation(),i()},v=function(){var e=(0,D.Z)(R().mark((function e(t){var n,a;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.relatedSelected,"parent"===(a=t.relType)&&n.value?o({variables:{id:r.id,changes:{parentId:n.value}}}):"child"===a&&n.value&&o({variables:{id:n.value,changes:{parentId:r.id}}}),i(),u.close();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(H.Z,{title:"Related Works",children:[r.reference&&(0,W.jsx)(L.Z,{content:"Reference",text:(0,W.jsx)(Cc.Z,{to:"/dashboard/issues?q=".concat(r.reference),children:r.reference})}),(0,W.jsx)("br",{}),(0,W.jsx)(z.Z,{columns:m,rows:l}),(0,W.jsx)(Re.H,{content:"Add",context:"secondary",handleClick:function(){return e="parent",void u.show({content:(0,W.jsx)(Hc,{job:r,submit:v,type:e}),title:"Related Works"});var e},size:"sm"})]})},Fc=n(78586),Vc=(0,h.Ps)(qc||(qc=(0,b.Z)(['\n  query getInvoices($jobId: Int!) {\n    invoices: Invoice(where: { Job: { id: { _eq: $jobId } } }) {\n      id\n      items\n      status\n      createdAt\n      rebate\n      meta\n      totals\n      invoiceType\n      invoiceNumber\n      invoiceDate\n      expenses\n      entityId\n      entity\n      configs\n      amounts\n      addendum\n      addresses\n      adminId\n      Reconciliations {\n        id\n        amount\n        createdAt\n        id\n        creditEntity\n        creditEntityId\n      }\n      amountPaid: Reconciliations_aggregate(where: { creditEntity: { _eq: "PaymentReceipt" } }) {\n        aggregate {\n          sum {\n            amount\n          }\n        }\n      }\n\n      amountDeducted: Reconciliations_aggregate(where: { creditEntity: { _eq: "CreditNote" } }) {\n        aggregate {\n          sum {\n            amount\n          }\n        }\n      }\n      reconciledAmount: Reconciliations_aggregate {\n        aggregate {\n          sum {\n            amount\n          }\n        }\n      }\n    }\n    meta: Invoice_aggregate(\n      where: {\n        Job: { id: { _eq: $jobId } }\n        invoiceType: { _in: ["ProformaInvoiceCustomer", "ProformaInvoiceSupplier"] }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),Lc=(0,h.Ps)(Ec||(Ec=(0,b.Z)(["\n  mutation InsertInvoice(\n    $invoice: [Invoice_insert_input!]!\n    $account: Account_set_input\n    $accountId: Int!\n    $updatePointer: Boolean!\n  ) {\n    insert_Invoice(objects: $invoice) {\n      returning {\n        id\n      }\n    }\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $account)\n      @include(if: $updatePointer) {\n      id\n    }\n  }\n"]))),zc=n(29575),Qc=n(6608),Bc=(0,h.Ps)(Tc||(Tc=(0,b.Z)(["\n  query getReconciliation($jobId: Int!, $invoiceId: Int) {\n    reconciliation: Reconciliation(\n      where: { Invoice: { id: { _eq: $invoiceId }, Job: { id: { _eq: $jobId } } } }\n    ) {\n      amount\n      createdAt\n      id\n      creditEntity\n      creditEntityId\n      meta\n      accountEntry: AccountEntry {\n        id\n        meta\n        credit\n      }\n    }\n    meta: Reconciliation_aggregate(\n      where: { Invoice: { id: { _eq: $invoiceId }, Job: { id: { _eq: $jobId } } } }\n    ) {\n      aggregate {\n        total: sum {\n          amount\n        }\n      }\n    }\n  }\n"]))),Yc=(0,h.Ps)($c||($c=(0,b.Z)(["\n  mutation AddCreditNote(\n    $job: Job_set_input!\n    $jobId: Int!\n    $reconciliation: Reconciliation_insert_input!\n    $timing: [JobTiming_insert_input!]!\n    $isPaid: Boolean!\n  ) {\n    insert_Reconciliation_one(object: $reconciliation) {\n      id\n    }\n\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $job) @include(if: $isPaid) {\n      id\n    }\n\n    insert_JobTiming(objects: $timing) @include(if: $isPaid) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),Wc=(0,h.Ps)(Nc||(Nc=(0,b.Z)(['\n  mutation deleteCreditNote(\n    $creditNoteId: Int!\n    $isCreditNote: Boolean!\n    $jobId: Int!\n    $jobChanges: Job_set_input!\n    $reconciliationId: Int!\n  ) {\n    delete_Reconciliation_by_pk(id: $reconciliationId) {\n      id\n    }\n    delete_AccountEntry(where: { id: { _eq: $creditNoteId }, entity: { _eq: "CreditNote" } })\n      @include(if: $isCreditNote) {\n      returning {\n        id\n      }\n    }\n    delete_JobTiming(where: { jobId: { _eq: $jobId }, status: { _eq: "customerPaid" } }) {\n      returning {\n        id\n      }\n    }\n    update_Job_by_pk(pk_columns: { id: $jobId }, _set: $jobChanges) {\n      id\n    }\n  }\n']))),Gc=(0,h.Ps)(Jc||(Jc=(0,b.Z)(["\n  mutation AddCreditNote($object: AccountEntry_insert_input!) {\n    insert_AccountEntry_one(object: $object) {\n      id\n    }\n  }\n"]))),Kc=(0,se.Ry)().shape({amountReceived:(0,se.Rx)().moreThan(0).required(),dateReceived:(0,se.hT)().required(),reason:(0,se.Z_)().required()}),Xc=(0,se.Ry)().shape({id:(0,se.Rx)(),description:(0,se.Z_)(),rate:(0,se.Rx)().moreThan(0).required(),unit:(0,se.Rx)().integer().moreThan(0).required(),vatRate:(0,se.Z_)(),vatCustom:(0,se.Rx)().min(0)});function es(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ts(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?es(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):es(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ns=[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],rs=function(e){var t,n,r=e.defaultValues,i=e.editMode,o=e.toggleShow,a=e.onSuccess;null!==r&&void 0!==r&&r.vatRate&&20!==(null===r||void 0===r?void 0:r.vatRate)?(t=r.vatRate,n="custom"):n="20";var c=(0,ae.cI)({defaultValues:ts(ts({},r),{},{vatCustom:t,vatRate:n}),resolver:(0,ce.S)(Xc)}),s=c.control,u=c.errors,d=c.handleSubmit,l=c.register,p=c.watch,m={control:s,errors:u,register:l},f=p("vatRate"),v=p("rate"),b=p("unit"),h=p("vatCustom"),y=function(e){var t=e.unit,n=void 0===t?0:t,r=e.rate,i=void 0===r?0:r,o=e.vatRate,a=void 0===o?0:o;return{net:n*i||0,vat:i*n*a||0,gross:i*n*(1+a)||0}}({unit:b,rate:v,vatRate:("20"===p("vatRate")?20:h||0)/100}),j=y.net,g=y.vat,x=y.gross,w=function(){var e=(0,D.Z)(R().mark((function e(t){var n;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:delete(n=ts(ts({},t),{},{vatRate:"20"===t.vatRate?20:t.vatCustom||0})).vatCustom,a(ts(ts({},n),{},{net:j,gross:x,vat:g}),i);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:d(w),children:[(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:"Description",children:(0,W.jsx)(Mt.Z,ts(ts({},m),{},{name:"description",rows:2}))})})}),(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:6,children:(0,W.jsx)(le.Z,ts(ts({},m),{},{name:"rate",label:"Unit Cost",vat:"Ex VAT"}))}),(0,W.jsx)(O.Z,{md:6,children:(0,W.jsx)(fe.Z,{label:"Units",children:(0,W.jsx)(Oe.Z,ts(ts({},m),{},{name:"unit",type:"number"}))})})]}),(0,W.jsx)(Z.Z,{children:(0,W.jsxs)(O.Z,{md:12,children:[(0,W.jsx)(fe.Z,{label:"VAT %"}),(0,W.jsx)(Vt.Z,ts(ts({},m),{},{name:"vatRate",data:ns})),"custom"===f&&(0,W.jsx)(ve.Z,ts(ts({},m),{},{label:"Custom VAT",name:"vatCustom"}))]})}),(0,W.jsxs)(U.Z,{children:["Net: ",(0,V.Z)(j)]}),(0,W.jsxs)(U.Z,{children:["VAT: ",(0,V.Z)(g)]}),(0,W.jsxs)(U.Z,{children:["Gross: ",(0,V.Z)(x)]}),(0,W.jsxs)(Z.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,W.jsx)(N.Z,{content:"Back",onClick:o,style:{margin:"0 5px"},context:"danger"}),(0,W.jsx)(N.Z,{content:i?"Save":"Add",type:"submit"})]}),"number"===typeof(null===r||void 0===r?void 0:r.id)&&(0,W.jsx)(Oe.Z,ts(ts({},m),{},{name:"id",type:"hidden"})),(0,W.jsx)("div",{style:{clear:"both"}})]})},is=(0,Q.ZP)(Z.Z).attrs((function(){return{align:"center",justify:"between"}})).withConfig({displayName:"creditNoteTable__StyledRow",componentId:"sc-1eov9hu-0"})(["margin:0 5px;"]),os=Q.ZP.p.withConfig({displayName:"creditNoteTable__StyledP",componentId:"sc-1eov9hu-1"})(["margin:0;"]),as=function(e){var t=e.values,n=e.setValue,r=e.showDetails,i=(0,d.useContext)(E.Z),o=function(e,r){if(r){var o=(0,Ce.Z)(t);o[e.id]=e,n(o)}else n([].concat((0,Ce.Z)(t),[e]));i.close()},a=function(e,t){i.show({content:(0,W.jsx)(rs,{editMode:!!t,onSuccess:o,toggleShow:i.close,defaultValues:t}),submit:!1,title:"".concat(t?"Edit":"Insert","  Item")})},c=[{hidden:!0},{hidden:!1,text:"Description"},{hidden:!1,text:"Quantity",formatter:function(e){return e.row.unit}},{hidden:!1,text:"Rate",formatter:function(e){var t=e.row;return(0,V.Z)(t.rate)}},{hidden:!1,text:"Net",formatter:function(e){var t=e.row;return(0,V.Z)(t.net)}},{hidden:!1,text:"VAT % ",formatter:function(e){var t=e.row;return"".concat(t.vatRate,"%")}},{hidden:!1,text:"VAT",formatter:function(e){var t=e.row;return(0,V.Z)(t.vat)}},{hidden:!1,text:"Gross",formatter:function(e){var t=e.row;return(0,V.Z)(t.gross)}},{formatter:wi.Z,formatterData:(0,Oi.N)(null,{onEditClick:a,onDeleteClick:function(e,r){var i=(0,Ce.Z)(t);i.splice(r.id,1),n((0,Ce.Z)(i))}}),text:"Actions",hidden:r}],s=t.reduce((function(e,t){return e+(t.itemTotal||t.net||0)}),0),u=t.reduce((function(e,t){return e+(t.vatAmount||t.vat||0)}),0),l=t.reduce((function(e,t){return e+(t.itemTotalIncVAT||t.gross||0)}),0);return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Nt.Z,{content:(0,W.jsxs)(is,{align:"center",justify:"between",children:[(0,W.jsx)("span",{children:"Items:"}),!r&&(0,W.jsx)(N.Z,{content:"Insert Item",context:"secondary",onClick:a,size:"sm"})]}),tag:"h4"}),(0,W.jsx)(z.Z,{columns:c,rows:t.map((function(e,t){return{id:t,description:e.description,unit:e.unit,rate:e.rate,net:e.net,vatRate:e.vatRate,vat:e.vat,gross:e.gross,action:""}}))}),(0,W.jsxs)("div",{style:{textAlign:"right"},children:[(0,W.jsxs)(os,{children:["Net Total : ",(0,V.Z)(s)]}),(0,W.jsxs)(os,{children:["VAT Total : ",(0,V.Z)(u)]}),(0,W.jsxs)(os,{children:["Gross Total : ",(0,V.Z)(l)]})]})]})},cs=n(380),ss=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return null===t||void 0===t||null===(e=t.items)||void 0===e?void 0:e.map((function(e){return{description:e.description,unit:e.unit,rate:e.rate,net:e.unit*e.rate,vatRate:100*e.vatRate,vat:e.unit*e.rate*e.vatRate,gross:e.unit*e.rate*(e.vatRate+1)}}))},us=function(e,t){return e.map((function(e){return{minutes:e.unit,name:e.description,itemTotal:e.price,itemTotalIncVAT:e.gross,rate:e.unitCost,cost:"".concat((0,V.Z)(e.unitCost)," (x").concat(e.unit,")"),totalCost:e.price.toFixed(2),id:e.id,vatAmount:e.vat,vatRate:e.vatPercent/100,serviceRate:"-"}}))};function ds(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ls(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ds(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ds(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ps=function(e){var t,n=e.defaultValues,r=e.job,i=e.refetch,o=e.toggleShow,a=(e.userId,e.invoiceId),c=e.invoice,s=e.totalReconciledAmount,l=(0,d.useState)(),p=l[0],f=l[1],v=(0,ae.cI)({defaultValues:ls({},n),resolver:(0,ce.S)(Kc)}),b=v.control,h=v.errors,y=v.handleSubmit,j=v.register,g=v.setValue,x=(0,d.useState)(ss(n)),w=x[0],I=x[1],Z="ProformaInvoiceCustomer"===c.invoiceType?c.reconciledAmount.aggregate.sum.amount:s||0,O=null!==(t=c.amounts.vatTotal)&&void 0!==t?t:0,S=(0,m.D)(Yc,{onCompleted:function(){i(),o()}}),_=(0,u.Z)(S,1)[0],P=(0,m.D)(Gc),A=(0,u.Z)(P,1)[0],C=function(){var e=(0,D.Z)(R().mark((function e(t){var n,i,o,s,u,d;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=w.reduce((function(e,t){return e+t.gross}),0),!(Number(n+Z)>O)){e.next=4;break}return f("maximum allowed value is ".concat((0,V.Z)(O-Z))),e.abrupt("return");case 4:return i={accountId:r.customer.id,balance:0,credit:parseFloat(t.amountReceived).toFixed(2),currencyId:(0,cs.K)(r.customer.id),debit:0,entity:"CreditNote",meta:{paymentReference:null,comment:t.reason},type:"creditNote",paymentStatus:"creditNote",dateReceived:(0,Hr.v)(t.dateReceived),AccountEntry_Invoice:{data:[{invoiceId:a}]}},e.next=7,A({variables:{object:i}}).then((function(e){return e.data.insert_AccountEntry_one.id}));case 7:o=e.sent,s={amount:n,creditEntity:"CreditNote",creditEntityId:o,debitEntity:"Invoice",debitEntityId:a,meta:{items:w.map((function(e){return{description:e.description,unit:e.unit,rate:e.rate,vatRate:e.vatRate/100}}))}},u={job:{},jobId:r.id,reconciliation:s,timing:[],isPaid:!1},n+Z===O&&(d="customerPaid",u.job={status:d},u.timing.push({status:d,jobId:r.id}),u.isPaid="ProformaInvoiceCustomer"!==c.invoiceType),_({variables:u});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),k={control:b,errors:h,register:j};return g("amountReceived",(0,Y.l)(null===w||void 0===w?void 0:w.reduce((function(e,t){return e+t.gross}),0),2)),(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:y(C),children:[(0,W.jsx)(L.Z,{content:"Invoice amount ",text:(0,V.Z)(O)}),(0,W.jsx)(L.Z,{content:"Reconciled amount",text:(0,V.Z)(Z)}),(0,W.jsx)(as,{setValue:I,values:w,showDetails:!1}),(0,W.jsx)(fe.Z,{label:"Date created"}),(0,W.jsx)(qe.M,ls(ls({},k),{},{name:"dateReceived"})),(0,W.jsx)(fe.Z,{label:"Amount"}),(0,W.jsxs)(be.Z,{children:[(0,W.jsx)(pe.Z,ls(ls({},k),{},{addonType:"prepend",size:10,text:!0,children:"\xa3"})),(0,W.jsx)(Oe.Z,ls(ls({},k),{},{name:"amountReceived",readOnly:!0})),(0,W.jsx)(pe.Z,ls(ls({},k),{},{addonType:"append",size:10,text:!0,children:"EX Vat"}))]}),(0,W.jsx)(fe.Z,{label:"Reason",children:(0,W.jsx)(Mt.Z,ls(ls({},k),{},{name:"reason",rows:2}))}),p&&(0,W.jsx)(dt.Z,{context:"danger",content:p})]})},ms=function(e){var t=e.jobId,n=e.onSuccess,r=e.reconciliation,i=(0,m.D)(Wc,{onCompleted:n}),o=(0,u.Z)(i,1)[0],a=function(){var e=(0,D.Z)(R().mark((function e(){var i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={creditNoteId:r.creditEntityId,isCreditNote:"CreditNote"===r.creditEntity,jobId:t,jobChanges:{status:"invoiceSent",paid:!1},reconciliationId:r.id},e.next=3,o({variables:i});case 3:n();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),c=r.meta,s=(c=void 0===c?{}:c).items,d=void 0===s?[]:s;return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(as,{values:ss({items:d}),showDetails:!0}),(0,W.jsx)(L.Z,{content:"Payment Type",text:r.creditEntity||"-"}),(0,W.jsx)(L.Z,{content:"Comment",text:r.comment||"-"}),(0,W.jsx)(L.Z,{content:"Amount",text:r.amountReceived||"-"}),(0,W.jsx)(L.Z,{content:"Date",text:r.dateReceived||"-"}),(0,W.jsx)(L.Z,{content:"Reference",text:r.paymentReference||"-"}),(0,W.jsx)(Re.H,{content:"Delete",context:"danger",handleClick:a}),(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,style:{textAlign:"right"},children:"PaymentReceipt"===r.creditEntity&&(0,W.jsx)(U.Z,{size:"sm",children:"will not remove payment record"})})})]})};function fs(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function vs(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fs(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fs(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var bs=function(){var e=(0,D.Z)(R().mark((function e(t){var n,r,i;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.adminId,t.item,n=t.creditNote,e.next=3,vs(vs({date:new Date},n),{},{title:"Credit Note"});case 3:return r=e.sent,i=window.open("/download","_blank"),e.next=7,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/credit-note/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(r)}).then((function(e){return e.json()})).then((function(e){i.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,hn.Tb)({message:e,section:"fetch"})}));case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),hs=function(e){e.handleEditCreditNote;var t=e.job,n=e.loading,r=e.reconciliation,i=e.refetch,o=(e.userId,(0,dn.x)().user),a=(0,d.useContext)(E.Z),c=function(e){a.show({content:(0,W.jsx)(ms,{jobId:t.id,onSuccess:s,reconciliation:e}),submit:!1,title:"Reconciliation Details"})},s=function(){i(),a.close()},u=[{hidden:!0},{hidden:!0},{text:"Type"},{formatter:function(e){var t=e.row;return(0,V.Z)(t.amountReceived)},text:"Payment Amount "},{formatter:function(e){var t=e.row;return(0,V.Z)(t.reconciledAmount)},text:"Reconciled"},{text:"Date"},{hidden:!0,text:"Reference"},{hidden:!0},{hidden:!0},{formatter:wi.Z,formatterData:function(e){var t=[{content:"Details",context:"secondary",icon:["fas","info-circle"],onClick:function(e,t){return c(t)},tooltip:"Details"}];return"CreditNote"===e.creditEntity&&t.push({context:"secondary",content:"Download",icon:["fas","download"],onClick:function(e,t){return function(e,t){e.stopPropagation();var n=t.metaCreditNote;bs({adminId:o.accountId,creditNote:n})}(e,t)},tooltip:"Download PDF"}),t},text:"Actions"}];return(0,W.jsx)(z.Z,{columns:u,loading:n,rows:r.map((function(e){var t,n,r,i;return{id:e.id,creditEntityId:e.creditEntityId,creditEntity:e.creditEntity,amountReceived:e.accountEntry.credit,reconciledAmount:e.amount,dateReceived:(0,ge.Z)(e.createdAt),paymentReference:(null===(t=e.accountEntry)||void 0===t||null===(n=t.meta)||void 0===n?void 0:n.paymentReference)||"-",comment:(null===(r=e.accountEntry)||void 0===r||null===(i=r.meta)||void 0===i?void 0:i.comment)||"-",meta:e.meta,action:""}})),rowClick:c})},ys=function(e){var t=e.currency,n=e.job,r=e.refetch,i=e.invoiceId,o=(0,d.useContext)(oe.Z).user,a=(0,d.useContext)(E.Z),c=(0,l.a)(Bc,{variables:{jobId:n.id,invoiceId:i}}),s=c.loading,u=c.refetch,p=c.data,m=(p=void 0===p?{reconciliation:[],meta:{aggregate:{total:{amount:0}}}}:p).reconciliation,f=p.meta;return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)("strong",{children:"Reconciliation"}),(0,W.jsx)(L.Z,{content:"Total",text:(0,V.Z)(f.aggregate.total.amount,t)}),(0,W.jsx)(hs,{handleEditCreditNote:function(e,t){return function(e,t){var i;e.stopPropagation(),t&&(i={id:t.id,effectiveDate:null!==t&&void 0!==t&&t.dateReceived?new Date(t.dateReceived):void 0,amount:t.amountReceived,vat:t.reconciledAmount,reason:t.comment,jobId:n.id}),a.show({content:(0,W.jsx)(ps,{defaultValues:i,job:n,refetch:r,toggleShow:a.close,userId:o.id}),title:i?"Update Credit Note":"Add Credit Note"})}(e,t)},job:n,loading:s,refetch:function(){r(),u()},reconciliation:m,userId:o.id})]})};function js(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function gs(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?js(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):js(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var xs=[{id:"default",label:"Default (20%)",value:20},{id:"custom",label:"Custom",value:"custom"}],ws=function(e){var t,n,r=e.defaultValues,i=e.editMode,o=e.toggleShow,a=e.onSuccess;null!==r&&void 0!==r&&r.vatPercent&&20!==(null===r||void 0===r?void 0:r.vatPercent)?(n=r.vatPercent,t="custom"):t="20";var c=(0,ae.cI)({defaultValues:gs(gs({},r),{},{vat:t,vatCustom:n})}),s=c.control,u=c.errors,d=c.handleSubmit,l=c.register,p=c.watch,m={control:s,errors:u,register:l},f=p("vat"),v=p("unitCost"),b=p("unit"),h=p("vatCustom"),y="20"===p("vat")?20:h||0,j=function(e){var t=e.unit,n=void 0===t?0:t,r=e.unitCost,i=void 0===r?0:r,o=e.vatPercent,a=void 0===o?0:o;return{net:n*i||0,vatTotal:i*n*(1+a)-i*n||0,gross:i*n*(1+a)||0,price:i*(n||1)}}({unit:b,unitCost:v,vatPercent:y/100}),g=j.net,x=j.vatTotal,w=j.gross,I=j.price,S=function(){var e=(0,D.Z)(R().mark((function e(t){return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a(gs(gs({},t),{},{price:I,net:g,vat:x,gross:w,vatPercent:y}));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return(0,W.jsxs)(de.Z,{handleSubmit:d(S),children:[(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:(0,W.jsx)(fe.Z,{label:"Description",children:(0,W.jsx)(Mt.Z,gs(gs({},m),{},{name:"description",rows:2}))})})}),(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:4,children:(0,W.jsx)(le.Z,gs(gs({},m),{},{name:"unitCost",label:"Unit Cost",vat:"Ex VAT"}))}),(0,W.jsx)(O.Z,{md:4,children:(0,W.jsx)(fe.Z,{label:"Units",children:(0,W.jsx)(Oe.Z,gs(gs({},m),{},{name:"unit"}))})})," ",(0,W.jsxs)(O.Z,{md:12,children:[(0,W.jsx)(fe.Z,{label:"VAT %"}),(0,W.jsx)(Vt.Z,gs(gs({},m),{},{name:"vat",data:xs})),"custom"===f&&(0,W.jsx)(ve.Z,gs(gs({},m),{},{label:"Custom VAT",name:"vatCustom"}))]})]}),(0,W.jsxs)(U.Z,{children:["Net: ",(0,V.Z)(g)]}),(0,W.jsxs)(U.Z,{children:["VAT: ",(0,V.Z)(x)]}),(0,W.jsxs)(U.Z,{children:["Gross: ",(0,V.Z)(w)]}),(0,W.jsxs)(Z.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,W.jsx)(N.Z,{content:"Back",onClick:o,style:{margin:"0 5px"},context:"danger"}),(0,W.jsx)(N.Z,{content:i?"Save":"Add",type:"submit"})]}),(0,W.jsx)(Oe.Z,gs(gs({},m),{},{name:"id",type:"hidden"})),(0,W.jsx)("div",{style:{clear:"both"}})]})};function Is(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Zs(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Is(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Is(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Os=(0,Q.ZP)(Z.Z).attrs((function(){return{align:"center",justify:"between"}})).withConfig({displayName:"lineInvoiceTable__StyledRow",componentId:"sc-qa1qq7-0"})(["margin:0 5px;"]),Ss=Q.ZP.div.withConfig({displayName:"lineInvoiceTable__StyledText",componentId:"sc-qa1qq7-1"})(["margin:0;display:flex;justify-content:space-between;"]),_s=Q.ZP.div.withConfig({displayName:"lineInvoiceTable__StyledTextBox",componentId:"sc-qa1qq7-2"})(["margin:0 0 0 auto;display:flex;flex-direction:column;width:144px;"]),Ps=function(e){var t=e.setInvoiceItems,n=e.invoiceItems,r=e.showDetails,i=(0,d.useContext)(E.Z),o=function(e){if(e.id){var r=Number(e.id),o=n.filter((function(e){return e.id!==r}));t([].concat((0,Ce.Z)(o),[Zs(Zs({},e),{},{id:r})]))}else{e.id=(null===n||void 0===n?void 0:n.length)+1;var a=n.concat(e);t((0,Ce.Z)(a))}i.close()},a=function(e,t){i.show({content:(0,W.jsx)(ws,{editMode:!(null===t||void 0===t||!t.rowData),onSuccess:o,toggleShow:i.close,defaultValues:null===t||void 0===t?void 0:t.rowData}),submit:!1,title:"".concat(t?"Edit":"Insert","  Item")})},c=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!1,text:"Quantity"},{hidden:!1,text:"Rate"},{hidden:!1,text:"Net"},{hidden:!1,text:"VAT % "},{hidden:!1,text:"VAT"},{hidden:!1,text:"Gross"},{hidden:!0},{formatter:wi.Z,formatterData:(0,Oi.N)(null,{onEditClick:a,onDeleteClick:function(e,r){n.splice(n.findIndex((function(e){return e.id===r.id})),1),t((0,Ce.Z)(n))}}),text:"Actions",hidden:r}],s=n.reduce((function(e,t){return e+t.net}),0),u=n.reduce((function(e,t){return e+t.vat}),0),l=n.reduce((function(e,t){return e+t.gross}),0);return(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Nt.Z,{content:(0,W.jsxs)(Os,{align:"center",justify:"between",children:[(0,W.jsx)("span",{children:"Invoice items:"}),!r&&(0,W.jsx)(N.Z,{content:"Insert Invoice Item",context:"secondary",onClick:a,size:"sm"})]}),tag:"h4"}),(0,W.jsx)(z.Z,{columns:c,rows:n.map((function(e){return{id:e.id,description:e.description,units:e.unit,unitCost:(0,V.Z)(null===e||void 0===e?void 0:e.unitCost),net:(0,V.Z)(e.net),vatPercent:"".concat(e.vatPercent,"%"),vat:(0,V.Z)(e.vat),gross:(0,V.Z)(e.gross),rowData:e,action:""}}))}),(0,W.jsxs)(_s,{children:[(0,W.jsxs)(Ss,{children:[(0,W.jsx)("div",{children:"Net Total :"})," ",(0,W.jsx)("div",{children:(0,V.Z)(s)})]}),(0,W.jsxs)(Ss,{children:[(0,W.jsx)("div",{children:"VAT Total :"})," ",(0,W.jsx)("div",{children:(0,V.Z)(u)})]}),(0,W.jsxs)(Ss,{children:[(0,W.jsx)("div",{children:"Gross Total :"})," ",(0,W.jsx)("div",{children:(0,V.Z)(l)})]})]})]})},As=(0,se.Ry)().shape({description:(0,se.Z_)()}),Cs=n(56572);function Ds(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ks(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ds(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ds(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Rs=function(e){var t,n,r=e.job,i=e.showDetails,o=e.defaultValues,a=e.refetch,c=e.toggleShow,s=(0,Gn.x)(),l=(0,ae.cI)({resolver:(0,ce.S)(As),defaultValues:{description:null===o||void 0===o||null===(t=o.configs)||void 0===t?void 0:t.descriptionInvoice}}),p=l.control,f=l.errors,v=l.handleSubmit,b=l.register,h=(0,d.useState)(function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{items:[]};return null===t||void 0===t||null===(e=t.items)||void 0===e?void 0:e.map((function(e){return{unit:e.minutes,description:e.name,price:e.itemTotal,gross:e.itemTotalIncVAT,unitCost:e.rate,net:e.minutes*(e.rate||1),vat:e.rate*e.minutes*1.2-(e.rate*e.minutes||1),vatPercent:100*e.vatRate}}))}(o)),y=h[0],j=h[1],g=(0,m.D)(Lc),x=(0,u.Z)(g,1)[0],w=function(){var e=(0,D.Z)(R().mark((function e(t){var n,i,o,u,d,l,p,m,f,v,b,h,j,g,w,I,Z,O,S,_,P,A,C,D,k,q,E,T,$,N,J,H,U,M;return R().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,zc.F)(s,r.id,"customer");case 2:return n=e.sent,i=n.financeCustomer,o=i.adminId,u=i.addresses,d=i.paymentInfo,l=i.currencyInfo,p=i.invoiceInfo,m=i.rateInfo,f=m.pricing,v=m.calcWithServiceRate,b=i.amountInfo.vatRate,h=i.customerInfo,j=i.jobInfo,g=j.description,w=j.id,I=j.number,Z=j.type,O=j.paid,S=j.customerId,_=j.supplierId,P=j.jobDate,A=j.reference,e.next=7,(0,Cs.f)({client:s,adminId:r.adminId});case 7:return C=e.sent,D=C.invoiceNumber,k=C.accountMeta,q=k,e.next=13,us(y);case 13:E=e.sent,T="ProformaInvoiceCustomer",$=new Date,N=null===E||void 0===E?void 0:E.reduce((function(e,t){return e+t.itemTotalIncVAT}),0),J=y.reduce((function(e,t){return e+t.net}),0),H=y.reduce((function(e,t){return e+t.vat}),0),U={addresses:u,entity:"Job",adminId:o,entityId:r.id,invoiceType:T,invoiceNumber:"".concat(D),invoiceDate:$,items:E,amounts:{vatTotal:N,vatRate:b,vatPDF:H,total:J},configs:{currencyInfo:l,paymentInfo:d,descriptionInvoice:t.description,reference:A,referenceInvoice:"".concat((0,Qc.y)(r.type)).concat(r.number),jobInfo:{description:g,id:w,number:I,type:Z,paid:O,customerId:S,supplierId:_,jobDate:P,pricing:f,calcWithServiceRate:v},invoiceInfo:p,customerInfo:h}},M={entity:"Job",entityId:r.id,invoiceType:T,rebateAmount:null,vatTotal:N,adminId:o,expensesTotal:null,currencyId:l.currencyId,invoiceNumber:"".concat(D),invoiceDate:$,meta:{job:{id:w,number:I,type:Z,paid:O,accountId:S,customerId:S,supplierId:_,jobDate:P}}},x({variables:{invoice:[ks(ks({},U),{},{InvoiceAmount:{data:[ks({},M)]}})],account:q,accountId:o,updatePointer:!0}}).then((function(e){a(),c()}));case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),I={control:p,errors:f,register:b};return(0,W.jsxs)(de.Z,{id:"offCanvasForm",handleSubmit:v(w),children:["customerVat"!==(null===o||void 0===o?void 0:o.invoiceType)&&"supplier"!==(null===o||void 0===o?void 0:o.invoiceType)&&(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(Ps,{setInvoiceItems:j,invoiceItems:y,showDetails:i}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(Z.Z,{children:(0,W.jsx)(O.Z,{md:12,children:i?(0,W.jsx)(L.Z,{content:"Description",text:null===o||void 0===o||null===(n=o.configs)||void 0===n?void 0:n.descriptionInvoice}):(0,W.jsx)(fe.Z,{label:"Description",children:(0,W.jsx)(Mt.Z,ks(ks({},I),{},{name:"description",rows:2,disabled:i}))})})})]}),(0,W.jsx)(Ft.Z,{}),(null===o||void 0===o?void 0:o.id)&&(0,W.jsx)(ys,{currency:"GBP",job:r,refetch:a,invoiceId:o.id})]})},qs=n(81185),Es=n(84619),Ts=function(e){var t=e.job,n=e.loading,r=e.invoices,i=e.refetch,o=e.meta,a=(e.handleAddInvoice,(0,dn.x)().user),c=(0,Gn.x)().client,s=(0,d.useContext)(E.Z),u=r.filter((function(e){return"customerVat"===e.invoiceType||"ProformaInvoiceCustomer"===e.invoiceType})).reduce((function(e,t){return e+t.reconciledAmount.aggregate.sum.amount}),0),l=r.reduce((function(e,t){return e+t.amountPaid.aggregate.sum.amount}),0),p=r.reduce((function(e,t){return e+t.amountDeducted.aggregate.sum.amount}),0),m=[{text:"Number"},{text:"Type"},{formatter:function(e){var t=e.row;return(0,V.Z)(t.total)},text:"Total",hidden:!0},{formatter:function(e){var t=e.row;return"".concat(100*t.vatRate," %")},text:"VAT",hidden:!0},{formatter:function(e){var t=e.row;return(0,V.Z)(t.vatTotal)},text:"VAT total"},{text:"Date"},{hidden:!0},{formatter:wi.Z,formatterData:function(e){return[{context:"secondary",icon:["fas","download"],onClick:function(e,n){return function(e,n){e.stopPropagation();var r=n.rowData,i=r.invoiceType;"ProformaInvoiceCustomer"===i?(0,Es.u)({invoice:r}):(0,ar._)({adminId:a.accountId,type:i,job:t,invoice:r,client:c})}(e,n)},tooltip:"Download"},{context:"secondary",icon:["fas","plus"],onClick:function(e,n){return function(e,n){e.stopPropagation(),s.show({content:(0,W.jsx)(ps,{defaultValues:void 0,job:t,refetch:i,toggleShow:s.close,userId:a.id,invoiceId:n.id,invoice:n.rowData,totalReconciledAmount:u}),title:"Add Credit Note"})}(e,n)},tooltip:"Add Credit Note",disabled:"supplier"===e.type},{content:"Details",context:"secondary",icon:["fas","info-circle"],onClick:function(e,n){return r=n,void s.show({content:(0,W.jsx)(Rs,{job:t,showDetails:!0,defaultValues:r.rowData,refetch:i}),submit:!1,title:"Items Details"});var r},tooltip:"Details"}]},text:"Actions"}];return(0,W.jsxs)("div",{children:[(0,W.jsx)(L.Z,{content:"Amount paid to date",text:(0,V.Z)(l)}),(0,W.jsx)(L.Z,{content:"Amount to be deducted",text:(0,V.Z)(p)}),(0,W.jsx)(Ft.Z,{}),(0,W.jsx)(L.Z,{content:"Total Amount reconciled",text:(0,V.Z)(u)}),(0,W.jsx)(qs.t,{columns:m,loading:n,meta:o,refetch:i,rows:null===r||void 0===r?void 0:r.map((function(e){var t;return{id:e.id,type:e.invoiceType,total:(null===(t=e.amounts)||void 0===t?void 0:t.vatTotal)/(1+e.amounts.vatRate),vatRate:e.amounts.vatRate,vatTotal:e.amounts.vatTotal,date:(0,ge.Z)(e.createdAt),rowData:e,action:""}}))})]})},$s=function(e){var t=e.job,n=e.refetch,r=(0,d.useContext)(E.Z),i=(0,l.a)(Vc,{variables:{jobId:t.id}}),o=i.loading,a=i.data,c=(a=void 0===a?{invoices:[],meta:{aggregate:{totalCount:0}}}:a).invoices,s=a.meta,u=i.refetch,p=function(e){e.stopPropagation(),r.show({content:(0,W.jsx)(Rs,{job:t,refetch:u,toggleShow:r.close}),title:"Add a proforma invoice",width:"40%"})};return(0,W.jsxs)(H.Z,{fitParentHeight:!0,open:!0,title:"Invoices",toolbar:(0,W.jsx)(N.Z,{content:"Add",context:"secondary",onClick:p,size:"sm"}),children:[(0,W.jsx)(Ts,{job:t,loading:o,refetch:function(){u(),n()},invoices:c,meta:s,handleAddInvoice:p}),(0,W.jsx)(Cc.Z,{to:"/dashboard/customers/view?id=".concat(t.customer.id,"&tab=finance"),children:"Account Entries"})]})};function Ns(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Js(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ns(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ns(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Hs=function(e){var t,n,r,i,o,a,s,b,h,j=e.id,g=(0,Fc.q)(),D=(0,dn.x)(),k=D.hasRole,R=D.user,q=(0,l.a)(x.nh,{variables:{id:R.id}}).data,E=(q=void 0===q?{user:{}}:q).user;R=Js(Js({},R),E);var T=null===(t=g.admin.jobSetting)||void 0===t?void 0:t.jobNumberPrefix,$=null===(n=g.admin.jobSetting)||void 0===n?void 0:n.jobNumberSuffix,N=v.E6;k("supplier")?N=w:k("customer")&&(N=I);var J=(0,l.a)(N,{skip:!j,variables:{number:j,adminId:R.adminId}}),H=J.loading,U=J.data,M=(U=void 0===U?{job:null}:U).job,F=J.refetch,V=(0,p.t)(y.EY),L=(0,u.Z)(V,2),z=L[0],Q=L[1].data,B=(Q=void 0===Q?{users:[]}:Q).users;(0,d.useEffect)((function(){R.accountId&&z({variables:{adminId:R.accountId}})}),[R.accountId]);var Y=(0,m.D)(f.j6),G=(0,u.Z)(Y,1)[0],K=(0,m.D)(v.qD,{onCompleted:F}),X=(0,u.Z)(K,1)[0],ee=(0,m.D)(v.r2,{onCompleted:F}),te=(0,u.Z)(ee,1)[0],ne=(0,m.D)(v.k7,{onCompleted:F}),ie=(0,u.Z)(ne,1)[0];if(!j)return null;if(!H&&!M)return c.default.push("/404"),!1;var oe=M?Js({},M[0]):{},ae=oe&&k("admin")?(0,Qt.sT)(oe):null,ce=(0,P.WE)(null===oe||void 0===oe?void 0:oe.location,"registered"),se=null;se=(0,re.E)(oe,"validated")&&null!==(r=oe.meta)&&void 0!==r&&null!==(i=r.customerVATInvoice)&&void 0!==i&&null!==(o=i.invoiceInfo)&&void 0!==o&&o.invoiceToAddress?{address:Js({},oe.meta.customerVATInvoice.invoiceInfo.invoiceToAddress)}:(0,P.Hv)(oe,"customer");var ue=function(e){var t=e.adminUsers,n=e.userId,r=e.accountType;return t.map((function(e){return{id:e.id,name:e.fullName,email:e.email,phone:e.phone,accountType:r}})).filter((function(e,t,r){return r.findIndex((function(t){return t.id===e.id}))===t&&e.id!==n}))}({adminUsers:B,userId:R.id,accountType:R.accountType});return!H&&(0,W.jsxs)(Z.Z,{children:[(0,W.jsx)(O.Z,{md:8,children:(0,W.jsxs)(Z.Z,{children:[(0,W.jsxs)(O.Z,{md:4,children:[oe.customer&&k(["admin","customer"])&&(0,W.jsx)(ia.g,{avatar:(0,ra.Q)(null===(a=oe.customerUser)||void 0===a?void 0:a.media),editable:k("admin"),entity:{id:oe.customer.id,name:oe.customer.name,website:oe.customer.website},entityName:"Account",icons:ae,job:oe,linkTitleTo:"/dashboard/customers/view?id=".concat(oe.customer.id),log:{entityId:oe.id,entityName:"Job"},numberPrefix:T,numberSuffix:$}),k(["admin","supplier"])&&(0,re.E)(oe,["accepted","quoteAccepted"])&&(0,W.jsx)(fa,{job:oe,refetch:F}),(0,W.jsx)($t.p,{job:oe,numberPrefix:T,numberSuffix:$,refetch:F,showOrder:!1,updateJob:X,user:R}),(0,W.jsx)(Tt.I,{job:oe,show:k(["admin"])}),(0,W.jsx)(Ae.G,{details:!0,entity:"Job",entityId:oe.id,onMediaAdd:function(){return F()},onMediaRemove:function(){return F()}}),oe.asset&&(null===(s=oe.asset.parentId)||void 0===s?void 0:s.media[0])&&(0,W.jsx)(C.f,{asset:oe.asset,edit:!1}),oe.asset&&(0,W.jsx)(A.B,{asset:oe.asset,edit:!1,title:"Asset Details"}),ce&&(0,W.jsx)(_.f,{access:oe.access,address:ce.address,edit:k(["admin","customer"]),entity:"Location",entityId:oe.location.id,id:ce.id,name:null===(b=oe.location)||void 0===b?void 0:b.name,showMap:!0,showLink:k(["admin","customer"]),title:"Address",type:"registered"}),k(["admin","customer"])&&se&&(0,W.jsx)(_.f,{address:se.address,edit:!(0,re.E)(oe,"validated"),entity:"Location",entityId:oe.location.id,id:se.id,refetch:F,title:"Invoice Address",type:"invoice"}),(0,W.jsx)(He.j,{edit:k(["admin"])&&!(0,re.E)(oe,"validated"),job:oe,refetch:F},"workDescription-".concat(oe.id)),(k(["admin"])||k(["customer"]))&&(0,W.jsx)(Mc,{job:oe,refetch:F,updateJob:X,numberPrefix:T,numberSuffix:$},"related-".concat(oe.id))]}),(0,W.jsxs)(O.Z,{md:4,children:[(0,W.jsx)($o,{addJobTiming:te,addQuotation:G,deleteJobTiming:ie,hasRole:k,job:oe,refetch:F,updateJob:X,user:R}),oe.supplier?(0,W.jsxs)(W.Fragment,{children:[k(["admin"])&&(0,W.jsx)(No.U,{job:oe},"supplier-".concat(oe.id)),k(["admin","customer"])&&(0,W.jsx)(ta,{job:oe}),k(["admin","supplier"])&&(0,re.E)(oe,"inProgress")&&!(0,re.E)(oe,"reportSentSupplier")&&(0,W.jsx)(pn,{job:oe,user:R,refetch:F})]}):(null===oe||void 0===oe||null===(h=oe.supplierOffers)||void 0===h?void 0:h.length)>0&&!(0,re.E)(oe,"rejected")&&k(["admin"])&&(0,W.jsx)(sa,{job:oe,refetch:F,user:R}),(0,re.E)(oe,"quoteNew")&&k("admin")&&(0,W.jsx)(Jn,{job:oe,quotes:oe.quotations,refetch:F})]}),(0,W.jsxs)(O.Z,{md:4,children:["quote"!==oe.type&&(0,W.jsx)(Ct,{hasRole:k,job:oe,refetch:F,user:R}),(0,re.E)(oe,"quoteNew")&&(0,W.jsx)(qn,{job:oe,refetch:F}),k("admin")&&"quote"!==oe.type&&(0,W.jsx)($s,{job:oe,refetch:F})]})]})}),(0,W.jsxs)(O.Z,{md:4,children:[k(["admin"])&&(0,W.jsx)(Ac.B,{filters:{entity:"Job",entityId:oe.id,status:"open"},view:"compact",onSuccess:F}),(0,W.jsx)(S.Z,{}),!(k("supplier")&&"offered"===oe.status)&&(0,W.jsx)(Pc,{id:parseInt(oe.id),mentions:ue,scope:"job"})]})]})};function Us(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ms(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Us(Object(n),!0).forEach((function(t){(0,a.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Us(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Fs=function(){var e=(0,c.useRouter)().query;return(0,W.jsx)(s.Z,{View:(0,W.jsx)(Hs,Ms({},e))})}},13115:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard/issues/view",function(){return n(84116)}])}},function(e){e.O(0,[9774,367,284,4195,5312,7287,2002,3086,7134,3486,9082,3515,4712,1265,6996,9666,4177,5597,8158,7615,4829,999,7139,6561,3039,899,3016,1110,9547,8606,2888,179],(function(){return t=13115,e(e.s=t);var t}));var t=e.O();_N_E=t}]);