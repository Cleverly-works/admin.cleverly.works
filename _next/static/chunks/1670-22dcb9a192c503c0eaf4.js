"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1670,26],{53197:function(e,n,t){t.d(n,{kJ:function(){return m},UB:function(){return p},rM:function(){return v},Ve:function(){return f},Wn:function(){return b},bD:function(){return y},G5:function(){return h}});var r,o,i,a,c,s,d,u=t(52209),l=t(54397),m=(0,l.Ps)(r||(r=(0,u.Z)(['\n  query GetCustomers(\n    $assignedUser: Int\n    $date: timestamptz\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: Account_order_by!\n    $status: String\n  ) {\n    customers: Account(\n      limit: $limit\n      offset: $offset\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $assignedUser }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      createdAt\n      name\n      companyNumber\n      vatId\n      website\n      status\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      locations: Account_Locations {\n        id\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n    }\n    meta: Account_aggregate(\n      where: {\n        type: { _eq: "customer" }\n        createdAt: { _eq: $date }\n        managerId: { _eq: $assignedUser }\n        name: { _ilike: $q }\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),p=(0,l.Ps)(o||(o=(0,u.Z)(['\n  query GetCustomer($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      clientType: ClientType {\n        id\n        name\n      }\n      structure\n      companyNumber\n      vatId\n      website\n      status\n      createdAt\n      updatedAt\n      status\n      type\n      meta\n      usersMeta: Account_Users_aggregate {\n        aggregate {\n          count\n        }\n      }\n      propertiesMeta: Account_Locations_aggregate {\n        aggregate {\n          count\n        }\n      }\n      jobsMeta: CustomerJobs_aggregate {\n        aggregate {\n          count\n        }\n      }\n      addresses: Addresses(where: { entity: { _eq: "Account" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      manager: Manager {\n        id\n        nameFirst\n        nameLast\n        phone\n        email\n      }\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        role\n        position\n        isContact\n        lastSignInAt\n        userId\n        user: User {\n          id\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n          email\n          createdAt\n          fullName\n          accounts: Account_Users {\n            id\n            role\n            position\n            isContact\n            status\n            account: Account {\n              id\n              name\n              type\n            }\n          }\n        }\n      }\n      bankAccounts: BankAccounts {\n        id\n        stripeId\n        accountNumber\n        routingNumber\n        bic\n        iban\n        status\n        default\n        createdAt\n      }\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      cards: Cards {\n        id\n        stripeId\n        type\n        last4\n        expYear\n        expMonth\n        status\n        default\n        createdAt\n      }\n      jobs: CustomerJobs {\n        id\n        title\n      }\n      finance: Financial {\n        id\n        invoicing\n        serviceRate\n        stripeId\n        totalRevenue\n        unpaidInvoices\n        creditLimit\n        creditRating\n        createdAt\n        amountOutstanding\n        accountId\n        approvalThreshold\n        arrangementFee\n        spendThreshold\n        defaultPaymentMethod\n      }\n      accountEntries: AccountEntries(order_by: { createdAt: asc }) {\n        id\n        outstandingAmount\n        type\n        entryId\n        currencyId\n        createdAt\n        balance\n        amount\n        accountId\n        updatedAt\n      }\n    }\n  }\n']))),v=(0,l.Ps)(i||(i=(0,u.Z)(["\n  query GetCustomerManage($id: Int!) {\n    customer: Account_by_pk(id: $id) {\n      id\n      name\n      website\n      companyNumber\n      vatId\n      contactUsers: Account_Users(where: { isContact: { _eq: true } }) {\n        id\n        isContact\n        userId\n        user: User {\n          id\n          email\n          fullName\n          meta\n          name: nameFirst\n          nameFirst\n          nameLast\n          phone\n          status\n        }\n      }\n      clientType: ClientType {\n        id\n        label: name\n        value: id\n      }\n      status\n      managerSelected: Manager {\n        id\n        label: fullName\n        value: id\n      }\n    }\n  }\n"]))),f=(0,l.Ps)(a||(a=(0,u.Z)(["\n  mutation AddCustomer($objects: [Account_insert_input!]!) {\n    insert_Account(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),b=(0,l.Ps)(c||(c=(0,u.Z)(["\n  mutation UpdateCustomer(\n    $customerId: Int!\n    $customer: Account_set_input\n    $userId: Int!\n    $user: User_set_input\n    $hasUpdateUser: Boolean!\n  ) {\n    update_Account_by_pk(pk_columns: { id: $customerId }, _set: $customer) {\n      id\n    }\n    update_User_by_pk(pk_columns: { id: $userId }, _set: $user) @include(if: $hasUpdateUser) {\n      id\n    }\n  }\n"]))),y=(0,l.Ps)(s||(s=(0,u.Z)(["\n  mutation AddFinancial($objects: [Financial_insert_input!]!) {\n    insert_Financial(objects: $objects) {\n      returning {\n        id\n        accountId\n        locationId\n      }\n    }\n  }\n"]))),h=(0,l.Ps)(d||(d=(0,u.Z)(['\n  query GetFinancialJob(\n    $adminId: Int\n    $customerId: Int\n    $endDate: timestamptz\n    $startDate: timestamptz\n    $limit: Int\n    $number: String\n    $status: [String]\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $supplierId: Int\n    $q: String\n    $orderBy: job_financial_order_by!\n  ) {\n    jobs: getDashboard_Job_Financial(\n      limit: $limit\n      offset: $offset\n      args: {\n        adminId: $adminId\n        managerId: $managerId\n        customerId: $customerId\n        locationId: $locationId\n        supplierId: $supplierId\n        startTime: $startDate\n        endTime: $endDate\n      }\n      where: {\n        Job: {\n          type: { _eq: "reactive" }\n          _or: [\n            { description: { _ilike: $q } }\n            { reference: { _ilike: $q } }\n            { number: { _ilike: $q } }\n          ]\n          _and: [{ status: { _in: $status }, number: { _eq: $number } }]\n        }\n      }\n      order_by: [$orderBy]\n    ) {\n      customerName: customer_name\n      customerId: customer_id\n      expensesAmountCustomer: job_expenses_customer\n      expensesAmountSupplier: job_expenses_supplier\n      invoiceDate: job_date\n      invoiceNumber: job_invoicenumber\n      jobId: job_id\n      jobStatus: job_status\n      jobTotal: customer_amount\n      jobType: job_type\n      jobNumber: job_number\n      payDate: pay_date\n      priorityId: sla_id\n      revenue: job_revenue\n      service: service_name\n      serviceLine: service_name\n      serviceName: service_name\n      supplierAmount: supplier_amount\n      supplierId: supplier_id\n      supplierName: supplier_name\n      job: Job {\n        description\n        location: Location {\n          name\n        }\n        sla: SLA {\n          name\n        }\n        manager: Manager {\n          fullName\n          nameLast\n          nameFirst\n          id\n        }\n      }\n      scheduledat\n      timingStart\n      status\n      createdAt\n    }\n    meta: getDashboard_Job_Financial_aggregate(\n      args: {\n        adminId: $adminId\n        managerId: $managerId\n        customerId: $customerId\n        locationId: $locationId\n        supplierId: $supplierId\n        startTime: $startDate\n        endTime: $endDate\n      }\n      where: {\n        Job: {\n          type: { _eq: "reactive" }\n          _or: [\n            { description: { _ilike: $q } }\n            { reference: { _ilike: $q } }\n            { number: { _ilike: $q } }\n          ]\n          _and: [{ status: { _in: $status }, number: { _eq: $number } }]\n        }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n'])))},380:function(e,n,t){t.d(n,{K:function(){return r}});var r=function(e){return 1}},26:function(e,n,t){t.d(n,{V:function(){return H}});var r=t(80318),o=t(30266),i=t(92809),a=t(10219),c=t(64687),s=t.n(c),d=t(67294),u=t(45697),l=t(93633),m=t(75709),p=t(71742),v=t(11163),f=t(42283),b=t(79665),y=t(80880),h=t(97202),g=t(11570),j=t(78215),x=t(2356),I=t(65375),O=t(71247),_=t(83528),Z=t(46482),S=t(47385),w=t(95146),$=t(85893);function P(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function D(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?P(Object(t),!0).forEach((function(n){(0,i.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):P(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var q=function(e){var n=e.accountId,t=e.accountName,r=e.canSelectAccount,o=e.control,i=e.errors,a=e.setValue,c=e.watch,s=n?{value:n,label:t}:c("propertyOwner"),u=(0,S.Z)(s);(0,d.useEffect)((function(){s!==u&&u&&a("contactUser",null)}),[s]);var l={control:o,errors:i};return(0,$.jsxs)(j.Z,{children:[(0,$.jsx)(x.Z,{md:6,children:(0,$.jsx)(w.P,D(D({},l),{},{defaultValue:n&&{value:n,label:t},errors:D({},i),isDisabled:!r,label:"Client",name:"propertyOwner",placeholder:"Select",type:"customer"}))}),(0,$.jsx)(x.Z,{md:6,children:(0,$.jsx)(w.P,D(D({},l),{},{accountId:(null===s||void 0===s?void 0:s.value)||null,errors:D({},i),isDisabled:!s,label:"Contact Name",name:"contactUser",placeholder:s?"Select":"Select the location owner",type:"user"}))})]})},A=t(34112),R=function(e){return e?(location.propertyOwner={label:e.customer[0].account.name,value:e.customer[0].account.id},location.contactUser=(null===e||void 0===e?void 0:e.user)&&e.customer[0].account.id&&{label:e.user.fullName,value:e.user.id},location.access=e.access,location.name=e.name,location.status=e.status,location):{}},C=function(e,n){var t=e.propertyOwner,r=e.contactUser;return e.Account_Locations={data:{accountId:t.value}},delete e.propertyOwner,e.contactUserId=(null===r||void 0===r?void 0:r.value)||null,delete e.contactUser,n&&delete e.Account_Locations,e},k=function(e,n){return n({variables:{objects:[C(e)]}})},N=t(19501),L=function(e){return(0,N.Ry)().shape({access:(0,N.Z_)().required(),contactUser:(0,N.Ry)().required(),name:(0,N.Z_)().required(),propertyOwner:(0,N.Ry)().required(),status:e("admin")&&(0,N.Z_)().required()})},T=t(47337),E=t(75838),F=t(1323),U=["accountId","accountName","entity","data","refetch","onAddressCreated","isPropsComponent","initialValues"];function J(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function M(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?J(Object(t),!0).forEach((function(n){(0,i.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):J(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var z="/dashboard/properties/",H=function(e){var n=e.accountId,t=e.accountName,i=e.entity,c=e.data,u=e.refetch,S=e.onAddressCreated,w=e.isPropsComponent,P=e.initialValues,D=((0,a.Z)(e,U),(0,d.useContext)(y.Z)),N=(0,F.x)().hasRole,J=(0,d.useState)(!1),H=J[0],B=J[1],V=(0,f.cI)({defaultValues:M(M({},R(c)),P),resolver:(0,b.S)(L(N))}),Q=V.control,G=V.errors,W=V.handleSubmit,X=V.register,Y=V.setValue,K=V.getValues,ee=V.watch,ne=(0,l.a)(p.yf,{variables:{id:null===c||void 0===c?void 0:c.id},skip:!(null!==c&&void 0!==c&&c.id)}).data,te=(ne=void 0===ne?{property:{}}:ne).property,re=function(){var e=(0,o.Z)(s().mark((function e(n){var t,r,o,a,c,d,u;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={Addresses:{data:{Address:{data:M({},n)},entity:i}}},r=M(M({},K()),t),N("customer")&&(r.status="active"),e.next=5,k(r,ce);case 5:o=e.sent,a=o.data,c=(a=void 0===a?{}:a).insert_Location,d=(c=void 0===c?{}:c).returning,u=void 0===d?{}:d,S&&S(u),D.close(),D.close();case 14:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),oe=function(){var e=(0,o.Z)(s().mark((function e(n){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:D.show({title:"Add new address",content:(0,$.jsx)(T.k,{onCancel:console.log,onSubmit:re,type:"text"}),submit:!1});case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),ie=(0,m.D)(p.A1,{onCompleted:function(e){if(!w){var n=e.insert_Location.returning[0].id;D.close(),u?u():v.default.push("".concat(z,"view?id=").concat(n))}}}),ae=(0,r.Z)(ie,2),ce=ae[0],se=ae[1].loading,de=(0,m.D)(p.$A,{onCompleted:function(e){var n=e.update_Location_by_pk.id;D.close(),u?u():v.default.push("".concat(z,"view?id=").concat(n))}}),ue=(0,r.Z)(de,2),le=ue[0],me=ue[1].loading,pe={control:Q,errors:G,register:X};return(0,$.jsxs)(h.Z,{disabled:se||me,id:"offCanvasForm",handleSubmit:W((function(e){if(B(!1),c){var n,t,r;if("inactive"===e.status&&!te.jobs.every((function(e){return!!(0,A.E)(e,["completed","closed"])})))return void B(!0);!function(e,n,t,r){r({variables:{location:C(e,!0),locationId:n.locationId,accountId:n.accountId,newAccountId:n.newAccountId,hasChanged:n.hasChanged}})}(e,{locationId:null===c||void 0===c?void 0:c.id,accountId:null===c||void 0===c||null===(n=c.customer[0])||void 0===n?void 0:n.account.id,newAccountId:null===e||void 0===e||null===(t=e.propertyOwner)||void 0===t?void 0:t.value,hasChanged:!((null===c||void 0===c||null===(r=c.customer[0])||void 0===r?void 0:r.account.id)===(null===e||void 0===e?void 0:e.propertyOwner.value))},c.id,le)}else oe()})),children:[H&&(0,$.jsx)(g.Z,{context:"info",content:" This location cannot be made inactive, it has active jobs."}),(0,$.jsx)(j.Z,{children:(0,$.jsx)(x.Z,{md:12,children:(0,$.jsx)(q,M(M({},pe),{},{accountId:n,accountName:t,canSelectAccount:!n,setValue:Y,watch:ee}))})}),(0,$.jsx)(I.Z,{label:"Name",children:(0,$.jsx)(O.Z,M(M({},pe),{},{name:"name"}))}),(0,$.jsx)(I.Z,{label:"Access information",children:(0,$.jsx)(_.Z,M(M({},pe),{},{name:"access",rows:4}))}),N("admin")&&(0,$.jsx)(I.Z,{label:"Status",children:(0,$.jsx)(Z.Z,M(M({},pe),{},{name:"status",options:E.bg}))})]})};q.propTypes={accountId:u.number,accountName:u.string,data:u.object,refetch:u.func,offCanvas:u.func}},71742:function(e,n,t){t.d(n,{Un:function(){return m},A1:function(){return p},$A:function(){return v},zg:function(){return f},yf:function(){return b}});var r,o,i,a,c,s,d,u=t(52209),l=t(54397),m=((0,l.Ps)(r||(r=(0,u.Z)(["\n  query GetProperty($id: Int!) {\n    location: Location_by_pk(id: $id) {\n      id\n      contactUserId\n      name\n      access\n      contactUser: User {\n        id\n        nameFirst\n        nameLast\n      }\n      propertyOwner: Account_Locations {\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"]))),(0,l.Ps)(o||(o=(0,u.Z)(['\n  query GetMapProperties {\n    properties: Location {\n      id\n      access\n      createdAt\n      name\n      contactUserId\n      addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      bookings: Jobs {\n        id\n        title\n        createdAt\n        customerId\n        amount\n        locationId\n        managerId\n        quoteNumber\n        reference\n        status\n        serviceId\n        meta\n        customer: Customer {\n          id\n          name\n        }\n        location: Location {\n          id\n          name\n          addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n            id\n            registered\n            operating\n            trading\n            invoice\n            status\n            createdAt\n            address: Address {\n              id\n              name\n              addressLine1\n              addressLine2\n              addressLine3\n              city\n              county\n              geo\n              postCode\n              country: Country {\n                id\n                name\n              }\n            }\n          }\n        }\n        manager: Manager {\n          id\n          nameFirst\n          nameLast\n        }\n        sla: SLA {\n          id\n          name\n          notes\n        }\n        supplier: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n          media: Media {\n            id\n            medium: Medium {\n              id\n              category\n              filename\n              meta\n              type\n            }\n          }\n          manager: Manager {\n            id\n            fullName\n          }\n        }\n        supplierOffers: SupplierOffers {\n          status\n          rate\n          supplier: Supplier {\n            id\n            companyNumber\n            createdAt\n            name\n            status\n            type\n            updatedAt\n            website\n            clientType\n            managerId\n            vatId\n            meta\n            media: Media {\n              id\n              medium: Medium {\n                id\n                category\n                filename\n                meta\n                type\n              }\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n          }\n        }\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n'])))),p=(0,l.Ps)(i||(i=(0,u.Z)(["\n  mutation AddLocation($objects: [Location_insert_input!]!) {\n    insert_Location(objects: $objects) {\n      returning {\n        id\n        name\n      }\n    }\n  }\n"]))),v=(0,l.Ps)(a||(a=(0,u.Z)(["\n  mutation UpdateAccountLocation(\n    $location: Location_set_input\n    $locationId: Int!\n    $accountId: Int!\n    $newAccountId: Int!\n    $hasChanged: Boolean!\n  ) {\n    update_Account_Location(\n      where: { Account: { id: { _eq: $accountId } }, id: { _eq: $locationId } }\n      _set: { accountId: $newAccountId }\n    ) @include(if: $hasChanged) {\n      returning {\n        id\n      }\n    }\n    update_Location_by_pk(pk_columns: { id: $locationId }, _set: $location) {\n      id\n    }\n  }\n"]))),f=(0,l.Ps)(c||(c=(0,u.Z)(["\n  mutation UpdateLocation($id: Int!, $changes: Location_set_input) {\n    update_Location_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),b=((0,l.Ps)(s||(s=(0,u.Z)(["\n  query GetAccountName($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n    }\n  }\n"]))),(0,l.Ps)(d||(d=(0,u.Z)(["\n  query GetPropertiesJob($id: Int!) {\n    property: Location_by_pk(id: $id) {\n      id\n      jobs: Jobs {\n        id\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n"]))))},85997:function(e,n,t){t.d(n,{Lq:function(){return u},yG:function(){return l},Io:function(){return m}});var r=t(92809),o=t(83789),i=t(73165),a=t(18862),c=t(6608);function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function d(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var u=function(e,n){var t=e.itemType,r=e.paymentStatus;return"paymentReceipt"===t?n.COLOUR.black:"creditNote"===t?n.COLOUR.dark:"paid"===r?n.COLOUR.success:"partial"===r?n.COLOUR.female:n.COLOUR.danger},l=function(e,n){var t=n||{},r=t.numberPrefix,o=void 0===r?"":r,s=t.numberSuffix,d=void 0===s?"":s;return e.map((function(e){var n,t,r,s,u,l,m,p,v,f,b,y,h,g,j,x,I=(null===e||void 0===e||null===(n=e.invoice)||void 0===n||null===(t=n.reconciledAmounts)||void 0===t||null===(r=t.aggregate)||void 0===r||null===(s=r.sum)||void 0===s?void 0:s.amount)||null;return{itemType:(0,i.Z)(e.type),invoice:"Location"===e.entity?"PM / ".concat((null===e||void 0===e?void 0:e.meta.invoiceNumber)||""):null!==e&&void 0!==e&&null!==(u=e.job)&&void 0!==u&&u.number?"".concat((0,c.y)((null===e||void 0===e||null===(l=e.job)||void 0===l?void 0:l.type)||null)," ").concat(o," ").concat(null===e||void 0===e||null===(m=e.job)||void 0===m?void 0:m.number," ").concat(d," / ").concat(null===e||void 0===e||null===(p=e.invoice)||void 0===p?void 0:p.id):null,reference:(null===e||void 0===e||null===(v=e.job)||void 0===v?void 0:v.reference)||(null===(f=e.meta)||void 0===f?void 0:f.paymentReference),date:(0,a.Z)(e.createdAt),daysOutstanding:null===e||void 0===e?void 0:e.outstandingdays,status:null===e||void 0===e||null===(b=e.job)||void 0===b?void 0:b.status,service:null===e||void 0===e||null===(y=e.job)||void 0===y||null===(h=y.service)||void 0===h?void 0:h.name,address:null===e||void 0===e||null===(g=e.job)||void 0===g||null===(j=g.location)||void 0===j?void 0:j.name,debit:e.debit,credit:e.credit,reconciledAmount:null!==I&&void 0!==I?I:0,amountOutstanding:"invoice"===e.type?e.debit-I:null,paymentStatus:"-",comment:null===(x=e.meta)||void 0===x?void 0:x.comment}}))},m=function(e){var n=e.accountId,t=e.from,r=void 0===t?null:t,i=e.jobNumber,a=e.locationId,c=e.outstandingLevel,s=e.paymentStatus,u=e.to,l=void 0===u?null:u,m=e.type,p={_or:[{Invoice:{invoiceType:{_neq:"supplier"}}},{type:{_in:["paymentReceipt","creditNote"]}}]},v={},f=[],b=[],y=[];return a&&(f=[{_and:[{Invoice:{entity:{_eq:"Location"},entityId:{_eq:a}}}]},{_and:[{Invoice:{Job:{Location:{id:{_eq:a}}}}}]}]),m&&(p.type={_in:[].concat((0,o.Z)(m),["invoice"])}),s&&(p.paymentStatus={_in:(0,o.Z)(s)}),n&&(p.accountId={_eq:n}),c&&(p.outstandingdays={_gte:c.split("-")[0]||null,_lte:c.split("-")[1]||null}),(l||r)&&(y=[{_and:[{_or:[{_and:[{createdAt:{_gte:r}},{createdAt:{_lte:l}}]}]}]}]),i&&(b=[{_and:[{_or:[{_and:[{Invoice:{id:{_eq:i}}}]},{_and:[{Job:{number:{_ilike:i}}}]}]}]}]),(f.length>0||b.length>0||y.length>0)&&(v={_and:[].concat((0,o.Z)(f),(0,o.Z)(b),(0,o.Z)(y))}),d(d({},p),v)}},22384:function(e,n,t){t.d(n,{r:function(){return r}});var r=[{text:"All outstanding invoices",value:""},{text:"1 - 30",value:"1-30"},{text:"31 - 60",value:"31-60"},{text:"61 - 90",value:"61-90"},{text:"> 90",value:"90-"}]},47763:function(e,n,t){t.d(n,{b:function(){return Ye}});var r=t(67294),o=t(93633),i=t(38094),a=t(80880),c=t(80285),s=t(58448),d=t(14347),u=t(78215),l=t(2356),m=t(80284),p=t(52002),v=t(47400),f=t(24237),b=t(93443),y=t(77417),h=t(7720),g=t(66805),j=t(50899),x=t(30266),I=t(80318),O=t(92809),_=t(64687),Z=t.n(_),S=t(75709),w=t(53197),$=t(42283),P=t(97202),D=t(34868),q=t(65375),A=t(71247),R=t(85893);function C(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function k(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?C(Object(t),!0).forEach((function(n){(0,O.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):C(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var N=function(e){var n=e.accountId,t=e.meta,r=e.refetch,o=e.toggleShow,i=k({},null===t||void 0===t?void 0:t.finance)||{},a=(0,$.cI)({defaultValues:{creditLimit:i.creditLimit||0,creditRating:i.creditRating||0}}),c=a.errors,s=a.handleSubmit,d=a.register,u=(0,S.D)(w.Wn),l=(0,I.Z)(u,1)[0],m=function(){var e=(0,x.Z)(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l({variables:{customerId:n,customer:p(t)}}).then((function(){r(),o()}));case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),p=function(e){var n={};return n.meta=k({},t)||{},n.meta.finance=i||{},n.meta.finance.creditLimit=Number(e.creditLimit),n.meta.finance.creditRating=Number(e.creditRating),n},v={errors:c,register:d};return(0,R.jsxs)(P.Z,{id:"offCanvasForm",handleSubmit:s(m),children:[(0,R.jsx)(D.Z,k(k({},v),{},{name:"creditLimit",label:"Credit Limit"})),(0,R.jsx)(q.Z,{label:"Credit Rating",children:(0,R.jsx)(A.Z,k(k({},v),{},{name:"creditRating",type:"number"}))})]})},L=function(e){var n=e.percent,t=e.breakPoints;return(!t||t.length<2)&&(t=[70,90]),n<=t[0]?"success":n<=t[1]?"warning":"danger"},T=t(26496),E=function(e){var n,t,r=e.accountId,o=e.edit,i=e.meta,a=e.offCanvas,s=e.customerBalance,d=e.refetch,u=(null===i||void 0===i?void 0:i.finance)||{};t=s>=0||null===u||void 0===u||!u.creditLimit?0:-1*(0,T.l)(s/(null===u||void 0===u?void 0:u.creditLimit)*100,0);return(0,R.jsxs)(j.G,{carousel:!1,details:!0,entity:"CreditReport",entityId:null===u||void 0===u?void 0:u.id,summary:"Credit Report",children:[(0,R.jsx)(b.Z,{content:"Balance",text:(0,c.Z)(null!==s&&void 0!==s?s:0)}),(0,R.jsx)(b.Z,{content:"Credit Limit",text:(0,R.jsxs)(R.Fragment,{children:["".concat((0,c.Z)(null!==(n=null===u||void 0===u?void 0:u.creditLimit)&&void 0!==n?n:0)," "),(0,R.jsx)(F,{size:"sm",content:"".concat(t,"%"),context:L({percent:t})})]})}),(0,R.jsx)(b.Z,{content:"Credit Rating",text:(null===u||void 0===u?void 0:u.creditRating)||0}),o&&(0,R.jsx)(g.H,{content:"Edit",handleClick:function(){a.show({title:"Edit Credit Details",content:(0,R.jsx)(N,{accountId:r,meta:i,refetch:d,toggleShow:a.close})})}}),(0,R.jsx)(y.Z,{size:"sm"})]})};E.defaultProps={edit:!0};var F=(0,f.ZP)(h.Z).withConfig({displayName:"creditReport__StyledBadge",componentId:"sc-1lef73r-0"})(["margin-bottom:0;"]),U=t(11163),J=t(26075),M=t(38460),z=t(84774),H=t(57460),B=t.n(H),V=t(55657),Q=t(18944),G=t(91126),W=t(18862),X=t(22796),Y=t(46482),K=t(11570),ee=t(65570),ne=function(e){var n=e.data,t=e.refetch,r=e.toggleShow,a=e.numberPrefix,s=e.numberSuffix,d=(0,S.D)(i.zn),u=(0,I.Z)(d,1)[0],l=(0,o.a)(i.to,{variables:{invoiceIds:n.invoices,accountEntryId:n.id}}).data,v=(l=void 0===l?{reconciliations:[]}:l).reconciliations,f=[{hidden:!0},{text:"Number",formatter:function(e){var n=e.row;return(0,R.jsx)(ee.D,{id:n.id,number:n.number,invoiceNumber:n.invoiceNumber,numberPrefix:a,numberSuffix:s,openCanvas:!0,type:n.jobType})}},{hidden:!0},{hidden:!0},{text:"Date"},{text:"Reconciled Amount"},{hidden:!0}];return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsxs)(m.Z,{open:!0,title:"Details",children:[(0,R.jsx)(b.Z,{content:"Date",text:n.date}),(0,R.jsx)(b.Z,{content:"Type",text:n.itemType}),n.reference&&(0,R.jsx)(b.Z,{content:"Reference",text:n.reference}),n.comment&&(0,R.jsx)(b.Z,{content:"Comment",text:n.comment}),(0,R.jsx)(b.Z,{content:"Debit",text:(0,c.Z)(n.debit)}),(0,R.jsx)(b.Z,{content:"Credit",text:(0,c.Z)(n.credit)})]}),["paymentReceipt","creditNote"].includes(n.itemType)&&(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(X.Z,{}),(0,R.jsx)(m.Z,{open:!0,title:"Related Jobs",children:(0,R.jsx)(p.Z,{columns:f,rows:v.map((function(e){var n,t,r,o,i,a,s,d;return{id:null===(n=e.invoice)||void 0===n||null===(t=n.job)||void 0===t?void 0:t.id,number:null===(r=e.invoice)||void 0===r||null===(o=r.job)||void 0===o?void 0:o.number,invoiceNumber:null===(i=e.invoice)||void 0===i?void 0:i.id,entity:null===(a=e.accountEntry)||void 0===a?void 0:a.entity,date:(0,W.Z)(e.createdAt),reconciledAmount:(0,c.Z)(e.amount),jobType:null===(s=e.invoice)||void 0===s||null===(d=s.job)||void 0===d?void 0:d.type}}))})}),(0,R.jsx)(g.H,{content:"Delete",context:"danger",handleClick:function(){u({variables:{paymentId:n.id,jobIds:n.jobIds}}).then((function(){t(),r()}))}}),v.length>0&&(0,R.jsx)(K.Z,{content:"Deleting this receipt will potentially remove other reconciled entries.",context:"info"})]})]})};ne.defaultProps={numberPrefix:"",numberSuffix:""};var te=t(81185),re=t(76800),oe=t(55863),ie=function(){var e=(0,x.Z)(Z().mark((function e(n){var t,r,o,i,a,c,s,d,u,l,m;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.adminId,r=n.accountId,o=n.locationId,i=n.from,a=n.invoiceNumber,c=n.jobId,s=n.outstandingLevel,d=n.to,u=n.type,e.next=3,{adminId:t,accountId:r,currency:"\xa3",locationId:o,from:i,invoiceNumber:a,jobId:c,outstandingLevel:s,to:d,type:u};case 3:return l=e.sent,m=window.open("/download","_blank"),e.next=7,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/statement/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(l)}).then((function(e){return e.json()})).then((function(e){m.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,oe.Tb)({message:e,section:"fetch"})}));case 7:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),ae=t(78606),ce=t(84619),se=t(13886),de=t(75472),ue=t.n(de),le=t(79665),me=t(43566),pe=t(83528),ve=t(34610),fe=t(380),be=t(12517),ye=t(7145),he=t(19501),ge=(0,he.Ry)().shape({dateReceived:(0,he.hT)().required(),amountReceived:(0,he.Rx)().required(),reason:(0,he.Z_)(),connectedAmount:(0,he.IX)().of((0,he.Ry)().shape({jobId:(0,he.Rx)().required(),entityId:(0,he.Rx)().required(),outstandingAmount:(0,he.Rx)().required(),amount:(0,he.Rx)().max((0,he.iH)("outstandingAmount")).min(0).required(),isPPM:(0,he.O7)().required()})).required()}),je=t(85997);function xe(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Ie(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?xe(Object(t),!0).forEach((function(n){(0,O.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):xe(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var Oe=function(e){var n=e.accountId,t=e.adminId,m=e.jobId,v=e.refetch,f=e.toggleShow,b=(0,r.useContext)(me.Z).user,y=(0,r.useContext)(a.Z),g=(0,r.useState)({item:"date",order:"asc"}),j=g[0],O=g[1],_=(0,r.useState)(!1),w=_[0],C=_[1],k=(0,r.useState)(0),N=k[0],L=k[1],T=(0,r.useState)(),E=T[0],F=T[1],U=(0,$.cI)({resolver:(0,le.S)(ge)}),J=U.control,M=U.errors,z=U.getValues,H=U.handleSubmit,B=U.register,Q=U.setValue;(0,$.Dq)({control:J,name:"connectedAmount"});var G=(0,$.qo)({control:J,name:"amountReceived",defaultValue:0}),X=(0,o.a)(i.v8,{variables:{where:(0,je.Io)({accountId:n,adminId:t,numberId:m?"".concat(m):null,invoiceNumber:m?Number(m):null,paymentStatus:["partial","unpaid"]})}}).data,Y=(X=void 0===X?{accountEntries:[]}:X).accountEntries,ee=(0,S.D)(i.qD,{onCompleted:function(e){v(),f()}}),ne=(0,I.Z)(ee,1)[0],te=(0,S.D)(i.DI),oe=(0,I.Z)(te,1)[0],ie=function(){var e=(0,x.Z)(Z().mark((function e(t){var r,o,i,a;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(Number(N).toFixed(2)>Number(G).toFixed(2))){e.next=3;break}return F("you can not reconcile more than credit note amount"),e.abrupt("return");case 3:if(!(Number(N).toFixed(2)<Number(G).toFixed(2))){e.next=6;break}return F("you can not reconcile less than credit note amount"),e.abrupt("return");case 6:return r=t.connectedAmount.filter((function(e){return e.amount>0})),o={accountId:n,balance:0,credit:parseFloat(t.amountReceived).toFixed(2),currencyId:(0,fe.K)(n),debit:0,entity:"CreditNote",meta:{paymentReference:null,comment:t.reason},type:"creditNote",paymentStatus:"creditNote",dateReceived:(0,ye.v)(t.dateReceived),AccountEntry_Invoice:{data:r.map((function(e){return{invoiceId:e.entityId}}))}},e.next=10,oe({variables:{object:o}}).then((function(e){return e.data.insert_AccountEntry_one.id}));case 10:i=e.sent,a="customerPaid",r.forEach((function(e){var n=e.amount,t=e.entityId,r=e.jobId,o=e.isPPM,c={creditEntity:"CreditNote",creditEntityId:i,debitEntity:"Invoice",debitEntityId:t,amount:n},s={changes:{},id:parseInt(r),insertTiming:!1,reconciliation:c,timing:{}};if(!o){var d,u,l,m,p=Y.find((function(e){return e.entityId===t}));n>=Number(p.debit-(null===p||void 0===p||null===(d=p.invoice)||void 0===d||null===(u=d.reconciledAmounts)||void 0===u||null===(l=u.aggregate)||void 0===l||null===(m=l.sum)||void 0===m?void 0:m.amount)||0)&&(s.changes.status=a,s.changes.paid=!0,s.insertTiming=!0,s.timing={status:a,jobId:parseInt(r),userId:b.id})}ne({variables:s})}));case 13:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),ae={control:J,errors:M,register:B},ce=function(e){return(0,R.jsx)(Ze,{onClick:function(){return function(e){y.show({title:"Job Details",content:(0,R.jsx)(be.g,{jobId:e.jobId,toggleShow:y.close}),submit:!1,width:"50%"})}(e)},children:e.invoiceNumber})},se=function(){var e=z().connectedAmount.reduce((function(e,n){return e+Number(n.amount)}),0);L(e),F()},de=function(){se()},he=function(e){var n=e.amount,t=e.connectedAmount,r=(e.id,e.entity),o=e.jobId,i=e.entityId,a=e.index,c=t===n?"success":"info";return Q("connectedAmount[".concat(a,"].jobId"),o),Q("connectedAmount[".concat(a,"].entityId"),i),Q("connectedAmount[".concat(a,"].isPPM"),!1),Q("connectedAmount[".concat(a,"].outstandingAmount"),n),"Location"===r&&Q("connectedAmount[".concat(a,"].isPPM"),!0),t||(c="danger"),w&&(Q("connectedAmount[".concat(a,"].amount"),t,{shouldDirty:!0}),de()),(0,R.jsxs)(s.Z,{children:[(0,R.jsx)(A.Z,Ie(Ie({},ae),{},{name:"connectedAmount[".concat(a,"].jobId"),type:"hidden"})),(0,R.jsx)(A.Z,Ie(Ie({},ae),{},{name:"connectedAmount[".concat(a,"].entityId"),type:"hidden"})),(0,R.jsx)(A.Z,Ie(Ie({},ae),{},{name:"connectedAmount[".concat(a,"].isPPM"),type:"hidden"})),(0,R.jsx)(A.Z,Ie(Ie({},ae),{},{name:"connectedAmount[".concat(a,"].outstandingAmount"),type:"hidden"})),(0,R.jsx)(Se,Ie(Ie({},ae),{},{context:w?c:null,name:"connectedAmount[".concat(a,"].amount"),onChange:de,size:"sm",type:"number",min:0,defaultValue:t})),(0,R.jsx)(d.Z,{context:"light","data-tip":"Button",onClick:function(){!function(e,n){Q(e,n),se()}("connectedAmount[".concat(a,"].amount"),n)},size:"xs",title:"copy amount",children:(0,R.jsx)(V.Z,{context:"secondary",icon:"clone",size:"lg"})})]})},xe=[{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Number",formatter:function(e){var n=e.row;return ce(n)}},{sortable:!0,sortName:"date",text:"Date"},{sortable:!0,sortName:"daysOutstanding",text:"Days Outstanding"},{sortable:!0,sortName:"amount",text:"Amount Outstanding",formatter:function(e){var n=e.row;return(0,c.Z)(n.amount)}},{text:"Reconciled Amount",formatter:function(e){var n=e.row;return he(n)}}];return(0,R.jsxs)(P.Z,{id:"offCanvasForm",handleSubmit:H(ie),children:[(0,R.jsxs)(u.Z,{children:[(0,R.jsxs)(l.Z,{md:6,children:[(0,R.jsx)(q.Z,{label:"Date Received"}),(0,R.jsx)(re.M,Ie(Ie({},ae),{},{name:"dateReceived"}))]}),(0,R.jsx)(l.Z,{md:6,children:(0,R.jsx)(_e,{align:"center",children:(0,R.jsx)(D.Z,Ie(Ie({},ae),{},{name:"amountReceived",label:"Amount",vat:!0}))})})]}),(0,R.jsx)(u.Z,{children:(0,R.jsx)(l.Z,{md:6,children:(0,R.jsx)(q.Z,{label:"Reason",children:(0,R.jsx)(pe.Z,Ie(Ie({},ae),{},{name:"reason",rows:2}))})})}),(0,R.jsx)(q.Z,{label:"Auto reconcile",children:(0,R.jsx)(ve.Z,Ie(Ie({},ae),{},{onToggle:function(e){C(!w)},size:"sm",toggled:w}))}),(0,R.jsx)(p.Z,{columns:xe,rows:function(){var e;return e=Y.filter((function(e){return e.debit>0})).map((function(e){var n,t,r,o,i,a,c,s,d,u,l=e.debit-((null===e||void 0===e||null===(n=e.invoice)||void 0===n||null===(t=n.reconciledAmounts)||void 0===t||null===(r=t.aggregate)||void 0===r||null===(o=r.sum)||void 0===o?void 0:o.amount)||0);return{id:e.id,jobId:e.jobId,entity:null===(i=e.invoice)||void 0===i?void 0:i.entity,entityId:null===(a=e.invoice)||void 0===a?void 0:a.id,invoiceNumber:"Location"===(null===e||void 0===e?void 0:e.entity)?"PM / ".concat(null===(c=e.meta)||void 0===c||null===(s=c.invoiceNumbers)||void 0===s?void 0:s[0]):e.jobId?"".concat(null===(d=e.job)||void 0===d?void 0:d.number," / ").concat(null===(u=e.invoice)||void 0===u?void 0:u.id):null,date:(0,W.Z)(e.createdAt),daysOutstanding:e.outstandingdays,amount:l,connectedAmount:0}})),ue()(e,[j.item],[j.order]).map((function(e,n){return Ie(Ie({index:n},e),{},{amount:Number(null===e||void 0===e?void 0:e.amount).toFixed(2)})}))}(),sort:j,setSort:function(e){return O(Ie({},e))}}),(0,R.jsxs)(_e,{reverse:!0,pr:!0,children:[(0,R.jsx)(h.Z,{content:"Sum: ".concat((0,c.Z)(N)),context:Number(N).toFixed(2)===Number(G).toFixed(2)?"success":"danger"}),E&&(0,R.jsx)(K.Z,{content:E,context:"danger"})]})]})},_e=(0,f.ZP)(u.Z).withConfig({displayName:"creditNoteForm__StyledRow",componentId:"sc-x4vr2o-0"})(["padding-left:1rem;padding-right:",";flex-flow:",";"],(function(e){return e.pr?"5rem":null}),(function(e){return e.reverse?"row-reverse":null})),Ze=f.ZP.a.withConfig({displayName:"creditNoteForm__StyledLink",componentId:"sc-x4vr2o-1"})(["color:",";cursor:pointer;"],(function(e){return e.theme.COLOUR.secondary})),Se=(0,f.ZP)(A.Z).withConfig({displayName:"creditNoteForm__StyledInput",componentId:"sc-x4vr2o-2"})(["border:1px solid ",";"],(function(e){return e.theme.COLOUR[e.context]})),we=t(49705),$e=t(83789),Pe=function(e){var n=e.onFilter,t=(0,r.useState)(["creditNote","partial","paid","paymentReceipt","proformaInvoice","unpaid"]),o=t[0],i=t[1],a=function(e,t){var r;r=t?[].concat((0,$e.Z)(o),[e]):o.filter((function(n){return n!==e})),n(r),i(r)};return(0,R.jsxs)(u.Z,{children:[(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"dark",onToggle:function(e){return a("creditNote",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Credit Note"})]}),(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"black",onToggle:function(e){return a("paymentReceipt",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Payment"})]}),(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"danger",onToggle:function(e){return a("proformaInvoice",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Proforma Invoice"})]}),(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"danger",onToggle:function(e){return a("unpaid",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Unpaid"})]}),(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"female",onToggle:function(e){return a("partial",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Partially Paid"})]}),(0,R.jsxs)(De,{md:2,children:[(0,R.jsx)(ve.Z,{context:"success",onToggle:function(e){return a("paid",e)},size:"sm",toggled:!0}),(0,R.jsx)(X.Z,{marginLeft:"sm"}),(0,R.jsx)(Q.Z,{size:"sm",children:"Paid"})]})]})},De=(0,f.ZP)(l.Z).withConfig({displayName:"filters__StyledColumn",componentId:"sc-116hl20-0"})(["align-items:center;display:flex;"]),qe=t(22384),Ae=t(42772),Re=t(1323),Ce=t(78586),ke=t(9273),Ne=t(68343);function Le(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Te(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Le(Object(t),!0).forEach((function(n){(0,O.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Le(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var Ee=function(e){var n,t,p=e.accountId,v=e.accountName,f=e.edit,b=e.locationId,g=(e.setCustomerBalance,(0,r.useContext)(a.Z)),j=(0,Re.x)().user,O=(0,J.x)(),_=j.adminId,S=(0,Ce.q)(),w=null===(n=S.admin.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,D=null===(t=S.admin.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,q=(0,U.useRouter)().query,C={endDate:q.endDate&&new Date(q.endDate),outstandingLevel:q.outstandingLevel,startDate:q.startDate&&new Date(q.startDate),type:["creditNote","proformaInvoice","paymentReceipt"],paymentStatus:["creditNote","paymentReceipt","partial","paid","unpaid"]},k=(0,r.useState)(C),N=k[0],L=k[1],T=N.endDate,E=N.invoiceNumber,F=N.outstandingLevel,H=N.startDate,K=N.type,de=N.paymentStatus,ue=(0,we.x)({filters:N}),le=ue.initialData,me=ue.ref,pe=(0,$.cI)({defaultValues:{endDate:T,invoiceNumber:E,outstandingLevel:F,startDate:H}}),ve=pe.control,fe=pe.errors,be=pe.handleSubmit,ye=pe.register,he=/^\d+$/.test(E),ge=(0,M.t)(z.E6,{onCompleted:function(e){(0,ae._)({adminId:_,type:"customerVat",job:Ze[0],client:O})}}),xe=(0,I.Z)(ge,2),Ie=xe[0],_e=xe[1].data,Ze=(_e=void 0===_e?{job:null}:_e).job,Se=(0,o.a)(i.v8,{variables:Te(Te({},le),{},{accountId:p,where:Te({},(0,je.Io)({outstandingLevel:F,adminId:_,accountId:p,to:T,from:H,locationId:b,jobNumber:he?"".concat(E):null,type:K,paymentStatus:de}))})}),$e=Se.data,De=($e=void 0===$e?{accountEntries:[],balances:[],meta:{aggregate:{totalCount:0,debitTotal:{debit:0},creditTotal:{credit:0},reconciledAmounts:{amount:0},balance:{balance:0}}}}:$e).accountEntries,Le=$e.meta,Ee=Se.loading,Je=Se.refetch,Me=(0,o.a)(i.HR,{variables:{customerId:p}}).data,ze=(Me=void 0===Me?{jobs:[]}:Me).jobs,He=(0,c.Z)(Le.aggregate.debitTotal.debit),Be=(0,c.Z)(Le.aggregate.creditTotal.credit),Ve=Le.aggregate.balance.balance,Qe=function(e){var n=e.adminId,t=e.endDate,r=e.accountId,o=e.invoiceNumber,a=e.locationId,c=e.outstandingLevel,s=e.startDate,u=e.queryIsNumber,l=e.type,m=e.paymentStatus,p=(0,M.t)(i.v8,{variables:{where:Te({},(0,je.Io)({outstandingLevel:c,adminId:n,accountId:r,to:t,from:s,locationId:a,jobNumber:u?"".concat(o):null,type:l,paymentStatus:m}))},onCompleted:function(e){var n=(0,je.yG)(e.accountEntries,{numberPrefix:w,numberSuffix:D}),t=B().unparse(n),r="data:application/octet-stream,"+encodeURIComponent(t);(0,Ae.S)(r,"account-entries.csv")}}),v=(0,I.Z)(p,1)[0];return(0,R.jsxs)(Ue,{children:[(0,R.jsx)(d.Z,{context:"white",onClick:function(e){e.preventDefault(),e.stopPropagation(),v()},title:"Export to CSV",size:"md",children:(0,R.jsx)(V.Z,{context:"secondary",icon:"file-csv",size:"lg"})}),(0,R.jsx)(d.Z,{context:"white",onClick:function(e){e.preventDefault(),e.stopPropagation(),ie({adminId:n,accountId:r,locationId:a,from:s,invoiceNumber:u?Number(o):null,jobId:u?"".concat(o):null,outstandingLevel:c>0?c:null,to:t,type:l})},title:"Export to PDF",children:(0,R.jsx)(V.Z,{context:"secondary",icon:"file-pdf",size:"lg"})})]})},Ge=function(){var e=(0,x.Z)(Z().mark((function e(n,t){var r,o,i,a,c,s,d,u;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.preventDefault(),n.stopPropagation(),"proformaInvoice"!==(null===t||void 0===t?void 0:t.itemType)){e.next=7;break}o=t.invoice,i=void 0===o?{}:o,(0,ce.u)({invoice:i}),e.next=19;break;case 7:if(null===(r=t.meta)||void 0===r||!r.jobIds){e.next=18;break}return a=t.meta.jobIds.split(","),c=t.invoice.id,s=t.id,d={jobIds:a,invoiceNumber:c,adminId:_,accountEntryId:s},"ppm/create",u=window.open("/download","_blank"),e.next=16,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/invoice/").concat("ppm/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(d)}).then((function(e){return e.json()})).then((function(e){u.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,oe.Tb)({message:e,section:"fetch"})}));case 16:e.next=19;break;case 18:Ie({variables:{adminId:_,number:t.number}});case 19:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),We=[{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var n=e.row,t=e.row.itemType;return(0,R.jsx)(Fe,{content:t,row:n,size:"sm"})},text:"Type"},{hidden:!0},{text:"Number",formatter:function(e){var n,t,r=e.row;return"Location"===(null===r||void 0===r||null===(n=r.invoice)||void 0===n?void 0:n.entity)?(0,R.jsx)(Q.Z,{size:"sm",children:"PM / ".concat(r.meta.invoiceNumber)}):(0,R.jsx)(ee.D,{id:r.jobId,number:r.number,invoiceNumber:null===(t=r.invoice)||void 0===t?void 0:t.id,numberPrefix:w,numberSuffix:D,openCanvas:!!r.jobId,type:r.jobType})}},{hidden:!0},{hidden:!0},{text:"Reference"},{hidden:!0},{text:"Date"},{hidden:!f,text:"Days Outstanding"},{hidden:!0,text:"Service"},{hidden:!0},{text:"Amount Outstanding",formatter:function(e){var n=e.row;return"invoice"===n.itemType||"proformaInvoice"===n.itemType?(0,c.Z)(n.outstandingAmount):"-"}},{text:"Status",formatter:function(e){var n=e.row;return n.status?(0,R.jsx)(Ne.B,{value:n.status}):""}},{text:"Debit",formatter:function(e){var n=e.row;return n.debit?(0,c.Z)(n.debit):"-"}},{text:"Credit",formatter:function(e){var n=e.row;return n.credit?(0,c.Z)(n.credit):"-"}},{text:"Balance",formatter:function(e){var n=e.row;return(0,c.Z)(n.balance)}},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:G.Z,formatterData:function(e){return[{context:"secondary",icon:["fas","download"],onClick:function(e,n){return Ge(e,n)},tooltip:"Download",disabled:"creditNote"===e.itemType||"paymentReceipt"===e.itemType}]},text:"Actions"}],Xe=function(e){e.invoiceNumber||e.startDate||e.endDate||e.outstandingLevel?L(Te(Te({},N),{},{endDate:e.endDate,invoiceNumber:e.invoiceNumber?e.invoiceNumber:null,outstandingLevel:e.outstandingLevel,startDate:e.startDate})):Array.isArray(e)?L(Te(Te({},N),{},{type:e.filter((function(e){return"paid"!==e||"unpaid"!==e||"partial"!==e})),paymentStatus:e})):L(C)},Ye={control:ve,errors:fe,register:ye};return(0,R.jsxs)(m.Z,{open:!0,title:"Account Entries",toolbar:(0,R.jsx)(Qe,{adminId:_,accountId:p,accountName:v,endDate:T,invoiceNumber:E,locationId:b,outstandingLevel:F,startDate:H,queryIsNumber:he,type:K,paymentStatus:de}),children:[(0,R.jsxs)(P.Z,{handleSubmit:be(Xe),children:[(0,R.jsxs)(u.Z,{children:[(0,R.jsx)(l.Z,{md:2,children:(0,R.jsx)(re.M,Te(Te({},Ye),{},{name:"startDate",placeholder:"Start date"}))}),(0,R.jsx)(l.Z,{md:2,children:(0,R.jsx)(re.M,Te(Te({},Ye),{},{name:"endDate",placeholder:"End date"}))}),(0,R.jsx)(l.Z,{md:3,children:(0,R.jsx)(A.Z,Te(Te({},Ye),{},{name:"invoiceNumber",placeholder:"Id / Invoice"}))}),(0,R.jsx)(l.Z,{md:3,children:(0,R.jsx)(Y.Z,Te(Te({},Ye),{},{name:"outstandingLevel",options:qe.r}))}),(0,R.jsx)(l.Z,{md:1,children:(0,R.jsx)(d.Z,{content:"Filter",context:"secondary",size:"sm",type:"submit"})})]}),(0,R.jsx)(X.Z,{marginBottom:"md"}),(0,R.jsx)(Pe,{onFilter:Xe})]}),(0,R.jsx)(te.t,{columns:We,history:!1,loading:Ee,meta:Le,ref:me,refetch:Je,rowClick:function(e){var n,t=[];if(null===e.jobId&&"Location"===(null===(n=e.invoice)||void 0===n?void 0:n.entity)){var r=e.meta.jobIds.split(",").map(Number);t=ze.filter((function(e){return r.includes(e.id)}))}g.show({content:(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(ne,{data:e,numberSuffix:D,numberPrefix:w,refetch:Je,toggleShow:g.close}),t&&t.length>0&&(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(X.Z,{}),(0,R.jsx)(ke.r,{jobs:t,location:location,offCanvas:g,row:e,refetch:Je,showCreateJobButton:!1})]})]}),title:"Account Entry Details"})},rows:De.map((function(e){var n,t,r,o,i,a,c,s,d,u,l,m,p,v,f,b,y,h,g=(null===e||void 0===e||null===(n=e.invoice)||void 0===n||null===(t=n.reconciledAmounts)||void 0===t||null===(r=t.aggregate)||void 0===r||null===(o=r.sum)||void 0===o?void 0:o.amount)||null,j="creditNote"!==e.type&&"paymentReceipt"!==e.type?e.outstandingdays:"-";return{id:e.id,jobId:e.jobId,jobIds:e.invoices.map((function(e){return e.Invoice.Job.id})),number:null===e||void 0===e||null===(i=e.job)||void 0===i?void 0:i.number,itemType:e.type,jobType:null===e||void 0===e||null===(a=e.job)||void 0===a?void 0:a.type,invoiceNumber:(null===e||void 0===e||null===(c=e.job)||void 0===c||null===(s=c.meta)||void 0===s||null===(d=s.invoiceNumbers)||void 0===d?void 0:d[0])||(null===e||void 0===e||null===(u=e.invoice)||void 0===u?void 0:u.invoiceNumber),invoice:e.invoice,invoices:e.invoices.map((function(e){return e.invoiceId})),reference:e.reference||(null===(l=e.meta)||void 0===l?void 0:l.paymentReference),comment:null===(m=e.meta)||void 0===m?void 0:m.comment,date:(0,W.Z)(e.createdAt),outstandingDays:j,service:null===e||void 0===e||null===(p=e.job)||void 0===p||null===(v=p.service)||void 0===v?void 0:v.name,address:null===e||void 0===e||null===(f=e.job)||void 0===f||null===(b=f.location)||void 0===b?void 0:b.name,outstandingAmount:e.outstandingAmount,status:null===e||void 0===e||null===(y=e.job)||void 0===y?void 0:y.status,debit:e.debit,credit:e.credit,balance:e.balance,paid:null===e||void 0===e||null===(h=e.job)||void 0===h?void 0:h.paid,paymentStatus:e.paymentStatus,reconciledAmounts:g,entity:e.entity,entryId:e.entryId,meta:e.meta,actions:""}}))}),(0,R.jsx)(X.Z,{marginBottom:"md"}),(0,R.jsx)(u.Z,{children:(0,R.jsxs)(l.Z,{md:12,style:{textAlign:"end"},children:[(0,R.jsx)(h.Z,{content:"Total Debit: ".concat(He),context:"info",size:"sm"}),(0,R.jsx)(h.Z,{content:"Total Credit: ".concat(Be),context:"info",size:"sm"}),(0,R.jsx)(h.Z,{content:"Balance:".concat((0,c.Z)(Ve)),context:"".concat(Ve<0?"warning":"success"),size:"sm"})]})}),(0,R.jsx)(y.Z,{size:"sm"}),(0,R.jsx)(s.Z,{align:"flex-end",children:f&&(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(d.Z,{content:"Add Payment Received",context:"secondary",onClick:function(){g.show({content:(0,R.jsx)(se.q,{accountId:p,adminId:_,refetch:Je,toggleShow:g.close}),title:"Add Payment Received",width:"60%"})},size:"sm"}),(0,R.jsx)(d.Z,{content:"Add Credit note",context:"secondary",onClick:function(){g.show({content:(0,R.jsx)(Oe,{accountId:p,adminId:_,refetch:Je,toggleShow:g.close}),title:"Add credit note",width:"60%"})},size:"sm"})]})})]})},Fe=(0,f.ZP)(h.Z).withConfig({displayName:"accountEntries__StyledBadge",componentId:"sc-1ab0cpy-0"})(["background-color:",";"],(function(e){return(0,je.Lq)(e.row,e.theme)})),Ue=f.ZP.div.withConfig({displayName:"accountEntries__StyledToolbar",componentId:"sc-1ab0cpy-1"})(["float:right;"]);Ee.defaultProps={edit:!0};var Je=t(69128),Me=t(12757),ze=(0,he.Ry)().shape({approvalThreshold:(0,he.Rx)().required(),serviceRateLabour:(0,he.Rx)().when("rateType",{is:"serviceRate",then:(0,he.Rx)().required()}),serviceRateExpenses:(0,he.Rx)().when("rateType",{is:"serviceRate",then:(0,he.Rx)().required()}),arrangementFee:(0,he.Rx)().when("rateType",{is:"rebate",then:(0,he.Rx)().required()}),spendThreshold:(0,he.Rx)().required()});function He(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function Be(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?He(Object(t),!0).forEach((function(n){(0,O.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):He(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var Ve=function(e){var n=e.accountId,t=e.meta,r=e.refetch,o=e.toggleShow,i=Be({},null===t||void 0===t?void 0:t.finance)||{},a=(0,$.cI)({defaultValues:{approvalThreshold:i.approvalThreshold||0,arrangementFee:i.arrangementFee||0,serviceRateLabour:i.serviceRateLabour||0,serviceRateExpenses:i.serviceRateExpenses||0,spendThreshold:i.spendThreshold||0,invoiceDueDate:i.invoiceDueDate||0,rateType:i.serviceRateLabour||i.serviceRateExpenses?"serviceRate":i.arrangementFee&&"rebate"},resolver:(0,le.S)(ze)}),c=a.errors,s=a.handleSubmit,d=a.register,u=a.watch,l=(0,S.D)(w.Wn),m=(0,I.Z)(l,1)[0],p=function(){var e=(0,x.Z)(Z().mark((function e(t){return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:m({variables:{customerId:n,customer:f(t),hasUpdateUser:!1,userId:n}}).then((function(){r(),o()}));case 1:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),v=u("rateType"),f=function(e){var n={};return n.meta=Be({},t)||{},n.meta.finance=i||{},"serviceRate"===v?(n.meta.finance.serviceRateLabour=e.serviceRateLabour,n.meta.finance.serviceRateExpenses=e.serviceRateExpenses,n.meta.finance.arrangementFee=0):"rebate"===v&&(n.meta.finance.serviceRateLabour=0,n.meta.finance.serviceRateExpenses=0,n.meta.finance.arrangementFee=e.arrangementFee),n.meta.finance.approvalThreshold=e.approvalThreshold,n.meta.finance.spendThreshold=e.spendThreshold,n.meta.finance.invoiceDueDate=e.invoiceDueDate,n},b={errors:c,register:d,type:"number"};return(0,R.jsxs)(P.Z,{id:"offCanvasForm",handleSubmit:s(p),children:[(0,R.jsx)(q.Z,{label:"",children:(0,R.jsx)(Je.Z,{errors:c,register:d,data:[{id:"serviceRate",label:"Service Rate",value:"serviceRate"},{id:"rebate",label:"Rebate",value:"rebate"}],name:"rateType"})}),"serviceRate"===v&&(0,R.jsxs)(q.Z,{label:"Service Rate",children:[(0,R.jsx)(Me.Z,Be(Be({},b),{},{label:"Labour",name:"serviceRateLabour"})),(0,R.jsx)(Me.Z,Be(Be({},b),{},{label:"Expenses and Material",name:"serviceRateExpenses"}))]}),"rebate"===v&&(0,R.jsx)(Me.Z,Be(Be({},b),{},{label:"Rebate",name:"arrangementFee"})),(0,R.jsx)(D.Z,Be(Be({},b),{},{label:"Approval Threshold",name:"approvalThreshold"})),(0,R.jsx)(D.Z,Be(Be({},b),{},{label:"Spend Threshold",name:"spendThreshold"})),(0,R.jsx)(q.Z,{label:"Invoice Due Date",children:(0,R.jsx)(A.Z,Be(Be({},b),{},{name:"invoiceDueDate"}))})]})},Qe=(0,he.Ry)().shape({code:(0,he.Z_)()});function Ge(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function We(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Ge(Object(t),!0).forEach((function(n){(0,O.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ge(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var Xe=function(e){var n=e.onSuccess,t=e.meta,r=e.accountId,o={code:null===t||void 0===t?void 0:t.sageCode},i=(0,$.cI)({defaultValues:o,resolver:(0,le.S)(Qe)}),a=i.control,c=i.errors,s=i.handleSubmit,d=i.register,u=(0,S.D)(w.Wn,{onCompleted:n}),l=(0,I.Z)(u,2),m=l[0],p=l[1].error;p&&console.error(p);var v=function(){var e=(0,x.Z)(Z().mark((function e(n){var o,i;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=n.code,(i=We({},t)||{}).sageCode=o,m({variables:{customerId:r,customer:{meta:i}}});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),f={control:a,errors:c,register:d};return(0,R.jsxs)(P.Z,{id:"offCanvasForm",handleSubmit:s(v),children:[(0,R.jsx)(q.Z,{label:"Sage Code",children:(0,R.jsx)(A.Z,We(We({},f),{},{name:"code"}))}),(0,R.jsx)(Q.Z,{children:null===p||void 0===p?void 0:p.message})]})},Ye=function(e){var n=e.accountId,t=e.accountName,f=e.accountRefetch,b=e.locationId,y=e.meta,h=e.hasSageIntegration,g=(0,r.useState)(0),j=g[0],x=g[1],I=(0,(0,Re.x)().hasRole)("admin"),O=(0,o.a)(i.Dn,{variables:{accountId:n}}),_=O.data,Z=(_=void 0===_?{financial:{}}:_).financial,S=O.loading,w=(null===y||void 0===y?void 0:y.finance)||{},$=Z.bankAccounts,P=(0,r.useContext)(a.Z),D=function(){q.close(),f()},q=(0,r.useContext)(a.Z),A=function(e){e.stopPropagation(),q.show({content:(0,R.jsx)(Xe,{meta:y,onSuccess:D,accountId:n}),title:null!==y&&void 0!==y&&y.sageCode?"Add Sage Code":"Update Sage Code"})},C=function(e){e.stopPropagation(),P.show({content:(0,R.jsx)(Ve,{accountId:n,meta:y,refetch:f,toggleShow:P.close}),title:"Edit Finance Details"})};if(S)return null;var k=function(){return(0,R.jsx)(s.Z,{children:(0,R.jsx)(d.Z,{context:"secondary",content:"Edit",onClick:C,size:"sm"})})},N=function(){return(0,R.jsx)(s.Z,{children:(0,R.jsx)(d.Z,{context:"secondary",content:"Edit",onClick:A,size:"sm"})})};return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(u.Z,{children:(0,R.jsx)(l.Z,{md:12,children:(0,R.jsx)(Ee,{accountId:n,accountName:t,edit:I,locationId:b,meta:y,setCustomerBalance:x})})}),(0,R.jsxs)(u.Z,{children:[(0,R.jsxs)(l.Z,{md:6,children:[(0,R.jsx)(m.Z,{toolbar:I&&(0,R.jsx)(k,{}),title:"Overview",open:!0,children:(0,R.jsx)(p.Z,{rows:function(){var e,n;return[{key:"Service Rate Labour",value:"".concat(w.serviceRateLabour||0,"%")},{key:"Service Rate Expenses and Material",value:"".concat(w.serviceRateExpenses||0,"%")},{key:"Rebate",value:"".concat((null===w||void 0===w?void 0:w.arrangementFee)||0,"%")},{key:"Approval Threshold",value:(0,c.Z)(null!==(e=null===w||void 0===w?void 0:w.approvalThreshold)&&void 0!==e?e:0)},{key:"Spend Threshold",value:(0,c.Z)(null!==(n=null===w||void 0===w?void 0:w.spendThreshold)&&void 0!==n?n:0)},{key:"Stripe ID",value:w.stripeId||"-"},{key:"Invoice Due Date",value:w.invoiceDueDate||"-"}]}()})}),(0,R.jsx)(v.y,{accountId:n,data:$,edit:I,refetch:f}),(0,R.jsx)(m.Z,{toolbar:(0,R.jsx)(N,{}),title:"Integration",open:!0,children:(0,R.jsx)(p.Z,{rows:function(){var e,n=[];return h&&n.push({key:"Sage Code",value:(null===y||void 0===y||null===(e=y.sageCode)||void 0===e?void 0:e.length)>0?null===y||void 0===y?void 0:y.sageCode:"not set"}),n}()})})]}),(0,R.jsxs)(l.Z,{md:6,children:[(0,R.jsx)(m.Z,{title:"Balance",open:!0,children:(0,R.jsx)(p.Z,{rows:[{key:"Total Outstanding",value:(0,c.Z)(w.amountOutstanding||0)},{key:"Total Revenues",value:(0,c.Z)(w.totalRevenue||0)}]})}),(0,R.jsx)(E,{accountId:n,edit:I,meta:y,offCanvas:P,refetch:f,customerBalance:j})]})]})]})}},13886:function(e,n,t){t.d(n,{q:function(){return H}});var r=t(92809),o=t(30266),i=t(80318),a=t(64687),c=t.n(a),s=t(67294),d=t(93633),u=t(75709),l=t(38094),m=t(75472),p=t.n(m),v=t(42283),f=t(79665),b=t(24237),y=t(43566),h=t(80880),g=t(58448),j=t(71247),x=t(14347),I=t(55657),O=t(80285),_=t(18862),Z=t(97202),S=t(78215),w=t(2356),$=t(65375),P=t(34868),D=t(83528),q=t(34610),A=t(52002),R=t(7720),C=t(11570),k=t(76800),N=t(380),L=t(12517),T=t(7145),E=t(19501),F=(0,E.Ry)().shape({dateReceived:(0,E.hT)().required(),paymentReference:(0,E.Z_)().required(),amountReceived:(0,E.Rx)().required(),comment:(0,E.Z_)(),connectedAmount:(0,E.IX)().of((0,E.Ry)().shape({jobId:(0,E.Rx)().required(),entityId:(0,E.Rx)().required(),outstandingAmount:(0,E.Rx)().required(),amount:(0,E.Rx)().max((0,E.iH)("outstandingAmount")).min(0).required(),isPPM:(0,E.O7)().required()})).required()}),U=t(85997),J=t(85893);function M(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function z(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?M(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):M(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var H=function(e){var n=e.accountId,t=e.adminId,r=(e.jobId,e.jobNumber),a=e.refetch,m=e.toggleShow,b=(0,s.useContext)(y.Z).user,E=(0,s.useContext)(h.Z),M=(0,s.useState)({item:"date",order:"asc"}),H=M[0],G=M[1],W=(0,s.useState)(!1),X=W[0],Y=W[1],K=(0,s.useState)(0),ee=K[0],ne=K[1],te=(0,s.useState)(),re=te[0],oe=te[1],ie=(0,v.cI)({resolver:(0,f.S)(F)}),ae=ie.control,ce=ie.errors,se=ie.getValues,de=ie.handleSubmit,ue=ie.register,le=ie.setValue;(0,v.Dq)({control:ae,name:"connectedAmount"});var me=(0,v.qo)({control:ae,name:"amountReceived",defaultValue:0}),pe=(0,d.a)(l.v8,{variables:{where:(0,U.Io)({accountId:n,adminId:t,jobNumber:r?"".concat(r):null,invoiceNumber:r?Number(r):null,paymentStatus:["partial","unpaid"]})}}).data,ve=(pe=void 0===pe?{accountEntries:[]}:pe).accountEntries,fe=(0,u.D)(l.qD,{onCompleted:function(e){a(),m()}}),be=(0,i.Z)(fe,1)[0],ye=(0,u.D)(l.tT,{onCompleted:function(e){a(),m()}}),he=(0,i.Z)(ye,1)[0],ge=(0,u.D)(l.Vr),je=(0,i.Z)(ge,1)[0],xe=function(){var e=(0,o.Z)(c().mark((function e(t){var r,o,i,a;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(Number(ee).toFixed(2)>Number(me).toFixed(2))){e.next=2;break}return e.abrupt("return",oe("you can not reconcile more than payment amount"));case 2:if(!(Number(ee).toFixed(2)<Number(me).toFixed(2))){e.next=4;break}return e.abrupt("return",oe("you can not reconcile less than payment amount"));case 4:return r=t.connectedAmount.filter((function(e){return e.amount>0})),o={accountId:n,balance:0,credit:parseFloat(t.amountReceived).toFixed(2),currencyId:(0,N.K)(n),debit:0,entity:"PaymentReceipt",meta:{paymentReference:t.paymentReference,comment:t.paymentReference},type:"paymentReceipt",paymentStatus:"paymentReceipt",dateReceived:(0,T.v)(t.dateReceived),AccountEntry_Invoice:{data:r.map((function(e){return{invoiceId:e.entityId}}))}},e.next=8,je({variables:{object:o}}).then((function(e){return e.data.insert_AccountEntry_one.id}));case 8:i=e.sent,a="customerPaid",r.forEach((function(e){var n=e.amount,t=e.entityId,r=e.jobId,o=e.isPPM,c={creditEntity:"PaymentReceipt",creditEntityId:i,debitEntity:"Invoice",debitEntityId:t,amount:n},s={changes:{},id:parseInt(r),insertTiming:!1,reconciliation:c,timing:{}};if(o){var d=ve.find((function(e){return e.id===t}));if(n>=Number(d.debit)){var u={changes:{status:a,paid:!0},ids:d.meta.jobIds.split(",").map((function(e){return parseInt(e,10)}))};he({variables:u})}}else{var l,m,p,v,f=ve.find((function(e){return e.entityId===t}));n>=Number(f.debit-(null===f||void 0===f||null===(l=f.invoice)||void 0===l||null===(m=l.reconciledAmounts)||void 0===m||null===(p=m.aggregate)||void 0===p||null===(v=p.sum)||void 0===v?void 0:v.amount)||0)&&(s.changes.status=a,s.changes.paid=!0,s.insertTiming=!0,s.timing={status:a,jobId:parseInt(r),userId:b.id})}be({variables:s})}));case 11:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),Ie={control:ae,errors:ce,register:ue},Oe=function(e){return(0,J.jsx)(V,{onClick:function(){return function(e){E.show({title:"Job Details",content:(0,J.jsx)(L.g,{jobId:e.jobId,toggleShow:E.close}),submit:!1,width:"50%"})}(e)},children:e.invoiceNumber})},_e=function(){var e=se().connectedAmount.reduce((function(e,n){return e+Number(n.amount)}),0);ne(e),oe()},Ze=function(){_e()},Se=function(e){var n=e.amount,t=e.connectedAmount,r=(e.id,e.entity),o=e.entityId,i=e.jobId,a=e.index,c=t===n?"success":"info";return le("connectedAmount[".concat(a,"].jobId"),i),le("connectedAmount[".concat(a,"].entityId"),o),le("connectedAmount[".concat(a,"].isPPM"),!1),le("connectedAmount[".concat(a,"].outstandingAmount"),n),"Location"===r&&le("connectedAmount[".concat(a,"].isPPM"),!0),t||(c="danger"),X&&Ze(),(0,J.jsxs)(g.Z,{children:[(0,J.jsx)(j.Z,z(z({},Ie),{},{name:"connectedAmount[".concat(a,"].jobId"),type:"hidden"})),(0,J.jsx)(j.Z,z(z({},Ie),{},{name:"connectedAmount[".concat(a,"].entityId"),type:"hidden"})),(0,J.jsx)(j.Z,z(z({},Ie),{},{name:"connectedAmount[".concat(a,"].isPPM"),type:"hidden"})),(0,J.jsx)(j.Z,z(z({},Ie),{},{name:"connectedAmount[".concat(a,"].outstandingAmount"),type:"hidden"})),(0,J.jsx)(Q,z(z({},Ie),{},{context:X?c:null,name:"connectedAmount[".concat(a,"].amount"),onChange:Ze,size:"sm",type:"number",defaultValue:t})),(0,J.jsx)(x.Z,{context:"light","data-tip":"Button",onClick:function(){!function(e,n){le(e,n),_e()}("connectedAmount[".concat(a,"].amount"),n)},size:"xs",title:"copy amount",children:(0,J.jsx)(I.Z,{context:"secondary",icon:"clone",size:"lg"})})]})},we=[{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Number",formatter:function(e){var n=e.row;return Oe(n)}},{sortable:!0,sortName:"date",text:"Date"},{sortable:!0,sortName:"daysOutstanding",text:"Days Outstanding"},{sortable:!0,sortName:"amount",text:"Amount Outstanding",formatter:function(e){var n=e.row;return(0,O.Z)(n.amount)}},{text:"Reconciled Amount",formatter:function(e){var n=e.row;return Se(n)}}];return(0,J.jsxs)(Z.Z,{id:"offCanvasForm",handleSubmit:de(xe),children:[(0,J.jsxs)(S.Z,{children:[(0,J.jsxs)(w.Z,{md:6,children:[(0,J.jsx)($.Z,{label:"Date Received"}),(0,J.jsx)(k.M,z(z({},Ie),{},{name:"dateReceived"}))]}),(0,J.jsx)(w.Z,{md:6,children:(0,J.jsx)($.Z,{label:"Payment Reference",children:(0,J.jsx)(j.Z,z(z({},Ie),{},{name:"paymentReference"}))})})]}),(0,J.jsxs)(S.Z,{children:[(0,J.jsx)(w.Z,{md:6,children:(0,J.jsx)(B,{align:"center",children:(0,J.jsx)(P.Z,z(z({},Ie),{},{name:"amountReceived",label:"Amount Received",vat:!0}))})}),(0,J.jsx)(w.Z,{md:6,children:(0,J.jsx)($.Z,{label:"Comment",children:(0,J.jsx)(D.Z,z(z({},Ie),{},{name:"comment",rows:2}))})})]}),(0,J.jsx)($.Z,{label:"Auto reconcile",children:(0,J.jsx)(q.Z,z(z({},Ie),{},{onToggle:function(e){Y(!X)},size:"sm",toggled:X}))}),(0,J.jsx)(A.Z,{columns:we,rows:function(){var e;return e=ve.filter((function(e){return e.debit>0})).map((function(e){var n,t,r,o,i,a,c,s,d,u,l,m=e.debit-((null===e||void 0===e||null===(n=e.invoice)||void 0===n||null===(t=n.reconciledAmounts)||void 0===t||null===(r=t.aggregate)||void 0===r||null===(o=r.sum)||void 0===o?void 0:o.amount)||0);return{id:e.id,jobId:e.jobId,entity:null===e||void 0===e||null===(i=e.invoice)||void 0===i?void 0:i.entity,entityId:null===(a=e.invoice)||void 0===a?void 0:a.id,invoiceNumber:"Location"===(null===e||void 0===e||null===(c=e.invoice)||void 0===c?void 0:c.entity)?"PM / ".concat(null===(s=e.meta)||void 0===s||null===(d=s.invoiceNumbers)||void 0===d?void 0:d[0]):e.jobId?"".concat(null===(u=e.job)||void 0===u?void 0:u.number," / ").concat(null===(l=e.invoice)||void 0===l?void 0:l.id):null,date:(0,_.Z)(e.createdAt),daysOutstanding:e.outstandingdays,amount:m,connectedAmount:0}})),p()(e,[H.item],[H.order]).map((function(e,n){return z(z({index:n},e),{},{amount:Number(null===e||void 0===e?void 0:e.amount).toFixed(2)})}))}(),sort:H,setSort:function(e){return G(z({},e))}}),(0,J.jsxs)(B,{reverse:!0,pr:!0,children:[(0,J.jsx)(R.Z,{content:"Sum: ".concat((0,O.Z)(ee)),context:Number(ee).toFixed(2)===Number(me).toFixed(2)?"success":"danger"}),re&&(0,J.jsx)(C.Z,{content:re,context:"danger"})]})]})},B=(0,b.ZP)(S.Z).withConfig({displayName:"paymentReceivedForm__StyledRow",componentId:"sc-1wl4d2h-0"})(["padding-left:1rem;padding-right:",";flex-flow:",";"],(function(e){return e.pr?"5rem":null}),(function(e){return e.reverse?"row-reverse":null})),V=b.ZP.a.withConfig({displayName:"paymentReceivedForm__StyledLink",componentId:"sc-1wl4d2h-1"})(["color:",";cursor:pointer;"],(function(e){return e.theme.COLOUR.secondary})),Q=(0,b.ZP)(j.Z).withConfig({displayName:"paymentReceivedForm__StyledInput",componentId:"sc-1wl4d2h-2"})(["border:1px solid ",";"],(function(e){return e.theme.COLOUR[e.context]}))},63306:function(e,n,t){t.d(n,{o:function(){return w}});var r=t(92809),o=t(30266),i=t(80318),a=t(64687),c=t.n(a),s=t(67294),d=t(93633),u=t(75709),l=t(90480),m=t(80880),p=t(91126),v=t(80284),f=t(11570),b=t(18944),y=t(81185),h=t(35614),g=t(49705),j=t(1323),x=t(32763),I=t(85893);function O(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function _(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?O(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):O(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var Z=["supplierHourRate","supplierHourRateOOH","supplierHourRatePremium","supplierDayRate","supplierDayRateOOH","supplierDayRatePremium"],S={item:"Service",inneritem:"name",order:"asc"},w=function(e){var n=e.customerId,t=e.edit,r=e.entity,a=e.entityId,O=e.filters,w=e.hasCustomRates,$=e.type,P=(0,s.useContext)(m.Z),D=(0,g.x)({filters:O,initialSort:S}),q=D.initialData,A=D.ref,R=(0,j.x)().hasRole,C=(0,d.a)(l.pP,{variables:_({customerId:n,entity:r,entityId:a,entityIds:n?[a,n]:[a],hasCustomerId:n>0},q)}),k=C.data,N=(k=void 0===k?{services:[],servicesSystem:[],servicesCustomer:[],metaServices:{aggregate:{totalCount:0}},metaServicesSystem:{aggregate:{totalCount:0}},metaServicesCustomer:{aggregate:{totalCount:0}}}:k).metaServices,L=k.metaServicesCustomer,T=k.metaServicesSystem,E=k.services,F=k.servicesSystem,U=k.servicesCustomer,J=C.loading,M=C.refetch,z=(0,u.D)(l.Q5,{onCompleted:function(e){P.close(),M()}}),H=(0,i.Z)(z,1)[0],B=(0,u.D)(l.oh,{onCompleted:function(e){P.close(),M()}}),V=(0,i.Z)(B,1)[0],Q=(0,x.tQ)({type:$,servicesSystem:F}),G=function(){var e=(0,o.Z)(c().mark((function e(n){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.serviceId=parseInt(n.service.value),n.entity=r,n.entityId=a,n.notes=null,delete n.service,n.hasCallOutRate||(n.callOutHourRate=null,n.callOutHourRateOOH=null,n.callOutHourRatePremium=null),delete n.hasCallOutRate,w&&(n.meta=n.id&&_({},E.find((function(e){return e.id===Number(n.id)})).meta)||{},Z.forEach((function(e){n.meta[e]=n[e],delete n[e]}))),!n.id){e.next=13;break}return e.next=11,V({variables:{id:n.id,changes:n}});case 11:e.next=15;break;case 13:return e.next=15,H({variables:{objects:[n]}});case 15:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),W=[{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{text:"Service Line"},{text:"Type"},{text:"Adjusted"},{text:"\xa3/H"},{text:"\xa3/H OOH"},{text:"\xa3/H Premium"},{text:"\xa3/D"},{text:"\xa3/D OOH"},{text:"\xa3/D Premium"},{text:"Min Interval"},{text:"Min Length"},{text:"Status"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!t,formatter:p.Z,formatterData:function(e){return[{context:"secondary",disabled:"location"===$&&"Customer"===e.type&&(null===E||void 0===E?void 0:E.find((function(n){return n.service.id===e.service.value}))),icon:["fas","edit"],onClick:function(e,n){return function(e){"location"===$&&"Customer"===e.type&&delete e.id,P.show({content:(0,I.jsx)(h.n,{defaultValues:e,entity:r,hasCustomRates:w,onSubmit:G,type:$}),title:"Services",width:"60%"})}(n)},tooltip:"Edit"}]},text:"Actions"}];return(0,I.jsxs)(v.Z,{open:!0,title:"Services",children:[(0,I.jsx)(y.t,{columns:W,initialSort:S,loading:J,meta:(0,x.dP)({metaServices:N,metaServicesCustomer:L,metaServicesSystem:T,type:$}),ref:A,refetch:M,rows:(0,x.WR)({allServicesSystem:Q,services:E,servicesCustomer:U,type:$}).filter((function(e){return!("location"===$&&"Customer"===e.type&&null!==E&&void 0!==E&&E.find((function(n){return n.service.id===e.service.id})))})).filter((function(e){return e.hourRate||!R("customer")})).map((function(e){var n,t,r,o,i,a;return{id:e.id,accountId:e.accountId,notes:e.notes,service:{label:e.service.name,value:e.service.id},location:e.location,delivery:e.delivery,name:e.service.name,type:e.type,adjusted:"System"===e.type?"":(0,x.BY)(e),hourRateForTable:function(){return(0,I.jsxs)(I.Fragment,{children:[e.hourRate||"-",(0,I.jsx)("br",{}),(0,I.jsx)("b",{children:"".concat(e.callOutHourRate?"First hour: "+e.callOutHourRate:"")})]})},hourRateOOHForTable:function(){return(0,I.jsxs)(I.Fragment,{children:[e.hourRateOOH||"-",(0,I.jsx)("br",{}),(0,I.jsx)("b",{children:"".concat(e.callOutHourRateOOH?"First hour: "+e.callOutHourRateOOH:"")})]})},hourRatePremiumForTable:function(){return(0,I.jsxs)(I.Fragment,{children:[e.hourRatePremium||"-",(0,I.jsx)("br",{}),(0,I.jsx)("b",{children:"".concat(e.callOutHourRatePremium?"First hour: "+e.callOutHourRatePremium:"")})]})},dayRate:e.dayRate||"-",dayRateOOH:e.dayRateOOH||"-",dayRatePremium:e.dayRatePremium||"-",minimumInterval:e.minimumInterval||"-",minimumLength:e.minimumLength||"-",status:e.status,supplierHourRate:null===(n=e.meta)||void 0===n?void 0:n.supplierHourRate,supplierHourRateOOH:null===(t=e.meta)||void 0===t?void 0:t.supplierHourRateOOH,supplierHourRatePremium:null===(r=e.meta)||void 0===r?void 0:r.supplierHourRatePremium,supplierDayRate:null===(o=e.meta)||void 0===o?void 0:o.supplierDayRate,supplierDayRateOOH:null===(i=e.meta)||void 0===i?void 0:i.supplierDayRateOOH,supplierDayRatePremium:null===(a=e.meta)||void 0===a?void 0:a.supplierDayRatePremium,hourRate:e.hourRate,hourRateOOH:e.hourRateOOH,hourRatePremium:e.hourRatePremium,callOutHourRate:e.callOutHourRate,callOutHourRateOOH:e.callOutHourRateOOH,callOutHourRatePremium:e.callOutHourRatePremium,actions:""}}))}),R("customer")&&(0,I.jsx)(f.Z,{context:"info",content:(0,I.jsxs)(b.Z,{children:["Only those service lines for which rates have been agreed are displayed above. If you would like pricing information on other service lines please contact your account manager.",(0,I.jsx)("b",{children:" Please note: you can still book jobs on other service lines"})]})})]})};w.defaultProps={edit:!0,hasCustomRates:!1,filters:{}}},30083:function(e,n,t){t.d(n,{C:function(){return H}});var r=t(30266),o=t(80318),i=t(64687),a=t.n(i),c=t(67294),s=t(93633),d=t(75709),u=t(99628),l=t(80880),m=t(34610),p=t(91126),v=t(80284),f=t(52002),b=t(92809),y=t(42283),h=t(79665),g=t(97202),j=t(11417),x=t(78215),I=t(2356),O=t(65375),_=t(46482),Z=t(83528),S=t(75838),w=t(71247),$=t(85893);function P(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function D(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?P(Object(t),!0).forEach((function(n){(0,b.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):P(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var q=function(e){var n=e.errors,t=e.register,r=e.slaSelected,o={errors:n,min:0,register:t,type:"number"};return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(j.Z,{content:"Default Rates",tag:"h3"}),(0,$.jsxs)(x.Z,{children:[(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Normal Rate (".concat(null===r||void 0===r?void 0:r.normalRate,"x)"),children:(0,$.jsx)(w.Z,D(D({},o),{},{name:"normalRate"}))})}),(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Out Of Hours Rate (".concat(null===r||void 0===r?void 0:r.oohRate,"x)"),children:(0,$.jsx)(w.Z,D(D({},o),{},{name:"oohRate"}))})}),(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Premium Rate (".concat(null===r||void 0===r?void 0:r.premiumRate,"x)"),children:(0,$.jsx)(w.Z,D(D({},o),{},{name:"premiumRate"}))})})]}),(0,$.jsxs)(x.Z,{children:[(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Minimum Interval (mins) (".concat(null===r||void 0===r?void 0:r.minimumInterval,"x)"),children:(0,$.jsx)(w.Z,D(D({},o),{},{name:"minimumInterval"}))})}),(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Minimum Job Length (mins) (".concat(null===r||void 0===r?void 0:r.minimumLength,"x)"),children:(0,$.jsx)(w.Z,D(D({},o),{},{name:"minimumLength"}))})})]})]})},A=t(24237);function R(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function C(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?R(Object(t),!0).forEach((function(n){(0,b.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):R(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var k=function(e){var n=e.errors,t=e.register,r=e.slaSelected,o={errors:n,register:t};return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(j.Z,{content:"Timings",tag:"h3"}),(0,$.jsxs)(x.Z,{children:[(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"On Site (".concat(null===r||void 0===r?void 0:r.onSite," ").concat(null===r||void 0===r?void 0:r.onSiteUnit,")"),children:(0,$.jsxs)(N,{children:[(0,$.jsx)(w.Z,C(C({},o),{},{name:"onSite",type:"number",min:0})),(0,$.jsx)(_.Z,C(C({},o),{},{name:"onSiteUnit",label:"",options:[{text:"Select",value:""},{text:"Minutes",value:"minutes"},{text:"Hours",value:"hours"},{text:"Days",value:"days"}]}))]})})}),(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Job Report (".concat(null===r||void 0===r?void 0:r.jobReport," ").concat(null===r||void 0===r?void 0:r.jobReportUnit,")"),children:(0,$.jsxs)(N,{children:[(0,$.jsx)(w.Z,C(C({},o),{},{name:"jobReport",type:"number",min:0})),(0,$.jsx)(_.Z,C(C({},o),{},{name:"jobReportUnit",label:"",options:[{text:"Select",value:""},{text:"Minutes",value:"minutes"},{text:"Hours",value:"hours"},{text:"Days",value:"days"}]}))]})})}),(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Completion (".concat(null===r||void 0===r?void 0:r.completion," ").concat(null===r||void 0===r?void 0:r.completionUnit,")"),children:(0,$.jsxs)(N,{children:[(0,$.jsx)(w.Z,C(C({},o),{},{name:"completion",type:"number",min:0})),(0,$.jsx)(_.Z,C(C({},o),{},{name:"completionUnit",label:"",options:[{text:"Select",value:""},{text:"Minutes",value:"minutes"},{text:"Hours",value:"hours"},{text:"Days",value:"days"}]}))]})})})]})]})},N=A.ZP.div.withConfig({displayName:"timings__StyledOption",componentId:"sc-132gp4y-0"})(["display:flex;max-width:180px;& input{margin-right:5px;text-align:center;width:70px;}& select{width:90px;}"]);function L(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}var T=function(e){var n=function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?L(Object(t),!0).forEach((function(n){(0,b.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):L(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}({},e);return n.inUse=null!==e&&void 0!==e&&e.inUse?"active":"inactive",n},E=t(19501),F=(0,E.Ry)().shape({onSite:(0,E.Z_)().required(),onSiteUnit:(0,E.Z_)().required(),jobReport:(0,E.Z_)().required(),jobReportUnit:(0,E.Z_)().required(),completion:(0,E.Z_)().required(),completionUnit:(0,E.Z_)().required(),normalRate:(0,E.Z_)().required(),oohRate:(0,E.Z_)().required(),premiumRate:(0,E.Z_)().required(),minimumInterval:(0,E.Z_)().required(),minimumLength:(0,E.Z_)().required(),notes:(0,E.Z_)().required(),inUse:(0,E.Z_)().oneOf(["active","inactive"]).required()});function U(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function J(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?U(Object(t),!0).forEach((function(n){(0,b.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):U(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var M=function(e){var n=e.entity,t=e.entityId,i=e.formData,c=e.onSuccess,s=(e.parentEntityId,e.sla),l=(0,y.cI)({defaultValues:i?T(i):{},resolver:(0,h.S)(F)}),m=l.errors,p=l.handleSubmit,v=l.register,f=(0,d.D)(u.PL,{onCompleted:function(e){var n=e.insert_SLA_Entity.returning[0].id;c&&c(n)}}),b=(0,o.Z)(f,1)[0],w=(0,d.D)(u.DE,{onCompleted:function(e){var n=e.update_SLA_Entity_by_pk.id;c&&c(n)}}),P=(0,o.Z)(w,1)[0],D=function(){var e=(0,r.Z)(a().mark((function e(r){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.slaId=null===s||void 0===s?void 0:s.id,r.entity=n,r.entityId=t,r.inUse="active"===r.inUse,delete r.slaSelected,null===i||void 0===i||!i.id){e.next=10;break}return e.next=8,P({variables:{id:null===i||void 0===i?void 0:i.id,changes:r}});case 8:e.next=12;break;case 10:return e.next=12,b({variables:{objects:[r]}});case 12:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),A={errors:m,register:v};return(0,$.jsxs)(g.Z,{id:"offCanvasForm",handleSubmit:p(D),children:[i&&(0,$.jsx)(j.Z,{content:"SLA: ".concat(i.sla.name),tag:"h2"}),(0,$.jsxs)($.Fragment,{children:[(0,$.jsxs)(x.Z,{children:[(0,$.jsx)(I.Z,{md:4,children:(0,$.jsx)(O.Z,{label:"Status",children:(0,$.jsx)(_.Z,J(J({},A),{},{name:"inUse",options:S.bg}))})}),(0,$.jsx)(I.Z,{md:8,children:(0,$.jsx)(O.Z,{label:"Notes",children:(0,$.jsx)(Z.Z,J(J({},A),{},{name:"notes",rows:2}))})})]}),(0,$.jsx)(x.Z,{children:(0,$.jsx)(I.Z,{md:12,children:(0,$.jsx)(q,J(J({},A),{},{slaSelected:s}))})}),(0,$.jsx)(x.Z,{children:(0,$.jsx)(I.Z,{md:12,children:(0,$.jsx)(k,J(J({},A),{},{slaSelected:s}))})})]})]})};M.defaultProps={};var z=t(1323),H=function(e){var n=e.entity,t=e.entityId,i=e.parentEntityId,b=(0,c.useContext)(l.Z),y=(0,z.x)().hasRole,h=(0,s.a)(u.uY,{variables:{entity:n,entityId:t,parentEntity:"Location"===n?"Account":null,parentEntityId:i,fetchParent:"Location"===n}}),g=h.data,j=(g=void 0===g?{slas:[],entities:[],parentEntities:[]}:g).slas,x=g.entities,I=g.parentEntities,O=h.loading,_=h.refetch,Z=(0,d.D)(u.PL,{onCompleted:function(){_()}}),S=(0,o.Z)(Z,2),w=S[0],P=S[1].addLoading,D=(0,d.D)(u.DE,{onCompleted:function(){_()}}),q=(0,o.Z)(D,2),A=q[0],R=q[1].updateLoading,C=function(){_(),b.close()},k=function(e,r){b.show({title:"SLA",content:(0,$.jsx)(M,{formData:x.find((function(e){return e.sla.id===r.id})),entity:n,entityId:t,onSuccess:C,parentEntityId:i,sla:r.data}),width:"50%"})},N=function(){var e=(0,r.Z)(a().mark((function e(r,o){var i,c;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=x.find((function(e){return e.sla.id===r})),c={slaId:r,entity:n,entityId:t,inUse:o,status:o?"active":"inactive"},!i){e.next=7;break}return e.next=5,A({variables:{id:null===i||void 0===i?void 0:i.id,changes:c}});case 5:e.next=9;break;case 7:return e.next=9,w({variables:{objects:[c]}});case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),L=[{hidden:!0},{hidden:!0},{text:"Name"},{hidden:!y("admin"),formatter:function(e){var n=e.row,t=-1===x.findIndex((function(e){return e.sla.id===n.id&&!e.inUse})),r=P||R;return(0,$.jsx)(m.Z,{context:"secondary",disabled:r||I&&(null===I||void 0===I?void 0:I.find((function(e){return e.sla.id===n.id&&!e.inUse}))),size:"sm",onToggle:function(e){return N(n.id,e)},toggled:t})},text:"In Use"},{text:"Normal Rate",sortable:!0,sortName:"normalRate"},{text:"Out Of Hours Rate",sortable:!0,sortName:"oohRate"},{text:"Premium Rate",sortable:!0,sortName:"premiumRate"},{text:"On Site"},{text:"Job Report"},{text:"Completion"},{text:"Notes"},{hidden:!y("admin"),formatter:function(e){var n=e.row;return(0,p.Z)({row:n,data:[{context:"secondary",disabled:I&&!(null!==I&&void 0!==I&&I.find((function(e){return e.sla.id===n.id&&e.inUse}))),icon:["fas","edit"],onClick:k,tooltip:"Edit"}]})},text:"Actions"}];return(0,$.jsx)(v.Z,{open:!0,title:"SLAs",children:(0,$.jsx)(f.Z,{columns:L,loading:O,rows:j.filter((function(e){return"active"===e.status})).map((function(e){var n=x.find((function(n){return n.slaId===e.id}));return{data:e,id:e.id,name:e.name,toggle:"",normalRate:parseFloat(null!==n&&void 0!==n&&n.normalRate?n.normalRate:e.normalRate).toFixed(1)+"x"||0,oohRate:parseFloat(null!==n&&void 0!==n&&n.oohRate?n.oohRate:e.oohRate).toFixed(1)+"x"||0,premiumRate:parseFloat(null!==n&&void 0!==n&&n.premiumRate?n.premiumRate:e.premiumRate).toFixed(1)+"x"||0,onSite:null!==n&&void 0!==n&&n.onSite?"".concat(n.onSite," ").concat(n.onSiteUnit):e.onSite?"".concat(e.onSite," ").concat(e.onSiteUnit):"-",jobReport:null!==n&&void 0!==n&&n.jobReport||e.jobReport?"".concat(e.jobReport," ").concat(e.jobReportUnit):"-",completion:null!==n&&void 0!==n&&n.completion?"".concat(n.completion," ").concat(n.completionUnit):e.completion?"".concat(e.completion," ").concat(e.completionUnit):"-",notes:(null===n||void 0===n?void 0:n.notes)||e.notes||"-",actions:""}}))})})}},35450:function(e,n,t){t.d(n,{r:function(){return g}});var r=t(92809),o=t(80318),i=t(67294),a=t(42593),c=t(78215),s=t(2356),d=t(65375),u=t(93515),l=t(55148),m=t(95146),p=t(76800),v=t(83894),f=t(24237),b=t(85893);function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function h(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?y(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):y(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var g=function(e){var n=e.control,t=e.errors,r=e.initialValues,u=e.register,f=e.setFilters,y=e.setValue,g=e.watch,x=(0,i.useContext)(a.Z).hasRole,I={control:n,errors:t,register:u},O=g("customerId"),_=g("supplierId"),Z=g("startDate"),S=!r.customerId;(0,i.useEffect)((function(){var e=w.filter((function(e){return"quoteOffered"===e.value})),n=(0,o.Z)(e,1)[0];f((function(e){return h(h({},e),{},{status:Z?[n.value]:null})})),y("status",Z?[n]:null)}),[Z]);var w=l.iz.map((function(e){return x("supplier")?{label:e.supplierText,value:e.value}:x("customer")?{label:e.customerText,value:e.value}:{label:e.text,value:e.value}})).filter((function(e){return null!==e.label}));(0,i.useEffect)((function(){S&&f((function(e){return h(h({},e),{},{customerId:(null===O||void 0===O?void 0:O.value)||null})}))}),[O]),(0,i.useEffect)((function(){S&&f((function(e){return h(h({},e),{},{supplierId:(null===_||void 0===_?void 0:_.value)||null})}))}),[_]);return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(c.Z,{children:[(0,b.jsx)(s.Z,{md:6,children:(0,b.jsx)(p.M,h(h({},I),{},{name:"startDate",onChange:function(e){f((function(n){return h(h({},n),{},{startDate:e||null})})),y("startDate",e)},placeholder:"Quote offered date"}))}),(0,b.jsx)(s.Z,{md:6,children:(0,b.jsx)(p.M,h(h({},I),{},{name:"endDate",onChange:function(e){var n=e?(0,v.Z)(e):e;f((function(e){return h(h({},e),{},{endDate:n})})),y("endDate",n)},placeholder:"Quote due date"}))})]}),(0,b.jsxs)(c.Z,{align:"baseline",children:[(0,b.jsx)(s.Z,{md:6,children:(0,b.jsx)(d.Z,{label:null,children:(0,b.jsx)(j,h(h({},I),{},{isDisabled:Boolean(Z),placeholder:"Select status",name:"status",isMulti:Boolean(!Z),onChange:function(e){var n=e.map((function(e){return e.value}));f((function(e){return h(h({},e),{},{status:n.length>0?n:null})})),y("status",e)},options:w}))})}),!x(["customer","supplier"])&&(0,b.jsx)(s.Z,{md:6,children:(0,b.jsx)(m.P,h(h({},I),{},{label:"",name:"customerId",placeholder:"Select customer",isClearable:!0,type:"customer"}))})]}),!x(["supplier","customer"])&&!Z&&(0,b.jsx)(c.Z,{children:(0,b.jsx)(s.Z,{md:6,children:(0,b.jsx)(m.P,h(h({},I),{},{label:"",name:"supplierId",isClearable:!0,placeholder:"Select supplier",type:"supplier"}))})})]})},j=(0,f.ZP)(u.Z).withConfig({displayName:"filter__StyledSelect",componentId:"sc-18vz0yz-0"})(["div > div > div{background:",";}div > div{background:",";}"],(function(e){return e.isDisabled&&"#dddddd"}),(function(e){return e.isDisabled&&"#dddddd"}))},37415:function(e,n,t){t.d(n,{v:function(){return re}});var r,o,i,a,c,s,d=t(83789),u=t(80318),l=t(92809),m=t(67294),p=t(11163),v=t(93633),f=t(38460),b=t(57460),y=t.n(b),h=t(80880),g=t(29444),j=t(80285),x=t(18862),I=t(91126),O=t(58448),_=t(22796),Z=t(14347),S=t(55657),w=t(80284),$=t(52209),P=t(54397),D=t(76585),q=t(38478),A=t(88402),R=(0,P.Ps)(r||(r=(0,$.Z)(["\n  fragment QuoteFields on Job {\n    quoteNumber\n    quoteDue\n    quoteCharge\n  }\n"]))),C=((0,P.Ps)(o||(o=(0,$.Z)(["\n  query Quote($id: Int!) {\n    job: Job_by_pk(id: $id) {\n      id\n      title\n      description\n      costCategory\n      status\n      workStatus\n      scheduledAt\n      createdAt\n      customerId\n      customerUserId\n      locationId\n      managerId\n      parentId\n      serviceId\n      slaId\n      tenantId\n      reference\n      amount\n      accountByTenantid {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        media: Media {\n          id\n          medium: Medium {\n            id\n            category\n            filename\n            meta\n            type\n          }\n        }\n        manager: Manager {\n          id\n          fullName\n        }\n      }\n      customer: Account {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        media: Media {\n          id\n          medium: Medium {\n            id\n            category\n            filename\n            meta\n            type\n          }\n        }\n        manager: Manager {\n          id\n          fullName\n        }\n      }\n      customerUser: CustomerUser {\n        id\n        name: nameFirst\n        nameFirst\n        nameLast\n        phone\n        status\n        email\n        createdAt\n        fullName\n        accounts: Account_Users {\n          id\n          role\n          position\n          isContact\n          status\n          account: Account {\n            id\n            name\n            type\n          }\n        }\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        vat\n      }\n      location: Location {\n        id\n        access\n        createdAt\n        name\n        contactUserId\n      }\n      messages: Messages {\n        id\n        message\n        priority\n        taskId\n        jobId\n        locationId\n        description\n      }\n      service: Service {\n        id\n        name\n        countryId\n        currencyId\n      }\n      supplier: Suplier {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        media: Media {\n          id\n          medium: Medium {\n            id\n            category\n            filename\n            meta\n            type\n          }\n        }\n        manager: Manager {\n          id\n          fullName\n        }\n      }\n      manager: Manager {\n        id\n        name: nameFirst\n        nameFirst\n        nameLast\n        phone\n        status\n        email\n        createdAt\n        fullName\n        accounts: Account_Users {\n          id\n          role\n          position\n          isContact\n          status\n          account: Account {\n            id\n            name\n            type\n          }\n        }\n      }\n      timings: JobTimings {\n        id\n        status\n        createdAt\n      }\n    }\n  }\n"]))),t(27834)),k=(0,P.Ps)(i||(i=(0,$.Z)(["\n  query GetQuotes(\n    $endDate: timestamptz\n    $number: String\n    $limit: Int\n    $offset: Int\n    $orderBy: Job_order_by!\n    $q: String\n    $startDate: timestamptz\n    $status: [String!]\n    $type: String\n  ) {\n    quotes: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        _and: [\n          {\n            _or: [\n              { description: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Customer: { name: { _ilike: $q } } }\n              { CustomerUser: { email: { _ilike: $q } } }\n              { Supplier: { name: { _ilike: $q } } }\n              { SupplierUser: { email: { _ilike: $q } } }\n              { Location: { name: { _ilike: $q } } }\n              { Taxonomy: { Taxonomy: { name: { _ilike: $q } } } }\n            ]\n          }\n        ]\n        createdAt: { _gte: $startDate }\n        quoteDue: { _lte: $endDate }\n        number: { _eq: $number }\n        status: { _in: $status }\n        quoted: { _eq: true }\n        type: { _eq: $type }\n      }\n      order_by: [$orderBy]\n    ) {\n      ...JobFields\n      ...JobSupplierFields\n      ...QuoteFields\n      quotations: SupplierQuotes {\n        id\n        createdAt\n        jobId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        updatedAt\n        siteVisitAt\n        supplier: Supplier {\n          ...AccountFields\n        }\n      }\n      location: Location {\n        id\n        name\n      }\n      service: Service {\n        id\n        name\n      }\n      timings: JobTimings {\n        id\n        status\n        notes\n        createdAt\n        user: User {\n          ...UserFields\n        }\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        _and: [\n          {\n            _or: [\n              { description: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { Customer: { name: { _ilike: $q } } }\n              { CustomerUser: { email: { _ilike: $q } } }\n              { Supplier: { name: { _ilike: $q } } }\n              { SupplierUser: { email: { _ilike: $q } } }\n              { Location: { name: { _ilike: $q } } }\n              { Taxonomy: { Taxonomy: { name: { _ilike: $q } } } }\n            ]\n          }\n        ]\n        createdAt: { _gte: $startDate }\n        quoteDue: { _lte: $endDate }\n        number: { _eq: $number }\n        status: { _in: $status }\n        quoted: { _eq: true }\n        type: { _eq: $type }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),D.z,q.aL,R,q.H_,C.Px),N=(0,P.Ps)(a||(a=(0,$.Z)(["\n  query GetQuotes(\n    $customerId: Int\n    $date: timestamptz\n    $endDate: timestamptz\n    $number: String\n    $limit: Int\n    $locationId: Int\n    $managerId: Int\n    $offset: Int\n    $orderBy: Job_order_by!\n    $q: String\n    $startDate: timestamptz\n    $status: [String!]\n    $supplierId: Int\n    $type: String\n  ) {\n    quotes: Job(\n      limit: $limit\n      offset: $offset\n      where: {\n        _and: [\n          {\n            _or: [\n              { description: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { Customer: { name: { _ilike: $q } } }\n              { CustomerUser: { email: { _ilike: $q } } }\n              { Supplier: { name: { _ilike: $q } } }\n              { SupplierUser: { email: { _ilike: $q } } }\n              { Location: { name: { _ilike: $q } } }\n              { Taxonomy: { Taxonomy: { name: { _ilike: $q } } } }\n            ]\n          }\n        ]\n        createdAt: { _gte: $startDate }\n        quoteDue: { _lte: $endDate }\n        status: { _in: $status }\n        type: { _eq: $type }\n        number: { _eq: $number }\n        customerId: { _eq: $customerId }\n        locationId: { _eq: $locationId }\n        managerId: { _eq: $managerId }\n        supplierId: { _eq: $supplierId }\n        quoted: { _eq: true }\n      }\n      order_by: [$orderBy]\n    ) {\n      ...JobFields\n      ...JobAdminFields\n      ...QuoteFields\n      statusLog\n      quotations: SupplierQuotes {\n        id\n        createdAt\n        jobId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        updatedAt\n        siteVisitAt\n        supplier: Supplier {\n          ...AccountFields\n        }\n        lineItems: SupplierQuoteLineItems {\n          id\n          total\n        }\n      }\n      supplier: Supplier {\n        ...AccountFields\n      }\n      admin: Admin {\n        id\n        name\n      }\n      customer: Customer {\n        ...AccountFields\n      }\n      location: Location {\n        id\n        name\n      }\n      manager: Manager {\n        ...UserFields\n      }\n      service: Service {\n        id\n        name\n      }\n      timings: JobTimings {\n        id\n        status\n        notes\n        createdAt\n        user: User {\n          ...UserFields\n        }\n      }\n    }\n    meta: Job_aggregate(\n      where: {\n        _and: [\n          {\n            _or: [\n              { description: { _ilike: $q } }\n              { number: { _ilike: $q } }\n              { reference: { _ilike: $q } }\n              { title: { _ilike: $q } }\n              { Customer: { name: { _ilike: $q } } }\n              { CustomerUser: { email: { _ilike: $q } } }\n              { Supplier: { name: { _ilike: $q } } }\n              { SupplierUser: { email: { _ilike: $q } } }\n              { Location: { name: { _ilike: $q } } }\n              { Taxonomy: { Taxonomy: { name: { _ilike: $q } } } }\n            ]\n          }\n        ]\n        createdAt: { _gte: $startDate }\n        quoteDue: { _lte: $endDate }\n        number: { _eq: $number }\n        status: { _in: $status }\n        customerId: { _eq: $customerId }\n        locationId: { _eq: $locationId }\n        managerId: { _eq: $managerId }\n        supplierId: { _eq: $supplierId }\n        quoted: { _eq: true }\n        type: { _eq: $type }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n  ","\n  ","\n  ","\n  ","\n  ","\n  ","\n"])),D.z,A.WW,q.aL,q.wd,R,C.Px),L=((0,P.Ps)(c||(c=(0,$.Z)(["\n  query getFinancialList(\n    $adminId: Int!\n    $customerId: Int\n    $invoiceNumber: jsonb\n    $jobId: String\n    $jobEndDate: timestamptz\n    $jobStartDate: timestamptz\n    $limit: Int\n    $managerId: Int\n    $locationId: Int\n    $offset: Int\n    $paymentStartDate: timestamptz\n    $paymentEndDate: timestamptz\n    $supplierId: Int\n  ) {\n    getFinancialList(\n      adminId: $adminId\n      customerId: $customerId\n      invoiceNumber: $invoiceNumber\n      jobId: $jobId\n      jobEndDate: $jobEndDate\n      jobStartDate: $jobStartDate\n      limit: $limit\n      managerId: $managerId\n      locationId: $locationId\n      offset: $offset\n      paymentStartDate: $paymentStartDate\n      paymentEndDate: $paymentEndDate\n      supplierId: $supplierId\n    ) {\n      jobFinancial\n      meta\n      __typename\n    }\n  }\n"]))),(0,P.Ps)(s||(s=(0,$.Z)(['\n  query GetDashboardList(\n    $accountId: Int\n    $adminId: Int\n    $customerId: Int\n    $supplierId: Int\n    $number: String\n    $asAt: timestamptz\n    $jobHoldReasonId: Int\n    $limit: Int\n    $monthStart: timestamptz\n    $offset: Int\n    $orderBy: dashboard_home_details_order_by!\n    $q: String\n    $tileName: String\n    $dayStart: timestamptz\n    $userId: Int\n    $status: [String!]\n    $yearStart: timestamptz\n    $type: String\n  ) {\n    quotes: getDashboard_HomeTile_Details(\n      args: {\n        accountId: $accountId\n        adminId: $adminId\n        asAt: $asAt\n        jobHoldReasonId: $jobHoldReasonId\n        monthStart: $monthStart\n        tileName: $tileName\n        dayStart: $dayStart\n        userId: $userId\n        yearStart: $yearStart\n      }\n      where: {\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { description: { _ilike: $q } }\n              { customerName: { _ilike: $q } }\n              { serviceName: { _ilike: $q } }\n              { assignedTo: { _ilike: $q } }\n              { supplierName: { _ilike: $q } }\n              { location: { _ilike: $q } }\n              { number: { _ilike: $q } }\n            ]\n          }\n        ]\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        number: { _eq: $number }\n        status: { _in: $status }\n        Job: { type: { _eq: $type } }\n      }\n      order_by: [$orderBy]\n      limit: $limit\n      offset: $offset\n    ) {\n      Assets(where: { entity: { _eq: "Job" } }) {\n        id\n        assetId\n        __typename\n      }\n      ...JobFields\n      ...JobAdminFields\n      admin: Admin {\n        id\n        name\n        __typename\n      }\n      customer: Customer {\n        ...AccountFields\n        __typename\n      }\n      location: Location {\n        id\n        name\n        __typename\n      }\n      manager: Manager {\n        ...UserFields\n        __typename\n      }\n      service: Service {\n        id\n        name\n        __typename\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n          __typename\n        }\n        __typename\n      }\n      sla: SLA {\n        id\n        name\n        __typename\n      }\n      supplier: Supplier {\n        ...AccountFields\n        __typename\n      }\n      supplierOffers: SupplierOffers {\n        status\n        rate\n        supplier: Supplier {\n          ...AccountFields\n          __typename\n        }\n        __typename\n      }\n      job: Job {\n        type\n      }\n      timings: JobTimings(order_by: { createdAt: asc }) {\n        id\n        status\n        createdAt\n        user: User {\n          ...UserFields\n          __typename\n        }\n        __typename\n      }\n      quotations: SupplierQuotes {\n        id\n        createdAt\n        jobId\n        methodStatement\n        notes\n        quoteNumber\n        startDate\n        status\n        totalDuration\n        totalDurationUnit\n        updatedAt\n        siteVisitAt\n        supplier: Supplier {\n          ...AccountFields\n        }\n      }\n      id: jobId\n      number\n      # location\n      priority\n      scheduledAt\n      assignedTo\n      jobHoldReason\n      locationId\n      meta\n      managerId\n      description\n      customerName\n      customerId\n      reference\n      serviceName\n      status\n      supplierId\n      supplierName\n      timingStart\n      type\n      quoteNumber\n      quoteDue\n      createdAt\n    }\n    meta: getDashboard_HomeTile_Details_aggregate(\n      args: {\n        accountId: $accountId\n        adminId: $adminId\n        asAt: $asAt\n        jobHoldReasonId: $jobHoldReasonId\n        monthStart: $monthStart\n        tileName: $tileName\n        dayStart: $dayStart\n        userId: $userId\n        yearStart: $yearStart\n      }\n      where: {\n        _and: [\n          {\n            _or: [\n              { reference: { _ilike: $q } }\n              { description: { _ilike: $q } }\n              { customerName: { _ilike: $q } }\n              { serviceName: { _ilike: $q } }\n              { assignedTo: { _ilike: $q } }\n              { supplierName: { _ilike: $q } }\n              { location: { _ilike: $q } }\n              { number: { _ilike: $q } }\n            ]\n          }\n        ]\n        customerId: { _eq: $customerId }\n        supplierId: { _eq: $supplierId }\n        number: { _eq: $number }\n        status: { _in: $status }\n        Job: { type: { _eq: $type } }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n        __typename\n      }\n      __typename\n    }\n  }\n  ',"\n  ","\n  ","\n  ","\n  ","\n"])),D.z,A.WW,q.aL,q.wd,C.Px)),T=t(83894),E=t(23855);function F(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function U(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?F(Object(t),!0).forEach((function(n){(0,l.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):F(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var J=t(81185),M=t(55148),z=t(80937),H=t(65570),B=t(1323),V=t(78586),Q=t(42772),G=t(49705),W=t(91110),X=t(99362),Y=t(13304),K=t(24237),ee=t(85893);function ne(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function te(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ne(Object(t),!0).forEach((function(n){(0,l.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ne(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var re=function(e){var n,t,r,o=e.filters,i=(0,m.useContext)(h.Z),a=(0,V.q)(),c=(0,p.useRouter)().query,s=(0,m.useState)(!1),l=s[0],b=s[1],$=null===(n=a.admin.jobSetting)||void 0===n?void 0:n.jobNumberPrefix,P=null===(t=a.admin.jobSetting)||void 0===t?void 0:t.jobNumberSuffix,D=(0,B.x)(),q=D.hasRole,A=D.user,R=(0,G.x)({filters:o}),C=R.initialData,F=R.ref,K=te(te({},C),{},{managerId:o.managerId?A.id:null,number:C.id?String(C.id):null}),ne=new Date(c.asAt)||new Date,re=(0,m.useState)({monthStart:(0,X.X)(ne).monthStart,todayEnd:(0,X.X)(ne).todayEnd,todayStart:(0,X.X)(ne).todayStart,yearStart:(0,X.X)(ne).yearStart,asAt:c.asAt}),ce=re[0],se=re[1];(0,m.useEffect)((function(){var e=(0,X.X)(ne),n=e.monthStart,t=e.todayEnd,r=e.todayStart,o=e.yearStart;se({monthStart:n,todayEnd:t,todayStart:r,yearStart:o,asAt:c.asAt})}),[null===o||void 0===o?void 0:o.asAt]);var de=function(e,n,t,r){var o=e.limit,i=e.offset,a=e.orderBy,c=e.q,s=e.status;if(t.hasOwnProperty("tileName"))return{query:L,variables:U({q:null,accountId:null,userId:null,currentUserId:null===n||void 0===n?void 0:n.id,asAt:(0,T.Z)((0,E.Z)(r.asAt)),tileName:null===t||void 0===t?void 0:t.tileName,limit:50,offset:0,orderBy:{jobId:"desc"},monthStart:r.monthStart,dayStart:r.todayStart,yearStart:r.yearStart,adminId:null===n||void 0===n?void 0:n.adminId},e)};switch(n.accountType){case"supplier":return{query:k,variables:U({limit:o,offset:i,orderBy:a,q:c,status:s},e)};default:return{query:N,variables:U({},e)}}}(K,A,c,ce),ue=de.query,le=de.variables;"Accepted"===le.status?(le.type="reactive",delete le.status):delete le.type;var me=(0,v.a)(ue,{variables:le}),pe=me.data,ve=(pe=void 0===pe?{quotes:[],meta:{aggregate:{totalCount:0}}}:pe).quotes,fe=pe.meta,be=me.loading,ye=me.refetch,he=(0,f.t)(ue,{variables:te(te({},le),{},{limit:(null===fe||void 0===fe||null===(r=fe.aggregate)||void 0===r?void 0:r.totalCount)||150}),onCompleted:function(e){var n=e.quotes;if(l){var t=y().unparse(Ae(n,!0)),r="data:application/octet-stream,"+encodeURIComponent(t);(0,Q.S)(r,"quotes.csv"),b(!1)}},skip:!0}),ge=(0,u.Z)(he,2),je=ge[0],xe=ge[1].loading,Ie=void 0===xe||xe,Oe=function(){ye(),i.close()},_e=function(e){e.stopPropagation(),je(),b(!0)},Ze={content:"Edit",context:"secondary",icon:["fas","edit"],onClick:function(e,n){e.stopPropagation(),p.default.push("/dashboard/issues/manage?id=".concat(n.number,"&quoted=1"))},tooltip:"Edit"},Se={context:"info",icon:["fas","receipt"],onClick:function(e,n){return function(e){var n=e.e,t=e.row;n.stopPropagation(),i.show({content:(0,ee.jsx)(W.m,{onSuccess:Oe,quotationId:t.quotationsId}),title:"Quotation",width:"50%"})}({e:e,row:n})},tooltip:"Fill quotation"},we={context:"secondary",icon:["fas","receipt"],onClick:function(e,n){return p.default.push("/dashboard/issues/view?id=".concat(n.number))},tooltip:"info"},$e=[{sortable:!0,text:"ID",sortName:"id",formatter:function(e){var n=e.row;return(0,ee.jsx)(H.D,{id:n.id,number:n.number,numberPrefix:$,numberSuffix:P,status:n.status,openCanvas:!0,type:n.type,isQuote:n.quoted})}},{text:"Creator"},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{hidden:!0},{formatter:function(e){var n=e.row;return(0,ee.jsx)(ee.Fragment,{children:(0,ee.jsx)(ie,{children:n.type})})},text:"Type",sortName:"type"},{formatter:function(e){var n=e.row;return(0,ee.jsx)(ee.Fragment,{children:(0,ee.jsx)(ie,{children:n.description})})},text:"Description"},{sortable:!0,hidden:!q("admin"),formatter:(0,g.Z)("/dashboard/users/view","managerId","manager"),sortName:'{"Manager": {"nameFirst": "ORDER"}}',text:"Assigned to"},{sortable:!0,hidden:!q(["admin","customer"]),formatter:(0,g.Z)("/dashboard/properties/view","propertyId","location"),text:"Location",sortName:'{"Location": {"name": "ORDER"}}'},{sortable:!0,hidden:q(["admin","customer"]),text:"Location",sortName:'{"Location": {"name": "ORDER"}}'},{sortable:!0,hidden:!q("admin"),formatter:(0,g.Z)("/dashboard/customers/view","customerId","customer"),text:"Customer",sortName:'{"Customer": {"name": "ORDER"}}'},{sortable:!0,hidden:!q("admin")&&!q("supplier"),formatter:(0,g.Z)("/dashboard/suppliers/view","supplierId","acceptSupplier"),text:"Accepted Supplier",sortName:'{"Supplier": {"name": "ORDER"}}'},{sortable:!0,hidden:!q("admin")&&!q("supplier"),formatter:function(e){var n,t=e.row;e.data;return(0,ee.jsx)(ee.Fragment,{children:(null===t||void 0===t||null===(n=t.offeredSupplier)||void 0===n?void 0:n.length)>0?(0,ee.jsx)(ee.Fragment,{children:((null===t||void 0===t?void 0:t.offeredSupplier)||[]).map((function(e){var n;return(0,ee.jsx)(oe,{onClick:function(n){var t;return Pe(n,null===e||void 0===e||null===(t=e.supplier)||void 0===t?void 0:t.id)},children:null===e||void 0===e||null===(n=e.supplier)||void 0===n?void 0:n.name})}))}):"-"})},text:"Offered Supplier",sortName:'{"Supplier": {"name": "ORDER"}}'},{hidden:!q("admin"),text:"Quotations"},{hidden:!q("admin")&&!q("supplier"),text:"Received"},{hidden:!q("admin"),text:"Quotations Range (if multiple)",formatter:function(e){var n=e.row.range;return n?(0,ee.jsxs)(ee.Fragment,{children:[(0,ee.jsxs)(ae,{children:["high: ",(0,j.Z)(n.high)]}),(0,ee.jsxs)(ae,{children:["low:\xa0 ",(0,j.Z)(n.low)]})]}):"-"}},{sortable:!0,text:"Quote Due",sortName:"quoteDue",formatter:function(e){var n=e.row,t=(0,x.Z)(new Date),r="Quote"===n.type,o=n.status.includes("quoteSent");return r&&n.due<t&&!o?(0,ee.jsxs)(ee.Fragment,{children:[(0,ee.jsx)(Y.Z,{color:"error"})," ",n.due]}):n.due}},{text:"Scheduled",sortable:!0,sortName:"scheduledAt"},{text:"Created",sortable:!0,sortName:"createdAt"},{formatter:function(e){var n=e.row;return(null===n||void 0===n?void 0:n.offeredSupplier.length)>0&&null!==n&&void 0!==n&&n.offeredSupplier.every((function(e){return"quotationRejected"===e.status}))?"Rejected":n.statusText},text:"Status",sortable:!0,sortName:"status"},{hidden:!0},{hidden:!0},{formatter:I.Z,formatterData:function(e){var n=[];return q("admin")&&n.push(Ze),q("admin")&&n.push(we),(q("admin")||q("supplier"))&&"quoteOffered"===e.status&&n.push(Se),n},text:"Actions"}],Pe=function(e,n){e.stopPropagation(),p.default.push("/dashboard/suppliers/view?id=".concat(n))},De=function(e){e.stopPropagation(),p.default.push("/dashboard/issues/manage?quoted=1")},qe=function(e){var n=null;if(e.length>1){var t=e.map((function(e){var n;return null===(n=e.lineItems)||void 0===n?void 0:n.reduce((function(e,n){return e+(n.total||0)}),0)}));n={high:Math.max.apply(Math,(0,d.Z)(t||[])),low:Math.min.apply(Math,(0,d.Z)(t||[]))}}return n},Ae=function(e,n){return e.map((function(e){var t,r,o,i,a,c,s,u,l,m,p,v,f,b,y=(0,d.Z)(M.iz).find((function(n){return n.value===e.status}))||{text:"Accepted"},h=y.text,g=y.supplierText,j=y.customerText,I=((0,d.Z)(z.x).find((function(n){return n.value===e.type}))||{text:"Quote"}).text,O=e.manager?"".concat(e.manager.nameFirst," ").concat(e.manager.nameLast):"Unassigned",_=e.scheduledAt?(0,x.Z)(e.scheduledAt,!0):"-";return{id:e.id,creator:(null===e||void 0===e||null===(t=e.timings[0])||void 0===t||null===(r=t.user)||void 0===r?void 0:r.fullName)||"-",description:null!==e&&void 0!==e&&e.description?null===e||void 0===e?void 0:e.description:"-",number:e.number,type:I,status:e.status,propertyId:null===(o=e.location)||void 0===o?void 0:o.id,managerId:null===(i=e.manager)||void 0===i?void 0:i.id,customerId:null===(a=e.customer)||void 0===a?void 0:a.id,supplierId:e.supplier?e.supplier.id:"",siteVisitStart:e.siteVisitStart,siteVisitEnd:e.siteVisitEnd,siteVisitWeekends:e.siteVisitWeekends,service:(null===(c=e.service)||void 0===c?void 0:c.name)||"-",manager:O,location:(null===(s=e.location)||void 0===s?void 0:s.name)||"-",property:(null===(u=e.location)||void 0===u?void 0:u.name)||"-",customer:(null===(l=e.customer)||void 0===l?void 0:l.name)||"-",acceptSupplier:e.supplier?e.supplier.name:"-",offeredSupplier:(null===e||void 0===e||null===(m=e.quotations)||void 0===m?void 0:m.length)>0?(b=e.quotations,n?b.map((function(e){var n;return null===e||void 0===e||null===(n=e.supplier)||void 0===n?void 0:n.name})).join(" / "):b):[],quotations:"".concat((null===(p=e.quotations)||void 0===p?void 0:p.length)||0,"/").concat(e.quoteNumber),received:"".concat(null===(v=e.quotations||[])||void 0===v?void 0:v.reduce((function(e,n){return"supplierQuoteComplete"===n.status?e+1:e}),0),"/").concat((null===(f=e.quotations)||void 0===f?void 0:f.length)||0),range:qe(e.quotations),due:(0,x.Z)(e.quoteDue),scheduleDate:_,date:(0,x.Z)(e.createdAt),statusText:q("admin")?h:q("supplier")?g||"Accepted":q("customer")?j||"Accepted":h,quoted:e.quoted||!1,quotationsId:e.quotations[0]&&e.quotations[0].id,actions:""}}))},Re=function(){return(0,ee.jsxs)(O.Z,{children:[(0,ee.jsx)(_.Z,{marginRight:"xs",children:(0,ee.jsx)(Z.Z,{content:"Export to excel",context:"secondary",size:"sm",disabled:Ie,onClick:_e,children:(0,ee.jsx)(S.Z,{context:"white",icon:"file-csv",size:"lg"})})}),q("admin")&&(0,ee.jsx)(Z.Z,{context:"secondary",content:"Add Quote",onClick:De,size:"sm"})]})};return(0,ee.jsx)(w.Z,{toolbar:(0,ee.jsx)(Re,{}),open:!0,title:"Quotes",children:(0,ee.jsx)(J.t,{columns:$e,loading:be,meta:fe,ref:F,refetch:ye,rowClick:function(e){p.default.push("/dashboard/issues/view?id=".concat(e.number))},rows:Ae(ve)})})},oe=K.ZP.button.withConfig({displayName:"table__LinkWrapper",componentId:"sc-1opq252-0"})(["cursor:pointer;margin:2px 0px;padding:8px 5px;color:rgb(41,41,204);background-color:transparent;border:none;&:hover{background-color:#dddddd;border-radius:5px;}"]),ie=K.ZP.div.withConfig({displayName:"table__StyledLink",componentId:"sc-1opq252-1"})(["line-height:1.5em;height:3em;overflow:hidden;"]),ae=K.ZP.div.withConfig({displayName:"table__DivWrapper",componentId:"sc-1opq252-2"})(["white-space:nowrap;"]);re.defaultProps={filters:{customerId:null,date:null,managerId:!1,q:null,status:null,supplierId:null,filterType:"quotes_table"}}},9273:function(e,n,t){t.d(n,{r:function(){return _}});var r=t(92809),o=t(80318),i=t(67294),a=t(11163),c=t(75709),s=t(7802),d=t(43045),u=t(5597),l=t(58448),m=t(14347),p=t(18944),v=t(22796),f=t(80284),b=t(93443),y=t(66805),h=t(38099),g=t(1323),j=t(68343),x=t(85893);function I(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function O(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?I(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):I(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var _=function(e){var n=e.jobs,t=e.location,r=e.offCanvas,I=e.refetch,_=e.row,Z=e.showCreateJobButton,S=(0,g.x)(),w=S.hasRole,$=S.user,P=(0,c.D)(s.mJ,{onCompleted:function(e){I()}}),D=(0,o.Z)(P,1)[0];n.sort((function(e,n){return e.timingStart>n.timingStart?1:n.timingStart>e.timingStart?-1:0}));var q=n.filter((function(e){return new Date(e.timingStart)<new Date})).length,A=q>0?"(".concat(q," Past Occurrence)"):"",R=n.length,C=function(e){var n=e.job;return(0,x.jsxs)(l.Z,{children:[(0,x.jsx)(m.Z,{content:(0,j.B)({value:n.status,textColor:"white"}),context:"dark",size:"sm"}),(0,x.jsx)(m.Z,O(O({},{context:"secondary",size:"sm",startIconProps:{size:"lg"}}),{},{onClick:function(e){return function(e,n){e.stopPropagation(),r.close(),a.default.push("/dashboard/issues/view?id=".concat(n))}(e,n.number)},startIcon:"eye"}))]})};return R<=0&&Z?(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(p.Z,{children:"No jobs have been created as yet"}),(0,x.jsx)(y.H,{content:"Create Jobs",context:"primary",handleClick:function(){var e;e=w("admin")?$.accountId:$.adminId||1,I(),r.close(),(0,h.U$)({addJobFunc:D,location:t,row:_,adminId:e})},size:"md"})]}):(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(p.Z,{children:"".concat(R," Future Occurrences ").concat(A)}),(0,x.jsx)(v.Z,{}),n.map((function(e,n){var t,r;return(0,x.jsxs)(i.Fragment,{children:["".concat((0,d.Z)(new Date(e.timingStart),{addSuffix:!0})," - ").concat((0,u.Z)(new Date(e.timingStart),"LLL do yyyy")),(0,x.jsxs)(f.Z,{context:e.rag||"primary",open:n===q,title:"".concat(e.number," - ").concat((null===(t=e.shortJobDesc[0])||void 0===t?void 0:t.taxonomy.name)||e.title),toolbar:(0,x.jsx)(C,{job:e}),children:[(0,x.jsx)(b.Z,{content:"Description",text:e.description}),(0,x.jsx)(b.Z,{content:"Supplier",text:null===(r=e.supplier)||void 0===r?void 0:r.name})]},e.id),(0,x.jsx)(v.Z,{marginBottom:"md"})]},n)}))]})};_.defaultProps={showCreateJobButton:!0}},38099:function(e,n,t){t.d(n,{U$:function(){return m},BH:function(){return p},tf:function(){return v},k3:function(){return f},CH:function(){return b},WJ:function(){return y}});var r=t(30266),o=t(64687),i=t.n(o),a=t(7151),c=t(42699),s=t(313),d=t(10928),u=t.n(d),l=t(34112),m=function(){var e=(0,r.Z)(i().mark((function e(n){var t,r,o,c,s,d,u,l,m,p,v,f;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.addJobFunc,o=n.location,c=n.row,s=n.adminId,d=a.Ci.fromString(c.frequency),u=d.all(),l=c.costCustomer,m=c.costSupplier,p=(null===o||void 0===o||null===(t=o.user)||void 0===t?void 0:t.id)||null,v=c.supplier.value,f=[],u.forEach((function(e){var n,t={adminId:s,amount:l,assetId:null===(n=c.asset)||void 0===n?void 0:n.value,costCategoryId:c.costCategory.value,customerId:o.customer[0].account.id,customerUserId:p,description:c.description,jobScheduleId:c.id,locationId:o.id,managerId:o.customer[0].account.managerId,pricing:"fixed",serviceId:c.service.value,source:"other",status:"offered",paymentMethod:"invoice",supplierLabourAmount:m,timing:"at",timingStart:e,title:c.title,type:"ppm",JobTimings:{data:[{status:"raised"},{status:"offered"}]},SupplierOffers:{data:[{status:"offered",accountId:v}]},Taxonomy:{data:[{entity:"Job",taxonomyId:c.shortDescription.value}]}};c.complianceSelect.value&&(t.Compliances={data:{complianceId:c.complianceSelect.value,entity:"Job",status:"active"}}),f.push(t)})),e.t0=(null===f||void 0===f?void 0:f.length)>0,!e.t0){e.next=13;break}return e.next=13,r({variables:{adminId:s,objects:f}});case 13:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),p=function(e){var n=e.scheduledJobs,t={},r={};return n.forEach((function(e){if(e.jobs&&e.jobs.length>0){var n,o,i=e.jobs.find((function(e){return new Date(e.timingStart)>new Date}));((null===i||void 0===i?void 0:i.timingStart)<(null===(n=t)||void 0===n?void 0:n.timingStart)||null===(o=t)||void 0===o||!o.timingStart)&&(t=i)}var c=a.Ci.fromString(e.frequency).all(),s=u()(c);(s<r||!r.date)&&(r.date=s,r.name=e.meta.serviceName)})),{nextExpire:r,nextJob:t}},v=function(e){var n=e.frequency,t=e.cost;return a.Ci.fromString(n).all().length*t},f=function(e){var n,t=e.jobScheduleId,r=e.jobs;return r&&(n=r.filter((function(e){return e.jobScheduleId===t&&(0,l.E)(e,"reportSent")})).length),n||0},b=function(e,n){var t=new Date(e.timingStart);return(0,c.Z)(t,n.startDate)&&(0,s.Z)(t,n.endDate)},y=function(e){var n=e.assetSelected,t=void 0===n?[]:n,r=e.compliance,o=e.service,i=void 0===o?[]:o,a=e.assetCategory,c=e.dateFilter,s={status:{_neq:"canceled"}};return null!==c&&void 0!==c&&c.startDate&&null!==c&&void 0!==c&&c.endDate&&(s.timingStart={_gte:c.startDate,_lte:c.endDate}),(null===t||void 0===t?void 0:t.length)>0&&(s.Assets={id:{_in:t.map((function(e){return e.value}))}}),(null===i||void 0===i?void 0:i.length)>0&&(s.Service={id:{_in:i.map((function(e){return null===e||void 0===e?void 0:e.value}))}}),null!==a&&void 0!==a&&a.value&&(s.AssetCategory={id:{_eq:null===a||void 0===a?void 0:a.value}}),"true"===r&&(s.type={_eq:"cppm"}),s}},7802:function(e,n,t){t.d(n,{Ms:function(){return v},RV:function(){return f},EW:function(){return b},YW:function(){return y},B6:function(){return h},mJ:function(){return g}});var r,o,i,a,c,s,d,u,l,m=t(52209),p=t(54397),v=((0,p.Ps)(r||(r=(0,m.Z)(["\n  query GetAssetParents($ids: [Int!]!) {\n    asset: Asset(where: { id: { _in: $ids } }) {\n      id\n      name\n      parent: ParentAsset {\n        id\n        name\n        parent: ParentAsset {\n          id\n          name\n        }\n      }\n    }\n  }\n"]))),(0,p.Ps)(o||(o=(0,m.Z)(["\n  mutation DeleteJobSchedule($id: Int!) {\n    delete_JobSchedule(where: { id: { _eq: $id } }) {\n      returning {\n        id\n      }\n    }\n  }\n"])))),f=(0,p.Ps)(i||(i=(0,m.Z)(['\n  query GetJobSchedule($orderBy: JobSchedule_order_by!, $locationId: Int) {\n    JobSchedule(where: { locationId: { _eq: $locationId } }, order_by: [$orderBy]) {\n      contractId\n      frequency\n      frequencyDescription\n      id\n      meta\n      paymentMethod\n      assets: Assets {\n        id\n        status\n        entity\n        entityId\n        Asset {\n          name\n          serialNumber\n          id\n        }\n      }\n      media: Media(where: { entity: { _eq: "JobSchedule" } }) {\n        id\n      }\n      contract: JobScheduleContract {\n        name\n        invoiceDate\n        startDate\n        contractLength\n        contractValue\n        status\n      }\n      expenses: Expenses {\n        id\n        paid\n        description\n        amount\n        markup\n        unit\n        vat\n      }\n      jobs: Jobs(where: { status: { _neq: "canceled" } }) {\n        id\n        rag\n        title\n        timingStart\n        shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n          id\n          taxonomyId\n          comments\n          taxonomy: Taxonomy {\n            name\n          }\n        }\n      }\n    }\n    meta: JobSchedule_aggregate(where: { locationId: { _eq: $locationId } }) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),b=(0,p.Ps)(a||(a=(0,m.Z)(['\n  query GetJobSchedule($id: Int!) {\n    jobSchedule: JobSchedule_by_pk(id: $id) {\n      contractId\n      frequency\n      frequencyDescription\n      id\n      meta\n      paymentMethod\n      jobs: Jobs(where: { status: { _neq: "canceled" } }) {\n        id\n        rag\n        title\n        timingStart\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n        shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n          id\n          taxonomyId\n          comments\n          taxonomy: Taxonomy {\n            name\n          }\n        }\n      }\n    }\n  }\n']))),y=(0,p.Ps)(c||(c=(0,m.Z)(['\n  query GetJobCompliance($locationId: Int!, $where: Job_bool_exp!) {\n    jobSchedule: JobSchedule(where: { locationId: { _eq: $locationId } }, order_by: { id: asc }) {\n      id\n      shortDescriptionName: meta(path: "$.shortDescriptionName")\n      serviceName: meta(path: "$.serviceName")\n      costCustomer: meta(path: "$.costCustomer")\n      costSupplier: meta(path: "$.costSupplier")\n      frequency\n      jobs: Jobs(where: $where) {\n        id\n        rag\n        timingStart\n      }\n      totalJobs: Jobs_aggregate {\n        aggregate {\n          count\n        }\n      }\n    }\n  }\n']))),h=(0,p.Ps)(s||(s=(0,m.Z)(['\n  query GetCalendarJobs($locationId: Int!) {\n    jobs: Job(\n      order_by: { timingStart: asc }\n      where: {\n        Location: { id: { _eq: $locationId } }\n        jobScheduleId: { _is_null: false }\n        status: { _neq: "canceled" }\n      }\n    ) {\n      id\n      number\n      title\n      description\n      quoted\n      reference\n      timingStart\n      timingEnd\n      createdAt\n      status\n      jobScheduleId\n      supplierNotes\n      amount\n      supplierLabourAmount\n      rag\n      type\n      timings: JobTimings {\n        id\n        status\n        createdAt\n      }\n      supplier: Supplier {\n        id\n        name\n      }\n      shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n        id\n        taxonomyId\n        comments\n        taxonomy: Taxonomy {\n          name\n        }\n      }\n    }\n  }\n']))),g=((0,p.Ps)(d||(d=(0,m.Z)(["\n  query GetStatusLog($entity: String!, $entityId: Int!) {\n    statusLog: StatusLog(where: { entityId: { _eq: $entityId }, entity: { _eq: $entity } }) {\n      id\n      createdAt\n      notes\n      status\n    }\n  }\n"]))),(0,p.Ps)(u||(u=(0,m.Z)(["\n  mutation AddJob($objects: [Job_insert_input!]!) {\n    insert_Job(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),(0,p.Ps)(l||(l=(0,m.Z)(["\n  mutation MyMutation($objects: [CreateJobInput]!, $adminId: Int!) {\n    createJob(adminId: $adminId, objects: $objects) {\n      data\n    }\n  }\n"]))))},41482:function(e,n,t){t.d(n,{l:function(){return f}});var r=t(92809),o=t(78215),i=t(2356),a=t(46482),c=t(22796),s=t(17044),d=t(27567),u=t(75838),l=t(69399),m=t(85893);function p(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function v(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?p(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var f=function(e){var n=e.errors,t=e.register,r=e.setFilters,p={errors:n,register:t};return(0,m.jsxs)(o.Z,{children:[(0,m.jsxs)(i.Z,{md:6,children:[(0,m.jsx)(a.Z,v(v({},p),{},{name:"countryId",onChange:function(e){return r((function(n){return v(v({},n),{},{countryId:e.target.value||null})}))},options:s.O})),(0,m.jsx)(c.Z,{marginTop:"sm",children:(0,m.jsx)(a.Z,v(v({},p),{},{name:"currencyId",onChange:function(e){return r((function(n){return v(v({},n),{},{currencyId:e.target.value||null})}))},options:d.m}))})]}),(0,m.jsx)(i.Z,{md:6,children:(0,m.jsx)(l.r,v(v({},p),{},{onChange:function(e){return r((function(n){return v(v({},n),{},{status:e.target.value||null})}))},options:u.bg}))})]})}},84619:function(e,n,t){t.d(n,{u:function(){return u}});var r=t(92809),o=t(30266),i=t(64687),a=t.n(i),c=t(55863);function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function d(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){(0,r.Z)(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}var u=function(){var e=(0,o.Z)(a().mark((function e(n){var t,r,o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.invoice,r=d(d({},t),{},{title:"Proforma Invoice"}),o=window.open("/download","_blank"),e.next=5,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/invoice/proforma/create"),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(r)}).then((function(e){return e.json()})).then((function(e){o.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,c.Tb)({message:e,section:"fetch"})}));case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()},27567:function(e,n,t){t.d(n,{m:function(){return r}});var r=[{text:"Currency",value:""},{text:"GBP",value:1},{text:"AUD",value:2},{text:"EUR",value:3}]}}]);