"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1110],{88338:function(t,e,n){n.d(e,{N:function(){return r}});var r=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return[{context:"secondary",icon:["fas","edit"],onClick:e.onEditClick,to:"".concat(t,"manage"),tooltip:"Edit"},{context:"danger",icon:["fas","trash"],onClick:e.onDeleteClick,tooltip:"Delete"}]}},91110:function(t,e,n){n.d(e,{m:function(){return dt}});var r=n(92809),o=n(93633),i=n(23845),a=n(97721),s=n(4513),u=n(30266),c=n(80318),d=n(64687),l=n.n(d),p=n(67294),m=n(30381),f=n.n(m),h=n(75709),b=n(29678),y=n(42283),j=n(79665),v=n(80880),g=n(97202),_=n(78215),x=n(2356),I=n(7720),q=n(14347),Z=n(77417),$=n(65375),w=n(71247),S=n(46482),O=n(83528),A=n(58448),D=n(76800),k=n(50899),T=n(42593),U=n(80285),P=n(24237),C=n(91126),Q=n(11417),L=n(52002),R=n(88338),E=n(34868),M=n(18944),N=n(85893);function F(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function V(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?F(Object(n),!0).forEach((function(e){(0,r.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):F(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var G=function(t){var e=t.editMode,n=t.onSuccess,r=t.rawData,o=t.quotationId,a=(t.setQuote,t.supplierId),s=t.type,d=t.toggleShow,m=(0,p.useContext)(T.Z).hasRole,f=(0,y.cI)({defaultValues:{description:e?r.description:"",qty:e?r.qty:"",qtyUnit:e?r.qtyUnit:"hours",unitRate:e?r.unitRate:"",item:e?r.item:"",total:e?r.total:""}}),b=f.control,j=f.errors,v=f.handleSubmit,I=f.register,A=f.watch,D={control:b,errors:j,register:I},k=A("qty"),P=A("unitRate"),C=A("total"),Q=(0,h.D)(i.Ih,{onCompleted:function(t){var e=t.insert_SupplierQuoteLineItem.returning[0].id;n&&n(e)}}),L=(0,c.Z)(Q,2),R=L[0],F=L[1].loading,G=(0,h.D)(i.EA,{onCompleted:function(t){var e=t.update_SupplierQuoteLineItem_by_pk.id;n&&n(e)}}),J=(0,c.Z)(G,2),z=J[0],H=J[1].loadingUpdate,W=function(){var t=(0,u.Z)(l().mark((function t(n){return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=6;break}return n.supplierTotal=n.qty*n.unitRate,t.next=4,z({variables:{id:null===r||void 0===r?void 0:r.id,changes:n}});case 4:t.next=12;break;case 6:return n.accountId=Number(a),n.type=s,n.quoteId=Number(o),n.supplierTotal=n.qty*n.unitRate,t.next=12,R({variables:{objects:[n]}});case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();return(0,N.jsxs)(g.Z,{handleSubmit:v(W),children:[(0,N.jsx)(_.Z,{children:(0,N.jsx)(x.Z,{md:12,children:(0,N.jsx)($.Z,{label:"Description",children:(0,N.jsx)(O.Z,V(V({},D),{},{name:"description",rows:2}))})})}),(0,N.jsxs)(_.Z,{children:[(0,N.jsx)(x.Z,{md:4,children:(0,N.jsx)($.Z,{label:"Quantity",children:(0,N.jsx)(w.Z,V(V({},D),{},{name:"qty",type:"number"}))})}),"Labour"===s&&(0,N.jsx)(x.Z,{md:4,children:(0,N.jsx)($.Z,{label:"Quantity Unit",children:(0,N.jsx)(S.Z,V(V({},D),{},{name:"qtyUnit",options:[{text:"Hours",value:"hours",disabled:!1},{text:"Days",value:"days",disabled:!1},{text:"Weeks",value:"weeks",disabled:!1}]}))})}),(0,N.jsx)(x.Z,{md:4,children:(0,N.jsx)(E.Z,V(V({},D),{},{label:m("supplier")?"Unit Rate":"Supplier Unit Rate",name:"unitRate",vat:"Ex VAT"}))})]}),(0,N.jsxs)(M.Z,{children:["Supplier Total: ",(0,U.Z)(k*P)]}),(0,N.jsx)(Z.Z,{}),m("admin")&&(0,N.jsxs)(N.Fragment,{children:[(0,N.jsx)(_.Z,{children:(0,N.jsx)(x.Z,{md:12,children:(0,N.jsx)(E.Z,V(V({},D),{},{label:"Customer Unit Rate",name:"total",vat:"Ex VAT"}))})}),(0,N.jsxs)(M.Z,{children:["Customer Total (Labour Item): ",(0,U.Z)(k*C)]}),(0,N.jsx)(Z.Z,{})]}),(0,N.jsxs)(_.Z,{justify:"end",style:{margin:"0 5px"},children:[(0,N.jsx)(q.Z,{content:"Cancel",onClick:d,style:{margin:"0 5px"}}),(0,N.jsx)(q.Z,{content:e?"Save":"Add",disabled:F||H,type:"submit"})]}),(0,N.jsx)("div",{style:{clear:"both"}})]})};G.defaultProps={rawData:{}};var J=function(t){var e=t.quotation,n=t.quotationId,r=t.type,u=t.updateTotal,d=t.readOnly,l=(0,p.useContext)(T.Z).hasRole,m=(0,p.useContext)(v.Z),f=(0,o.a)(i.cu,{variables:{quotationId:n,type:r}}),b=f.data,y=(b=void 0===b?{lineItems:[]}:b).lineItems,j=f.loading,g=f.refetch,_=(0,h.D)(i.nc,{onCompleted:function(t){g()}}),x=(0,c.Z)(_,1)[0];(0,p.useEffect)((function(){u(y)}),[y]);var I=function(){g(),m.close()},Z=function(t,o){var i;m.show({content:(0,N.jsx)(G,{editMode:!(null===o||void 0===o||!o.rawData),onSuccess:I,rawData:null===o||void 0===o?void 0:o.rawData,toggleShow:m.close,quotationId:n,supplierId:null===(i=e.supplier)||void 0===i?void 0:i.id,type:r}),submit:!1,title:"".concat(o?"Edit":"Insert"," ").concat(r," Item")})},$=[{text:"ID",hidden:!0},{text:"Description"},{hidden:!l(["admin","supplier"]),text:"Qty"},{hidden:!l(["admin","supplier"]),text:"Rate"},{hidden:!l(["admin","supplier"]),text:"Supplier Total"},{hidden:!l(["admin","customer"]),text:"Customer Total"},{hidden:!l(["admin","supplier"])||d,formatter:C.Z,formatterData:(0,R.N)("/dashboard/quotes/",{onEditClick:Z,onDeleteClick:function(t,e){x({variables:{id:e.id}})}}),text:"Actions"},{text:"Raw Data",hidden:!0}],w=y.reduce((function(t,e){return t+e.total*e.qty}),0),S=y.reduce((function(t,e){return t+e.supplierTotal}),0);return j?(0,N.jsx)(a.Z,{indicator:(0,N.jsx)(s.Z,{})}):(0,N.jsxs)(N.Fragment,{children:[(0,N.jsx)(Q.Z,{content:(0,N.jsxs)(z,{align:"center",justify:"between",children:[(0,N.jsx)("span",{children:r}),l(["admin","supplier"])&&!d&&(0,N.jsx)(q.Z,{content:"Insert ".concat(r," Item"),context:"secondary",onClick:Z,size:"sm"})]}),tag:"h4"}),(0,N.jsx)(L.Z,{columns:$,rows:y.map((function(t){return{id:t.id,description:t.description,qty:"Labour"===t.type?"".concat(t.qty," ").concat(t.qtyUnit):t.qty,rate:(0,U.Z)(t.unitRate),supplierTotal:(0,U.Z)(t.supplierTotal),total:(0,U.Z)(t.total*t.qty),action:"",rawData:t}}))}),(0,N.jsxs)("div",{style:{textAlign:"right"},children:[l(["admin","supplier"])&&(0,N.jsxs)(H,{children:["Subtotal - ",r," ",l(["admin"])&&"- Supplier",": ",(0,U.Z)(S)]}),l(["admin","customer"])&&(0,N.jsxs)(H,{children:["Subtotal - ",r,": ",(0,U.Z)(w)]})]})]})},z=(0,P.ZP)(_.Z).attrs((function(){return{align:"center",justify:"between"}})).withConfig({displayName:"lineItemTable__StyledRow",componentId:"sc-18sy5kb-0"})(["margin:0 5px;"]),H=P.ZP.p.withConfig({displayName:"lineItemTable__StyledP",componentId:"sc-18sy5kb-1"})(["margin:0;"]);function W(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function B(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?W(Object(n),!0).forEach((function(e){(0,r.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):W(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var X=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1?arguments[1]:void 0;return t.reduce((function(t,n){return t+="total"===e?n[e]*n.qty:n[e]}),0)},K=function(t){var e=t.quotation,n=t.total,o=t.setTotal,i=(t.supplierTotal,t.setSupplierTotal),a=(t.customerTotal,t.setCustomerTotal),s=t.readOnly,u=(0,p.useContext)(T.Z).hasRole,c=function(t,e){return o((function(n){return B(B({},n),{},(0,r.Z)({},t,X(e,"total")))}))},d=function(t,e){return i((function(n){return B(B({},n),{},(0,r.Z)({},t,X(e,"supplierTotal")))}))},l=function(t,e){return a((function(n){return B(B({},n),{},(0,r.Z)({},t,X(e,"total")))}))},m=n.labour+n.materials,f=.2*m,h=m+f;return(0,N.jsxs)(N.Fragment,{children:[(0,N.jsx)(_.Z,{children:(0,N.jsx)(x.Z,{md:12,children:(0,N.jsx)(J,{quotationId:e.id,quotation:e,type:"Labour",updateTotal:function(t){c("labour",t),d("labour",t),l("labour",t)},readOnly:s})})}),(0,N.jsx)(Z.Z,{}),(0,N.jsx)(_.Z,{children:(0,N.jsx)(x.Z,{md:12,children:(0,N.jsx)(J,{quotationId:e.id,quotation:e,type:"Materials",updateTotal:function(t){c("materials",t),d("materials",t),l("materials",t)},readOnly:s})})}),(0,N.jsx)(Z.Z,{}),u(["admin","customer"])&&(0,N.jsx)(_.Z,{children:(0,N.jsxs)(x.Z,{md:12,style:{textAlign:"right"},children:[(0,N.jsxs)("div",{children:["Sub Total: ",(0,U.Z)(m)]}),(0,N.jsxs)("div",{children:["VAT (20%): ",(0,U.Z)(f)]}),(0,N.jsxs)("div",{children:["Total: ",(0,U.Z)(h)]})]})})]})},Y=n(19501),tt=(0,Y.Ry)().shape({totalDuration:(0,Y.Z_)().required(),totalDurationUnit:(0,Y.Z_)().required(),methodStatement:(0,Y.Z_)().required(),startDate:(0,Y.Z_)(),rebate:(0,Y.Z_)(),notes:(0,Y.Z_)()}),et=n(78777);function nt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function rt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?nt(Object(n),!0).forEach((function(e){(0,r.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var ot=function(t){var e,n,r,o,i,a,s,d=t.quotation,m=t.status,T=t.user,U=t.hasRole,P=t.onSuccess,C=(0,p.useContext)(v.Z),Q=null===T||void 0===T||null===(e=T.meta)||void 0===e||null===(n=e.threshold)||void 0===n?void 0:n.quote,L=(0,p.useState)({labour:0,materials:0}),R=L[0],E=L[1],M=(0,p.useState)({labour:0,materials:0}),F=M[0],V=M[1],G=(0,p.useState)({labour:0,materials:0}),J=G[0],z=G[1],H=F.labour+F.materials,W=null===d||void 0===d||null===(r=d.job)||void 0===r||null===(o=r.timings)||void 0===o?void 0:o.find((function(t){return t.quoteId===d.id&&t.status==="".concat("admin"===T.accountType?"adminSupplier":T.accountType,"QuoteThresholdApproval")})),B=null===d||void 0===d||null===(i=d.job)||void 0===i||null===(a=i.timings)||void 0===a?void 0:a.find((function(t){return t.quoteId===d.id&&t.status==="".concat("admin"===T.accountType?"adminSupplier":T.accountType,"QuoteThresholdApproved")})),X=W&&B&&(null===W||void 0===W||null===(s=W.meta)||void 0===s?void 0:s.to)===(null===B||void 0===B?void 0:B.userId),Y=(0,h.D)(b.HI),nt=(0,c.Z)(Y,1)[0],ot=(0,y.cI)({defaultValues:{totalDuration:(null===d||void 0===d?void 0:d.totalDuration)||"",totalDurationUnit:(null===d||void 0===d?void 0:d.totalDurationUnit)||"hour",startDate:null!==d&&void 0!==d&&d.startDate?new Date(d.startDate):"",methodStatement:(null===d||void 0===d?void 0:d.methodStatement)||"",rebate:(null===d||void 0===d?void 0:d.rebate)||"",notes:(null===d||void 0===d?void 0:d.notes)||"",siteVisitAt:null!==d&&void 0!==d&&d.siteVisitAt?new Date(d.siteVisitAt):""},resolver:(0,j.S)(tt)}),it=ot.control,at=ot.errors,st=ot.handleSubmit,ut=ot.register,ct=U("customer")||U("supplier")&&("quotationAccepted"===d.status||"quotationRejected"===d.status||"supplierQuoteSent"===d.status),dt=function(){var t=(0,u.Z)(l().mark((function t(e){var n,r,o,i;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.status="quoteSent"===(null===d||void 0===d?void 0:d.job.status)?"supplierQuoteUpdated":"supplierQuoteComplete",e.startDate&&(e.startDate=f()(e.startDate).format()),t.next=4,nt({variables:{id:d.id,changes:e,recommend:!1}});case 4:n=t.sent,r=n.data.update_SupplierQuote_by_pk,o=r.id,i=r.status,P&&P({id:o,status:i});case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),lt=function(){var t=(0,u.Z)(l().mark((function t(e){return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.status="supplierQuoteDraft",e.startDate&&(e.startDate=f()(e.startDate).format()),t.next=4,nt({variables:{id:d.id,changes:e,recommend:!1}});case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),pt=function(){var t=(0,u.Z)(l().mark((function t(){var e;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(e={}).status="supplierQuoteRefused",t.next=4,nt({variables:{id:d.id,changes:e,recommend:!1}});case 4:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),mt=function(){var t=(0,u.Z)(l().mark((function t(){return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,nt({variables:{changes:{recommended:!0},id:d.id,jobId:d.jobId,recommend:!0}});case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),ft={control:it,errors:at,register:ut};return(0,N.jsxs)(g.Z,{handleSubmit:st(dt),children:[(0,N.jsx)(_.Z,{children:(0,N.jsxs)(x.Z,{md:12,children:["Status: ",(0,N.jsx)(I.Z,{content:m.text,size:"md",context:m.context}),U("admin")&&(0,N.jsx)(q.Z,{content:"Recommend This Quotation",context:"secondary",onClick:mt,size:"sm"})]})}),(0,N.jsx)(Z.Z,{}),(0,N.jsx)(K,{quotation:d,total:R,setTotal:E,supplierTotal:F,setSupplierTotal:V,customerTotal:J,setCustomerTotal:z,readOnly:ct}),(0,N.jsx)(Z.Z,{}),(0,N.jsxs)(_.Z,{children:[(0,N.jsx)(x.Z,{md:3,children:(0,N.jsx)($.Z,{label:"Total Duration",children:(0,N.jsx)(w.Z,rt(rt({},ft),{},{name:"totalDuration",type:"number",readOnly:ct}))})}),(0,N.jsx)(x.Z,{md:3,children:(0,N.jsx)($.Z,{label:"Total Duration Unit",children:(0,N.jsx)(S.Z,rt(rt({},ft),{},{name:"totalDurationUnit",options:[{text:"Hour",value:"hour",disabled:!1},{text:"Day",value:"day",disabled:!1},{text:"Week",value:"week",disabled:!1}],readOnly:ct}))})}),(0,N.jsxs)(x.Z,{md:3,children:[(0,N.jsx)($.Z,{label:"Available Start date"}),(0,N.jsx)(D.M,rt(rt({},ft),{},{name:"startDate",readOnly:ct}))]})]}),(0,N.jsx)(_.Z,{children:(0,N.jsx)(x.Z,{md:12,children:(0,N.jsx)($.Z,{label:"Method Statement",children:(0,N.jsx)(O.Z,rt(rt({},ft),{},{name:"methodStatement",readOnly:ct,rows:2}))})})}),U(["admin","supplier"])&&!ct&&(0,N.jsx)(_.Z,{children:(0,N.jsxs)(x.Z,{md:12,children:[(0,N.jsx)($.Z,{label:"Risk Assessments & Method Statements"}),(0,N.jsx)($.Z,{label:"Where RAMS are required, please upload them here.",children:(0,N.jsx)(q.Z,{content:"Upload",context:"secondary",onClick:function(){C.show({title:"Upload Risk Assessments",content:(0,N.jsx)(k.G,{entity:"Quotation",entityId:d.id})})},size:"sm"})})]})}),(0,N.jsx)(_.Z,{justify:"end",style:{margin:"0 5px"},children:(0,N.jsxs)(A.Z,{children:[U(["admin","supplier"])&&!ct&&(0,N.jsx)(q.Z,{content:"Cancel",onClick:function(){C.close()},type:"button"}),U(["admin","supplier"])&&!ct&&(0,N.jsx)(q.Z,{content:"Save",context:"secondary",onClick:st(lt)}),U(["admin"])&&(0,N.jsx)(q.Z,{content:"Reject quote",context:"danger",onClick:pt}),U(["admin","supplier"])&&!ct&&(!Q||Q>H||X?(0,N.jsx)(q.Z,{content:"Submit quote",type:"submit"}):(0,N.jsx)(q.Z,{content:"Request threshold",onClick:function(){var t;return(0,et.I_)({type:"quote",role:"admin"===T.accountType?"adminSupplier":T.accountType,jobId:null===d||void 0===d||null===(t=d.job)||void 0===t?void 0:t.id,quotationId:d.id,accountId:T.accountId,threshold:Q,offCanvas:C})}}))]})}),(0,N.jsx)("div",{style:{clear:"both"}})]})},it=n(55148),at=n(1323),st=n(27834);function ut(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function ct(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ut(Object(n),!0).forEach((function(e){(0,r.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ut(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var dt=function(t){var e=t.quotationId,n=t.onSuccess,r=(0,at.x)(),u=r.hasRole,c=r.user,d=(0,o.a)(i.Ib,{variables:{id:e}}),l=d.data,p=(l=void 0===l?{quotation:{}}:l).quotation,m=d.loading,f=(0,o.a)(st.nh,{variables:{id:c.id}}).data,h=(f=void 0===f?{user:{}}:f).user,b=it.E6.find((function(t){return t.value===p.status}))||{text:"-",context:"info"};return m?(0,N.jsx)(a.Z,{indicator:(0,N.jsx)(s.Z,{})}):(0,N.jsx)(ot,{quotation:p,quotationId:e,user:ct(ct({},c),h),hasRole:u,onSuccess:n,status:b})}},23845:function(t,e,n){n.d(e,{Ib:function(){return p},JE:function(){return m},cu:function(){return f},Ih:function(){return h},EA:function(){return b},nc:function(){return y}});var r,o,i,a,s,u,c=n(52209),d=n(54397),l=n(27834),p=(0,d.Ps)(r||(r=(0,c.Z)(["\n  query GetQuotation($id: Int!) {\n    quotation: SupplierQuote_by_pk(id: $id) {\n      id\n      createdAt\n      jobId\n      methodStatement\n      notes\n      quoteNumber\n      startDate\n      rebate\n      status\n      totalDuration\n      totalDurationUnit\n      meta\n      updatedAt\n      siteVisitAt\n      job: Job {\n        id\n        status\n        timings: JobTimings(order_by: { id: desc }) {\n          id\n          status\n          notes\n          meta\n          userId\n          quoteId\n          createdAt\n        }\n      }\n      lineItems: SupplierQuoteLineItems {\n        id\n        description\n        item\n        qty\n        qtyUnit\n        quoteId\n        supplierTotal\n        total\n        type\n        unitRate\n      }\n      supplier: Supplier {\n        id\n        companyNumber\n        createdAt\n        name\n        status\n        type\n        updatedAt\n        website\n        clientType\n        managerId\n        vatId\n        meta\n        media: Media {\n          id\n          medium: Medium {\n            id\n            category\n            filename\n            meta\n            type\n          }\n        }\n        manager: Manager {\n          id\n          fullName\n        }\n      }\n    }\n  }\n"]))),m=(0,d.Ps)(o||(o=(0,c.Z)(['\n  query GetQuotations($accountId: Int, $status: [String!], $q: String, $limit: Int, $offset: Int) {\n    quotations: SupplierQuote(\n      limit: $limit\n      offset: $offset\n      where: {\n        _or: [\n          { quoteNumber: { _ilike: $q } }\n          { totalDurationUnit: { _ilike: $q } }\n          { notes: { _ilike: $q } }\n        ]\n        accountId: { _eq: $accountId }\n        type: { _eq: "quote" }\n        status: { _in: $status }\n      }\n      order_by: { quoteNumber: desc }\n    ) {\n      id\n      createdAt\n      jobId\n      methodStatement\n      notes\n      quoteNumber\n      startDate\n      rebate\n      status\n      totalDuration\n      totalDurationUnit\n      meta\n      updatedAt\n      type\n      lineItems: SupplierQuoteLineItems {\n        id\n        description\n        item\n        qty\n        qtyUnit\n        quoteId\n        supplierTotal\n        total\n        type\n        unitRate\n      }\n      labourTotal: SupplierQuoteLineItems_aggregate(where: { type: { _eq: "Labour" } }) {\n        aggregate {\n          sum {\n            supplierTotal\n          }\n        }\n      }\n      materialsTotal: SupplierQuoteLineItems_aggregate(where: { type: { _eq: "Materials" } }) {\n        aggregate {\n          sum {\n            supplierTotal\n          }\n        }\n      }\n      total: SupplierQuoteLineItems_aggregate {\n        aggregate {\n          sum {\n            supplierTotal\n          }\n        }\n      }\n      job: Job {\n        description\n        title\n        type\n        number\n        status\n        customer: Customer {\n          id\n          name\n        }\n        shortJobDesc: Taxonomy(where: { Taxonomy: { type: { _eq: "jobTags" } } }) {\n          id\n          taxonomyId\n          comments\n          taxonomy: Taxonomy {\n            name\n          }\n        }\n        location: Location {\n          addresses: Addresses(where: { entity: { _eq: "Location" }, registered: { _eq: true } }) {\n            id\n            status\n            address: Address {\n              id\n              name\n              addressLine1\n              postCode\n            }\n          }\n        }\n        timings: JobTimings(order_by: { createdAt: asc }) {\n          id\n          status\n          notes\n          createdAt\n          user: User {\n            ...UserFields\n          }\n        }\n      }\n    }\n    meta: SupplierQuote_aggregate(\n      where: {\n        _or: [\n          { quoteNumber: { _ilike: $q } }\n          { totalDurationUnit: { _ilike: $q } }\n          { notes: { _ilike: $q } }\n        ]\n        accountId: { _eq: $accountId }\n        type: { _eq: "quote" }\n        status: { _in: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n  ',"\n"])),l.Px),f=(0,d.Ps)(i||(i=(0,c.Z)(["\n  query GetQuotationLineItems($quotationId: Int!, $type: String!) {\n    lineItems: SupplierQuoteLineItem(\n      where: { quoteId: { _eq: $quotationId }, type: { _eq: $type } }\n    ) {\n      id\n      description\n      item\n      qty\n      qtyUnit\n      quoteId\n      supplierTotal\n      total\n      type\n      unitRate\n    }\n  }\n"]))),h=(0,d.Ps)(a||(a=(0,c.Z)(["\n  mutation InsertSupplierQuoteLineItem($objects: [SupplierQuoteLineItem_insert_input!]!) {\n    insert_SupplierQuoteLineItem(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),b=(0,d.Ps)(s||(s=(0,c.Z)(["\n  mutation UpdateSupplierQuoteLineItem($id: Int!, $changes: SupplierQuoteLineItem_set_input) {\n    update_SupplierQuoteLineItem_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),y=(0,d.Ps)(u||(u=(0,c.Z)(["\n  mutation DeleteSupplierQuoteLineItem($id: Int!) {\n    delete_SupplierQuoteLineItem_by_pk(id: $id) {\n      id\n    }\n  }\n"])))},29678:function(t,e,n){n.d(e,{j6:function(){return c},HI:function(){return d},Dg:function(){return l},lx:function(){return p}});var r,o,i,a,s=n(52209),u=n(54397),c=(0,u.Ps)(r||(r=(0,s.Z)(["\n  mutation AddQuotation($objects: [SupplierQuote_insert_input!]!) {\n    insert_SupplierQuote(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),d=(0,u.Ps)(o||(o=(0,s.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $recommend: Boolean!\n    $jobId: Int\n  ) {\n    update_SupplierQuote(where: { jobId: { _eq: $jobId } }, _set: { recommended: false })\n      @include(if: $recommend) {\n      returning {\n        id\n      }\n    }\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n      status\n    }\n  }\n"]))),l=(0,u.Ps)(i||(i=(0,s.Z)(["\n  mutation UpdateQuotation(\n    $id: Int!\n    $changes: SupplierQuote_set_input\n    $supplierOffer: [SupplierOffer_insert_input!]!\n  ) {\n    update_SupplierQuote_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n    insert_SupplierOffer(objects: $supplierOffer) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),p=(0,u.Ps)(a||(a=(0,s.Z)(['\n  mutation UpdateQuotation($jobId: Int, $changes: SupplierQuote_set_input) {\n    update_SupplierQuote(\n      where: {\n        jobId: { _eq: $jobId }\n        status: { _neq: "quotationAccepted" }\n        type: { _eq: "quote" }\n      }\n      _set: $changes\n    ) {\n      returning {\n        id\n        jobId\n        status\n      }\n    }\n  }\n'])))},78777:function(t,e,n){n.d(e,{i$:function(){return A},Ii:function(){return D},I_:function(){return k}});var r=n(30266),o=n(64687),i=n.n(o),a=n(80318),s=n(67294),u=n(42283),c=n(75709),d=n(43566),l=n(97202),p=n(65375),m=n(83528),f=n(84774),h=n(55148),b=n(85893),y=function(t){var e=t.type,n=t.status,o=t.role,y=t.job,j=t.quoteId,v=t.toggleShow,g=t.refetch,_=(0,s.useContext)(d.Z).user,x=(0,c.D)(f.qD,{onCompleted:function(t){}}),I=(0,a.Z)(x,1)[0],q=(0,c.D)(f.r2,{onCompleted:function(t){}}),Z=(0,a.Z)(q,1)[0],$=(0,c.D)(f.k7,{onCompleted:function(t){}}),w=(0,a.Z)($,1)[0],S=(0,u.cI)({defaultValues:{comments:""}}),O=S.errors,A=S.handleSubmit,D=S.register,k=function(){switch(e){case"quote":return"".concat(o,"QuoteThresholdApproved"===n?"QuoteThresholdRejected":"QuoteThresholdApproved");default:return"".concat(o,"ThresholdApproved"===n?"ThresholdRejected":"ThresholdApproved")}},T=function(){var t=(0,r.Z)(i().mark((function t(r){var a,s,u,c;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:u={id:y.id,status:k(),userId:_.id,quoteId:"quote"===e?j:void 0},w({variables:u}),c={notes:r.comments,status:"".concat(o).concat(n),jobId:y.id,userId:_.id,quoteId:j},Z({variables:{objects:[c]}}),I({variables:{id:y.id,changes:{status:null===(a=y.timings)||void 0===a||null===(s=a.find((function(t){return!h.g4.includes(t.status)})))||void 0===s?void 0:s.status}}}),v&&v(),g&&g();case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();return(0,b.jsx)(l.Z,{id:"offCanvasForm",handleSubmit:A(T),children:(0,b.jsx)(p.Z,{label:"Comments",children:(0,b.jsx)(m.Z,{errors:O,name:"comments",register:D,rows:3})})})},j=n(92809),v=n(50542),g=n(22887),_=n(79665),x=n(95146),I=n(1323),q=n(29678),Z=n(19501),$=(0,Z.Ry)().shape({manager:(0,Z.Ry)().shape({value:(0,Z.Rx)().integer().required(),label:(0,Z.Z_)()}).required(),quotes:(0,Z.IX)().when("$hasQuotes",(function(t){return t?(0,Z.IX)().of((0,Z.Rx)().integer().required()).min(1).required():void 0}))});function w(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function S(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?w(Object(n),!0).forEach((function(e){(0,j.Z)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var O=function(t){var e,n=t.role,o=t.type,s=t.quotations,d=t.jobId,m=t.quotationId,h=t.accountId,y=t.threshold,j=t.toggleShow,Z=(0,I.x)(),w=Z.user,O=Z.hasRole,A=(0,c.D)(f.r2,{onCompleted:function(t){}}),D=(0,a.Z)(A,1)[0],k=(0,c.D)(f.qD,{onCompleted:function(t){}}),T=(0,a.Z)(k,1)[0],U=(0,c.D)(q.HI),P=(0,a.Z)(U,1)[0],C=(0,u.cI)({resolver:(0,_.S)($),defaultValues:{manager:[]},context:{hasQuotes:"quote"===o&&"adminCustomer"===n&&O(["admin"])}}),Q=C.errors,L=C.handleSubmit,R=C.register,E=C.control,M=null===s||void 0===s||null===(e=s.filter((function(t){var e=t.lineItems.reduce((function(t,e){return t+e.total}),0);return e+.2*e>=y})))||void 0===e?void 0:e.map((function(t){return{label:t.quoteNumber,value:t.id}})),N=function(){var t=(0,r.Z)(i().mark((function t(e){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("issue"!==o){t.next=5;break}return t.next=3,D({variables:{objects:[{status:"".concat(n,"ThresholdApproval"),jobId:d,userId:w.id,quoteId:m,meta:{to:e.manager.value}}]}});case 3:t.next=14;break;case 5:if("quote"!==o||"adminCustomer"!==n){t.next=10;break}return t.next=8,Promise.all(e.quotes.map(function(){var t=(0,r.Z)(i().mark((function t(r){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,D({variables:{objects:[{status:"".concat(n,"QuoteThresholdApproval"),jobId:d,userId:w.id,quoteId:r,meta:{to:e.manager.value}}]}});case 2:return t.next=4,P({variables:{id:+r,changes:{status:"waitingThresholdApproval"},recommend:!1}});case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 8:t.next=14;break;case 10:return t.next=12,D({variables:{objects:[{status:"".concat(n,"QuoteThresholdApproval"),jobId:d,userId:w.id,quoteId:m,meta:{to:e.manager.value}}]}});case 12:return t.next=14,P({variables:{id:m,changes:{status:"waitingThresholdApproval"},recommend:!1}});case 14:return t.next=16,T({variables:{id:d,changes:{status:"waitingThresholdApproval"}}});case 16:j();case 17:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),F={control:E,register:R,errors:Q};return(0,b.jsxs)(l.Z,{id:"offCanvasForm",handleSubmit:L(N),children:["quote"===o&&"adminCustomer"===n&&O(["admin"])&&(0,b.jsx)(p.Z,{label:"Choose quotations",children:M.map((function(t,e){var n;return(0,b.jsx)(v.Z,{value:t.value,control:(0,b.jsx)(g.Z,{}),label:t.label,name:"quotes[".concat(e,"]"),inputRef:R,error:!(null===Q||void 0===Q||null===(n=Q.quotes)||void 0===n||!n.length)})}))}),(0,b.jsx)(x.P,S(S({},F),{},{label:"Choose approve manager",accountId:h,name:"manager",type:"manager"}))]})},A=function(){var t=(0,r.Z)(i().mark((function t(e){var n,r,o,a,s,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.type,r=e.role,o=e.job,a=e.quoteId,s=e.offCanvas,u=e.refetch,s.show({content:(0,b.jsx)(y,{type:n,role:r,job:o,quoteId:a,status:"quote"===n?"QuoteThresholdApproved":"ThresholdApproved",toggleShow:s.show,refetch:u}),title:"Approve threshold"});case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),D=function(){var t=(0,r.Z)(i().mark((function t(e){var n,r,o,a,s,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.type,r=e.role,o=e.job,a=e.quoteId,s=e.offCanvas,u=e.refetch,s.show({content:(0,b.jsx)(y,{type:n,role:r,job:o,quoteId:a,status:"quote"===n?"QuoteThresholdRejected":"ThresholdRejected",toggleShow:s.show,refetch:u}),title:"Reject threshold"});case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),k=function(t){var e=t.type,n=t.role,r=t.quotations,o=t.jobId,i=t.quotationId,a=t.accountId,s=t.threshold,u=t.offCanvas;u.show({content:(0,b.jsx)(O,{role:n,type:e,jobId:o,quotations:r,quotationId:i,accountId:a,threshold:s,toggleShow:u.show}),title:"Request threshold approval"})}},27834:function(t,e,n){n.d(e,{I4:function(){return _},AX:function(){return x},fo:function(){return I},JA:function(){return q},WF:function(){return Z},Px:function(){return $},a8:function(){return w},r1:function(){return S},MT:function(){return O},nE:function(){return A},nh:function(){return D},$E:function(){return k},uz:function(){return T},ge:function(){return U},ZA:function(){return P},tW:function(){return C}});var r,o,i,a,s,u,c,d,l,p,m,f,h,b,y,j,v=n(52209),g=n(54397),_=(0,g.Ps)(r||(r=(0,v.Z)(["\n  mutation InsertAccountUser($objects: [Account_User_insert_input!]!) {\n    insert_Account_User(objects: $objects) {\n      returning {\n        id\n      }\n    }\n  }\n"]))),x=(0,g.Ps)(o||(o=(0,v.Z)(["\n  mutation UpdateUser(\n    $id: Int!\n    $accountUserId: Int!\n    $accountUserChanges: Account_User_set_input\n    $changes: User_set_input\n    $updateAccountUser: Boolean!\n  ) {\n    update_Account_User_by_pk(pk_columns: { id: $accountUserId }, _set: $accountUserChanges)\n      @include(if: $updateAccountUser) {\n      id\n    }\n    update_User_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),I=(0,g.Ps)(i||(i=(0,v.Z)(["\n  query GetUsers(\n    $accountId: Int\n    $accountType: String\n    $date: timestamptz\n    $limit: Int\n    $offset: Int\n    $q: String\n    $orderBy: User_order_by!\n    $status: String\n  ) {\n    users: User(\n      limit: $limit\n      offset: $offset\n      where: {\n        Account_Users: { Account: { id: { _eq: $accountId }, type: { _eq: $accountType } } }\n        createdAt: { _eq: $date }\n        _or: [\n          { email: { _ilike: $q } }\n          { nameFirst: { _ilike: $q } }\n          { nameLast: { _ilike: $q } }\n        ]\n        status: { _eq: $status }\n      }\n      order_by: [$orderBy]\n    ) {\n      id\n      name: nameFirst\n      nameFirst\n      nameLast\n      phone\n      status\n      email\n      createdAt\n      meta\n      accounts: Account_Users {\n        id\n        role\n        position\n        isContact\n        status\n        account: Account {\n          id\n          name\n          type\n        }\n        userLocations: User_Account_Locations {\n          accountLocationId\n        }\n      }\n    }\n    meta: User_aggregate(\n      where: {\n        Account_Users: { Account: { id: { _eq: $accountId }, type: { _eq: $accountType } } }\n        createdAt: { _eq: $date }\n        _or: [{ nameFirst: { _ilike: $q } }, { nameLast: { _ilike: $q } }]\n        status: { _eq: $status }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n"]))),q=(0,g.Ps)(a||(a=(0,v.Z)(["\n  query GetUser($id: Int!) {\n    user: User_by_pk(id: $id) {\n      id\n      fullName\n      name: nameFirst\n      nameFirst\n      nameLast\n      phone\n      status\n      email\n      createdAt\n      meta\n      media: Media {\n        id\n        medium: Medium {\n          id\n          category\n          filename\n          meta\n          type\n        }\n      }\n      accounts: Account_Users {\n        id\n        role\n        position\n        isContact\n        status\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"]))),Z=(0,g.Ps)(s||(s=(0,v.Z)(["\n  query CheckDuplicateEmail($email: String!) {\n    users: User_public(where: { email: { _eq: $email } }) {\n      id\n      nameFirst\n      nameLast\n      email\n      phone\n    }\n  }\n"]))),$=(0,g.Ps)(u||(u=(0,v.Z)(["\n  fragment UserFields on User {\n    id\n    email\n    nameFirst\n    nameLast\n    fullName\n    phone\n    status\n  }\n"]))),w=(0,g.Ps)(c||(c=(0,v.Z)(["\n  mutation SendGoogleAuthCode($code: String!, $id: Int!, $type: String!) {\n    createGoogleToken(code: $code, id: $id, type: $type) {\n      success\n      tokens\n      error\n    }\n  }\n"]))),S=(0,g.Ps)(d||(d=(0,v.Z)(["\n  mutation GenerateMSURL($type: String!, $id: Int!) {\n    genenrateMSURL(id: $id, type: $type) {\n      url\n    }\n  }\n"]))),O=(0,g.Ps)(l||(l=(0,v.Z)(["\n  mutation signoutMS($id: Int!, $type: String!, $email: String!) {\n    signoutMS(id: $id, type: $type, email: $email) {\n      error\n      msId\n      success\n    }\n  }\n"]))),A=(0,g.Ps)(p||(p=(0,v.Z)(["\n  query getAccountMeta($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      meta\n    }\n  }\n"]))),D=(0,g.Ps)(m||(m=(0,v.Z)(["\n  query user($id: Int!) {\n    user: User_by_pk(id: $id) {\n      meta\n    }\n  }\n"]))),k=(0,g.Ps)(f||(f=(0,v.Z)(["\n  mutation updateAccount($accountId: Int!, $set: Account_set_input!) {\n    update_Account_by_pk(pk_columns: { id: $accountId }, _set: $set) {\n      id\n    }\n  }\n"]))),T=(0,g.Ps)(h||(h=(0,v.Z)(["\n  mutation updateUserMeta($userId: Int!, $meta: jsonb!) {\n    update_User_by_pk(pk_columns: { id: $userId }, _set: { meta: $meta }) {\n      id\n      meta\n    }\n  }\n"]))),U=(0,g.Ps)(b||(b=(0,v.Z)(['\n  query userDevices($accountId: Int!) {\n    users: User(\n      where: {\n        Account_Users: { accountId: { _eq: $accountId }, status: { _eq: "active" } }\n        UserDevices: { status: { _eq: "active" } }\n        status: { _eq: "active" }\n      }\n    ) {\n      id\n      fullName\n      devices: UserDevices(\n        order_by: { updatedAt: desc_nulls_last }\n        where: { status: { _eq: "active" } }\n        limit: 1\n      ) {\n        id\n        playerId\n      }\n    }\n  }\n']))),P=(0,g.Ps)(y||(y=(0,v.Z)(['\n  query GetAccountLocations($accountId: Int, $limit: Int, $offset: Int) {\n    location: Location(\n      offset: $offset\n      limit: $limit\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n      }\n    ) {\n      id\n      name\n      accountLocations: Account_Locations {\n        id\n      }\n      addresses: Addresses(where: { entity: { _eq: "Location" }, registered: { _eq: true } }) {\n        id\n        status\n        address: Address {\n          id\n          name\n          addressLine1\n          postCode\n        }\n      }\n    }\n    meta: Location_aggregate(\n      where: {\n        Account_Locations: {\n          accountId: { _eq: $accountId }\n          Account: { type: { _eq: "customer" } }\n        }\n      }\n    ) {\n      aggregate {\n        totalCount: count\n      }\n    }\n  }\n']))),C=(0,g.Ps)(j||(j=(0,v.Z)(["\n  mutation InsertUserAccountLocations(\n    $accountUserId: Int!\n    $objects: [User_Account_Location_insert_input!]!\n  ) {\n    delete_User_Account_Location(where: { accountUserId: { _eq: $accountUserId } }) {\n      affected_rows\n    }\n    insert_User_Account_Location(objects: $objects) {\n      affected_rows\n      returning {\n        id\n      }\n    }\n  }\n"])))}}]);