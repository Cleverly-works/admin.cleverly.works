"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26],{26:function(n,e,t){t.d(e,{V:function(){return F}});var o=t(80318),r=t(30266),a=t(92809),c=t(10219),i=t(64687),s=t.n(i),d=t(67294),u=t(45697),l=t(93633),p=t(75709),m=t(71742),f=t(11163),y=t(42283),b=t(79665),v=t(80880),g=t(97202),h=t(11570),j=t(78215),w=t(2356),O=t(65375),_=t(71247),I=t(83528),A=t(46482),Z=t(47385),L=t(95146),P=t(85893);function $(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function x(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?$(Object(t),!0).forEach((function(e){(0,a.Z)(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):$(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}var C=function(n){var e=n.accountId,t=n.accountName,o=n.canSelectAccount,r=n.control,a=n.errors,c=n.setValue,i=n.watch,s=e?{value:e,label:t}:i("propertyOwner"),u=(0,Z.Z)(s);(0,d.useEffect)((function(){s!==u&&u&&c("contactUser",null)}),[s]);var l={control:r,errors:a};return(0,P.jsxs)(j.Z,{children:[(0,P.jsx)(w.Z,{md:6,children:(0,P.jsx)(L.P,x(x({},l),{},{defaultValue:e&&{value:e,label:t},errors:x({},a),isDisabled:!o,label:"Client",name:"propertyOwner",placeholder:"Select",type:"customer"}))}),(0,P.jsx)(w.Z,{md:6,children:(0,P.jsx)(L.P,x(x({},l),{},{accountId:(null===s||void 0===s?void 0:s.value)||null,errors:x({},a),isDisabled:!s,label:"Contact Name",name:"contactUser",placeholder:s?"Select":"Select the location owner",type:"user"}))})]})},k=t(34112),S=function(n){return n?(location.propertyOwner={label:n.customer[0].account.name,value:n.customer[0].account.id},location.contactUser=(null===n||void 0===n?void 0:n.user)&&n.customer[0].account.id&&{label:n.user.fullName,value:n.user.id},location.access=n.access,location.name=n.name,location.status=n.status,location):{}},N=function(n,e){var t=n.propertyOwner,o=n.contactUser;return n.Account_Locations={data:{accountId:t.value}},delete n.propertyOwner,n.contactUserId=(null===o||void 0===o?void 0:o.value)||null,delete n.contactUser,e&&delete n.Account_Locations,n},q=function(n,e){return e({variables:{objects:[N(n)]}})},U=t(19501),D=function(n){return(0,U.Ry)().shape({access:(0,U.Z_)().required(),contactUser:(0,U.Ry)().required(),name:(0,U.Z_)().required(),propertyOwner:(0,U.Ry)().required(),status:n("admin")&&(0,U.Z_)().required()})},V=t(47337),E=t(75838),M=t(1323),T=["accountId","accountName","entity","data","refetch","onAddressCreated","isPropsComponent","initialValues"];function J(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function G(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?J(Object(t),!0).forEach((function(e){(0,a.Z)(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):J(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}var R="/dashboard/properties/",F=function(n){var e=n.accountId,t=n.accountName,a=n.entity,i=n.data,u=n.refetch,Z=n.onAddressCreated,L=n.isPropsComponent,$=n.initialValues,x=((0,c.Z)(n,T),(0,d.useContext)(v.Z)),U=(0,M.x)().hasRole,J=(0,d.useState)(!1),F=J[0],z=J[1],B=(0,y.cI)({defaultValues:G(G({},S(i)),$),resolver:(0,b.S)(D(U))}),H=B.control,K=B.errors,Q=B.handleSubmit,W=B.register,X=B.setValue,Y=B.getValues,nn=B.watch,en=(0,l.a)(m.yf,{variables:{id:null===i||void 0===i?void 0:i.id},skip:!(null!==i&&void 0!==i&&i.id)}).data,tn=(en=void 0===en?{property:{}}:en).property,on=function(){var n=(0,r.Z)(s().mark((function n(e){var t,o,r,c,i,d,u;return s().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t={Addresses:{data:{Address:{data:G({},e)},entity:a}}},o=G(G({},Y()),t),U("customer")&&(o.status="active"),n.next=5,q(o,sn);case 5:r=n.sent,c=r.data,i=(c=void 0===c?{}:c).insert_Location,d=(i=void 0===i?{}:i).returning,u=void 0===d?{}:d,Z&&Z(u),x.close(),x.close();case 14:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),rn=function(){var n=(0,r.Z)(s().mark((function n(e){return s().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:x.show({title:"Add new address",content:(0,P.jsx)(V.k,{onCancel:console.log,onSubmit:on,type:"text"}),submit:!1});case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),an=(0,p.D)(m.A1,{onCompleted:function(n){if(!L){var e=n.insert_Location.returning[0].id;x.close(),u?u():f.default.push("".concat(R,"view?id=").concat(e))}}}),cn=(0,o.Z)(an,2),sn=cn[0],dn=cn[1].loading,un=(0,p.D)(m.$A,{onCompleted:function(n){var e=n.update_Location_by_pk.id;x.close(),u?u():f.default.push("".concat(R,"view?id=").concat(e))}}),ln=(0,o.Z)(un,2),pn=ln[0],mn=ln[1].loading,fn={control:H,errors:K,register:W};return(0,P.jsxs)(g.Z,{disabled:dn||mn,id:"offCanvasForm",handleSubmit:Q((function(n){if(z(!1),i){var e,t,o;if("inactive"===n.status&&!tn.jobs.every((function(n){return!!(0,k.E)(n,["completed","closed"])})))return void z(!0);!function(n,e,t,o){o({variables:{location:N(n,!0),locationId:e.locationId,accountId:e.accountId,newAccountId:e.newAccountId,hasChanged:e.hasChanged}})}(n,{locationId:null===i||void 0===i?void 0:i.id,accountId:null===i||void 0===i||null===(e=i.customer[0])||void 0===e?void 0:e.account.id,newAccountId:null===n||void 0===n||null===(t=n.propertyOwner)||void 0===t?void 0:t.value,hasChanged:!((null===i||void 0===i||null===(o=i.customer[0])||void 0===o?void 0:o.account.id)===(null===n||void 0===n?void 0:n.propertyOwner.value))},i.id,pn)}else rn()})),children:[F&&(0,P.jsx)(h.Z,{context:"info",content:" This location cannot be made inactive, it has active jobs."}),(0,P.jsx)(j.Z,{children:(0,P.jsx)(w.Z,{md:12,children:(0,P.jsx)(C,G(G({},fn),{},{accountId:e,accountName:t,canSelectAccount:!e,setValue:X,watch:nn}))})}),(0,P.jsx)(O.Z,{label:"Name",children:(0,P.jsx)(_.Z,G(G({},fn),{},{name:"name"}))}),(0,P.jsx)(O.Z,{label:"Access information",children:(0,P.jsx)(I.Z,G(G({},fn),{},{name:"access",rows:4}))}),U("admin")&&(0,P.jsx)(O.Z,{label:"Status",children:(0,P.jsx)(A.Z,G(G({},fn),{},{name:"status",options:E.bg}))})]})};C.propTypes={accountId:u.number,accountName:u.string,data:u.object,refetch:u.func,offCanvas:u.func}},71742:function(n,e,t){t.d(e,{Un:function(){return p},A1:function(){return m},$A:function(){return f},zg:function(){return y},yf:function(){return b}});var o,r,a,c,i,s,d,u=t(52209),l=t(54397),p=((0,l.Ps)(o||(o=(0,u.Z)(["\n  query GetProperty($id: Int!) {\n    location: Location_by_pk(id: $id) {\n      id\n      contactUserId\n      name\n      access\n      contactUser: User {\n        id\n        nameFirst\n        nameLast\n      }\n      propertyOwner: Account_Locations {\n        account: Account {\n          id\n          name\n          type\n        }\n      }\n    }\n  }\n"]))),(0,l.Ps)(r||(r=(0,u.Z)(['\n  query GetMapProperties {\n    properties: Location {\n      id\n      access\n      createdAt\n      name\n      contactUserId\n      addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n        id\n        registered\n        operating\n        trading\n        invoice\n        status\n        createdAt\n        address: Address {\n          id\n          name\n          addressLine1\n          addressLine2\n          addressLine3\n          city\n          county\n          geo\n          postCode\n          country: Country {\n            id\n            name\n          }\n        }\n      }\n      bookings: Jobs {\n        id\n        title\n        createdAt\n        customerId\n        amount\n        locationId\n        managerId\n        quoteNumber\n        reference\n        status\n        serviceId\n        meta\n        customer: Customer {\n          id\n          name\n        }\n        location: Location {\n          id\n          name\n          addresses: Addresses(where: { entity: { _eq: "Location" } }) {\n            id\n            registered\n            operating\n            trading\n            invoice\n            status\n            createdAt\n            address: Address {\n              id\n              name\n              addressLine1\n              addressLine2\n              addressLine3\n              city\n              county\n              geo\n              postCode\n              country: Country {\n                id\n                name\n              }\n            }\n          }\n        }\n        manager: Manager {\n          id\n          nameFirst\n          nameLast\n        }\n        sla: SLA {\n          id\n          name\n          notes\n        }\n        supplier: Supplier {\n          id\n          companyNumber\n          createdAt\n          name\n          status\n          type\n          updatedAt\n          website\n          clientType\n          managerId\n          vatId\n          meta\n          media: Media {\n            id\n            medium: Medium {\n              id\n              category\n              filename\n              meta\n              type\n            }\n          }\n          manager: Manager {\n            id\n            fullName\n          }\n        }\n        supplierOffers: SupplierOffers {\n          status\n          rate\n          supplier: Supplier {\n            id\n            companyNumber\n            createdAt\n            name\n            status\n            type\n            updatedAt\n            website\n            clientType\n            managerId\n            vatId\n            meta\n            media: Media {\n              id\n              medium: Medium {\n                id\n                category\n                filename\n                meta\n                type\n              }\n            }\n            manager: Manager {\n              id\n              fullName\n            }\n          }\n        }\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n'])))),m=(0,l.Ps)(a||(a=(0,u.Z)(["\n  mutation AddLocation($objects: [Location_insert_input!]!) {\n    insert_Location(objects: $objects) {\n      returning {\n        id\n        name\n      }\n    }\n  }\n"]))),f=(0,l.Ps)(c||(c=(0,u.Z)(["\n  mutation UpdateAccountLocation(\n    $location: Location_set_input\n    $locationId: Int!\n    $accountId: Int!\n    $newAccountId: Int!\n    $hasChanged: Boolean!\n  ) {\n    update_Account_Location(\n      where: { Account: { id: { _eq: $accountId } }, id: { _eq: $locationId } }\n      _set: { accountId: $newAccountId }\n    ) @include(if: $hasChanged) {\n      returning {\n        id\n      }\n    }\n    update_Location_by_pk(pk_columns: { id: $locationId }, _set: $location) {\n      id\n    }\n  }\n"]))),y=(0,l.Ps)(i||(i=(0,u.Z)(["\n  mutation UpdateLocation($id: Int!, $changes: Location_set_input) {\n    update_Location_by_pk(pk_columns: { id: $id }, _set: $changes) {\n      id\n    }\n  }\n"]))),b=((0,l.Ps)(s||(s=(0,u.Z)(["\n  query GetAccountName($id: Int!) {\n    account: Account_by_pk(id: $id) {\n      id\n      name\n      type\n    }\n  }\n"]))),(0,l.Ps)(d||(d=(0,u.Z)(["\n  query GetPropertiesJob($id: Int!) {\n    property: Location_by_pk(id: $id) {\n      id\n      jobs: Jobs {\n        id\n        timings: JobTimings {\n          id\n          status\n          createdAt\n        }\n      }\n    }\n  }\n"]))))}}]);