"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8606],{38596:function(e,t,n){n.d(t,{B:function(){return r}});var i=n(83789),r=function(e,t,n){var r;if(!t)return null;var o=null===(r=(0,i.Z)(t).sort((function(e,t){return e.createdAt-t.createdAt})).find((function(t){return t.type===e})))||void 0===r?void 0:r.value;return o||0===o?o:n||0}},39715:function(e,t,n){n.d(t,{K:function(){return o}});var i=n(38596),r=n(93710),o=function(e){var t,n,o,u,a=null===(t=e.admin)||void 0===t?void 0:t.meta,c=(null===a||void 0===a?void 0:a.timeSegment)||(0,r.g)(),l=new Date(e.timingStart),s=(null===a||void 0===a||null===(n=a.timeZone)||void 0===n?void 0:n.value)||"Europe/London",d=l.toLocaleTimeString("en-GB",{hour12:!1,hour:"2-digit",minute:"2-digit",timeZone:s}),m=(null===(o=c.find((function(e){return d>=e.from&&d<=e.to})))||void 0===o?void 0:o.name)||c[c.length-1].name,v=new Date(l.toLocaleDateString("en-GB",{timeZone:s})).getDay();6!==v&&0!==v||"Normal"!==m||(m="OOH"),m=e.timingNormalHours?"Normal":m;var p=(0,i.B)("timing",e.financeLogs);return(null===(u=(0,r.g)().find((function(e){return e.id===p})))||void 0===u?void 0:u.name)||m}},44744:function(e,t,n){n.d(t,{_:function(){return u}});var i=n(18862),r=n(64509),o=n(11699),u=function(e){var t=e.slice().sort((function(e,t){return Number(e.id)-Number(t.id)})),n=[],u=t.findIndex((function(e){return"inProgress"===e.status})),a=t.findIndex((function(e){return"completed"===e.status}));if(-1===u&&-1===a)return n;-1===a&&(a=t.length-1);for(var c=u;c<=a;c+=2)if(("inProgress"===t[c].status||"resumed"===t[c].status||"continued"===t[c].status)&&c+1<t.length){var l=(0,o.Z)(new Date(t[c+1].createdAt),new Date(t[c].createdAt));n.push({from:"".concat((0,i.Z)(t[c].createdAt),"-").concat((0,r.Z)(t[c].createdAt)),to:"".concat((0,i.Z)(t[c+1].createdAt),"-").concat((0,r.Z)(t[c+1].createdAt)),startDate:(0,i.Z)(t[c].createdAt),duration:Math.round(l)})}return n}},34112:function(e,t,n){n.d(t,{E:function(){return i}});var i=function(e,t){var n;if(Array.isArray(t)){var i=null;return t.forEach((function(t){var n,r=null===e||void 0===e||null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));i=(null===r||void 0===r?void 0:r.createdAt)||i})),i}var r=null===e||void 0===e||null===(n=e.timings)||void 0===n?void 0:n.find((function(e){return e.status===t}));return(null===r||void 0===r?void 0:r.createdAt)||null}},93710:function(e,t,n){n.d(t,{g:function(){return i}});var i=function(){return[{id:1,name:"Normal",from:"08:00",to:"18:00"},{id:2,name:"OOH",from:"18:00",to:"22:00"},{id:3,name:"Premium",from:"22:00",to:"08:00"}]}},78606:function(e,t,n){n.d(t,{_:function(){return x}});var i=n(83789),r=n(92809),o=n(30266),u=n(64687),a=n.n(u),c=(n(70448),n(73303)),l=n.n(c),s=n(38596),d=n(44744),m=n(34112),v=n(39715),p=function(e){return parseInt(e).toLocaleString("en-GB",{minimumIntegerDigits:2,useGrouping:!1})},f=function(e){var t=e.job,n=(0,d._)(t.timings),i=l()(n,"duration"),r=Math.round(i/60);return(0,s.B)("time",t.financeLogs,r)},b=function(e,t,n,i){var r,o,u,a,c,l=null===n||void 0===n?void 0:n.callOutHourRate,d=null===n||void 0===n?void 0:n.callOutHourRateOOH,m=null===n||void 0===n?void 0:n.callOutHourRatePremium,v="supplier"===i?"callOutSupplier":"callOutCustomer",p="supplier"===i?"supplierRate":"customerRate";switch("supplier"===i?(u=n.supplierHourRate,a=n.supplierHourRateOOH,c=n.supplierHourRatePremium):(u=n.customerHourRate,a=n.customerHourRateOOH,c=n.customerHourRatePremium),t){case"Normal":r=(0,s.B)(v,e.financeLogs,l),o=(0,s.B)(p,e.financeLogs,u);break;case"OOH":r=(0,s.B)(v,e.financeLogs,d),o=(0,s.B)(p,e.financeLogs,a);break;case"Premium":r=(0,s.B)(v,e.financeLogs,m),o=(0,s.B)(p,e.financeLogs,c)}return{callOutRate:r,rate:o}},g=function(e){var t,n=e.callOutRate,i=e.durationInMinutes,r=e.rate;return t=i<=60?i/60*n/r*60:(n+(i-60)/60*r)/r*60,isNaN(t)?0:t},I=function(e){var t=e.vatRate,n=function(e,t,n){var i,r=0,o="-",u=0,a="supplier"===n?"callOutSupplier":"callOutCustomer",c=Number.isInteger(null===t||void 0===t?void 0:t.callOutHourRate)||-1!==(0,s.B)(a,e.financeLogs,-1),l=(0,v.K)(e),d=b(e,l,t,n),I=d.callOutRate,y=d.rate;if((0,m.E)(e,"completed")){r="incorrect"===e.timingStatus?e.correctDuration:f({job:e});var A=t.minimumInterval,h=t.minimumLength;A=parseInt(A),h=parseInt(h);var O=r>=t.minimumLength;if(r=O?r:h,i=(r+=r%A>0?A-r%A:0)>420)o="Daily",u=1;else{var D="".concat(p(r/60|0),":").concat(p(r%60|0));o="".concat(D,O?" (actual)":" (minimum length)"),u=c?g({callOutRate:I,durationInMinutes:r,rate:y})/60:r/60}}return{callOutRate:I,displayTime:o,hasCallOutRate:c,isDaily:i,minutes:r,rateMultiplier:u}}(e,e.selectedService),i=n.isDaily,r=n.minutes,o=function(e){e.customerService;var t=e.fixedAmount,n=e.isDaily,i=e.minutes,r=e.pricing,o=e.rate,u=e.slaMultiplier,a=e.supplierLabourAmount,c=e.supplierMaterialsAmount,l=e.supplierService,s=n?l.supplierDayRate:l.supplierHourRate,d="time-materials"===r?Number(n?(o*u).toFixed(2):(i*o*u/60).toFixed(2)):t;return{rateExcludingRebate:d,serviceCharge:d-("time-materials"===r?Number(n?(s*u).toFixed(2):(i*s*u/60).toFixed(2)):a+c)}}({customerService:e.selectedService,fixedAmount:e.amount,isDaily:i,minutes:r,pricing:e.pricing,rate:e.rate,slaMultiplier:e.slaMultiplier,supplierLabourAmount:e.supplierLabourAmount,supplierMaterialsAmount:e.supplierMaterialsAmount,supplierService:e.supplierService}).serviceCharge,u=[];u.push({minutes:0,name:"Service fee",itemTotal:o,itemTotalIncVAT:o+o*t,rate:o,rateVatInc:o+o*t,vatAmount:o*t,vatAmountForRate:o*t,vatRate:t,type:"customerFee",serviceRate:"-",totalCost:o});var a=function(e){var t,n,i,r,o,u,a,c,l,s=e.additions,d=void 0===s?0:s,m=e.deductions,v=void 0===m?0:m,p=e.discount,f=void 0===p?0:p,b=e.fixedAmount,g=void 0===b?0:b,I=e.job,y=e.pricing,A=e.rate,h=void 0===A?0:A,O=e.rateMultiplier,D=void 0===O?0:O,R=e.slaMultiplier,w=void 0===R?1:R,k=e.supplierLabourAmount,S=e.supplierMaterialsAmount,x=e.type,L="supplier"===x?0:(null===(t=I.customer)||void 0===t||null===(n=t.meta)||void 0===n||null===(i=n.finance)||void 0===i?void 0:i.arrangementFee)||0,j=0,N=0,P=0;"time-materials"===y?(P=h*D,j=h*w/(1-L/100)||0,N=(P*=w)/(1-L/100)):(P="supplier"===x?k+S:g/(1-L/100),j=N=g/(1-L/100)-g);var M=(null===(r=I.customer)||void 0===r||null===(o=r.meta)||void 0===o||null===(u=o.finance)||void 0===u?void 0:u.serviceRateLabour)||0;return{rebate:j,rebateAmount:N,rebatePercent:L,rebatePercentSupplier:0,serviceRateAmount:0,serviceRateExpenses:(null===(a=I.customer)||void 0===a||null===(c=a.meta)||void 0===c||null===(l=c.finance)||void 0===l?void 0:l.serviceRateExpenses)||0,serviceRateLabour:M,total:P+0+d-v-f,workRate:P}}({customerDeposit:e.customerDeposit,discount:e.discount,fixedAmount:e.amount,job:e,pricing:e.pricing,rate:e.rate,rateMultiplier:e.rateMultiplier,slaMultiplier:e.slaMultiplier,supplierLabourAmount:e.supplierLabourAmount,supplierMaterialsAmount:e.supplierMaterialsAmount,type:e.type}),c=a.rebateAmount,l=a.rebatePercent,d=c+l*o/100;return d&&u.push({itemTotalIncVAT:d+d*t,itemTotal:d,minutes:0,name:"Rebate (".concat(l,"%)"),rate:d,rateVatInc:d+d*t,type:"customerFee",vatAmount:c*t,vatAmountForRate:d*t,vatRate:t,serviceRate:"-",totalCost:o}),u},y=function(e){var t;if(null!==(t=e.admin)&&void 0!==t&&t.bankAccounts&&e.admin.bankAccounts.length){var n,i=e.admin.bankAccounts[0],r=i.accountNumber,o=i.bank,u=i.bic,a=i.iban,c=i.routingNumber,l=i.meta;return{accountName:e.admin.name,accountNumber:r,bic:u,entity:o,iban:a,sortCode:c,showInInvoice:null!==(n=null===l||void 0===l?void 0:l.showInInvoice)&&void 0!==n&&n}}},A=n(77349),h=function(e,t){var n,i,r,o,u,a,c=parseInt(null===(n=e.customer)||void 0===n||null===(i=n.meta)||void 0===i||null===(r=i.finance)||void 0===r?void 0:r.invoiceDueDate)||parseInt(null===(o=e.admin)||void 0===o||null===(u=o.meta)||void 0===u||null===(a=u.finance)||void 0===a?void 0:a.invoiceDueDate)||30,l=(0,m.E)(e,"invoiceSent")||new Date;return"supplier"===t?new Date:(0,A.Z)(new Date(l),c)},O=n(29575),D=n(55863);n(48764).Buffer;function R(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?R(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):R(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var k="",S="",x=function(){var e=(0,o.Z)(a().mark((function e(t){var n,r,o,u,c,l,s,d,v,p,f,b,g,A,R,x,j,N,P,M;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:u=t.adminId,c=t.job,l=t.invoice,s=t.revisionIndex,d=t.type,v=t.client,e.t0=d,e.next="supplier"===e.t0?4:"customerFee"===e.t0?7:"customerVat"===e.t0?10:13;break;case 4:return k="supplier/create",S="Self Bill Invoice",e.abrupt("break",16);case 7:return k="customer/create",S="Fee Invoice",e.abrupt("break",16);case 10:return k="customer/create",S="VAT Invoice",e.abrupt("break",16);case 13:return k="customer/create",S="Invoice",e.abrupt("break",16);case 16:if(p={},f=L({meta:c.meta,revisionIndex:s,type:d}),b=(null===c||void 0===c||null===(n=c.invoices)||void 0===n?void 0:n.reduce((function(e,t){return e+t.amountPaid.aggregate.sum.amount}),0))||0,g=(null===c||void 0===c||null===(r=c.invoices)||void 0===r?void 0:r.reduce((function(e,t){return e+t.amountDeducted.aggregate.sum.amount}),0))||0,A=(null===c||void 0===c||null===(o=c.invoices)||void 0===o?void 0:o.reduce((function(e,t){return e+t.reconciledAmount.aggregate.sum.amount}),0))||0,!f){e.next=34;break}f.amountInfo=w(w({},f.amountInfo),{},{title:S,amountPaid:b,amountDeducted:g,reconciledAmount:A}),f.invoiceInfo=w(w({},f.invoiceInfo),{},{invoiceNumber:(null===l||void 0===l?void 0:l.id)||"Draft",invoiceDate:(0,m.E)(c,"invoiceSent")}),(p=w({},f)).jobInfo=w(w({},p.jobInfo),{},{number:c.number}),p.customerInfo=w({},p.customerInfo),p.adminId=u,p.invoiceType=d,p.invoiceInfo=w(w({},p.invoiceInfo),{},{dueDate:h(c,d)}),p.paymentInfo=w(w({},p.paymentInfo),{},{paymentInformation:y(c)}),"customerFee"!==d||null!==f&&void 0!==f&&null!==(R=f.items)&&void 0!==R&&R.find((function(e){return"customerFee"===e.type}))||(p.items=(x=p.items).concat.apply(x,(0,i.Z)(I(f)))),e.next=40;break;case 34:return e.next=36,(0,O.F)(v,c.id);case 36:j=e.sent,N=j.financeSupplier,P=j.financeCustomer,p="supplier"===d?N:P;case 40:return M=window.open("/download","_blank"),e.next=43,window.fetch("".concat("https://aws-staging.cleverly.works","/pdf/invoice/").concat(k),{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(p)}).then((function(e){return e.json()})).then((function(e){M.location.assign("".concat("https://d1hk88326p7ilp.cloudfront.net","/").concat(e.key))})).catch((function(e){(0,D.Tb)({message:e,section:"fetch"})}));case 43:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),L=function(e){var t=e.meta,n=e.revisionIndex,i=e.type;if(n&&Number(n)>-1){var r=w({},null===t||void 0===t?void 0:t.revisions[n]);return w({},"supplier"===i?r.data.supplierInvoice:r.data.customerVATInvoice)}return w({},"supplier"===i?null===t||void 0===t?void 0:t.supplierInvoice:null===t||void 0===t?void 0:t.customerVATInvoice)}},29575:function(e,t,n){n.d(t,{F:function(){return a}});var i=n(30266),r=n(64687),o=n.n(r),u=n(84774),a=function(){var e=(0,i.Z)(o().mark((function e(t,n,i){var r,a;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={},a={},e.next=4,t.mutate({mutation:u.iU,variables:{jobId:n,invoiceType:"supplier"},skip:i&&"supplier"!==i}).then((function(e){var t;r=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData}));case 4:return e.next=6,t.mutate({mutation:u.iU,variables:{jobId:n,invoiceType:"customerVat"},skip:i&&"supplier"===i}).then((function(e){var t;a=null===e||void 0===e||null===(t=e.data.calculateJobFinance)||void 0===t?void 0:t.data.persistentData}));case 6:return e.abrupt("return",{financeSupplier:r,financeCustomer:a});case 7:case"end":return e.stop()}}),e)})));return function(t,n,i){return e.apply(this,arguments)}}()}}]);